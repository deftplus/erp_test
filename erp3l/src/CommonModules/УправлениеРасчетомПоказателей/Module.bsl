
#Область ПрограммныйИнтерфейс

////////////////////////////////////////////////////////////////////////////////
// Экспортные процедуры и функции
//  
////////////////////////////////////////////////////////////////////////////////

#Область Трассировка

// Функция - ВТ - Возвращает структуру с таблицами запроса, в том числе и временными
//
// Параметры:
//  ЗапросМенеджер	 - Запрос, МенеджерВременныхТаблиц - Запрос или Менеджер временных таблиц
// 
// Возвращаемое значение:
//   - Структура - Структура с таблицами запроса
//
Функция ВТ(Знач ЗапросМенеджер) Экспорт
	
	Если ТипЗнч(ЗапросМенеджер) = Тип("Запрос") Тогда
		ЗапросМенеджер = ЗапросМенеджер.МенеджерВременныхТаблиц;
	КонецЕсли;
	Если ТипЗнч(ЗапросМенеджер) <> Тип("МенеджерВременныхТаблиц") Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Результаты = Новый Структура;
	
	Для Каждого Таблица Из ЗапросМенеджер.Таблицы Цикл		
		Результаты.Вставить(Таблица.ПолноеИмя,Таблица.ПолучитьДанные().Выгрузить());	
	КонецЦикла;
	
	Возврат Результаты;
	
КонецФункции

#КонецОбласти

// Процедура - Получить обработку расчета для текущего случая
//
// Параметры:
//  ОбработкаРасчета - ОбработкаОбъект - В данную переменную возвращается обработка, в которой будет производиться расчет
//  ОбъектРасчета	 - Структура - Структура с данными для расчета
//
Процедура ПолучитьОбработкуРасчета(ОбработкаРасчета, ОбъектРасчета) Экспорт
	
	Если Константы.ИспользоватьРасширенныйАлгоритмПересчетаПоказателей.Получить()
		И (ОбъектРасчета = Неопределено 			
		Или ОпределитьСпособФормированияОтчета(ОбъектРасчета) = ПредопределенноеЗначение("Перечисление.СпособыФормированияОтчетов.АвтоматическиПоПравилуОбработки")) 
		Тогда
		ОбработкаРасчета = Обработки.РасчетИЗаписьПоказателей.Создать();
	Иначе
		ОбработкаРасчета = Обработки.ЗаписьПоказателяСРасчетомЗависимых.Создать();
	КонецЕсли;
	
КонецПроцедуры	

// Процедура - Использовать расширенный расчет
//
// Параметры:
//  ПризнакРасширенногоРасчета	 - Булево - Истина - если используется расширенный расчет показателей, Ложь - в противном случае.
//
Процедура ИспользоватьРасширенныйРасчет(ПризнакРасширенногоРасчета) Экспорт
	
	ПризнакРасширенногоРасчета = Константы.ИспользоватьРасширенныйАлгоритмПересчетаПоказателей.Получить();
	
КонецПроцедуры

// Функция - Определить способ формирования отчета
//
// Параметры:
//  ОбъектРасчета	 - Структура - Структура с данными для расчета
// 
// Возвращаемое значение:
//   - ПеречислениеСсылка.СпособыФормированияОтчетов - способ формирования отчета с переданными данными для расчета
//
Функция ОпределитьСпособФормированияОтчета(ОбъектРасчета) Экспорт
	
	Если ЗначениеЗаполнено(ОбъектРасчета.СпособФормированияОтчета) Тогда			
		СпособФормированияОтчета = ОбъектРасчета.СпособФормированияОтчета; 		
	Иначе
		ВерсияРегламента = ПолныеПраваУХ.ВернутьВерсиюОрганизационнойСтруктурыПоПериодСценарию(ОбъектРасчета.ПериодОтчета,ОбъектРасчета.Сценарий);
		СпособФормированияОтчета = УправлениеОтчетамиУХ.НайтиПараметрОтчета(
			Перечисления.ЭлементыНастройкиОтчета.СпособФормированияОтчета, ОбъектРасчета.ВидОтчета, 
			ОбъектРасчета.Сценарий, ОбъектРасчета.Организация, ОбъектРасчета.ПериодОтчета, ВерсияРегламента);
		Если НЕ ЗначениеЗаполнено(СпособФормированияОтчета) Тогда
			СпособФормированияОтчета = ПредопределенноеЗначение("Перечисление.СпособыФормированияОтчетов.АвтоматическиПоПравилуОбработки");
		КонецЕсли;
	КонецЕсли;

	Возврат СпособФормированияОтчета;
	
КонецФункции

// Процедура - Очищает версии и данные параметрики текущего отчета 
//
// Параметры:
//  ОбъектРасчета					 - Структура - Структура с данными для расчета 
//  УдалятьВерсии					 - Булево - Признак того, что необходимо удалить версии
//  УдалятьПараметрикуНовогоДвижка	 - Булево - Признак того, что необходимо очистить данные параметрики расширенного алгоритма пересчета показателей
//  УдалятьПараметрикуСтарогоДвижка	 - Булево - Признак того, что необходимо очистить данные параметрики классического алгоритма пересчета показателей 
//
Процедура ОчиститьСтарыеДанные(ОбъектРасчета,УдалятьВерсии=Истина,УдалятьПараметрикуНовогоДвижка=Истина,УдалятьПараметрикуСтарогоДвижка=Ложь) Экспорт
	
	Если УдалятьПараметрикуСтарогоДвижка Тогда
		УправлениеОтчетамиУХ.ОчиститьЗаписиРегистраПараметрическихНастроек(ОбъектРасчета.ПравилоОбработки);
	ИначеЕсли УдалятьПараметрикуНовогоДвижка Тогда
		НаборЗаписей = РегистрыСведений.ХранилищаПараметрическойНастройкиРасширенный.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.ПравилоОбработки.Установить(ОбъектРасчета.ПравилоОбработки);
		НаборЗаписей.Записать();
	КонецЕсли;
	
	Если УдалятьВерсии Тогда
	
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ВерсииЗначенийПоказателей.Владелец КАК Ссылка
			|ИЗ
			|	Справочник.ВерсииЗначенийПоказателей КАК ВерсииЗначенийПоказателей
			|ГДЕ
			|	ВерсииЗначенийПоказателей.ВидОтчета = &ВидОтчета
			|	И ВерсииЗначенийПоказателей.Организация = &Организация
			|	И ВерсииЗначенийПоказателей.Сценарий = &Сценарий
			|	И ВерсииЗначенийПоказателей.Проект = &Проект
			|	И ВерсииЗначенийПоказателей.ПериодОтчета В(&МассивПериодов) %ТекстАналитики%";
		
		Запрос.УстановитьПараметр("ВидОтчета",ОбъектРасчета.ВидОтчета);   
		Запрос.УстановитьПараметр("Организация",ОбъектРасчета.Организация);
		Запрос.УстановитьПараметр("Сценарий",ОбъектРасчета.Сценарий);
		Запрос.УстановитьПараметр("Проект",ОбъектРасчета.Проект);
		
		Если ОбъектРасчета.МассивПериодов = Неопределено Тогда
			ОбъектРасчета.Вставить("МассивПериодов",УправлениеОтчетамиУХ.ПолучитьМассивПериодов(
				Новый Структура("ПериодОтчета,ПериодОкончания",ОбъектРасчета.ПериодОтчета,ОбъектРасчета.ПериодОкончания)));
		КонецЕсли;
		Запрос.УстановитьПараметр("МассивПериодов",ОбъектРасчета.МассивПериодов);
		
		Если ОбъектРасчета.МаксАналитикОтчета = Неопределено Тогда
			ДанныеВидаОтчета = ДанныеВидаОтчета(ОбъектРасчета.ВидОтчета);
			ОбъектРасчета.МаксАналитикОтчета = ДанныеВидаОтчета.МаксКлючевыхАналитик;
		КонецЕсли;
		
		ТекстАналитики = "";
		Для Сч = 1 По ОбъектРасчета.МаксАналитикОтчета Цикл
		    ТекстАналитики = ТекстАналитики + "
			|	И ВерсииЗначенийПоказателей.Аналитика" + Сч + " = &Аналитика" + Сч;
			Запрос.УстановитьПараметр("Аналитика" + Сч, ОбъектРасчета["Аналитика" + Сч]);
		КонецЦикла;
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"%ТекстАналитики%",ТекстАналитики);
		
		РезультатЗапроса = Запрос.Выполнить();
		
		Если Не РезультатЗапроса.Пустой() Тогда
			
			НачатьТранзакцию();
			Попытка
				
				Блокировка = Новый БлокировкаДанных;
				ЭлементБлокировки = Блокировка.Добавить("Справочник.ОписаниеВерсий");
				ЭлементБлокировки.ИсточникДанных = РезультатЗапроса;
				ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
				Блокировка.Заблокировать();
			
				ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
				Пока ВыборкаДетальныеЗаписи.Следующий() Цикл		
					СпрОбъект = ВыборкаДетальныеЗаписи.Ссылка.ПолучитьОбъект();
					СпрОбъект.Удалить();
				КонецЦикла;
			
				ЗафиксироватьТранзакцию();
				
			Исключение
				ОтменитьТранзакцию();
				ИнформацияОбОшибке = ИнформацияОбОшибке();
				ОбщегоНазначенияУХ.СообщитьОбОшибке(ПодробноеПредставлениеОшибки(ИнформацияОбОшибке),,,СтатусСообщения.Внимание);
			КонецПопытки;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры 

// Процедура - Очищает регистр сведений "ХранилищаПараметрическойНастройкиРасширенный" для связанных правил расчета
//
// Параметры:
//  ДанныеСсылка - СправочникСсылка - Ссылка на изменяемый объект
//
Процедура ОчиститьСтруктуруРасчетаПоказателейПоПравилуРасчета(ДанныеСсылка) Экспорт
	
	Запрос = Новый Запрос;
	Если ТипЗнч(ДанныеСсылка) = Тип("СправочникСсылка.ПравилаОбработки") Тогда
		
		НаборЗаписей = РегистрыСведений.ХранилищаПараметрическойНастройкиРасширенный.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.ПравилоОбработки.Установить(ДанныеСсылка);
		НаборЗаписей.Записать();
		Возврат;
		
	ИначеЕсли ТипЗнч(ДанныеСсылка) = Тип("СправочникСсылка.ВидыОтчетов") Тогда		
		
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПравилаОбработки.Ссылка КАК ПравилоОбработки
		|ИЗ
		|	Справочник.ПравилаОбработки КАК ПравилаОбработки
		|ГДЕ
		|	ПравилаОбработки.Владелец = &Ссылка";
	
	ИначеЕсли ТипЗнч(ДанныеСсылка) = Тип("СправочникСсылка.ПоказателиОтчетов") Тогда
	
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПравилаОбработки.Ссылка КАК ПравилоОбработки
		|ИЗ
		|	Справочник.ПравилаОбработки КАК ПравилаОбработки
		|ГДЕ
		|	ПравилаОбработки.Владелец В
		|			(ВЫБРАТЬ
		|				СправочникДанные.Владелец КАК Владелец
		|			ИЗ
		|				Справочник.ПоказателиОтчетов КАК СправочникДанные
		|			ГДЕ
		|				СправочникДанные.Ссылка = &Ссылка)";
		
	ИначеЕсли ТипЗнч(ДанныеСсылка) = Тип("СправочникСсылка.ГруппыРаскрытия") Тогда
		
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПравилаОбработки.Ссылка КАК ПравилоОбработки
		|ИЗ
		|	Справочник.ПравилаОбработки КАК ПравилаОбработки
		|ГДЕ
		|	ПравилаОбработки.Владелец В
		|			(ВЫБРАТЬ
		|				СправочникДанные.Владелец КАК Владелец
		|			ИЗ
		|				Справочник.ГруппыРаскрытия КАК СправочникДанные
		|			ГДЕ
		|				СправочникДанные.Ссылка = &Ссылка)";
		
	ИначеЕсли ТипЗнч(ДанныеСсылка) = Тип("СправочникСсылка.КолонкиОтчетов") Тогда
		
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПравилаОбработки.Ссылка КАК ПравилоОбработки
		|ИЗ
		|	Справочник.ПравилаОбработки КАК ПравилаОбработки
		|ГДЕ
		|	ПравилаОбработки.Владелец В
		|			(ВЫБРАТЬ
		|				СправочникДанные.Владелец КАК Владелец
		|			ИЗ
		|				Справочник.КолонкиОтчетов КАК СправочникДанные
		|			ГДЕ
		|				СправочникДанные.Ссылка = &Ссылка)";
		
	ИначеЕсли ТипЗнч(ДанныеСсылка) = Тип("СправочникСсылка.СтрокиОтчетов") Тогда
		
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПравилаОбработки.Ссылка КАК ПравилоОбработки
		|ИЗ
		|	Справочник.ПравилаОбработки КАК ПравилаОбработки
		|ГДЕ
		|	ПравилаОбработки.Владелец В
		|			(ВЫБРАТЬ
		|				СправочникДанные.Владелец КАК Владелец
		|			ИЗ
		|				Справочник.СтрокиОтчетов КАК СправочникДанные
		|			ГДЕ
		|				СправочникДанные.Ссылка = &Ссылка)";
		
	Иначе
		Возврат;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Ссылка", ДанныеСсылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		НаборЗаписей = РегистрыСведений.ХранилищаПараметрическойНастройкиРасширенный.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.ПравилоОбработки.Установить(ВыборкаДетальныеЗаписи.ПравилоОбработки);
		НаборЗаписей.Записать();
	КонецЦикла;
	
КонецПроцедуры

// Возвращает данные вида отчета
//
// Параметры:
//  ВидОтчета	 - СправочникСсылка.ВидыОтчетов - Ссылка на вид отчета
// 
// Возвращаемое значение:
//   - Структура - Структура с данными вида отчета
//
Функция ДанныеВидаОтчета(ВидОтчета) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ВидыОтчетов.Ссылка КАК ВидОтчета,
		|	ВидыОтчетов.РазделениеПоПроектам КАК РазделениеПоПроектам,
		|	ВидыОтчетов.СохранятьИсториюИзменений КАК СохранятьИсториюИзменений,
		|	ВЫБОР
		|		КОГДА ВидыОтчетов.ВидАналитики1 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ + ВЫБОР
		|		КОГДА ВидыОтчетов.ВидАналитики2 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ + ВЫБОР
		|		КОГДА ВидыОтчетов.ВидАналитики3 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ + ВЫБОР
		|		КОГДА ВидыОтчетов.ВидАналитики4 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ + ВЫБОР
		|		КОГДА ВидыОтчетов.ВидАналитики5 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ + ВЫБОР
		|		КОГДА ВидыОтчетов.ВидАналитики6 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ КАК МаксКлючевыхАналитик
		|ИЗ
		|	Справочник.ВидыОтчетов КАК ВидыОтчетов
		|ГДЕ
		|	ВидыОтчетов.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка",ВидОтчета);
	Возврат Запрос.Выполнить().Выгрузить().Получить(0);

КонецФункции

#Область ОписанияПроцедурРасчета

// Функция - Получить описание лога измененных показателей
// 
// Возвращаемое значение:
//   - ТаблицаЗначений - пустая таблица для лога измененных показателей
//
Функция ПолучитьОписаниеЛогаИзмененныхПоказателей() Экспорт
	
	Возврат Обработки.РасчетИЗаписьПоказателей.Создать().ЛогИзмененныхПоказателей.ВыгрузитьКолонки();
	
КонецФункции

// Функция - Получить описание лога комментариев показателей
// 
// Возвращаемое значение:
//   - ТаблицаЗначений - пустая таблица для лога комментариев показателей
//
Функция ПолучитьОписаниеЛогаКомментариевПоказателей() Экспорт
	
	КолонкиТаблицы = "ПравилоОбработки,Показатель,Сценарий,Организация,Проект,ПериодОтчета,Валюта,НомерТранзакции,АналитикаВалюта";
	Для Сч = 1 По ПараметрыСеанса.ЧислоДопАналитик Цикл
		КолонкиТаблицы = КолонкиТаблицы + ",Аналитика" + Сч;
	КонецЦикла;
	
	Таблица = Обработки.РасчетИЗаписьПоказателей.Создать().ЛогИзмененныхПоказателей.ВыгрузитьКолонки(КолонкиТаблицы);
	Таблица.Колонки.Добавить("Комментарий", ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСтроки(1024));
	
	Возврат Таблица;
	
КонецФункции

// Функция - Получить описание таблицы измененных показателей
// 
// Возвращаемое значение:
//   - ТаблицаЗначений - пустая таблица для таблицы измененных показателей
//
Функция ПолучитьОписаниеТаблицыИзмененныхПоказателей() Экспорт
	
	КолонкиТаблицы = "ПравилоОбработки,Показатель,Сценарий,Организация,Проект,ПериодОтчета,Значение,ЗначениеНечисловое,ЗначениеВалюта,АналитикаВалюта";
	Для Сч = 1 По ПараметрыСеанса.ЧислоДопАналитик Цикл
		КолонкиТаблицы = КолонкиТаблицы + ",Аналитика" + Сч;
	КонецЦикла;
	
	Возврат Обработки.РасчетИЗаписьПоказателей.Создать().ЛогИзмененныхПоказателей.ВыгрузитьКолонки(КолонкиТаблицы);
	
КонецФункции

#КонецОбласти

#Область ПроцедурыДляРасчета
 
// Функция - Получает из регистра сведений "ХранилищаПараметрическойНастройкиРасширенный" 
//	структуру для расчета показателей по правилу расчета.
//	Если в регистре сведений нет данных для переданного правила расчета, происходит расчет параметрики расчета
//
// Параметры:
//  ПравилоОбработки	 	- СправочникСсылка.ПравилаОбработки - Привило обработки для расчета
// 
// Возвращаемое значение:
//   - Структура - Структура для расчета показателей по правилу расчета
//
Функция ПолучитьТаблицуРасчетаПоказателейПоПравилуРасчета(ПравилоОбработки) Экспорт
	
	тПересчетаПоказателей = ПолучитьДанныеИзХранилищаПараметрическойНастройки(ПравилоОбработки, 1);
	Если тПересчетаПоказателей = Неопределено Тогда	
		
		// Сформируем данные для расчета запросов
		СтруктураРасчетаПоказателей = ПодготовитьТаблицыДляРасчетаПоказателейПоПравилуРасчета(ПравилоОбработки);
		
		Если СтруктураРасчетаПоказателей.тПоказателиОперанды.Количество() > 0 Тогда
		
			// Создадим таблицу показателей
			СоздатьТаблицуПоказателейОперандов(СтруктураРасчетаПоказателей);
			
			// Генерация таблицы запросов для получения независимых операндов (0 уровень расчета)
			ПодготовитьЗапросУровня0(СтруктураРасчетаПоказателей);
			
			// Генерация таблиц запросов для расчета операндов всех зависимых уровней расчета
			ПодготовитьЗапросыРекурсивныхУровней(СтруктураРасчетаПоказателей);

			// Получаем объединенную таблицу потребителей 
			ПодготовитьТаблицуНовыхЗначенийПотребителей(СтруктураРасчетаПоказателей);
			
			// Получаем исходные данные потребителей
			ПодготовитьТаблицуИсходныхЗначенийПотребителей(СтруктураРасчетаПоказателей);	
			
			// Получаем таблицы с дельтами, относительно исходных данных
			ПодготовитьТаблицуДляРасчетаОтклонений(СтруктураРасчетаПоказателей);
			
			// Запишем данные в лог измененных показателей
			ДобавитьВЛогТаблицуИзмененныхПоказателей(СтруктураРасчетаПоказателей);
			ДобавитьВЛогТаблицуИзмененныхПоказателей(СтруктураРасчетаПоказателей, Истина);
			
		КонецЕсли;
		
		тПересчетаПоказателей = СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей;
		
		СохранитьДанныеВХранилищеПараметрическойНастройки(ПравилоОбработки, 1, тПересчетаПоказателей);
		
	КонецЕсли;
	
	Возврат тПересчетаПоказателей;
	
КонецФункции

// Функция - Рассчитывает параметрические данные для расчета целевых показателей переданных 
//		в таблице значений "ОбъектРасчета.тЦелевыеПоказатели" 
//
// Параметры:
//  ОбъектРасчета	 			- Структура - Структура с данным для расчета параметрики
// 
// Возвращаемое значение:
//   - Структура - Структура для расчета показателей по правилу расчета
//
Функция ПолучитьТаблицуРасчетаПоказателейПоДаннымДляПересчета(ПравилоОбработки) Экспорт
	// ДОДЕЛАТЬ: Нужна ли?
	тПересчетаПоказателей = ПолучитьДанныеИзХранилищаПараметрическойНастройки(ПравилоОбработки, 2);
	Если тПересчетаПоказателей = Неопределено Тогда		
		
		// Сформируем данные для расчета запросов
		СтруктураРасчетаПоказателей = ПодготовитьТаблицыДляРасчетаПоказателейПоПравилуРасчета(ПравилоОбработки);
		
		Если СтруктураРасчетаПоказателей.тПоказателиОперанды.Количество() > 0 Тогда
			
			// Не пересчитываем в валютные значения
			СтруктураРасчетаПоказателей.ЕстьАналитикаВалюта = Ложь;
		
			// Создадим таблицу показателей
			СоздатьТаблицуПоказателейОперандов(СтруктураРасчетаПоказателей);
			
			// Генерация таблицы запросов для получения независимых операндов (0 уровень расчета)
			ПодготовитьЗапросУровня0(СтруктураРасчетаПоказателей);
			
			// Генерация таблиц запросов для расчета операндов всех зависимых уровней расчета
			ПодготовитьЗапросыРекурсивныхУровней(СтруктураРасчетаПоказателей);

			// Получаем объединенную таблицу потребителей 
			ПодготовитьТаблицуНовыхЗначенийПотребителей(СтруктураРасчетаПоказателей);
			
			// Свернем таблицу новых значений потребителей
			СвернутьТаблицуНовыхЗначенийПотребителей(СтруктураРасчетаПоказателей); 
			
			// Сгруппируем таблицу новых значений потребителей
			ДобавитьВЛогТаблицуИзмененныхПоказателей(СтруктураРасчетаПоказателей);
			
		КонецЕсли;
		
		тПересчетаПоказателей = СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей;
		
		СохранитьДанныеВХранилищеПараметрическойНастройки(ПравилоОбработки, 2, тПересчетаПоказателей);
		
	КонецЕсли; 
	
	Возврат тПересчетаПоказателей;
	
КонецФункции

// Функция - Получить структуру для установки новых значений показателей
//
// Параметры:
//  ОбъектРасчета						 - Структура - Структура с данными для расчета 
// 
// Возвращаемое значение:
//   - ТаблицаЗначений - Таблица со строками этапов расчета показателей по правилу расчета
//
Функция ПолучитьТаблицуУстановкиИзмененныхЗначенийПоказателей(ОбъектРасчета) Экспорт 
	
	// Инициализируем служебные таблицы
	ОписаниеСлужебныхТаблиц = ПолучитьОписаниеСлужебныхТаблиц();
	глТаблицаПересчетаПоказателей = ОписаниеСлужебныхТаблиц.глТаблицаПересчетаПоказателей;
	тРасшифровкаГруппОтборов = ОписаниеСлужебныхТаблиц.тРасшифровкаГруппОтборов;	
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ВсеПоказатели",ОбъектРасчета.тИзмененныеПоказатели.ВыгрузитьКолонку("Показатель"));
	Запрос.Текст =
		"ВЫБРАТЬ
		|	МАКСИМУМ(ЕСТЬNULL(ГруппыРаскрытия.ЧислоАналитик, 0)) КАК МаксАналитикПоказателя,
		|	МАКСИМУМ(ЕСТЬNULL(ГруппыРаскрытия.Валютная, ЛОЖЬ)) КАК ЕстьАналитикаВалюта,
		|	МАКСИМУМ(ПоказателиОтчетов.ПересчитыватьВалютнуюСумму) КАК ЕстьЗначениеВалюта,
		|	МАКСИМУМ(ПоказателиОтчетов.ТипЗначения = ЗНАЧЕНИЕ(Перечисление.ТипыЗначенийПоказателейОтчетов.Число)) КАК ЕстьЗначение,
		|	МАКСИМУМ(ПоказателиОтчетов.ТипЗначения <> ЗНАЧЕНИЕ(Перечисление.ТипыЗначенийПоказателейОтчетов.Число)) КАК ЕстьЗначениеНечисловое,
		|	МАКСИМУМ(НЕ ПоказателиОтчетов.НеФинансовый
		|			И ПоказателиОтчетов.ВидКурса = ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.ЗначениеУказанноеВДокументе)) КАК ЕстьВидКурсаЗначениеУказанноеВДокументе,
		|	МАКСИМУМ(НЕ ПоказателиОтчетов.НеФинансовый
		|			И ПоказателиОтчетов.ВидКурса = ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.КурсНаМоментНачисления)) КАК ЕстьВидКурсаКурсНаМоментНачисления,
		|	МАКСИМУМ(НЕ ПоказателиОтчетов.НеФинансовый
		|			И ПоказателиОтчетов.ВидКурса <> ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.КурсНаМоментНачисления)
		|			И ПоказателиОтчетов.ВидКурса <> ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.ЗначениеУказанноеВДокументе)) КАК ЕстьВидКурсаПрочее
		|ИЗ
		|	Справочник.ПоказателиОтчетов КАК ПоказателиОтчетов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ГруппыРаскрытия КАК ГруппыРаскрытия
		|		ПО ПоказателиОтчетов.ГруппаРаскрытия = ГруппыРаскрытия.Ссылка
		|ГДЕ
		|	ПоказателиОтчетов.Ссылка В(&ВсеПоказатели)";
	
	ВыборкаЗапроса = Запрос.Выполнить().Выбрать();
	Если ВыборкаЗапроса.Следующий() Тогда
		
		СтруктураРасчетаПоказателей = ПолучитьСтруктуруРасчетаПоказателей();
		СтруктураРасчетаПоказателей.Вставить("глТаблицаПересчетаПоказателей", глТаблицаПересчетаПоказателей);
		СтруктураРасчетаПоказателей.Вставить("ДанныеВидаОтчета", ОбъектРасчета.ДанныеВидаОтчета);
		СтруктураРасчетаПоказателей.Вставить("тРасшифровкаГруппОтборов", тРасшифровкаГруппОтборов);
		СтруктураРасчетаПоказателей.Вставить("МаксКлючевыхАналитик",ОбъектРасчета.МаксАналитикОтчета);
		СтруктураРасчетаПоказателей.Вставить("МаксИспользуемыхАналитик",ВыборкаЗапроса.МаксАналитикПоказателя + ОбъектРасчета.МаксАналитикОтчета);
		СтруктураРасчетаПоказателей.Вставить("ЕстьАналитикаВалюта",ВыборкаЗапроса.ЕстьАналитикаВалюта);
		СтруктураРасчетаПоказателей.Вставить("ЕстьЗначение",ВыборкаЗапроса.ЕстьЗначение);
		СтруктураРасчетаПоказателей.Вставить("ЕстьЗначениеНечисловое",ВыборкаЗапроса.ЕстьЗначениеНечисловое);
		СтруктураРасчетаПоказателей.Вставить("ЕстьЗначениеВалюта",ВыборкаЗапроса.ЕстьАналитикаВалюта И ВыборкаЗапроса.ЕстьЗначениеВалюта);
		СтруктураРасчетаПоказателей.Вставить("ЕстьВидКурсаЗначениеУказанноеВДокументе",ВыборкаЗапроса.ЕстьВидКурсаЗначениеУказанноеВДокументе);
		СтруктураРасчетаПоказателей.Вставить("ЕстьВидКурсаКурсНаМоментНачисления",ВыборкаЗапроса.ЕстьВидКурсаКурсНаМоментНачисления);
		СтруктураРасчетаПоказателей.Вставить("ЕстьВидКурсаПрочее",ВыборкаЗапроса.ЕстьВидКурсаПрочее);
		
		// Добавим таблицу измененных показателей
		СоздатьТаблицуИзмененныхПоказателей(СтруктураРасчетаПоказателей, ОбъектРасчета.тИзмененныеПоказатели);
		
		// Запишем данные в лог измененных показателей
		ДобавитьВЛогТаблицуИзмененныхПоказателей(СтруктураРасчетаПоказателей, ОбъектРасчета.ДополнительныеВалюты.Количество() > 0);		
		
		// Получим таблицу только новых значений ЗначениеВалюта
		Если СтруктураРасчетаПоказателей.ЕстьЗначениеВалюта Тогда
			ПодготовитьИзмененияВалютныхПоказателей(СтруктураРасчетаПоказателей);
		КонецЕсли;
	
	КонецЕсли;
	
	Возврат глТаблицаПересчетаПоказателей;
	
КонецФункции	

// Функция - Рассчитывает параметрические данные для расчета показателей для переданных 
//		в таблице значений "ОбъектРасчета.тИзмененныеПоказатели" измененных показателей
//
// Параметры:
//  ОбъектРасчета	 			- Структура - Структура с данным для расчета параметрики
// 
// Возвращаемое значение:
//   - Структура - Структура для расчета показателей по правилу расчета
//
Функция ПолучитьТаблицуРасчетаПоказателейПоИзмененнымПоказателям(ОбъектРасчета) Экспорт
	
	// Сформируем данные для расчета запросов
	СтруктураРасчетаПоказателей = ПодготовитьТаблицыДляРасчетаПоказателейПоПравилуРасчета(ОбъектРасчета.ПравилоОбработки, ОбъектРасчета.тИзмененныеПоказатели);
	
	Если СтруктураРасчетаПоказателей.тПоказателиОперанды.Количество() > 0 Тогда
		
		Если ОбъектРасчета.ВидРасчета = "ПоИзмененнымПоЦелевым" Тогда
			// Данные получаем только из лога рассчитанных показателей
			СтруктураРасчетаПоказателей.ПолучатьДанныеИзРегистров = Ложь;
			// Не делаем пересчеты в валюты
			СтруктураРасчетаПоказателей.ЕстьАналитикаВалюта = Ложь;
		КонецЕсли;
	
		// Создадим таблицу показателей
		СоздатьТаблицуПоказателейОперандов(СтруктураРасчетаПоказателей);
		
		// Генерация таблицы запросов для получения независимых операндов (0 уровень расчета)
		ПодготовитьЗапросУровня0(СтруктураРасчетаПоказателей);
		
		// Генерация таблиц запросов для расчета операндов всех зависимых уровней расчета
		ПодготовитьЗапросыРекурсивныхУровней(СтруктураРасчетаПоказателей);

		// Получим объединенную таблицу потребителей 
		ПодготовитьТаблицуНовыхЗначенийПотребителей(СтруктураРасчетаПоказателей);
		
		// Получим исходные данные потребителей
		ПодготовитьТаблицуИсходныхЗначенийПотребителей(СтруктураРасчетаПоказателей, , Истина);	
		
		// Получаем таблицы с дельтами, относительно исходных данных
		ПодготовитьТаблицуДляРасчетаОтклонений(СтруктураРасчетаПоказателей);
		
		// Запишем данные в лог измененных показателей
		ДобавитьВЛогТаблицуИзмененныхПоказателей(СтруктураРасчетаПоказателей, ОбъектРасчета.ДополнительныеВалюты.Количество() > 0);
		
	КонецЕсли;
		
	// Получаем итоговую таблицу пересчета показателей
	Возврат СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей;
	
КонецФункции

// Функция - Рассчитывает параметрические данные для расчета целевых показателей переданных 
//		в таблице значений "ОбъектРасчета.тЦелевыеПоказатели" 
//
// Параметры:
//  ОбъектРасчета	 			- Структура - Структура с данным для расчета параметрики
// 
// Возвращаемое значение:
//   - Структура - Структура для расчета показателей по правилу расчета
//
Функция ПолучитьТаблицуРасчетаПоказателейПоЦелевымПоказателям(ПравилоОбработки, тЦелевыеПоказатели) Экспорт
	
	// Сформируем данные для расчета запросов
	СтруктураРасчетаПоказателей = ПодготовитьТаблицыДляРасчетаПоказателейПоПравилуРасчета(ПравилоОбработки, , тЦелевыеПоказатели);
	
	Если СтруктураРасчетаПоказателей.тПоказателиОперанды.Количество() > 0 Тогда
		
		// Не пересчитываем в валютные значения
		СтруктураРасчетаПоказателей.ЕстьАналитикаВалюта = Ложь;
	
		// Создадим таблицу показателей
		СоздатьТаблицуПоказателейОперандов(СтруктураРасчетаПоказателей);
		
		// Генерация таблицы запросов для получения независимых операндов (0 уровень расчета)
		ПодготовитьЗапросУровня0(СтруктураРасчетаПоказателей);
		
		// Генерация таблиц запросов для расчета операндов всех зависимых уровней расчета
		ПодготовитьЗапросыРекурсивныхУровней(СтруктураРасчетаПоказателей);

		// Получим объединенную таблицу потребителей 
		ПодготовитьТаблицуНовыхЗначенийПотребителей(СтруктураРасчетаПоказателей);
		
		// Свернем таблицу новых значений потребителей
		СвернутьТаблицуНовыхЗначенийПотребителей(СтруктураРасчетаПоказателей); 
		
		// Сгруппируем таблицу новых значений потребителей
		ДобавитьВЛогТаблицуИзмененныхПоказателей(СтруктураРасчетаПоказателей);
		
		// Запомним показатели нулевого уровня
		ДобавитьВЛогТаблицуИзмененныхПоказателейУровень0(СтруктураРасчетаПоказателей);
		
	КонецЕсли;
		
	// Получаем итоговую таблицу пересчета показателей
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("глТаблицаПересчетаПоказателей", СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей);
	СтруктураВозврата.Вставить("тПоказателиОперанды", СтруктураРасчетаПоказателей.тПоказателиОперанды);
	
	Возврат СтруктураВозврата;
	
КонецФункции

// Функция - Получить структуру для установки новых значений показателей
//
// Параметры:
//  ОбъектРасчета						 - Структура - Структура с данными для расчета 
//  ТаблицаУстановкиЗначенийПоказателей	 - ТаблицаЗначений - Таблица с новыми значениями показателей 
// 
// Возвращаемое значение:
//   - ТаблицаЗначений - Таблица со строками этапов расчета показателей по правилу расчета
//
Функция ПолучитьТаблицуРасчетаПоказателейДляУстановкиНовыхЗначенийПоказателей(ОбъектРасчета, ТаблицаУстановкиЗначенийПоказателей) Экспорт 
	
	ВидОтчета 						= ОбъектРасчета.ВидОтчета;
	МаксАналитикОтчета				= ОбъектРасчета.МаксАналитикОтчета;
	МаксАналитикПоказателя			= ОбъектРасчета.МаксАналитикПоказателя;
	МенеджерВременныхТаблиц 		= ОбъектРасчета.МенеджерВременныхТаблиц;
	ПравилоОбработки				= ОбъектРасчета.ПравилоОбработки;
	
	ТекстПоля = "
		|	ЗначенияПоказателей.ПериодОтчета,
		|	ЗначенияПоказателей.Аналитика1,
		|	ЗначенияПоказателей.Аналитика2,
		|	ЗначенияПоказателей.Аналитика3,
		|	ЗначенияПоказателей.Аналитика4,
		|	ЗначенияПоказателей.Аналитика5,
		|	ЗначенияПоказателей.Аналитика6,
		|	ЗначенияПоказателей.АналитикаВалюта,";
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("ЗначенияПоказателейДляУстановки",ТаблицаУстановкиЗначенийПоказателей);
	Запрос.УстановитьПараметр("ВидОтчета",ВидОтчета);	
	Запрос.УстановитьПараметр("МаксКлючевыхАналитик",МаксАналитикОтчета);	
	Запрос.Текст =
		"ВЫБРАТЬ %ТекстПоля%
		|	ЗначенияПоказателей.Показатель КАК Показатель,
		|	ЗначенияПоказателей.КодВФормуле КАК КодПоказателя,
		|	ЗначенияПоказателей.Значение КАК Значение,
		|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета,
		|	ЗначенияПоказателей.УровеньРасчета КАК Счетчик
		|ПОМЕСТИТЬ втЗначенияПоказателейДляУстановки
		|ИЗ
		|	&ЗначенияПоказателейДляУстановки КАК ЗначенияПоказателей
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ %ТекстПоля%
		|	ЕСТЬNULL(ПоказателиОтчетов.Ссылка, ЗначенияПоказателей.Показатель) КАК Показатель,
		|	ЗначенияПоказателей.Значение КАК Значение,
		|	ЗначенияПоказателей.Счетчик КАК Счетчик
		|ПОМЕСТИТЬ втЗначенияПоказателейДляУстановкиСПоказателями
		|ИЗ
		|	втЗначенияПоказателейДляУстановки КАК ЗначенияПоказателей
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПоказателиОтчетов КАК ПоказателиОтчетов
		|		ПО ЗначенияПоказателей.КодПоказателя = ПоказателиОтчетов.Код
		|			И (ПоказателиОтчетов.Владелец = &ВидОтчета)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ %ТекстПоля%
		|	ЗначенияПоказателей.Показатель КАК Показатель,
		|	МАКСИМУМ(ЗначенияПоказателей.Счетчик) КАК Счетчик
		|ПОМЕСТИТЬ втКрайниеЗначенияПоказателейПоказателейДляУстановки
		|ИЗ
		|	втЗначенияПоказателейДляУстановкиСПоказателями КАК ЗначенияПоказателей
		|
		|СГРУППИРОВАТЬ ПО %ТекстПоля%
		|	ЗначенияПоказателей.Показатель
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ %ТекстПоля%
		|	ЗначенияПоказателей.Показатель КАК Показатель,
		|	ЗначенияПоказателей.Значение КАК Значение
		|ПОМЕСТИТЬ втИтоговыеЗначенияПоказателейДляУстановки
		|ИЗ
		|	втЗначенияПоказателейДляУстановкиСПоказателями КАК ЗначенияПоказателей
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втКрайниеЗначенияПоказателейПоказателейДляУстановки КАК КрайниеЗначенияПоказателейПоказателейДляУстановки
		|		ПО ЗначенияПоказателей.Показатель = КрайниеЗначенияПоказателейПоказателейДляУстановки.Показатель
		|			И ЗначенияПоказателей.ПериодОтчета = КрайниеЗначенияПоказателейПоказателейДляУстановки.ПериодОтчета
		|			И ЗначенияПоказателей.Аналитика1 = КрайниеЗначенияПоказателейПоказателейДляУстановки.Аналитика1
		|			И ЗначенияПоказателей.Аналитика2 = КрайниеЗначенияПоказателейПоказателейДляУстановки.Аналитика2
		|			И ЗначенияПоказателей.Аналитика3 = КрайниеЗначенияПоказателейПоказателейДляУстановки.Аналитика3
		|			И ЗначенияПоказателей.Аналитика4 = КрайниеЗначенияПоказателейПоказателейДляУстановки.Аналитика4
		|			И ЗначенияПоказателей.Аналитика5 = КрайниеЗначенияПоказателейПоказателейДляУстановки.Аналитика5
		|			И ЗначенияПоказателей.Аналитика6 = КрайниеЗначенияПоказателейПоказателейДляУстановки.Аналитика6
		|			И ЗначенияПоказателей.АналитикаВалюта = КрайниеЗначенияПоказателейПоказателейДляУстановки.АналитикаВалюта
		|			И ЗначенияПоказателей.Счетчик = КрайниеЗначенияПоказателейПоказателейДляУстановки.Счетчик
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ %ТекстПоля%
		|	ПоказателиОтчетов.Ссылка КАК Показатель,
		|	ЕСТЬNULL(ГруппыРаскрытия.ЧислоАналитик, 0) + &МаксКлючевыхАналитик КАК МаксИспользуемыхАналитик,
		|	ЕСТЬNULL(ГруппыРаскрытия.Валютная, ЛОЖЬ) КАК ЕстьАналитикаВалюта,
		|	ВЫБОР
		|		КОГДА ПоказателиОтчетов.ТипЗначения = ЗНАЧЕНИЕ(Перечисление.ТипыЗначенийПоказателейОтчетов.Число)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК Числовой,
		|	ВЫБОР
		|		КОГДА ПоказателиОтчетов.ТипЗначения = ЗНАЧЕНИЕ(Перечисление.ТипыЗначенийПоказателейОтчетов.Число)
		|			ТОГДА ВЫРАЗИТЬ(ЗначенияПоказателей.Значение КАК ЧИСЛО(18, 5))
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Значение,
		|	ВЫБОР
		|		КОГДА ПоказателиОтчетов.ТипЗначения <> ЗНАЧЕНИЕ(Перечисление.ТипыЗначенийПоказателейОтчетов.Число)
		|			ТОГДА ЗначенияПоказателей.Значение
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК ЗначениеНечисловое,
		|	ПоказателиОтчетов.НеФинансовый КАК НеФинансовый,
		|	ПоказателиОтчетов.ВидКурса КАК ВидКурса
		|ПОМЕСТИТЬ втЗначенияПотребителейРасчет
		|ИЗ
		|	втИтоговыеЗначенияПоказателейДляУстановки КАК ЗначенияПоказателей
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПоказателиОтчетов КАК ПоказателиОтчетов
		|		ПО ЗначенияПоказателей.Показатель = ПоказателиОтчетов.Ссылка
		|		И (ПоказателиОтчетов.Владелец = &ВидОтчета)
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ГруппыРаскрытия КАК ГруппыРаскрытия
		|		ПО (ПоказателиОтчетов.ГруппаРаскрытия = ГруппыРаскрытия.Ссылка)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	МАКСИМУМ(ПоказателиОтчетов.МаксИспользуемыхАналитик) КАК МаксИспользуемыхАналитик,
		|	МАКСИМУМ(ПоказателиОтчетов.ЕстьАналитикаВалюта) КАК ЕстьАналитикаВалюта,
		|	МАКСИМУМ(ПоказателиОтчетов.Числовой) КАК ЕстьЧисловойПоказатель,
		|	НЕ МИНИМУМ(ПоказателиОтчетов.Числовой) КАК ЕстьНечисловойПоказатель,
		|	МАКСИМУМ(НЕ ПоказателиОтчетов.НеФинансовый
		|			И ПоказателиОтчетов.ВидКурса = ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.ЗначениеУказанноеВДокументе)) КАК ЕстьВидКурсаЗначениеУказанноеВДокументе,
		|	МАКСИМУМ(НЕ ПоказателиОтчетов.НеФинансовый
		|			И ПоказателиОтчетов.ВидКурса = ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.КурсНаМоментНачисления)) КАК ЕстьВидКурсаКурсНаМоментНачисления,
		|	МАКСИМУМ(НЕ ПоказателиОтчетов.НеФинансовый
		|			И ПоказателиОтчетов.ВидКурса <> ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.КурсНаМоментНачисления)
		|			И ПоказателиОтчетов.ВидКурса <> ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.ЗначениеУказанноеВДокументе)) КАК ЕстьВидКурсаПрочее
		|ИЗ
		|	втЗначенияПотребителейРасчет КАК ПоказателиОтчетов
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ЗначенияПоказателей.Показатель КАК Потребитель,
		|	ВЫБОР
		|		КОГДА ЗначенияПоказателей.Числовой
		|			ТОГДА 
		|				ВЫБОР
		|					КОГДА ЗначенияПоказателей.МаксИспользуемыхАналитик = 0
		|						И ЗначенияПоказателей.ЕстьАналитикаВалюта ТОГДА -2
		|					ИНАЧЕ ЗначенияПоказателей.МаксИспользуемыхАналитик
		|				КОНЕЦ
		|		КОГДА ЗначенияПоказателей.МаксИспользуемыхАналитик = 0
		|			ТОГДА -11
		|		ИНАЧЕ -1
		|	КОНЕЦ КАК ИндексРегистраПотребителя
		|ИЗ
		|	втЗначенияПотребителейРасчет КАК ЗначенияПоказателей";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "%ТекстПоля%", ТекстПоля);
	
	// Инициализируем служебные таблицы		
	тСлужебныеТаблицы 					= ПолучитьОписаниеСлужебныхТаблиц();
	глТаблицаПересчетаПоказателей		= тСлужебныеТаблицы.глТаблицаПересчетаПоказателей;
	тПоказателиОперанды                 = тСлужебныеТаблицы.тПоказателиОперанды; 	
	тИспользуемыеРесурсы                = тСлужебныеТаблицы.тИспользуемыеРесурсы;  
	тИспользуемыеАналитики              = тСлужебныеТаблицы.тИспользуемыеАналитики; 
	тРасшифровкаГруппОтборов			= тСлужебныеТаблицы.тРасшифровкаГруппОтборов;
	
	// Добавим данные по аналитикам вида отчета
	СтруктураРасчетаПоказателей = ПолучитьСтруктуруРасчетаПоказателей();
	ДанныеВидаОтчета = ДанныеВидаОтчета(ВидОтчета);
	СтруктураРасчетаПоказателей.ДанныеВидаОтчета = ДанныеВидаОтчета;
	СтруктураРасчетаПоказателей.МаксКлючевыхАналитик = ДанныеВидаОтчета.МаксКлючевыхАналитик;
	
	ПакетРезультатов = Запрос.ВыполнитьПакет();
	
	// Заполним показатели отчета
	РезультатОперанды = ПакетРезультатов.Получить(ПакетРезультатов.Количество()-1);
	Если РезультатОперанды.Пустой() Тогда
		Возврат глТаблицаПересчетаПоказателей;
	КонецЕсли;
	ВыборкаЗапроса = РезультатОперанды.Выбрать();
	Пока ВыборкаЗапроса.Следующий() Цикл
		НСтр = тПоказателиОперанды.Добавить();
		ЗаполнитьЗначенияСвойств(НСтр,ВыборкаЗапроса);
	КонецЦикла;
	
	// Добавим аналитики и ресурсы
	МаксИспользуемыхАналитик = 0;
	ЕстьЗначение = Ложь;
	ЕстьЗначениеНечисловое = Ложь;
	ЕстьАналитикаВалюта = Ложь;
	ВыборкаЗапроса = ПакетРезультатов.Получить(ПакетРезультатов.Количество()-2).Выбрать();
	Если ВыборкаЗапроса.Следующий() Тогда
		МаксИспользуемыхАналитик = ВыборкаЗапроса.МаксИспользуемыхАналитик;
		Для Сч = СтруктураРасчетаПоказателей.МаксКлючевыхАналитик+1 По МаксИспользуемыхАналитик Цикл
			НСтр					= тИспользуемыеАналитики.Добавить();
			НСтр.УровеньРасчета		= 0;
			НСтр.Поле				= "Аналитика" + Сч;
		КонецЦикла;
		Если ВыборкаЗапроса.ЕстьАналитикаВалюта Тогда
			НСтр					= тИспользуемыеАналитики.Добавить();
			НСтр.УровеньРасчета		= 0;
			НСтр.Поле				= "АналитикаВалюта";
			ЕстьАналитикаВалюта		= Истина;
		КонецЕсли;
		Если ВыборкаЗапроса.ЕстьЧисловойПоказатель Тогда
			НСтр = тИспользуемыеРесурсы.Добавить();
			НСтр.УровеньРасчета 	= 0;
			НСтр.Поле 				= "Значение";
			НСтр.Суммируется 		= Истина;
			НСтр.ВыводитсяВОтчет 	= Истина;
			ЕстьЗначение			= Истина;
		КонецЕсли;
		Если ВыборкаЗапроса.ЕстьНечисловойПоказатель Тогда
			НСтр = тИспользуемыеРесурсы.Добавить();
			НСтр.УровеньРасчета 	= 0;
			НСтр.Поле 				= "ЗначениеНечисловое";
			НСтр.Суммируется 		= Ложь;
			НСтр.ВыводитсяВОтчет 	= Истина;
			ЕстьЗначениеНечисловое	= Истина;
		КонецЕсли;
		СтруктураРасчетаПоказателей.Вставить("ЕстьВидКурсаЗначениеУказанноеВДокументе",ВыборкаЗапроса.ЕстьВидКурсаЗначениеУказанноеВДокументе);
		СтруктураРасчетаПоказателей.Вставить("ЕстьВидКурсаКурсНаМоментНачисления",ВыборкаЗапроса.ЕстьВидКурсаКурсНаМоментНачисления);
		СтруктураРасчетаПоказателей.Вставить("ЕстьВидКурсаПрочее",ВыборкаЗапроса.ЕстьВидКурсаПрочее);
	КонецЕсли;
	
	// Получим данные для всех показателей
	ДанныеДляРасчета = ПолучитьОперандыПоПравилуОбработки(ПравилоОбработки);
	ДанныеВидаОтчета = ДанныеДляРасчета.ДанныеВидаОтчета.Получить(0);
	
	СтруктураРасчетаПоказателей.Вставить("глТаблицаПересчетаПоказателей",глТаблицаПересчетаПоказателей);
	СтруктураРасчетаПоказателей.Вставить("тПоказателиОперанды",тПоказателиОперанды);
	СтруктураРасчетаПоказателей.Вставить("тИспользуемыеРесурсы",тИспользуемыеРесурсы);
	СтруктураРасчетаПоказателей.Вставить("тИспользуемыеАналитики",тИспользуемыеАналитики);
	СтруктураРасчетаПоказателей.Вставить("тРасшифровкаГруппОтборов",тРасшифровкаГруппОтборов);
	СтруктураРасчетаПоказателей.Вставить("МаксИспользуемыхАналитик",ДанныеВидаОтчета.МаксАналитикПоказателя + ДанныеВидаОтчета.МаксКлючевыхАналитик);
	СтруктураРасчетаПоказателей.Вставить("ЕстьАналитикаВалюта",ДанныеВидаОтчета.ЕстьАналитикаВалюта);
	СтруктураРасчетаПоказателей.Вставить("ЕстьЗначение",ЕстьЗначение);
	СтруктураРасчетаПоказателей.Вставить("ЕстьЗначениеНечисловое",ЕстьЗначениеНечисловое);
	СтруктураРасчетаПоказателей.Вставить("ЕстьЗначениеВалюта",ДанныеВидаОтчета.ЕстьЗначениеВалюта);
	
	// Добавим таблицу измененных показателей
	СоздатьТаблицуПоказателейОперандов(СтруктураРасчетаПоказателей);
	
	// Получим исходные данные потребителей
	ПодготовитьТаблицуИсходныхЗначенийПотребителей(СтруктураРасчетаПоказателей, , Истина);
	
	// Получим таблицы с дельтами, относительно исходных данных
	ПодготовитьТаблицуДляРасчетаОтклонений(СтруктураРасчетаПоказателей);
	
	// Запишем данные в лог измененных показателей
 	ДобавитьВЛогТаблицуИзмененныхПоказателей(СтруктураРасчетаПоказателей, ОбъектРасчета.ДополнительныеВалюты.Количество() > 0);

	Возврат глТаблицаПересчетаПоказателей;
	
КонецФункции	

// Функция - Получить структуру расчета показателей по автоматической консолидации
//
// Параметры:
//  ОбъектРасчета		 - Структура - Структура с данными для расчета 
//  МассивОрганизаций	 - Массив - Массив организаций, участвующих в консолидации
// 
// Возвращаемое значение:
//   - ТаблицаЗначений - Таблица со строками этапов расчета показателей по правилу расчета
//
Функция ПолучитьТаблицуРасчетаПоказателейПоАвтоматическойКонсолидации(ОбъектРасчета, МассивОрганизаций) Экспорт
	
	/////////////////////////////////////////////////////////////////
	// Сформируем структура расчета для построения текстов запросов
	
	СтруктураРасчетаПоказателей = ПолучитьСтруктуруРасчетаПоказателей();
	МаксИспользуемыхАналитик	= 0;
	ВидОтчета					= ОбъектРасчета.ВидОтчета;
	МаксАналитикПоказателя		= ОбъектРасчета.МаксАналитикПоказателя;
	ПравилоОбработки			= ОбъектРасчета.ПравилоОбработки;
	
	// Инициализируем служебные таблицы
	тСлужебныеТаблицы 					= ПолучитьОписаниеСлужебныхТаблиц();	
	глТаблицаПересчетаПоказателей       = тСлужебныеТаблицы.глТаблицаПересчетаПоказателей;  
	тПоказателиОперанды                 = тСлужебныеТаблицы.тПоказателиОперанды; 	
	тИспользуемыеРесурсы                = тСлужебныеТаблицы.тИспользуемыеРесурсы;  
	тИспользуемыеАналитики              = тСлужебныеТаблицы.тИспользуемыеАналитики; 
	тРасшифровкаГруппОтборов			= тСлужебныеТаблицы.тРасшифровкаГруппОтборов; 	
	
	// Добавим ресурс "Значение"
	НСтр = тИспользуемыеРесурсы.Добавить();
	НСтр.УровеньРасчета = 1;
	НСтр.Поле = "Значение";
	НСтр.Суммируется = Истина;
	НСтр.ВыводитсяВОтчет = Истина;
	
	// Добавим данные по аналитикам вида отчета	
	ДанныеВидаОтчета = ДанныеВидаОтчета(ВидОтчета);
	СтруктураРасчетаПоказателей.ДанныеВидаОтчета = ДанныеВидаОтчета;
	СтруктураРасчетаПоказателей.МаксКлючевыхАналитик = ДанныеВидаОтчета.МаксКлючевыхАналитик;
	
	// Получим показатели с индексами регистров
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ВидОтчета",ВидОтчета);
	Запрос.УстановитьПараметр("МаксКлючевыхАналитик",СтруктураРасчетаПоказателей.МаксКлючевыхАналитик);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПоказателиОтчетов.Ссылка КАК Потребитель,
	|	ЕСТЬNULL(ПоказателиОтчетов.ГруппаРаскрытия.ЧислоАналитик, 0) + &МаксКлючевыхАналитик КАК ИндексРегистраПотребителя,
	|	ЕСТЬNULL(ПоказателиОтчетов.ГруппаРаскрытия.Валютная, ЛОЖЬ) КАК ЕстьАналитикаВалюта
	|ПОМЕСТИТЬ втПоказателиОтчетов
	|ИЗ
	|	Справочник.ПоказателиОтчетов КАК ПоказателиОтчетов
	|ГДЕ
	|	ПоказателиОтчетов.Владелец = &ВидОтчета
	|	И ПоказателиОтчетов.ЧисловойПоказатель
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ПоказателиОтчетов.ИндексРегистраПотребителя) КАК МаксИспользуемыхАналитик,
	|	МАКСИМУМ(ПоказателиОтчетов.ЕстьАналитикаВалюта) КАК ЕстьАналитикаВалюта
	|ИЗ
	|	втПоказателиОтчетов КАК ПоказателиОтчетов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втПоказателиОтчетов.Потребитель КАК Потребитель,
	|	втПоказателиОтчетов.ИндексРегистраПотребителя КАК ИндексРегистраПотребителя
	|ИЗ
	|	втПоказателиОтчетов КАК втПоказателиОтчетов";
	
	ПакетРезультатов = Запрос.ВыполнитьПакет();
	
	ВыборкаЗапроса = ПакетРезультатов.Получить(2).Выбрать();
	Пока ВыборкаЗапроса.Следующий() Цикл
		НСтр = тПоказателиОперанды.Добавить();
		ЗаполнитьЗначенияСвойств(НСтр,ВыборкаЗапроса);
	КонецЦикла;
	
	// Добавим аналитики
	ЕстьАналитикаВалюта = Ложь;
	ВыборкаЗапроса = ПакетРезультатов.Получить(1).Выбрать();
	Если ВыборкаЗапроса.Следующий() Тогда
		МаксИспользуемыхАналитик = ВыборкаЗапроса.МаксИспользуемыхАналитик;
		Если ВыборкаЗапроса.ЕстьАналитикаВалюта Тогда
			НСтр				= тИспользуемыеАналитики.Добавить();
			НСтр.УровеньРасчета	= 1;
			НСтр.Поле			= "АналитикаВалюта";
			ЕстьАналитикаВалюта	= Истина;
		КонецЕсли;
	КонецЕсли;
	
	// Получим данные для всех показателей
	ДанныеДляРасчета = ПолучитьОперандыПоПравилуОбработки(ПравилоОбработки);
	ДанныеВидаОтчета = ДанныеДляРасчета.ДанныеВидаОтчета.Получить(0);
	
	СтруктураРасчетаПоказателей.Вставить("глТаблицаПересчетаПоказателей",глТаблицаПересчетаПоказателей);
	СтруктураРасчетаПоказателей.Вставить("тПоказателиОперанды",тПоказателиОперанды);
	СтруктураРасчетаПоказателей.Вставить("тИспользуемыеРесурсы",тИспользуемыеРесурсы);
	СтруктураРасчетаПоказателей.Вставить("тИспользуемыеАналитики",тИспользуемыеАналитики);
	СтруктураРасчетаПоказателей.Вставить("тРасшифровкаГруппОтборов",тРасшифровкаГруппОтборов);
	СтруктураРасчетаПоказателей.Вставить("МаксАналитикПоказателя",МаксАналитикПоказателя);
	СтруктураРасчетаПоказателей.Вставить("МаксИспользуемыхАналитик",ДанныеВидаОтчета.МаксАналитикПоказателя + ДанныеВидаОтчета.МаксКлючевыхАналитик);
	СтруктураРасчетаПоказателей.Вставить("ЕстьАналитикаВалюта",ДанныеВидаОтчета.ЕстьАналитикаВалюта);
	СтруктураРасчетаПоказателей.Вставить("ЕстьЗначениеВалюта",ДанныеВидаОтчета.ЕстьЗначениеВалюта);
	СтруктураРасчетаПоказателей.Вставить("МаксУровеньРасчета",1);
	
	// Сформируем запрос подъема значений показателей
	СоздатьТаблицуПоказателейОперандов(СтруктураРасчетаПоказателей);
	ПодготовитьТаблицуИсходныхЗначенийПотребителей(СтруктураРасчетаПоказателей,МассивОрганизаций);
	ПодготовитьТаблицуИсходныхЗначенийПотребителей(СтруктураРасчетаПоказателей);
	ПодготовитьТаблицуДляРасчетаОтклонений(СтруктураРасчетаПоказателей);

	Возврат глТаблицаПересчетаПоказателей;
	
КонецФункции

#КонецОбласти

#КонецОбласти


#Область ХранилищаПараметрическойНайстройки

Функция ПолучитьДанныеИзХранилищаПараметрическойНастройки(ПравилоОбработки, Уровень)

	// Проверим, есть ли сохраненные рассчитанные показатели
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ХранилищаПараметрическойНастройкиРасширенный.ДатаАктуальности КАК ДатаАктуальности
		|ИЗ
		|	РегистрСведений.ХранилищаПараметрическойНастройкиРасширенный КАК ХранилищаПараметрическойНастройкиРасширенный
		|ГДЕ
		|	ХранилищаПараметрическойНастройкиРасширенный.ПравилоОбработки = &ПравилоОбработки
		|	И ХранилищаПараметрическойНастройкиРасширенный.Уровень = &Уровень";
		
	Запрос.УстановитьПараметр("ПравилоОбработки", ПравилоОбработки);
	Запрос.УстановитьПараметр("Уровень", Уровень);
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
		
	// Получим сохраненные рассчитанные показатели
	ВыборкаИзЗапроса = РезультатЗапроса.Выбрать();
	ВыборкаИзЗапроса.Следующий();
	
	Возврат КэшируемыеПроцедурыУХ.ПолучитьДанныеПараметрическойНастройкиРасширенный(ПравилоОбработки,Уровень,ВыборкаИзЗапроса.ДатаАктуальности);
	
КонецФункции

Процедура СохранитьДанныеВХранилищеПараметрическойНастройки(ПравилоОбработки, Уровень, тПересчетаПоказателей)

	// Сохраним сформированные правила расчета показателей в регистр сведений	
	НаборЗаписей = РегистрыСведений.ХранилищаПараметрическойНастройкиРасширенный.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.ПравилоОбработки.Установить(ПравилоОбработки);
	НаборЗаписей.Отбор.Уровень.Установить(Уровень);
	
	НоваяСтрока = НаборЗаписей.Добавить();
	НоваяСтрока.ПравилоОбработки 				= ПравилоОбработки;
	НоваяСтрока.Уровень							= Уровень;
	НоваяСтрока.ДанныеПараметрическойНастройки 	= Новый ХранилищеЗначения(тПересчетаПоказателей, Новый СжатиеДанных());
	НоваяСтрока.ДатаАктуальности 				= ТекущаяДатаСеанса();
	
	НаборЗаписей.Записать();	
		
КонецПроцедуры

#КонецОбласти


#Область ПодъемДанныхДляРасчетаПараметрики

////////////////////////////////////////////////////////////////////////////////
// Получение данных для расчета параметрики
//  
////////////////////////////////////////////////////////////////////////////////

Функция РассчитатьОперандыПоПравилуОбработки(ПравилоОбработки)
	
	// Получим данные источников
	#Область Запрос
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("НазначениеРасчетов", ПравилоОбработки);
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПроцедурыРасчетов.ПотребительРасчета КАК ПотребительРасчета,
		|	ПроцедурыРасчетов.Процедура КАК Процедура,
		|	ПроцедурыРасчетов.ПроизвольныйКод КАК ПроизвольныйКод
		|ПОМЕСТИТЬ втПроцедурыРасчетов
		|ИЗ
		|	РегистрСведений.ПроцедурыРасчетов КАК ПроцедурыРасчетов
		|ГДЕ
		|	ПроцедурыРасчетов.НазначениеРасчетов = &НазначениеРасчетов
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ИсточникиДанныхДляРасчетов.ПоказательТекущегоОтчета КАК ПоказательТекущегоОтчета,
		|	ВЫРАЗИТЬ(ИсточникиДанныхДляРасчетов.Код КАК СТРОКА(50)) КАК Код,
		|	ИсточникиДанныхДляРасчетов.Ссылка КАК Ссылка,
		|	ИсточникиДанныхДляРасчетов.ПотребительРасчета КАК ПотребительРасчета,
		|	ИсточникиДанныхДляРасчетов.ПоказательОтбор КАК ПоказательОтбор,
		|	ИсточникиДанныхДляРасчетов.СпособПолучения КАК СпособПолучения,
		|	ИсточникиДанныхДляРасчетов.РегистрБД КАК РегистрБД,
		|	ИсточникиДанныхДляРасчетов.РесурсРегистра КАК РесурсРегистра,
		|	ИсточникиДанныхДляРасчетов.ОсновнаяТаблицаРегистра КАК ОсновнаяТаблицаРегистра,
		|	ИсточникиДанныхДляРасчетов.Счет.СчетСсылка КАК Счет,
		|	ИсточникиДанныхДляРасчетов.КоррСчет.СчетСсылка КАК КоррСчет,
		|	ИсточникиДанныхДляРасчетов.ВидСреза КАК ВидСреза,
		|	ИсточникиДанныхДляРасчетов.ОбъектБД КАК ОбъектБД,
		|	ИсточникиДанныхДляРасчетов.ТабличнаяЧастьБД КАК ТабличнаяЧастьБД,
		|	ИсточникиДанныхДляРасчетов.ТипЗначения КАК ТипЗначения,
		|	ИсточникиДанныхДляРасчетов.ИспользоватьМногопериодныйКонтекст КАК ИспользоватьМногопериодныйКонтекст,
		|	ВЫБОР
		|		КОГДА ИсточникиДанныхДляРасчетов.СпособПолучения = ЗНАЧЕНИЕ(Перечисление.СпособыПолученияОперандов.ВнутренниеДанныеПроизвольныйЗапрос)
		|				ИЛИ ИсточникиДанныхДляРасчетов.СпособПолучения = ЗНАЧЕНИЕ(Перечисление.СпособыПолученияОперандов.ВнешниеДанныеПроизвольныйЗапрос)
		|			ТОГДА ИсточникиДанныхДляРасчетов.ТекстЗапросаМодуля
		|		ИНАЧЕ """"
		|	КОНЕЦ КАК ТекстЗапросаМодуля
		|ПОМЕСТИТЬ втИсточникиДанныхДляРасчетов
		|ИЗ
		|	Справочник.ИсточникиДанныхДляРасчетов КАК ИсточникиДанныхДляРасчетов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втПроцедурыРасчетов КАК ПроцедурыРасчетов
		|		ПО ИсточникиДанныхДляРасчетов.ПотребительРасчета = ПроцедурыРасчетов.ПотребительРасчета
		|ГДЕ
		|	НЕ ИсточникиДанныхДляРасчетов.ПометкаУдаления
		|	И НЕ ИсточникиДанныхДляРасчетов.НеИспользуется
		|	И ИсточникиДанныхДляРасчетов.СпособИспользования = ЗНАЧЕНИЕ(Перечисление.СпособыИспользованияОперандов.ДляФормулРасчета)
		|	И ИсточникиДанныхДляРасчетов.НазначениеРасчетов = &НазначениеРасчетов
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ПотребителиРасчета.Ссылка КАК ПотребительРасчета,
		|	ПотребителиРасчета.Ссылка.Представление КАК ПотребительПредставление,
		|	ПотребителиРасчета.ТипЗначения КАК ТипЗначения,
		|	ПотребителиРасчета.Владелец КАК ВидОтчетаПотребителя,
		|	ПотребителиРасчета.Владелец.Представление КАК ВидОтчетаПотребителяПредставление,
		|	ПотребителиРасчета.ПересчитыватьВалютнуюСумму КАК ПересчитыватьВалютнуюСумму,
		|	ПотребителиРасчета.ВидИтога КАК ВидИтога,
		|	ПотребителиРасчета.СпособРасчетаИтогаПоПериоду КАК ВидИтогаПоПериоду,
		|	ПотребителиРасчета.ВидКурса КАК ВидКурса,
		|	ПотребителиРасчета.НеФинансовый КАК НеФинансовый,
		|	ЕСТЬNULL(ПотребителиРасчета.ГруппаРаскрытия.ЧислоАналитик, 0) КАК ЧислоАналитик,
		|	ВЫБОР
		|		КОГДА ПотребителиРасчета.ГруппаРаскрытия.ВидАналитикиВалютаДт ЕСТЬ NULL
		|			ТОГДА ЛОЖЬ
		|		КОГДА ПотребителиРасчета.ГруппаРаскрытия.ВидАналитикиВалютаДт = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ КАК ЕстьАналитикаВалюта,
		|	ИсточникиДанныхДляРасчетов.ПоказательТекущегоОтчета КАК ПоказательТекущегоОтчета,
		|	ИсточникиДанныхДляРасчетов.Код КАК Код,
		|	ИсточникиДанныхДляРасчетов.Ссылка КАК Ссылка,
		|	ИсточникиДанныхДляРасчетов.ПоказательОтбор КАК ПоказательОтбор,
		|	ИсточникиДанныхДляРасчетов.СпособПолучения КАК СпособПолучения,
		|	ИсточникиДанныхДляРасчетов.РегистрБД КАК РегистрБД,
		|	ИсточникиДанныхДляРасчетов.РесурсРегистра КАК РесурсРегистра,
		|	ИсточникиДанныхДляРасчетов.ОсновнаяТаблицаРегистра КАК ОсновнаяТаблицаРегистра,
		|	ИсточникиДанныхДляРасчетов.Счет КАК Счет,
		|	ИсточникиДанныхДляРасчетов.КоррСчет КАК КоррСчет,
		|	ИсточникиДанныхДляРасчетов.ВидСреза КАК ВидСреза,
		|	ИсточникиДанныхДляРасчетов.ОбъектБД КАК ОбъектБД,
		|	ИсточникиДанныхДляРасчетов.ТабличнаяЧастьБД КАК ТабличнаяЧастьБД,
		|	ИсточникиДанныхДляРасчетов.ИспользоватьМногопериодныйКонтекст КАК ИспользоватьМногопериодныйКонтекст,
		|	ИсточникиДанныхДляРасчетов.ТекстЗапросаМодуля КАК ТекстЗапросаМодуля,
		|	ИсточникиДанныхДляРасчетов.ПоказательОтбор.Владелец КАК ВидОтчетаПоказателя,
		|	ВЫБОР 
		|		КОГДА ИсточникиДанныхДляРасчетов.ПоказательОтбор = ЗНАЧЕНИЕ(Справочник.ПоказателиОтчетов.ПустаяСсылка) ТОГДА
		|			ИсточникиДанныхДляРасчетов.ТипЗначения
		|		ИНАЧЕ
		|			ИсточникиДанныхДляРасчетов.ПоказательОтбор.ТипЗначения
		|	КОНЕЦ КАК ТипЗначенияПоказателя,
		|	ЕСТЬNULL(ИсточникиДанныхДляРасчетов.ПоказательОтбор.ГруппаРаскрытия.ЧислоАналитик, 0) КАК ЧислоАналитикПоказателя,
		|	ВЫБОР
		|		КОГДА ИсточникиДанныхДляРасчетов.ПоказательОтбор.ГруппаРаскрытия.ВидАналитикиВалютаДт ЕСТЬ NULL
		|			ТОГДА ЛОЖЬ
		|		КОГДА ИсточникиДанныхДляРасчетов.ПоказательОтбор.ГруппаРаскрытия.ВидАналитикиВалютаДт = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ КАК ЕстьАналитикаВалютаПоказателя,
		|	ВЫБОР
		|		КОГДА ИсточникиДанныхДляРасчетов.ПоказательОтбор.Владелец.ВидАналитики1 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ + ВЫБОР
		|		КОГДА ИсточникиДанныхДляРасчетов.ПоказательОтбор.Владелец.ВидАналитики2 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ + ВЫБОР
		|		КОГДА ИсточникиДанныхДляРасчетов.ПоказательОтбор.Владелец.ВидАналитики3 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ + ВЫБОР
		|		КОГДА ИсточникиДанныхДляРасчетов.ПоказательОтбор.Владелец.ВидАналитики4 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ + ВЫБОР
		|		КОГДА ИсточникиДанныхДляРасчетов.ПоказательОтбор.Владелец.ВидАналитики5 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ + ВЫБОР
		|		КОГДА ИсточникиДанныхДляРасчетов.ПоказательОтбор.Владелец.ВидАналитики6 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ КАК МаксКлючевыхАналитикПоказателя
		|ПОМЕСТИТЬ втДанныеДляРасчета
		|ИЗ
		|	Справочник.ПоказателиОтчетов КАК ПотребителиРасчета
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втПроцедурыРасчетов КАК ПроцедурыРасчетов
		|		ПО (ПроцедурыРасчетов.ПотребительРасчета = ПотребителиРасчета.Ссылка)
		|		ЛЕВОЕ СОЕДИНЕНИЕ втИсточникиДанныхДляРасчетов КАК ИсточникиДанныхДляРасчетов
		|		ПО (ИсточникиДанныхДляРасчетов.ПотребительРасчета = ПотребителиРасчета.Ссылка)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДанныеДляРасчета.Счет КАК Счет
		|ПОМЕСТИТЬ втВсеСчета
		|ИЗ
		|	втДанныеДляРасчета КАК ДанныеДляРасчета
		|ГДЕ
		|	НЕ ДанныеДляРасчета.Счет ЕСТЬ NULL
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДанныеДляРасчета.КоррСчет
		|ИЗ
		|	втДанныеДляРасчета КАК ДанныеДляРасчета
		|ГДЕ
		|	НЕ ДанныеДляРасчета.КоррСчет ЕСТЬ NULL
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ИсточникиДанныхДляРасчетовПравилаИспользованияПолейЗапроса.Ссылка КАК Ссылка,
		|	ИсточникиДанныхДляРасчетовПравилаИспользованияПолейЗапроса.Поле КАК Поле,
		|	ИсточникиДанныхДляРасчетовПравилаИспользованияПолейЗапроса.Синоним КАК Синоним,
		|	ИсточникиДанныхДляРасчетовПравилаИспользованияПолейЗапроса.КодАналитики КАК КодАналитики,
		|	ИсточникиДанныхДляРасчетовПравилаИспользованияПолейЗапроса.СпособЗаполнения КАК СпособЗаполнения,
		|	ИсточникиДанныхДляРасчетовПравилаИспользованияПолейЗапроса.ФиксированноеЗначение КАК ФиксированноеЗначение,
		|	ИсточникиДанныхДляРасчетовПравилаИспользованияПолейЗапроса.НастройкаСоответствия КАК НастройкаСоответствия
		|ПОМЕСТИТЬ втПравилаИспользованияПолейЗапроса
		|ИЗ
		|	втИсточникиДанныхДляРасчетов КАК ИсточникиДанныхДляРасчетов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ИсточникиДанныхДляРасчетов.ПравилаИспользованияПолейЗапроса КАК ИсточникиДанныхДляРасчетовПравилаИспользованияПолейЗапроса
		|		ПО ИсточникиДанныхДляРасчетов.Ссылка = ИсточникиДанныхДляРасчетовПравилаИспользованияПолейЗапроса.Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ИсточникиДанныхДляРасчетов.ПоказательОтбор КАК ПоказательОперанд,
		|	ИсточникиДанныхДляРасчетов.Код КАК КодВФормуле,
		|	ИсточникиДанныхДляРасчетовТаблицаПараметровОтбораБД.Ссылка КАК Ссылка,
		|	ИсточникиДанныхДляРасчетовТаблицаПараметровОтбораБД.ПолеБД КАК ПолеБД,
		|	ИсточникиДанныхДляРасчетовТаблицаПараметровОтбораБД.ИмяПараметра КАК ИмяПараметра,
		|	ИсточникиДанныхДляРасчетовТаблицаПараметровОтбораБД.СпособВычисленияПараметра КАК СпособВычисленияПараметра,
		|	ИсточникиДанныхДляРасчетовТаблицаПараметровОтбораБД.ИдентификаторСтроки КАК ИдентификаторСтроки,
		|	ИсточникиДанныхДляРасчетовТаблицаПараметровОтбораБД.ИдентификаторРодителя КАК ИдентификаторРодителя,
		|	ИсточникиДанныхДляРасчетовТаблицаПараметровОтбораБД.ТекстМодуля КАК ТекстМодуля,
		|	ИсточникиДанныхДляРасчетовТаблицаПараметровОтбораБД.ТипЗначенияАналитики КАК ТипЗначенияАналитики
		|ПОМЕСТИТЬ втПараметрыОтбораБД
		|ИЗ
		|	втИсточникиДанныхДляРасчетов КАК ИсточникиДанныхДляРасчетов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ИсточникиДанныхДляРасчетов.ТаблицаПараметровОтбораБД КАК ИсточникиДанныхДляРасчетовТаблицаПараметровОтбораБД
		|		ПО ИсточникиДанныхДляРасчетов.Ссылка = ИсточникиДанныхДляРасчетовТаблицаПараметровОтбораБД.Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ИсточникиДанныхДляРасчетовУточненияСпособовОпределения.Ссылка КАК Ссылка,
		|	ИсточникиДанныхДляРасчетовУточненияСпособовОпределения.ПолеБД КАК ПолеБД,
		|	ИсточникиДанныхДляРасчетовУточненияСпособовОпределения.ИмяПараметра КАК ИмяПараметра,
		|	ИсточникиДанныхДляРасчетовУточненияСпособовОпределения.Тип КАК Тип,
		|	ИсточникиДанныхДляРасчетовУточненияСпособовОпределения.Представление КАК Представление,
		|	ИсточникиДанныхДляРасчетовУточненияСпособовОпределения.Значение КАК Значение
		|ПОМЕСТИТЬ втУточненияСпособовОпределения
		|ИЗ
		|	втИсточникиДанныхДляРасчетов КАК ИсточникиДанныхДляРасчетов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ИсточникиДанныхДляРасчетов.УточненияСпособовОпределения КАК ИсточникиДанныхДляРасчетовУточненияСпособовОпределения
		|		ПО ИсточникиДанныхДляРасчетов.Ссылка = ИсточникиДанныхДляРасчетовУточненияСпособовОпределения.Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	втУточненияСпособовОпределения.Ссылка КАК Ссылка,
		|	втУточненияСпособовОпределения.ПолеБД КАК ПолеБД,
		|	втУточненияСпособовОпределения.ИмяПараметра КАК ИмяПараметра,
		|	втУточненияСпособовОпределения.Тип КАК Тип
		|ИЗ
		|	втУточненияСпособовОпределения КАК втУточненияСпособовОпределения
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДанныеДляРасчета.ПотребительРасчета КАК ПотребительРасчета
		|ИЗ
		|	втДанныеДляРасчета КАК ДанныеДляРасчета
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втПараметрыОтбораБД КАК втПараметрыОтбораБД
		|		ПО ДанныеДляРасчета.Ссылка = втПараметрыОтбораБД.Ссылка
		|			И (втПараметрыОтбораБД.ПолеБД = ""Версия.ПериодОтчета"")
		|ГДЕ
		|	ДанныеДляРасчета.ВидОтчетаПоказателя = ДанныеДляРасчета.ВидОтчетаПотребителя
		|	И втПараметрыОтбораБД.СпособВычисленияПараметра <> ЗНАЧЕНИЕ(Перечисление.СпособыВычисленияПараметровОперандов.ПериодОтчета)
		|	И втПараметрыОтбораБД.СпособВычисленияПараметра <> ЗНАЧЕНИЕ(Перечисление.СпособыВычисленияПараметровОперандов.ВышестоящийПериод)
		|	И втПараметрыОтбораБД.СпособВычисленияПараметра <> ЗНАЧЕНИЕ(Перечисление.СпособыВычисленияПараметровОперандов.АналогичныйПериодПредыдущегоГода)
		|	И втПараметрыОтбораБД.СпособВычисленияПараметра <> ЗНАЧЕНИЕ(Перечисление.СпособыВычисленияПараметровОперандов.АналогичныйПериодГодаСоСдвигом)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	втПравилаИспользованияПолейЗапроса.Ссылка КАК Ссылка
		|ИЗ
		|	втПравилаИспользованияПолейЗапроса КАК втПравилаИспользованияПолейЗапроса
		|ГДЕ
		|	втПравилаИспользованияПолейЗапроса.СпособЗаполнения = ЗНАЧЕНИЕ(Перечисление.СпособыЗаполненияПолейИсточника.ПолеДругогоИсточникаДанных)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВидыОтчетов.Ссылка КАК ВидОтчета,
		|	ВидыОтчетов.РазделениеПоПроектам КАК РазделениеПоПроектам,
		|	ВидыОтчетов.СохранятьИсториюИзменений КАК СохранятьИсториюИзменений,
		|	ВЫБОР
		|		КОГДА ВидыОтчетов.ВидАналитики1 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ + ВЫБОР
		|		КОГДА ВидыОтчетов.ВидАналитики2 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ + ВЫБОР
		|		КОГДА ВидыОтчетов.ВидАналитики3 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ + ВЫБОР
		|		КОГДА ВидыОтчетов.ВидАналитики4 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ + ВЫБОР
		|		КОГДА ВидыОтчетов.ВидАналитики5 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ + ВЫБОР
		|		КОГДА ВидыОтчетов.ВидАналитики6 = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоКорпоративные.ПустаяСсылка)
		|			ТОГДА 0
		|		ИНАЧЕ 1
		|	КОНЕЦ КАК МаксКлючевыхАналитик,
		|	ЕСТЬNULL(ВложенныйЗапрос.МаксАналитикПоказателя, 0) КАК МаксАналитикПоказателя,
		|	ЕСТЬNULL(ВложенныйЗапрос.ЕстьАналитикаВалюта, 0) КАК ЕстьАналитикаВалюта,
		|	ЕСТЬNULL(ВложенныйЗапрос.ЕстьЗначениеВалюта, 0) КАК ЕстьЗначениеВалюта
		|ИЗ
		|	Справочник.ВидыОтчетов КАК ВидыОтчетов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПравилаОбработки КАК ПравилаОбработки
		|		ПО (ПравилаОбработки.Владелец = ВидыОтчетов.Ссылка)
		|			И (ПравилаОбработки.Ссылка = &НазначениеРасчетов)
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			МАКСИМУМ(ДанныеДляРасчета.ЧислоАналитик) КАК МаксАналитикПоказателя,
		|			МАКСИМУМ(ДанныеДляРасчета.ЕстьАналитикаВалюта) КАК ЕстьАналитикаВалюта,
		|			МАКСИМУМ(ДанныеДляРасчета.ПересчитыватьВалютнуюСумму) КАК ЕстьЗначениеВалюта
		|		ИЗ
		|			втДанныеДляРасчета КАК ДанныеДляРасчета) КАК ВложенныйЗапрос
		|		ПО (ИСТИНА)";
	#КонецОбласти	
		
	РезультатЗапроса = Запрос.ВыполнитьПакетСПромежуточнымиДанными();
	
	СтруктураВозврата = Новый Структура();
	
	// Данные вида отчета
	ДанныеВидаОтчета = РезультатЗапроса.Получить(РезультатЗапроса.Количество()-1).Выгрузить();
	МаксКлючевыхАналитик = ДанныеВидаОтчета.Получить(0).МаксКлючевыхАналитик;
	СтруктураВозврата.Вставить("ДанныеВидаОтчета",ДанныеВидаОтчета);
	
	// Формулы расчета с обработкой
	тПроцедурыРасчетов = РезультатЗапроса.Получить(0).Выгрузить();
	тПроцедурыРасчетов.Индексы.Добавить("ПотребительРасчета");
	
	// Данные источников для расчетов
	тДанныеДляРасчетов = РезультатЗапроса.Получить(2).Выгрузить();
	тДанныеДляРасчетов.Индексы.Добавить("ПотребительРасчета");
	тДанныеДляРасчетов.Колонки.Добавить("УровеньОперанда");
	тДанныеДляРасчетов.Колонки.Добавить("ИндексРегистраОперанда");
	тДанныеДляРасчетов.Колонки.Добавить("ИндексРегистраПотребителя");
	тДанныеДляРасчетов.Колонки.Добавить("ВариантРасчета");
	тДанныеДляРасчетов.Колонки.Добавить("Процедура");
	Для Каждого СтрокаТаблицы Из тДанныеДляРасчетов Цикл
		
		// Код без пробелов
		СтрокаТаблицы.Код = СокрЛП(СтрокаТаблицы.Код);
		
		// Индекс регистра операнда
		Если СтрокаТаблицы.ТипЗначенияПоказателя <> Перечисления.ТипыЗначенийПоказателейОтчетов.Число  Тогда
			// -11 - это нечисловая синтетика (Итоговое значение = ИСТИНА), -1  - нечисловая аналитика (Итоговое значение = ЛОЖЬ)
			СтрокаТаблицы.ИндексРегистраОперанда = ?(СтрокаТаблицы.ЧислоАналитикПоказателя > 0,-1,-11);		
		ИначеЕсли СтрокаТаблицы.ЧислоАналитикПоказателя = 0 И СтрокаТаблицы.МаксКлючевыхАналитикПоказателя = 0 И СтрокаТаблицы.ЕстьАналитикаВалютаПоказателя Тогда
			СтрокаТаблицы.ИндексРегистраОперанда = -2;
		Иначе	
			СтрокаТаблицы.ИндексРегистраОперанда = СтрокаТаблицы.ЧислоАналитикПоказателя + СтрокаТаблицы.МаксКлючевыхАналитикПоказателя;
		КонецЕсли;
		
		// Индекс регистра потребителя
		Если СтрокаТаблицы.ТипЗначения <> Перечисления.ТипыЗначенийПоказателейОтчетов.Число  Тогда
			// -11 - это нечисловая синтетика (Итоговое значение = ИСТИНА), -1  - нечисловая аналитика (Итоговое значение = ЛОЖЬ)
			СтрокаТаблицы.ИндексРегистраПотребителя = ?(СтрокаТаблицы.ЧислоАналитик > 0,-1,-11);		
		ИначеЕсли СтрокаТаблицы.ЧислоАналитик = 0 И МаксКлючевыхАналитик = 0 И СтрокаТаблицы.ЕстьАналитикаВалюта Тогда
			СтрокаТаблицы.ИндексРегистраПотребителя = -2;
		Иначе	
			СтрокаТаблицы.ИндексРегистраПотребителя = СтрокаТаблицы.ЧислоАналитик + МаксКлючевыхАналитик;
		КонецЕсли;
		
		// Вариант расчета
		текФормула = тПроцедурыРасчетов.Найти(СтрокаТаблицы.ПотребительРасчета,"ПотребительРасчета");
		Если ЗначениеЗаполнено(СтрокаТаблицы.Ссылка) Тогда
			// Есть источник данных для расчетов
			СтрокаТаблицы.ВариантРасчета = ПолучитьВариантРасчетаПоказателя(текФормула, тДанныеДляРасчетов);
		Иначе
			// Произвольный код без источников данных
			СтрокаТаблицы.ВариантРасчета = 2;
			СтрокаТаблицы.Код = СтрЗаменить(Новый УникальныйИдентификатор, "-", "");
		КонецЕсли;
		СтрокаТаблицы.Процедура = СокрЛП(текФормула.Процедура);
		
	КонецЦикла;
	СтруктураВозврата.Вставить("тДанныеДляРасчетов",тДанныеДляРасчетов);
	
	// Найдем группы счетов, если такие имеются
	Если РезультатЗапроса.Получить(3).Пустой() Тогда
		тСчетаСИерархией = Новый ТаблицаЗначений;
		тСчетаСИерархией.Колонки.Добавить("Счет");
	Иначе
		тСчетаСИерархией = ПолучитьТаблицуСчетовСИерархией(Запрос.МенеджерВременныхТаблиц);
	КонецЕсли;
	СтруктураВозврата.Вставить("тСчетаСИерархией", тСчетаСИерархией);
	
	// Правила вычисления полей запроса
	тПравилаИспользованияПолейЗапроса = РезультатЗапроса.Получить(4).Выгрузить();
	тПравилаИспользованияПолейЗапроса.Индексы.Добавить("Ссылка");
	СтруктураВозврата.Вставить("тПравилаИспользованияПолейЗапроса",тПравилаИспользованияПолейЗапроса);	
	
	// Заполним уточнения способов определения, если необходимо
	тПараметрыОтбораБД = РезультатЗапроса.Получить(5).Выгрузить();
	тПараметрыОтбораБД.Индексы.Добавить("Ссылка");
	тПараметрыОтбораБД.Колонки.Добавить("УточнениеСпособаОпределения");
	тУточненияСпособовОпределения = РезультатЗапроса.Получить(6).Выгрузить();	
	ВыборкаУСО = РезультатЗапроса.Получить(7).Выбрать();
	Пока ВыборкаУСО.Следующий() Цикл
		
		СтруктураОтбора = Новый Структура("Ссылка, ПолеБД, ИмяПараметра", 
			ВыборкаУСО.Ссылка, ВыборкаУСО.ПолеБД, ВыборкаУСО.ИмяПараметра);			
		СтрокиЗначений = тУточненияСпособовОпределения.НайтиСтроки(СтруктураОтбора);			
		
		Если ВыборкаУСО.Тип = "СписокЗначений" Тогда		
			УточнениеСпособаОпределения = Новый СписокЗначений;			
			Для Каждого Строка Из СтрокиЗначений Цикл				
				УточнениеСпособаОпределения.Добавить(Строка.Значение); 				
			КонецЦикла;			
		ИначеЕсли ВыборкаУСО.Тип="Массив" Тогда
			УточнениеСпособаОпределения=Новый Массив;			
			Для Каждого Строка Из СтрокиЗначений Цикл				
				УточнениеСпособаОпределения.Добавить(Строка.Значение);				
			КонецЦикла;			
		ИначеЕсли ВыборкаУСО.Тип="Структура" Тогда
			УточнениеСпособаОпределения=Новый Структура;			
			Для Каждого Строка Из СтрокиЗначений Цикл 				
				УточнениеСпособаОпределения.Вставить(Строка.Представление,Строка.Значение);				
			КонецЦикла;			
		Иначе			
			УточнениеСпособаОпределения=СтрокиЗначений[0].Значение;			
		КонецЕсли;

		СтрокиОтбора = тПараметрыОтбораБД.НайтиСтроки(СтруктураОтбора);
		Если СтрокиОтбора.Количество() = 0 Тогда 			
			СтрокиОтбора = тПараметрыОтбораБД.НайтиСтроки(
				Новый Структура("Ссылка, ИмяПараметра", ВыборкаУСО.Ссылка, ВыборкаУСО.ИмяПараметра));
			Если СтрокиОтбора.Количество() = 0 Тогда				
				СтрокиОтбора = тПараметрыОтбораБД.НайтиСтроки(
					Новый Структура("Ссылка, ПолеБД", ВыборкаУСО.Ссылка, ВыборкаУСО.ПолеБД));				
			КонецЕсли;			
		КонецЕсли;
				
		Для Каждого СтрокаОтбора Из СтрокиОтбора Цикл
			СтрокаОтбора.УточнениеСпособаОпределения = УточнениеСпособаОпределения;
		КонецЦикла;
			
	КонецЦикла;
	
	// Параметры отбора
	Для Каждого СтрокаТаблицы Из тПараметрыОтбораБД Цикл
		СтрокаТаблицы.ПолеБД = СтрЗаменить(СтрокаТаблицы.ПолеБД,"Версия.","");
		СтрокаТаблицы.КодВФормуле = СокрЛП(СтрокаТаблицы.КодВФормуле);
	КонецЦикла;
	СтруктураВозврата.Вставить("тПараметрыОтбораБД",тПараметрыОтбораБД);	
	
	// Показатели со сдвигом по периоду
	СтруктураВозврата.Вставить("мПоказателиСоСдвигомПоПериоду",РезультатЗапроса.Получить(8).Выгрузить().ВыгрузитьКолонку("ПотребительРасчета"));
	СтруктураВозврата.Вставить("мИсточникиСДополнениемАналитик",РезультатЗапроса.Получить(9).Выгрузить().ВыгрузитьКолонку("Ссылка"));
	
	Возврат СтруктураВозврата;
	
КонецФункции

Функция ПолучитьВариантРасчетаПоказателя(текФормула, тДанныеДляРасчетов)
	
	// 1 - Ручной расчет в коде
	// 2 - Без формул, только перенос значения показателя
	// 3 - Суммирование значений показателей
	// 4 - Расчет в запросе по значениям показателей
	
	Если текФормула.ПроизвольныйКод Тогда
		// Ручной расчет в коде
		Возврат 1;
	КонецЕсли;
	
	тОперандыТекущегоПоказателя = тДанныеДляРасчетов.НайтиСтроки(Новый Структура("ПотребительРасчета",текФормула.ПотребительРасчета));
	Если тОперандыТекущегоПоказателя.Количество() > 50 Тогда
		// Слишком много операндов для вычисления в запросе
		Возврат 1;	 
	КонецЕсли;
	
	// Получим текст процедуры без пробелов
	ТекстПроцедуры = СокрЛП(текФормула.Процедура);
	Пока СтрНайти(ТекстПроцедуры," ") > 0 Цикл
		ТекстПроцедуры = СтрЗаменить(ТекстПроцедуры, " ", "");
	КонецЦикла;
	
	// Проверим число условных операторов
	ЧислоВхождений = СтрЧислоВхождений(ТекстПроцедуры,"?");
	Если ЧислоВхождений > 10 Тогда
		// Максимальное число вложенных условных операторов превышено, используем ручной расчет в коде
		Возврат 1;
	КонецЕсли;
	
	Если тОперандыТекущегоПоказателя.Количество() = 1
		И ТекстПроцедуры = "[" + СокрЛП(тОперандыТекущегоПоказателя.Получить(0).Код) + "]" Тогда
		// Без формул, только перенос значения показателя
		Возврат 2;
	КонецЕсли;
	
	// Проверим наличие формул с нечисловыми показателями
	Для Каждого СтрОперанда Из тОперандыТекущегоПоказателя Цикл		
		Если СтрОперанда.ТипЗначенияПоказателя <> Перечисления.ТипыЗначенийПоказателейОтчетов.Число Тогда
			// Формула с датами или со строками, скорее всего в запросе вычислить не получится
			Возврат 1;
		КонецЕсли;		
	КонецЦикла;
		
	// Удалим операнды из формулы
	Для Каждого СтрОперанда Из тОперандыТекущегоПоказателя Цикл
		
		КодОперанда = "[" + СокрЛП(СтрОперанда.Код) + "]";
		
		Если СтрНайти(ТекстПроцедуры, КодОперанда, , , 2) > 0 Тогда
			// Операнд используется в формуле более 1 раза, вычисляем в запросе
			Возврат 4;
		КонецЕсли;
		
		ТекстПроцедуры = СтрЗаменить(ТекстПроцедуры,КодОперанда,"");
		
	КонецЦикла;

	ТекстПроцедуры  = СтрЗаменить(ТекстПроцедуры,"+","");
	ТекстПроцедуры  = СтрЗаменить(ТекстПроцедуры,")","");
	ТекстПроцедуры  = СтрЗаменить(ТекстПроцедуры,"(","");
	Если ПустаяСтрока(ТекстПроцедуры) Тогда
		// В формуле только операции сложения
		Возврат 3;
	КонецЕсли;
	
	// Показатель рассчитывается в запросе по значениям других показателей
	Возврат 4;
	
КонецФункции

Функция ПолучитьСчетаСИерархией(Счет)
	
	Если Не ЗначениеЗаполнено(Счет) Тогда
		Возврат Новый Массив;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Хозрасчетный.Ссылка КАК Ссылка
		|ИЗ
		|	ПланСчетов." + Счет.Метаданные().Имя + " КАК Хозрасчетный
		|ГДЕ
		|	Хозрасчетный.Ссылка В ИЕРАРХИИ(&Счет)";
	
	Запрос.УстановитьПараметр("Счет", Счет);
	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	
КонецФункции

Функция ПолучитьТаблицуСчетовСИерархией(МенеджерВременныхТаблиц)
	
	ТекстЗапроса = "";
	Для Каждого ПланСчетов Из Метаданные.ПланыСчетов Цикл
		
		Если ТекстЗапроса <> "" Тогда
			ТекстЗапроса = ТекстЗапроса + "
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|";
		КонецЕсли;
		
		ТекстЗапроса = ТекстЗапроса + СтрЗаменить( 
		"ВЫБРАТЬ
		|	ВсеСчета.Счет КАК Счет,
		|	НЕОПРЕДЕЛЕНО КАК МассивПодчиненныхСчетов
		|ИЗ
		|	втВсеСчета КАК ВсеСчета
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПланСчетов.%ИмяПланаСчетов% КАК ПланСчетов%ИмяПланаСчетов%
		|		ПО ВсеСчета.Счет = ПланСчетов%ИмяПланаСчетов%.Родитель
		|ГДЕ
		|	НЕ ПланСчетов%ИмяПланаСчетов%.Ссылка ЕСТЬ NULL", "%ИмяПланаСчетов%", ПланСчетов.Имя);
		
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст = ТекстЗапроса;
	тСчетаСИерархией = Запрос.Выполнить().Выгрузить();
	
	Для Каждого СтрСчет Из тСчетаСИерархией Цикл		
		СтрСчет.МассивПодчиненныхСчетов = ПолучитьСчетаСИерархией(СтрСчет.Счет);		
	КонецЦикла;
	
	Возврат тСчетаСИерархией;
	
КонецФункции

Функция ПолучитьОперандыПоПравилуОбработки(ПравилоОбработки)
	
	ДанныеДляРасчета = ПолучитьДанныеИзХранилищаПараметрическойНастройки(ПравилоОбработки, 0);
	Если ДанныеДляРасчета = Неопределено Тогда
		
		ДанныеДляРасчета = РассчитатьОперандыПоПравилуОбработки(ПравилоОбработки);
		
		СохранитьДанныеВХранилищеПараметрическойНастройки(ПравилоОбработки, 0, ДанныеДляРасчета);
		
	КонецЕсли;
		
	Возврат ДанныеДляРасчета;
	
КонецФункции

#КонецОбласти


#Область ПроцедурыФормированияДополненнойПараметрики

////////////////////////////////////////////////////////////////////////////////
// Процедуры расчета итоговой параметрики
//  
////////////////////////////////////////////////////////////////////////////////

Функция ПодготовитьТаблицыДляРасчетаПоказателейПоПравилуРасчета(ПравилоОбработки, тИзмененныеПоказатели=Неопределено, тЦелевыеПоказатели=Неопределено)
	
	// Данные для расчета
	ДанныеДляРасчета = ПолучитьОперандыПоПравилуОбработки(ПравилоОбработки);
	
	// Отфильтруем данные по таблице измененных показателей
	Если ТипЗнч(тИзмененныеПоказатели) = Тип("ТаблицаЗначений") Тогда
		ОтфильтроватьПоИзмененнымПоказателям(ДанныеДляРасчета, тИзмененныеПоказатели); 
	КонецЕсли;
	
	// Отфильтруем данные по таблице целевых показателей
	Если ТипЗнч(тЦелевыеПоказатели) = Тип("ТаблицаЗначений") Тогда
		ОтфильтроватьПоЦелевымПоказателям(ДанныеДляРасчета, тЦелевыеПоказатели); 
	КонецЕсли;
	
	// Получим таблицы
	тДанныеДляРасчетов 					= ДанныеДляРасчета.тДанныеДляРасчетов;
	тСчетаСИерархией					= ДанныеДляРасчета.тСчетаСИерархией;
	тПараметрыОтбораБД					= ДанныеДляРасчета.тПараметрыОтбораБД;
	тПравилаИспользованияПолейЗапроса	= ДанныеДляРасчета.тПравилаИспользованияПолейЗапроса;
	мПоказателиСоСдвигомПоПериоду 		= ДанныеДляРасчета.мПоказателиСоСдвигомПоПериоду;
	мИсточникиСДополнениемАналитик		= ДанныеДляРасчета.мИсточникиСДополнениемАналитик;
	ДанныеВидаОтчета 					= ДанныеДляРасчета.ДанныеВидаОтчета.Получить(0);
	
	// Получим описание служебных таблиц, используемых при расчете:
	СлужебныеТаблицы 								= ПолучитьОписаниеСлужебныхТаблиц();
	глТаблицаПересчетаПоказателей	 				= СлужебныеТаблицы.глТаблицаПересчетаПоказателей;
	тРасшифровкаГруппОтборов						= СлужебныеТаблицы.тРасшифровкаГруппОтборов;
	тПоказателиОперанды              				= СлужебныеТаблицы.тПоказателиОперанды;	
	тКэшИменПоказателей		            			= СлужебныеТаблицы.тКэшИменПоказателей;
	тКэшГруппОтборовПоказателей         			= СлужебныеТаблицы.тКэшГруппОтборовПоказателей;
	тИспользуемыеАналитики							= СлужебныеТаблицы.тИспользуемыеАналитики;
	тИспользуемыеРесурсы							= СлужебныеТаблицы.тИспользуемыеРесурсы;
	тВнутренниеДанные								= СлужебныеТаблицы.тВнутренниеДанные;
	тВнешниеДанные 									= СлужебныеТаблицы.тВнешниеДанные;
	тПроизвольныйКод								= СлужебныеТаблицы.тПроизвольныйКод;
	тПроизвольныеЗапросы 							= тВнешниеДанные.СкопироватьКолонки();
	мУровниСВременнымРасчетом						= Новый Массив;
	МаксУИДГруппыОтборов 							= 0;
	МаксУровеньРасчетаПоказателей 					= 0;
	МаксУровеньРучныхРасчетов						= 0;
	ЕстьИспользованиеВнешнихДанных					= Ложь;
	ЕстьВидКурсаПрочее								= Ложь;
	ЕстьВидКурсаЗначениеУказанноеВДокументе			= Ложь;
	ЕстьВидКурсаКурсНаМоментНачисления 				= Ложь;
		
	// Построим дерево расчета
	тРазличныеПоказатели = тДанныеДляРасчетов.Скопировать();
	тРазличныеПоказатели.Свернуть("ПотребительРасчета");
	Для Каждого СтрПоказателя Из тРазличныеПоказатели Цикл
	
		тОперандыТекущегоПоказателя = тДанныеДляРасчетов.НайтиСтроки(Новый Структура("ПотребительРасчета",СтрПоказателя.ПотребительРасчета));
		
		// Определяем максимальный уровень расчета показателя и уровень расчета каждого операнда
		МаксУровеньРасчета = 1;
		ЕстьДополненияАналитик = Ложь;
		ЕстьПоказательНеТекущегоОтчета = Ложь;
				
		Для Каждого СтрОперанд Из тОперандыТекущегоПоказателя Цикл
			
			Если мИсточникиСДополнениемАналитик.Найти(СтрОперанд.Ссылка) <> Неопределено Тогда
				ЕстьДополненияАналитик = Истина;
			КонецЕсли;
			
			СтрОперанд.УровеньОперанда = 0;
			
			тМаксимальныйУровень = Новый ТаблицаЗначений;
			тМаксимальныйУровень.Колонки.Добавить("тУровень");
			
			ПолучитьУровеньРасчетаОперандаРекурсивно(
				Новый ДеревоЗначений,
				СтрОперанд,
				тДанныеДляРасчетов,
				мПоказателиСоСдвигомПоПериоду,
				СтрОперанд,
				тМаксимальныйУровень);
					
			Если НЕ СтрОперанд.ПоказательТекущегоОтчета
				И НЕ (ЗначениеЗаполнено(СтрОперанд.ПоказательОтбор)
				И мПоказателиСоСдвигомПоПериоду.Найти(СтрОперанд.ПоказательОтбор) = Неопределено) 
				Тогда
				
				ЕстьПоказательНеТекущегоОтчета = Истина;
				СтрОперанд.УровеньОперанда = 1;
				
			Иначе							
				
				тМаксимальныйУровень.Сортировать("тУровень УБЫВ");
				УровеньРасчета = тМаксимальныйУровень[0].тУровень;
				
				Если УровеньРасчета > МаксУровеньРасчета Тогда
					МаксУровеньРасчета = УровеньРасчета;
				КонецЕсли;	
				
			КонецЕсли;
			
		КонецЦикла;
		
		ТекущийПериод = мПоказателиСоСдвигомПоПериоду.Найти(СтрПоказателя.ПотребительРасчета) = Неопределено;
		
		// Запоминаем максимальный уровень расчета
		МаксУровеньРасчетаПоказателей = Макс(МаксУровеньРасчета,МаксУровеньРасчетаПоказателей);
		
		Для Каждого СтрОперанд Из тОперандыТекущегоПоказателя Цикл
			
			// Запоминаем максимальный уровень ручных расчетов
			Если Не ТекущийПериод ИЛИ СтрОперанд.ВариантРасчета = 1 Тогда
				МаксУровеньРучныхРасчетов = Макс(МаксУровеньРасчета, МаксУровеньРучныхРасчетов);
			КонецЕсли;
			
			// Добавляем в таблицу операндов
			нСтр 							= тПоказателиОперанды.Добавить();
			ЗаполнитьЗначенияСвойств(нСтр, СтрОперанд);
			нСтр.ИсточникДанныхДляРасчетов	= СтрОперанд.Ссылка;
			нСтр.Потребитель 				= СтрОперанд.ПотребительРасчета;
			нСтр.ПоказательОперанд  		= СтрОперанд.ПоказательОтбор;
			нСтр.УровеньРасчетаПотребителя 	= МаксУровеньРасчета;
			нСтр.УровеньРасчетаОперанда 	= СтрОперанд.УровеньОперанда;
			нСтр.КодВФормуле         		= СтрОперанд.Код;
			нСтр.ТекущийПериод				= ТекущийПериод;
			нСтр.ТипПотребителя				= СтрОперанд.ТипЗначения;
			нСтр.ТипПоказателя				= СтрОперанд.ТипЗначенияПоказателя;
			
			нСтр.ЭтоОперандТекущегоПериода 	= мПоказателиСоСдвигомПоПериоду.Найти(нСтр.ПоказательОперанд) = Неопределено;
			
			Если ЕстьДополненияАналитик Тогда
				Если СтрНайти(нСтр.Процедура, нСтр.КодВФормуле) = 0 Тогда
					// Операнд только для дополнения аналитик
					нСтр.ДляДополненияАналитик = Истина;
				КонецЕсли;
			КонецЕсли; 
			
			// Заполним данные для пересчета значений в валюты
			Если Не СтрОперанд.НеФинансовый Тогда
				Если СтрОперанд.ВидКурса = Перечисления.ВидыКурсов.ЗначениеУказанноеВДокументе Тогда
					ЕстьВидКурсаЗначениеУказанноеВДокументе = Истина;
				ИначеЕсли СтрОперанд.ВидКурса = Перечисления.ВидыКурсов.КурсНаМоментНачисления Тогда
					ЕстьВидКурсаКурсНаМоментНачисления = Истина;
				Иначе
					ЕстьВидКурсаПрочее = Истина;
				КонецЕсли;
			КонецЕсли;
			
			// Строим таблицу отбора показателей, с учетом хеша
			тТекущихПараметровОтбораБД = тПараметрыОтбораБД.Скопировать(Новый Структура("Ссылка",СтрОперанд.Ссылка));
		
			Если СтрОперанд.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеРегистрНакопления 
			    Или СтрОперанд.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеРегистрБухгалтерии 
			    Или СтрОперанд.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеРегистрСведений 
				Или СтрОперанд.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеСправочники
				Или СтрОперанд.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеПроизвольныйЗапрос Тогда
				
				// Данные из внутренних источников
				МаксУИДГруппыОтборов = МаксУИДГруппыОтборов + 1;
				нСтр.УИДГруппыОтборов = МаксУИДГруппыОтборов;
				
				тТекущихПравилИспользованияПолейЗапроса = тПравилаИспользованияПолейЗапроса.Скопировать(Новый Структура("Ссылка",СтрОперанд.Ссылка));

				ТекстЗапроса = "";
				Если СтрОперанд.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеПроизвольныйЗапрос Тогда
					Если СтрОперанд.ИспользоватьМногопериодныйКонтекст Тогда
						// Режим использования многопериодного контекста
						ТекстЗапроса = СтрОперанд.ТекстЗапросаМодуля;
					Иначе
						// Режим выполнения запросов в цикле
						СформироватьДанныеДляРасчетаКлассическимДвижкомРасчета(
							тПроизвольныеЗапросы,
							СтрОперанд,
							тТекущихПравилИспользованияПолейЗапроса,
							тТекущихПараметровОтбораБД,
							ДанныеВидаОтчета.МаксКлючевыхАналитик);
						Продолжить;
					КонецЕсли;
				ИначеЕсли СтрОперанд.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеРегистрБухгалтерии Тогда
					Если Не ЗначениеЗаполнено(СтрОперанд.Счет) Тогда
						// Не указан счет-ссылка
						Продолжить;
					КонецЕсли;
				КонецЕсли;
					
				нСтрокаТаблицы = тВнутренниеДанные.Добавить();
				ЗаполнитьЗначенияСвойств(нСтрокаТаблицы, СтрОперанд);
				нСтрокаТаблицы.ХешОтбораПоказателей = ПолучитьХешПоОтборам(тТекущихПараметровОтбораБД);
				нСтрокаТаблицы.ТекстЗапроса = ТекстЗапроса;				
				нСтрокаТаблицы.Показатель = СтрОперанд.ПотребительРасчета;
				нСтрокаТаблицы.КорреспонденцияСчетов = ЗначениеЗаполнено(нСтрокаТаблицы.КоррСчет);
				нСтрокаТаблицы.ТаблицаПараметровОтбораБД = тТекущихПараметровОтбораБД;
				нСтрокаТаблицы.ПравилаИспользованияПолейЗапроса = тТекущихПравилИспользованияПолейЗапроса; 
				нСтрокаТаблицы.ТипЗначения = СтрОперанд.ТипЗначенияПоказателя;
				
			ИначеЕсли СтрОперанд.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнешниеДанныеРегистрНакопления
				Или СтрОперанд.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнешниеДанныеРегистрБухгалтерии
				Или СтрОперанд.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнешниеДанныеРегистрСведений
				Или СтрОперанд.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнешниеДанныеСправочники
				Или СтрОперанд.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнешниеДанныеПроизвольныйЗапрос
				Или СтрОперанд.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнешниеДанныеADO Тогда
				
				// Данные из внешних источников
				МаксУИДГруппыОтборов = МаксУИДГруппыОтборов + 1;
				нСтр.УИДГруппыОтборов = МаксУИДГруппыОтборов;
				
				ЕстьИспользованиеВнешнихДанных = Истина;
		
			ИначеЕсли СтрОперанд.СпособПолучения = Перечисления.СпособыПолученияОперандов.ПустаяСсылка() Тогда
				
				// Это операнд с произвольным кодом без источников данных для расчета
				
				МаксУИДГруппыОтборов = МаксУИДГруппыОтборов + 1;
				нСтр.УИДГруппыОтборов = МаксУИДГруппыОтборов;
				
				нСтрокаТаблицы = тПроизвольныйКод.Добавить();				
				нСтрокаТаблицы.Показатель = СтрОперанд.ПотребительРасчета;
				нСтрокаТаблицы.Процедура = СтрОперанд.Процедура;
				нСтрокаТаблицы.ТипЗначения = СтрОперанд.ТипЗначения;
				
			Иначе	
				
				// Данные из значений показателей других отчетов
				
				нСтрКэш 				= тКэшИменПоказателей.Добавить();
				нСтрКэш.КодВФормуле 	= СтрОперанд.Код;
				нСтрКэш.Показатель 		= СтрОперанд.ПоказательОтбор;
		        нСтрКэш.УровеньРасчета  = СтрОперанд.УровеньОперанда;
				нСтрКэш.ВидОтчета       = СтрОперанд.ВидОтчетаПоказателя;
				
				нСтрКэш.УИДГруппыОтборов = ПолучитьУИДДляПоказателя(тТекущихПараметровОтбораБД,
					СтрОперанд.ИндексРегистраОперанда,
					тКэшГруппОтборовПоказателей,
					МаксУИДГруппыОтборов,
					тРасшифровкаГруппОтборов,
					ТекущийПериод);
					
				нСтр.УИДГруппыОтборов = нСтрКэш.УИДГруппыОтборов;
				
				// Добавим еще раз операнд в первый уровень для расчета рекурсивно-зависимых по периоду показателей
				// Если потребитель со смещением периода, а показатель - нет. 
				Если НЕ СтрОперанд.ПоказательТекущегоОтчета
					И НЕ ТекущийПериод
					И НЕ ЕстьПоказательНеТекущегоОтчета
					И МаксУровеньРасчета > 1
					И мПоказателиСоСдвигомПоПериоду.Найти(СтрОперанд.ПоказательОтбор) = Неопределено Тогда
					
					ДопСтрока = тПоказателиОперанды.Добавить();
					ЗаполнитьЗначенияСвойств(ДопСтрока, нСтр);
					ДопСтрока.УровеньРасчетаПотребителя = 1;
					ДопСтрока.УровеньРасчетаОперанда = 1;
					ДопСтрока.ТекущийПериод = Истина;
					ДопСтрока.ВременныйРасчет = Истина;
					ДопСтрока.Процедура = ДопСтрока.КодВФормуле;
					ДопСтрока.ВариантРасчета = 2;	
					мУровниСВременнымРасчетом.Добавить(1);
						
					ДопСтрКэш = тКэшИменПоказателей.Добавить();
					ЗаполнитьЗначенияСвойств(ДопСтрКэш, нСтрКэш);
			        ДопСтрКэш.УровеньРасчета = 1; 
			
				КонецЕсли;
					
			КонецЕсли;
				
		КонецЦикла;	
	
	КонецЦикла;
	
	Если ЕстьИспользованиеВнешнихДанных Тогда
		// Добавим параметры для получения значений из внешних данных
		ЗаполнитьТаблицуВнешнихДанных(тВнешниеДанные, ПравилоОбработки);
	КонецЕсли;

	// Зададим текст трансформации полей
	ОпределитьПравилаТрансформацииПолей(
		тПоказателиОперанды,
		тПравилаИспользованияПолейЗапроса,
		тИспользуемыеАналитики,
		ДанныеВидаОтчета.МаксКлючевыхАналитик,
		мУровниСВременнымРасчетом,
		МаксУровеньРасчетаПоказателей);
		
	// Подготовим структуру для дальнейшего построения текстов запросов
	СтруктураРасчетаПоказателей = ПолучитьСтруктуруРасчетаПоказателей();
	СтруктураРасчетаПоказателей.Вставить("глТаблицаПересчетаПоказателей", глТаблицаПересчетаПоказателей);
	
	СтруктураРасчетаПоказателей.Вставить("тВнутренниеДанные", тВнутренниеДанные);
	СтруктураРасчетаПоказателей.Вставить("тСчетаСИерархией", тСчетаСИерархией);
	СтруктураРасчетаПоказателей.Вставить("тПроизвольныйКод", тПроизвольныйКод);
	СтруктураРасчетаПоказателей.Вставить("тПроизвольныеЗапросы", тПроизвольныеЗапросы);
	СтруктураРасчетаПоказателей.Вставить("тВнешниеДанные", тВнешниеДанные);
	
	СтруктураРасчетаПоказателей.Вставить("тПоказателиОперанды", тПоказателиОперанды);
	СтруктураРасчетаПоказателей.Вставить("тИспользуемыеАналитики", тИспользуемыеАналитики);
	СтруктураРасчетаПоказателей.Вставить("тИспользуемыеРесурсы", тИспользуемыеРесурсы);
	
	СтруктураРасчетаПоказателей.Вставить("тРасшифровкаГруппОтборов", тРасшифровкаГруппОтборов);
	СтруктураРасчетаПоказателей.Вставить("тКэшИменПоказателей", тКэшИменПоказателей);
	СтруктураРасчетаПоказателей.Вставить("тКэшГруппОтборовПоказателей", тКэшГруппОтборовПоказателей);		
	
	СтруктураРасчетаПоказателей.Вставить("ДанныеВидаОтчета", ДанныеВидаОтчета);
	СтруктураРасчетаПоказателей.Вставить("МаксКлючевыхАналитик", ДанныеВидаОтчета.МаксКлючевыхАналитик); 
	СтруктураРасчетаПоказателей.Вставить("МаксИспользуемыхАналитик", ДанныеВидаОтчета.МаксАналитикПоказателя + ДанныеВидаОтчета.МаксКлючевыхАналитик);
	СтруктураРасчетаПоказателей.Вставить("МаксУровеньРасчета", МаксУровеньРасчетаПоказателей);
	СтруктураРасчетаПоказателей.Вставить("МаксУровеньРучныхРасчетов", МаксУровеньРучныхРасчетов);
	СтруктураРасчетаПоказателей.Вставить("УровниСВременнымРасчетом", мУровниСВременнымРасчетом);
	СтруктураРасчетаПоказателей.Вставить("ЕстьДополненияАналитик", мИсточникиСДополнениемАналитик.Количество()>0);
	
	// Определим настройки валютной аналитики
	тАналитикиВалюта = тИспользуемыеАналитики.НайтиСтроки(Новый Структура("Поле","АналитикаВалюта"));
	Для Каждого СтрокаТаблицы ИЗ тАналитикиВалюта Цикл
		Если СтрокаТаблицы.УровеньРасчета <> 0 Тогда
			СтруктураРасчетаПоказателей.Вставить("ЕстьАналитикаВалюта", Истина); 	
			СтруктураРасчетаПоказателей.Вставить("ЕстьЗначениеВалюта", тПоказателиОперанды.НайтиСтроки(Новый Структура("ПересчитыватьВалютнуюСумму", Истина)).Количество() > 0);
			Прервать;
		КонецЕсли;
	КонецЦикла;

	СтруктураРасчетаПоказателей.Вставить("ЕстьВидКурсаЗначениеУказанноеВДокументе", ЕстьВидКурсаЗначениеУказанноеВДокументе);
	СтруктураРасчетаПоказателей.Вставить("ЕстьВидКурсаКурсНаМоментНачисления", ЕстьВидКурсаКурсНаМоментНачисления);
	СтруктураРасчетаПоказателей.Вставить("ЕстьВидКурсаПрочее", ЕстьВидКурсаПрочее);
	
	// Подготовим поля и ресурсы исходных таблиц для каждого уровня расчета
	ПодготовитьПоляВыборкиЗапроса(СтруктураРасчетаПоказателей);
	
	ИтоговыеРесурсы = тИспользуемыеРесурсы.Скопировать(Новый Структура("ВыводитсяВОтчет",Истина));
	СтруктураРасчетаПоказателей.Вставить("ЕстьЗначение", ИтоговыеРесурсы.Найти("Значение","Поле") <> Неопределено);
	СтруктураРасчетаПоказателей.Вставить("ЕстьЗначениеНечисловое", ИтоговыеРесурсы.Найти("ЗначениеНечисловое","Поле") <> Неопределено);
	
	Возврат СтруктураРасчетаПоказателей;
		
КонецФункции

Функция ПолучитьОписаниеСлужебныхТаблиц()
	
	ОписаниеТиповБулево 	= ОбщегоНазначенияУХ.ПолучитьОписаниеТиповБулево();
	ОписаниеТиповЧисло5Н 	= ОбщегоНазначенияУХ.ПолучитьОписаниеТиповЧисла(5,0,ДопустимыйЗнак.Неотрицательный);
	ОписаниеТиповЧисло2     = ОбщегоНазначенияУХ.ПолучитьОписаниеТиповЧисла(2,0,ДопустимыйЗнак.Любой);
	
	глТаблицаПересчетаПоказателей = Новый ТаблицаЗначений;
	глТаблицаПересчетаПоказателей.Колонки.Добавить("КомментарийКПакету");
	глТаблицаПересчетаПоказателей.Колонки.Добавить("ВидОперацииРасчета");
	глТаблицаПересчетаПоказателей.Колонки.Добавить("ТекстПодзапросов");
	глТаблицаПересчетаПоказателей.Колонки.Добавить("тПараметрыПакета");
	глТаблицаПересчетаПоказателей.Колонки.Добавить("ВыгружатьРезультатВТаблицу",ОписаниеТиповБулево);
	глТаблицаПересчетаПоказателей.Колонки.Добавить("УровеньРасчета",ОписаниеТиповЧисло5Н);
	
	тРасшифровкаГруппОтборов = Новый ТаблицаЗначений;
	тРасшифровкаГруппОтборов.Колонки.Добавить("ПоказательОперанд");
	тРасшифровкаГруппОтборов.Колонки.Добавить("КодВФормуле");
	тРасшифровкаГруппОтборов.Колонки.Добавить("ПолеБД");
	тРасшифровкаГруппОтборов.Колонки.Добавить("СпособВычисленияПараметра");
	тРасшифровкаГруппОтборов.Колонки.Добавить("УточнениеСпособаОпределения");
	тРасшифровкаГруппОтборов.Колонки.Добавить("ИдентификаторСтроки");
	тРасшифровкаГруппОтборов.Колонки.Добавить("ИдентификаторРодителя");
	тРасшифровкаГруппОтборов.Колонки.Добавить("ТекстМодуля");
	тРасшифровкаГруппОтборов.Колонки.Добавить("УИДГруппыОтборов",ОписаниеТиповЧисло5Н);
	тРасшифровкаГруппОтборов.Колонки.Добавить("ВключаетсяВПоля",ОписаниеТиповБулево);
	тРасшифровкаГруппОтборов.Колонки.Добавить("УровеньРасчета",ОписаниеТиповЧисло5Н);
	тРасшифровкаГруппОтборов.Колонки.Добавить("ТипЗначенияАналитики");
	
	тВнешниеДанные = Новый ТаблицаЗначений;
	тВнешниеДанные.Колонки.Добавить("ТаблицаОперандов");
	тВнешниеДанные.Колонки.Добавить("ПоказательОтбор");
	тВнешниеДанные.Колонки.Добавить("ГруппаРаскрытияОтбор");
	тВнешниеДанные.Колонки.Добавить("ГруппаРаскрытия", ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСсылка("СправочникСсылка.ГруппыРаскрытия"));
	тВнешниеДанные.Колонки.Добавить("ПравилаВычисленияПараметров");
	тВнешниеДанные.Колонки.Добавить("ТабПравилаИспользованияПолей");
	тВнешниеДанные.Колонки.Добавить("ТекстЗапроса");
	тВнешниеДанные.Колонки.Добавить("РегистрБД");
	тВнешниеДанные.Колонки.Добавить("ТаблицаADO");
	тВнешниеДанные.Колонки.Добавить("ТипБД");
	тВнешниеДанные.Колонки.Добавить("ПланСчетов");
	тВнешниеДанные.Колонки.Добавить("СпособПолучения");
	тВнешниеДанные.Колонки.Добавить("ТолькоАналитическиеЗначения", ОписаниеТиповБулево);
	тВнешниеДанные.Колонки.Добавить("ПроизвольныйЗапрос", ОписаниеТиповБулево);
	тВнешниеДанные.Колонки.Добавить("ПоказательТекущегоОтчета", ОписаниеТиповБулево);
	тВнешниеДанные.Колонки.Добавить("СтруктураПараметров");
	тВнешниеДанные.Колонки.Добавить("СтруктураЗапроса");
	тВнешниеДанные.Колонки.Добавить("ВалютнаяСумма", ОписаниеТиповБулево);
	тВнешниеДанные.Колонки.Добавить("АналитикВидаОтчета", ОбщегоНазначенияУХ.ПолучитьОписаниеТиповЧисла(1,0));
	
	тВнутренниеДанные = Новый ТаблицаЗначений;
	тВнутренниеДанные.Колонки.Добавить("СпособПолучения");
	тВнутренниеДанные.Колонки.Добавить("РегистрБД");
	тВнутренниеДанные.Колонки.Добавить("ОсновнаяТаблицаРегистра");
	тВнутренниеДанные.Колонки.Добавить("ВидСреза");
	тВнутренниеДанные.Колонки.Добавить("КорреспонденцияСчетов");
	тВнутренниеДанные.Колонки.Добавить("ХешОтбораПоказателей");
	тВнутренниеДанные.Колонки.Добавить("ОбъектБД");
	тВнутренниеДанные.Колонки.Добавить("ТабличнаяЧастьБД");
	тВнутренниеДанные.Колонки.Добавить("ТекстЗапроса");
	тВнутренниеДанные.Колонки.Добавить("ТаблицаПараметровОтбораБД");
	тВнутренниеДанные.Колонки.Добавить("Показатель");
	тВнутренниеДанные.Колонки.Добавить("Код");	
	тВнутренниеДанные.Колонки.Добавить("ТипЗначения");
	тВнутренниеДанные.Колонки.Добавить("ПравилаИспользованияПолейЗапроса"); 
	тВнутренниеДанные.Колонки.Добавить("РесурсРегистра");		 
	тВнутренниеДанные.Колонки.Добавить("Счет");				 
	тВнутренниеДанные.Колонки.Добавить("КоррСчет");
	
	тПроизвольныйКод = Новый ТаблицаЗначений;
	тПроизвольныйКод.Колонки.Добавить("Показатель");
	тПроизвольныйКод.Колонки.Добавить("ТипЗначения");
	тПроизвольныйКод.Колонки.Добавить("Процедура");
	
	тПоказателиОперанды = Новый ТаблицаЗначений;
	тПоказателиОперанды.Колонки.Добавить("ИсточникДанныхДляРасчетов",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСсылка("СправочникСсылка.ИсточникиДанныхДляРасчетов"));
	тПоказателиОперанды.Колонки.Добавить("Потребитель",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСсылка("СправочникСсылка.ПоказателиОтчетов"));
	тПоказателиОперанды.Колонки.Добавить("ПоказательОперанд",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСсылка("СправочникСсылка.ПоказателиОтчетов"));
	тПоказателиОперанды.Колонки.Добавить("УровеньРасчетаПотребителя",ОписаниеТиповЧисло5Н);
	тПоказателиОперанды.Колонки.Добавить("УровеньРасчетаОперанда",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповЧисла(4,0));
	тПоказателиОперанды.Колонки.Добавить("КодВФормуле",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСтроки(1024));
	тПоказателиОперанды.Колонки.Добавить("ТекущийПериод",ОписаниеТиповБулево);
	тПоказателиОперанды.Колонки.Добавить("ТипПотребителя",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСсылка("ПеречислениеСсылка.ТипыЗначенийПоказателейОтчетов"));
	тПоказателиОперанды.Колонки.Добавить("ТипПоказателя",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСсылка("ПеречислениеСсылка.ТипыЗначенийПоказателейОтчетов"));
	тПоказателиОперанды.Колонки.Добавить("УИДГруппыОтборов",ОписаниеТиповЧисло5Н);
	тПоказателиОперанды.Колонки.Добавить("ТрансформацияПолей",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСтроки(0));
	тПоказателиОперанды.Колонки.Добавить("ИндексРегистраОперанда",ОписаниеТиповЧисло2);
	тПоказателиОперанды.Колонки.Добавить("ИндексРегистраПотребителя",ОписаниеТиповЧисло2);
	тПоказателиОперанды.Колонки.Добавить("ВариантРасчета",ОписаниеТиповЧисло5Н);
	тПоказателиОперанды.Колонки.Добавить("УИДГруппыТрансформации",ОписаниеТиповЧисло5Н);
	тПоказателиОперанды.Колонки.Добавить("ЭтоОперандТекущегоПериода",ОписаниеТиповБулево);
	тПоказателиОперанды.Колонки.Добавить("ДляДополненияАналитик",ОписаниеТиповБулево);
	тПоказателиОперанды.Колонки.Добавить("ВременныйРасчет",ОписаниеТиповБулево);
	тПоказателиОперанды.Колонки.Добавить("ВидОтчетаПоказателя",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСсылка("СправочникСсылка.ВидыОтчетов"));
	тПоказателиОперанды.Колонки.Добавить("СпособПолучения");
	тПоказателиОперанды.Колонки.Добавить("Процедура");
	тПоказателиОперанды.Колонки.Добавить("ПересчитыватьВалютнуюСумму",ОписаниеТиповБулево);
	тПоказателиОперанды.Колонки.Добавить("ЧислоАналитик",ОписаниеТиповЧисло2);
	тПоказателиОперанды.Колонки.Добавить("ЕстьАналитикаВалюта",ОписаниеТиповБулево);
	тПоказателиОперанды.Колонки.Добавить("ВидИтога",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСсылка("ПеречислениеСсылка.ВидыИтоговПоказателя"));
	тПоказателиОперанды.Колонки.Добавить("ВидИтогаПоПериоду",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСсылка("ПеречислениеСсылка.ВидыИтоговПоказателяПоПериоду"));
	тПоказателиОперанды.Колонки.Добавить("ПотребительПредставление");
	тПоказателиОперанды.Колонки.Добавить("ВидОтчетаПотребителя");
	тПоказателиОперанды.Колонки.Добавить("ВидОтчетаПотребителяПредставление");
	
	тКэшИменПоказателей = Новый ТаблицаЗначений;
	тКэшИменПоказателей.Колонки.Добавить("Показатель",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСсылка("СправочникСсылка.ПоказателиОтчетов"));
	тКэшИменПоказателей.Колонки.Добавить("ВидОтчета",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСсылка("СправочникСсылка.ВидыОтчетов"));
	тКэшИменПоказателей.Колонки.Добавить("УровеньРасчета",ОписаниеТиповЧисло5Н);
	тКэшИменПоказателей.Колонки.Добавить("КодВФормуле",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСтроки(1024));
	тКэшИменПоказателей.Колонки.Добавить("УИДГруппыОтборов",ОписаниеТиповЧисло5Н);
	
	тКэшГруппОтборовПоказателей = Новый ТаблицаЗначений;
	тКэшГруппОтборовПоказателей.Колонки.Добавить("ХешГруппыОтборов");
	тКэшГруппОтборовПоказателей.Колонки.Добавить("ИндексРегистра",ОписаниеТиповЧисло2);
	тКэшГруппОтборовПоказателей.Колонки.Добавить("УИДГруппыОтборов",ОписаниеТиповЧисло5Н);
	тКэшГруппОтборовПоказателей.Колонки.Добавить("ЭтоАналитикаВерсии",ОписаниеТиповБулево);
	тКэшГруппОтборовПоказателей.Колонки.Добавить("ТекущийПериод",ОписаниеТиповБулево);
	
	тИспользуемыеАналитики = Новый ТаблицаЗначений;
	тИспользуемыеАналитики.Колонки.Добавить("УровеньРасчета",ОписаниеТиповЧисло5Н);
	тИспользуемыеАналитики.Колонки.Добавить("Поле",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСтроки(100));
	тИспользуемыеАналитики.Колонки.Добавить("ПолеТрансформации",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСтроки(100));
	тИспользуемыеАналитики.Колонки.Добавить("ПолеВерсии",ОписаниеТиповБулево);
	тИспользуемыеАналитики.Колонки.Добавить("Операнды");
	
	тИспользуемыеРесурсы = Новый ТаблицаЗначений;
	тИспользуемыеРесурсы.Колонки.Добавить("УровеньРасчета",ОписаниеТиповЧисло5Н);
	тИспользуемыеРесурсы.Колонки.Добавить("Поле",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСтроки(100));
	тИспользуемыеРесурсы.Колонки.Добавить("Суммируется",ОписаниеТиповБулево); 
	тИспользуемыеРесурсы.Колонки.Добавить("ВыводитсяВОтчет",ОписаниеТиповБулево);
	
	тСлужебныеТаблицы = Новый Структура;
	тСлужебныеТаблицы.Вставить("глТаблицаПересчетаПоказателей",глТаблицаПересчетаПоказателей);
	тСлужебныеТаблицы.Вставить("тРасшифровкаГруппОтборов",тРасшифровкаГруппОтборов);
	тСлужебныеТаблицы.Вставить("тВнешниеДанные",тВнешниеДанные);
	тСлужебныеТаблицы.Вставить("тВнутренниеДанные",тВнутренниеДанные);
	тСлужебныеТаблицы.Вставить("тПроизвольныйКод",тПроизвольныйКод);
	тСлужебныеТаблицы.Вставить("тПоказателиОперанды",тПоказателиОперанды);
    тСлужебныеТаблицы.Вставить("тКэшИменПоказателей",тКэшИменПоказателей);
    тСлужебныеТаблицы.Вставить("тКэшГруппОтборовПоказателей",тКэшГруппОтборовПоказателей);
	тСлужебныеТаблицы.Вставить("тИспользуемыеАналитики",тИспользуемыеАналитики);
	тСлужебныеТаблицы.Вставить("тИспользуемыеРесурсы",тИспользуемыеРесурсы);	
		
	Возврат тСлужебныеТаблицы; 
	
КонецФункции	

Функция ПолучитьСтруктуруРасчетаПоказателей()

	СтруктураРасчетаПоказателей = Новый Структура;
	СтруктураРасчетаПоказателей.Вставить("глТаблицаПересчетаПоказателей", Неопределено);
	
	СтруктураРасчетаПоказателей.Вставить("тВнутренниеДанные", Неопределено);
	СтруктураРасчетаПоказателей.Вставить("тСчетаСИерархией", Неопределено);
	СтруктураРасчетаПоказателей.Вставить("тПроизвольныйКод", Неопределено);
	СтруктураРасчетаПоказателей.Вставить("тПроизвольныеЗапросы", Неопределено);
	СтруктураРасчетаПоказателей.Вставить("тВнешниеДанные", Неопределено);
	
	СтруктураРасчетаПоказателей.Вставить("тПоказателиОперанды", Неопределено);
	СтруктураРасчетаПоказателей.Вставить("тИспользуемыеАналитики", Неопределено);
	СтруктураРасчетаПоказателей.Вставить("тИспользуемыеРесурсы", Неопределено);
	
	СтруктураРасчетаПоказателей.Вставить("тРасшифровкаГруппОтборов", Неопределено);
	СтруктураРасчетаПоказателей.Вставить("тКэшИменПоказателей", Неопределено);
	СтруктураРасчетаПоказателей.Вставить("тКэшГруппОтборовПоказателей", Неопределено);		
	
	СтруктураРасчетаПоказателей.Вставить("ДанныеВидаОтчета", Новый Структура);
	СтруктураРасчетаПоказателей.Вставить("МаксКлючевыхАналитик", 0); 
	СтруктураРасчетаПоказателей.Вставить("МаксИспользуемыхАналитик", 0);
	СтруктураРасчетаПоказателей.Вставить("МаксУровеньРасчета", 0);
	СтруктураРасчетаПоказателей.Вставить("МаксУровеньРучныхРасчетов", 0);
	
	СтруктураРасчетаПоказателей.Вставить("УровниСВременнымРасчетом", Новый Массив);
	СтруктураРасчетаПоказателей.Вставить("ЕстьДополненияАналитик", Ложь);
	
	СтруктураРасчетаПоказателей.Вставить("ЕстьДополненияАналитик", Ложь);
	
	СтруктураРасчетаПоказателей.Вставить("ЕстьАналитикаВалюта", Ложь);
	СтруктураРасчетаПоказателей.Вставить("ЕстьЗначениеВалюта", Ложь);

	СтруктураРасчетаПоказателей.Вставить("ЕстьВидКурсаЗначениеУказанноеВДокументе", Ложь);
	СтруктураРасчетаПоказателей.Вставить("ЕстьВидКурсаКурсНаМоментНачисления", Ложь);
	СтруктураРасчетаПоказателей.Вставить("ЕстьВидКурсаПрочее", Ложь);
	
	СтруктураРасчетаПоказателей.Вставить("ЕстьЗначение", Ложь);
	СтруктураРасчетаПоказателей.Вставить("ЕстьЗначениеНечисловое", Ложь);
	
	СтруктураРасчетаПоказателей.Вставить("РасчетПоИзмененнымПоказателям", Ложь);
	СтруктураРасчетаПоказателей.Вставить("ПолучатьДанныеИзРегистров", Истина);
	
	Возврат СтруктураРасчетаПоказателей;
			
КонецФункции

Процедура ДобавитьЗависимыеПоказателиРекурсивно(тПотребители, тДанныеДляРасчетов, стрПоказатель, ПоказательДляПоиска)
	
	НайденныеСтроки = тДанныеДляРасчетов.НайтиСтроки(Новый Структура("ПоказательОтбор", ПоказательДляПоиска));
	Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
		СтруктураПоиска = Новый Структура;
		СтруктураПоиска.Вставить("Показатель",НайденнаяСтрока.ПотребительРасчета);
		Для Сч = 1 По ПараметрыСеанса.ЧислоДопАналитик Цикл
			СтруктураПоиска.Вставить("Аналитика" + Сч, стрПоказатель["Аналитика" + Сч]);
		КонецЦикла;	
		Если тПотребители.НайтиСтроки(СтруктураПоиска).Количество() = 0 Тогда
			НСтрокаТаблицы = тПотребители.Добавить();
			ЗаполнитьЗначенияСвойств(НСтрокаТаблицы, стрПоказатель);
			НСтрокаТаблицы.Показатель = НайденнаяСтрока.ПотребительРасчета;
			ДобавитьЗависимыеПоказателиРекурсивно(тПотребители, тДанныеДляРасчетов, стрПоказатель, НайденнаяСтрока.ПотребительРасчета);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура ОтфильтроватьПоИзмененнымПоказателям(ДанныеДляРасчета, тИзмененныеПоказатели)	
	
	Если тИзмененныеПоказатели.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	тДанныеДляРасчетов = ДанныеДляРасчета.тДанныеДляРасчетов;
	тДанныеДляРасчетовНовая = тДанныеДляРасчетов.СкопироватьКолонки();
	тПараметрыОтбораБДНовая = ДанныеДляРасчета.тПараметрыОтбораБД.Скопировать();
	тПравилаИспользованияПолейЗапроса = ДанныеДляРасчета.тПравилаИспользованияПолейЗапроса;
	
	СтруктураСложныхОтборов = Новый Структура;
	
	тПотребители = Новый ТаблицаЗначений;
	тПотребители.Колонки.Добавить("Показатель");
	тПотребители.Колонки.Добавить("АналитикаВалюта");
	Для Сч = 1 По ПараметрыСеанса.ЧислоДопАналитик Цикл
		тПотребители.Колонки.Добавить("Аналитика" + Сч);
	КонецЦикла;
	Для Каждого стрПоказатель Из тИзмененныеПоказатели Цикл
		ДобавитьЗависимыеПоказателиРекурсивно(тПотребители, тДанныеДляРасчетов, стрПоказатель, стрПоказатель.Показатель);
	КонецЦикла;
	
	тРазличныеПотребители = тПотребители.Скопировать(,"Показатель");
	тРазличныеПотребители.Свернуть("Показатель");
	
	// Оставим только полученных потребителей	
	Для Каждого стрПотребитель Из тРазличныеПотребители Цикл
		НайденныеПотребители = тДанныеДляРасчетов.НайтиСтроки(Новый Структура("ПотребительРасчета", стрПотребитель.Показатель));
		Для Каждого СтрНайденныйПотребитель Из НайденныеПотребители Цикл
			
			//	Добавляем строку потребителя в таблицу для расчета
			НСтрока = тДанныеДляРасчетовНовая.Добавить();
			ЗаполнитьЗначенияСвойств(НСтрока, СтрНайденныйПотребитель);
			
			// Добавим в таблицу потребителей для формирования отборов
			НайденныеСтроки = тПотребители.НайтиСтроки(Новый Структура("Показатель",стрПотребитель.Показатель));
			Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
				НСтрока = тПотребители.Добавить();
				ЗаполнитьЗначенияСвойств(НСтрока, НайденнаяСтрока);
				НСтрока.Показатель = СтрНайденныйПотребитель.ПоказательОтбор;
			КонецЦикла;
		
			// Проверим наличие сложных отборов по аналитикам
			Для Сч = 0 По СтрНайденныйПотребитель.ЧислоАналитикПоказателя Цикл
				
				Если Сч = 0 Тогда
					Если СтрНайденныйПотребитель.ЕстьАналитикаВалютаПоказателя Тогда
						ИмяОтбора = "АналитикаВалюта";
					Иначе
						Продолжить;
					КонецЕсли;
				Иначе
					ИмяОтбора = "Аналитика" + Строка(Сч + СтрНайденныйПотребитель.МаксКлючевыхАналитикПоказателя);
				КонецЕсли;
				
				Если СтруктураСложныхОтборов.Свойство(ИмяОтбора) Тогда
					// Отбор уже определен, как сложный
					Продолжить;
				КонецЕсли;
				
				Если СтрНайденныйПотребитель.ЧислоАналитикПоказателя <> СтрНайденныйПотребитель.ЧислоАналитик Тогда
					// Есть трансформация аналитик, отборы не устанавливаем
					СтруктураСложныхОтборов.Вставить(ИмяОтбора);
					Продолжить;
				КонецЕсли;
				
				// Найдем правила заполнения аналитик
				ПравилаТрансформации = тПравилаИспользованияПолейЗапроса.НайтиСтроки(Новый Структура("Ссылка,Поле", СтрНайденныйПотребитель.Ссылка, ИмяОтбора));
				Если ПравилаТрансформации.Количество() <> 1 Тогда
					// Нет правил трансформации
					СтруктураСложныхОтборов.Вставить(ИмяОтбора);
					Продолжить;
				КонецЕсли;
				
				ПравилоТрансформации = ПравилаТрансформации.Получить(0);
				Если ПравилоТрансформации.СпособЗаполнения <> Перечисления.СпособыЗаполненияПолейИсточника.ПолеИсходнойТаблицы
					ИЛИ ПравилоТрансформации.КодАналитики <> ИмяОтбора Тогда
					// Нестандартные правила трансформации
					СтруктураСложныхОтборов.Вставить(ИмяОтбора);
					Продолжить;
				КонецЕсли;				
								
				// Ищем отборы по аналитикам 
				СтрокиОтбора = тПараметрыОтбораБДНовая.НайтиСтроки(Новый Структура("Ссылка,ПолеБД", СтрНайденныйПотребитель.Ссылка, ИмяОтбора));
				Если СтрокиОтбора.Количество() <> 0 Тогда
					// Уже задан отбор по аналитике
					СтруктураСложныхОтборов.Вставить(ИмяОтбора);
				КонецЕсли;

			КонецЦикла;
	
		КонецЦикла;
	КонецЦикла;
	
	Для Каждого СтрПотребитель Из тДанныеДляРасчетовНовая Цикл

		// Добавим отборы по аналитикам, если в дереве расчета нет сложных отборов
		Для Сч = 0 По СтрПотребитель.ЧислоАналитикПоказателя Цикл
			
			Если Сч = 0 Тогда
				Если СтрПотребитель.ЕстьАналитикаВалютаПоказателя Тогда
					ИмяОтбора = "АналитикаВалюта";
				Иначе
					Продолжить;
				КонецЕсли;
			Иначе
				ИмяОтбора = "Аналитика" + Строка(Сч + СтрПотребитель.МаксКлючевыхАналитикПоказателя);
			КонецЕсли;
			
			Если СтруктураСложныхОтборов.Свойство(ИмяОтбора) Тогда
				// По этой аналитике есть сложный отбор
				Продолжить;
			КонецЕсли;
			
			// Установим отбор по аналитике
			стрОтбор = тПараметрыОтбораБДНовая.Добавить();
			стрОтбор.ИдентификаторРодителя 			= 0;
			стрОтбор.ИдентификаторСтроки 			= 1000 + Сч;
			стрОтбор.ИмяПараметра					= 1000 + Сч;
			стрОтбор.КодВФормуле 					= СтрПотребитель.Код;
			стрОтбор.ПоказательОперанд              = СтрПотребитель.ПоказательОтбор;
			стрОтбор.ПолеБД                         = ИмяОтбора;
			стрОтбор.Ссылка                         = СтрПотребитель.Ссылка;
			стрОтбор.ТекстМодуля                    = "";
			тТекущиеПотребители = тПотребители.Скопировать(Новый Структура("Показатель",СтрПотребитель.ПотребительРасчета));
			тТекущиеПотребители.Свернуть(ИмяОтбора);
			Если тТекущиеПотребители.Количество() = 1 Тогда 
				стрОтбор.СпособВычисленияПараметра 		= Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение;
				стрОтбор.УточнениеСпособаОпределения 	= тТекущиеПотребители[0][ИмяОтбора];
			Иначе				
				стрОтбор.СпособВычисленияПараметра 		= Перечисления.СпособыВычисленияПараметровОперандов.СписокФиксированныхЗначений;
				стрОтбор.УточнениеСпособаОпределения 	= тТекущиеПотребители.ВыгрузитьКолонку(ИмяОтбора);
			КонецЕсли;
	
		КонецЦикла;
		
	КонецЦикла;
	
	ДанныеДляРасчетаНовые = Новый Структура;
	Для Каждого КлючЗначение Из ДанныеДляРасчета Цикл
		Если КлючЗначение.Ключ = "тПараметрыОтбораБД" Тогда
			Значение = тПараметрыОтбораБДНовая;
		ИначеЕсли КлючЗначение.Ключ = "тДанныеДляРасчетов" Тогда
			Значение = тДанныеДляРасчетовНовая;
		Иначе
			Значение = КлючЗначение.Значение;
		КонецЕсли;
		ДанныеДляРасчетаНовые.Вставить(КлючЗначение.Ключ, Значение);	
	КонецЦикла;
	
	ДанныеДляРасчета = ДанныеДляРасчетаНовые;
	
КонецПроцедуры


Процедура ДобавитьВлияющиеПоказателиРекурсивно(тПотребители, тДанныеДляРасчетов, стрПоказатель, ПоказательДляПоиска)
	
	НайденныеСтроки = тДанныеДляРасчетов.НайтиСтроки(Новый Структура("ПотребительРасчета", ПоказательДляПоиска));
	Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
		Если НайденнаяСтрока.ВидОтчетаПотребителя = НайденнаяСтрока.ВидОтчетаПоказателя Тогда
			// Оставляем показатели только текущего вида отчета
			СтруктураПоиска = Новый Структура;
			СтруктураПоиска.Вставить("Показатель",НайденнаяСтрока.ПоказательОтбор);
			Для Сч = 1 По ПараметрыСеанса.ЧислоДопАналитик Цикл
				СтруктураПоиска.Вставить("Аналитика" + Сч, стрПоказатель["Аналитика" + Сч]);
			КонецЦикла;	
			Если тПотребители.НайтиСтроки(СтруктураПоиска).Количество() = 0 Тогда
				НСтрокаТаблицы = тПотребители.Добавить();
				ЗаполнитьЗначенияСвойств(НСтрокаТаблицы, стрПоказатель);
				НСтрокаТаблицы.Показатель = НайденнаяСтрока.ПоказательОтбор;
				ДобавитьВлияющиеПоказателиРекурсивно(тПотребители, тДанныеДляРасчетов, стрПоказатель, НайденнаяСтрока.ПоказательОтбор);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура ОтфильтроватьПоЦелевымПоказателям(ДанныеДляРасчета, тЦелевыеПоказатели)	
	
	Если тЦелевыеПоказатели.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	тДанныеДляРасчетов = ДанныеДляРасчета.тДанныеДляРасчетов;
	тДанныеДляРасчетовНовая = тДанныеДляРасчетов.СкопироватьКолонки();
	тПараметрыОтбораБДНовая = ДанныеДляРасчета.тПараметрыОтбораБД.Скопировать();
	тПравилаИспользованияПолейЗапроса = ДанныеДляРасчета.тПравилаИспользованияПолейЗапроса;
	
	СтруктураСложныхОтборов = Новый Структура;
	
	тПотребители = Новый ТаблицаЗначений;
	тПотребители.Колонки.Добавить("Показатель");
	тПотребители.Колонки.Добавить("АналитикаВалюта");
	Для Сч = 1 По ПараметрыСеанса.ЧислоДопАналитик Цикл
		тПотребители.Колонки.Добавить("Аналитика" + Сч);
	КонецЦикла;
	Для Каждого стрПоказатель Из тЦелевыеПоказатели Цикл
		НСтрокаТаблицы = тПотребители.Добавить();
		ЗаполнитьЗначенияСвойств(НСтрокаТаблицы, стрПоказатель);
		ДобавитьВлияющиеПоказателиРекурсивно(тПотребители, тДанныеДляРасчетов, стрПоказатель, стрПоказатель.Показатель);
	КонецЦикла;
	
	тРазличныеПотребители = тПотребители.Скопировать(,"Показатель");
	тРазличныеПотребители.Свернуть("Показатель");
	
	// Оставим только полученных потребителей	
	Для Каждого стрПотребитель Из тРазличныеПотребители Цикл
		НайденныеПотребители = тДанныеДляРасчетов.НайтиСтроки(
			Новый Структура("ПотребительРасчета, СпособПолучения", стрПотребитель.Показатель, Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеПоказательОтчета));  // Здесь отличие
		Для Каждого СтрНайденныйПотребитель Из НайденныеПотребители Цикл
			
			//	Добавляем строку потребителя в таблицу для расчета
			НСтрока = тДанныеДляРасчетовНовая.Добавить();
			ЗаполнитьЗначенияСвойств(НСтрока, СтрНайденныйПотребитель);
			
			// Добавим в таблицу потребителей для формирования отборов
			НайденныеСтроки = тПотребители.НайтиСтроки(Новый Структура("Показатель",стрПотребитель.Показатель));
			Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
				НСтрока = тПотребители.Добавить();
				ЗаполнитьЗначенияСвойств(НСтрока, НайденнаяСтрока);
				НСтрока.Показатель = СтрНайденныйПотребитель.ПоказательОтбор;
			КонецЦикла;
		
			// Проверим наличие сложных отборов по аналитикам
			Для Сч = 0 По СтрНайденныйПотребитель.ЧислоАналитикПоказателя Цикл
				
				Если Сч = 0 Тогда
					Если СтрНайденныйПотребитель.ЕстьАналитикаВалютаПоказателя Тогда
						ИмяОтбора = "АналитикаВалюта";
					Иначе
						Продолжить;
					КонецЕсли;
				Иначе
					ИмяОтбора = "Аналитика" + Строка(Сч + СтрНайденныйПотребитель.МаксКлючевыхАналитикПоказателя);
				КонецЕсли;
				
				Если СтруктураСложныхОтборов.Свойство(ИмяОтбора) Тогда
					// Отбор уже определен, как сложный
					Продолжить;
				КонецЕсли;
				
				Если СтрНайденныйПотребитель.ЧислоАналитикПоказателя <> СтрНайденныйПотребитель.ЧислоАналитик Тогда
					// Есть трансформация аналитик, отборы не устанавливаем
					СтруктураСложныхОтборов.Вставить(ИмяОтбора);
					Продолжить;
				КонецЕсли;
				
				// Найдем правила заполнения аналитик
				ПравилаТрансформации = тПравилаИспользованияПолейЗапроса.НайтиСтроки(Новый Структура("Ссылка,Поле", СтрНайденныйПотребитель.Ссылка, ИмяОтбора));
				Если ПравилаТрансформации.Количество() <> 1 Тогда
					// Нет правил трансформации
					СтруктураСложныхОтборов.Вставить(ИмяОтбора);
					Продолжить;
				КонецЕсли;
				
				ПравилоТрансформации = ПравилаТрансформации.Получить(0);
				Если ПравилоТрансформации.СпособЗаполнения <> Перечисления.СпособыЗаполненияПолейИсточника.ПолеИсходнойТаблицы
					ИЛИ ПравилоТрансформации.КодАналитики <> ИмяОтбора Тогда
					// Нестандартные правила трансформации
					СтруктураСложныхОтборов.Вставить(ИмяОтбора);
					Продолжить;
				КонецЕсли;				
								
				// Ищем отборы по аналитикам 
				СтрокиОтбора = тПараметрыОтбораБДНовая.НайтиСтроки(Новый Структура("Ссылка,ПолеБД", СтрНайденныйПотребитель.Ссылка, ИмяОтбора));
				Если СтрокиОтбора.Количество() <> 0 Тогда
					// Уже задан отбор по аналитике
					СтруктураСложныхОтборов.Вставить(ИмяОтбора);
				КонецЕсли;

			КонецЦикла;
	
		КонецЦикла;
	КонецЦикла;
	
	Для Каждого СтрПотребитель Из тДанныеДляРасчетовНовая Цикл

		// Добавим отборы по аналитикам, если в дереве расчета нет сложных отборов
		Для Сч = 0 По СтрПотребитель.ЧислоАналитикПоказателя Цикл
			
			Если Сч = 0 Тогда
				Если СтрПотребитель.ЕстьАналитикаВалютаПоказателя Тогда
					ИмяОтбора = "АналитикаВалюта";
				Иначе
					Продолжить;
				КонецЕсли;
			Иначе
				ИмяОтбора = "Аналитика" + Строка(Сч + СтрПотребитель.МаксКлючевыхАналитикПоказателя);
			КонецЕсли;
			
			Если СтруктураСложныхОтборов.Свойство(ИмяОтбора) Тогда
				// По этой аналитике есть сложный отбор
				Продолжить;
			КонецЕсли;
			
			// Установим отбор по аналитике
			стрОтбор = тПараметрыОтбораБДНовая.Добавить();
			стрОтбор.ИдентификаторРодителя 			= 0;
			стрОтбор.ИдентификаторСтроки 			= 1000 + Сч;
			стрОтбор.ИмяПараметра					= 1000 + Сч;
			стрОтбор.КодВФормуле 					= СтрПотребитель.Код;
			стрОтбор.ПоказательОперанд              = СтрПотребитель.ПоказательОтбор;
			стрОтбор.ПолеБД                         = ИмяОтбора;
			стрОтбор.Ссылка                         = СтрПотребитель.Ссылка;
			стрОтбор.ТекстМодуля                    = "";
			тТекущиеПотребители = тПотребители.Скопировать(Новый Структура("Показатель",СтрПотребитель.ПотребительРасчета));
			тТекущиеПотребители.Свернуть(ИмяОтбора);
			Если тТекущиеПотребители.Количество() = 1 Тогда 
				стрОтбор.СпособВычисленияПараметра 		= Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение;
				стрОтбор.УточнениеСпособаОпределения 	= тТекущиеПотребители[0][ИмяОтбора];
			Иначе				
				стрОтбор.СпособВычисленияПараметра 		= Перечисления.СпособыВычисленияПараметровОперандов.СписокФиксированныхЗначений;
				стрОтбор.УточнениеСпособаОпределения 	= тТекущиеПотребители.ВыгрузитьКолонку(ИмяОтбора);
			КонецЕсли;
	
		КонецЦикла;
		
	КонецЦикла;
	
	ДанныеДляРасчетаНовые = Новый Структура;
	Для Каждого КлючЗначение Из ДанныеДляРасчета Цикл
		Если КлючЗначение.Ключ = "тПараметрыОтбораБД" Тогда
			Значение = тПараметрыОтбораБДНовая;
		ИначеЕсли КлючЗначение.Ключ = "тДанныеДляРасчетов" Тогда
			Значение = тДанныеДляРасчетовНовая;
		Иначе
			Значение = КлючЗначение.Значение;
		КонецЕсли;
		ДанныеДляРасчетаНовые.Вставить(КлючЗначение.Ключ, Значение);	
	КонецЦикла;
	
	ДанныеДляРасчета = ДанныеДляРасчетаНовые;
	
КонецПроцедуры


Процедура ПолучитьУровеньРасчетаОперандаРекурсивно(
	дУровни,
	СтрокаОперанда,
	тДанныеДляРасчетов,
	мПоказателиСоСдвигомПоПериоду,
	СтрокаОперандаИсходная,
	тМаксимальныйУровень)
		
	тСтрокаДерева = дУровни.Строки.Добавить();	
	нУровень = тМаксимальныйУровень.Добавить();
	нУровень.тУровень = тСтрокаДерева.Уровень() + 1;

	Если СтрокаОперанда.ПоказательОтбор = СтрокаОперанда.ПотребительРасчета
		И мПоказателиСоСдвигомПоПериоду.Найти(СтрокаОперанда.ПоказательОтбор) = Неопределено Тогда
		СтрокаОперандаИсходная.УровеньОперанда = нУровень.тУровень;
		// Показатель ссылается сам на себя с отбором по ключевым аналитикам, но не по периоду
		Возврат;
	КонецЕсли;
	
	ЕстьПоказательТекущегоОтчета = Ложь;	
	тРекурсивныеОперанды = тДанныеДляРасчетов.НайтиСтроки(Новый Структура("ПотребительРасчета",СтрокаОперанда.ПоказательОтбор,Истина));
	Для Каждого Стр Из тРекурсивныеОперанды Цикл
		Если Стр.ПоказательТекущегоОтчета Тогда
			ЕстьПоказательТекущегоОтчета = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	Если Не ЕстьПоказательТекущегоОтчета И тРекурсивныеОперанды.Количество() > 0 Тогда
		нУровень.тУровень = нУровень.тУровень + 1;
	КонецЕсли;
	
	Если СтрокаОперандаИсходная.УровеньОперанда <> Неопределено Тогда
		Если СтрокаОперандаИсходная.УровеньОперанда < нУровень.тУровень Тогда
			СтрокаОперандаИсходная.УровеньОперанда = нУровень.тУровень;
		КонецЕсли;
	КонецЕсли;
	
	Для Каждого Стр Из тРекурсивныеОперанды Цикл
		
		Если Стр.ПоказательТекущегоОтчета Тогда
			ПолучитьУровеньРасчетаОперандаРекурсивно(
				тСтрокаДерева,
				Стр,
				тДанныеДляРасчетов,
				мПоказателиСоСдвигомПоПериоду,
				СтрокаОперандаИсходная,
				тМаксимальныйУровень);
		КонецЕсли;
		
	КонецЦикла;
	
	Если мПоказателиСоСдвигомПоПериоду.Найти(СтрокаОперанда.ПоказательОтбор) <> Неопределено Тогда
		мПоказателиСоСдвигомПоПериоду.Добавить(СтрокаОперанда.ПотребительРасчета);
	КонецЕсли;
		
КонецПроцедуры	

Функция ПолучитьУИДДляПоказателя(ТЗРасшифровкаОтборовГруппРаскрытия,
	ИндексРегистраОперанда,КэшГруппОтборовПоказателей,МаксУИД,тРасшифровкаГруппОтборов,ТекущийПериод)
	
	Если ТЗРасшифровкаОтборовГруппРаскрытия.Количество() = 0 Тогда
		тХешГруппыОтборов = "";	
	Иначе
		тХешГруппыОтборов = ПолучитьХешПоОтборам(ТЗРасшифровкаОтборовГруппРаскрытия);
	КонецЕсли;
	
	СтруктураПоискаПоУмолчанию = Новый Структура;
	СтруктураПоискаПоУмолчанию.Вставить("ИндексРегистра",ИндексРегистраОперанда);
	СтруктураПоискаПоУмолчанию.Вставить("ХешГруппыОтборов",тХешГруппыОтборов);
	СтруктураПоискаПоУмолчанию.Вставить("ТекущийПериод",ТекущийПериод);
	
	НайденнаяСтрокаКэша = КэшГруппОтборовПоказателей.НайтиСтроки(СтруктураПоискаПоУмолчанию);
	
	Если НайденнаяСтрокаКэша.Количество() = 0 Тогда
		НСтр = КэшГруппОтборовПоказателей.Добавить();
		ЗаполнитьЗначенияСвойств(НСтр,СтруктураПоискаПоУмолчанию);
		
		МаксУИД = МаксУИД + 1;
		НСтр.УИДГруппыОтборов = МаксУИД;	   		
		
		Для Каждого СтрРасшифровка Из ТЗРасшифровкаОтборовГруппРаскрытия Цикл
			НСтрРасшифровка = тРасшифровкаГруппОтборов.Добавить();
			ЗаполнитьЗначенияСвойств(НСтрРасшифровка,СтрРасшифровка);
			Если СтрРасшифровка.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеЗначение
				Или СтрРасшифровка.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеСписокЗначений Тогда
				НСтрРасшифровка.УточнениеСпособаОпределения = СтрРасшифровка.ТекстМодуля;
			КонецЕсли;
			НСтрРасшифровка.УИДГруппыОтборов = МаксУИД;
		КонецЦикла;	
		
	Иначе	  
		НСтр = НайденнаяСтрокаКэша[0];	   
	КонецЕсли; 
	
	Возврат НСтр.УИДГруппыОтборов;
	
КонецФункции

Функция ПолучитьХешПоОтборам(Знач ПараметрыОтбора)
	
	СтрокаХешаОтборов = "";
	
	ПараметрыОтбора.Сортировать("ПолеБД");
	
	Для Каждого Стр Из ПараметрыОтбора Цикл
		
		ЗначениеОтбора = Стр.УточнениеСпособаОпределения;		
		Если ТипЗнч(ЗначениеОтбора) = Тип("СписокЗначений") Тогда
			СтрЗначениеОтбора = ЗначениеВСтрокуВнутр(ЗначениеОтбора.ВыгрузитьЗначения());
		ИначеЕсли ЗначениеОтбора = "" Тогда
			СтрЗначениеОтбора = "";
		ИначеЕсли ЗначениеОтбора = Неопределено 
			И (Стр.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеЗначение 
			Или Стр.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеСписокЗначений) Тогда
			СтрЗначениеОтбора = Стр.ТекстМодуля;
		Иначе	
			СтрЗначениеОтбора = ЗначениеВСтрокуВнутр(ЗначениеОтбора);
		КонецЕсли;
		
		СтрокаХешаОтборов = СтрокаХешаОтборов+Стр.ПолеБД+"@"+Стр.СпособВычисленияПараметра+"@"+СтрЗначениеОтбора;
				
	КонецЦикла;	   
	
	Возврат СтрокаХешаОтборов;
	
КонецФункции	

Процедура ЗаполнитьТаблицуВнешнихДанных(тВнешниеДанные, ПравилоОбработки)
	
	ДанныеПараметрическойНастройки 	= УправлениеОтчетамиУХ.ПолучитьДанныеПараметрическойНастройки(ПравилоОбработки);
	Если ДанныеПараметрическойНастройки = Неопределено Тогда
		ТекОбъектРасчета = Документы.НастраиваемыйОтчет.СоздатьДокумент();
		ТекОбъектРасчета.ПравилоОбработки = ПравилоОбработки;
		ТекОбъектРасчета.СформироватьСтруктуруПараметров();
		ТекОбъектРасчета.ИнициализироватьКонтекст();
		УправлениеОтчетамиУХ.ПодготовитьДанныеПараметрическойНастройки(ТекОбъектРасчета);
		ДанныеПараметрическойНастройки 	= УправлениеОтчетамиУХ.ПолучитьДанныеПараметрическойНастройки(ПравилоОбработки);
	КонецЕсли;
	мТабПоказателиЗапросы = ДанныеПараметрическойНастройки.мТабПоказателиЗапросы;
	
	Для Каждого ПоказательЗапрос Из мТабПоказателиЗапросы Цикл
		
		Если ПоказательЗапрос.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнешниеДанныеРегистрНакопления
			Или ПоказательЗапрос.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнешниеДанныеРегистрБухгалтерии
			Или ПоказательЗапрос.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнешниеДанныеРегистрСведений
			Или ПоказательЗапрос.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнешниеДанныеСправочники
			Или ПоказательЗапрос.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнешниеДанныеПроизвольныйЗапрос
			Или ПоказательЗапрос.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнешниеДанныеADO Тогда
			нСтрокаТаблицы = тВнешниеДанные.Добавить();
			ЗаполнитьЗначенияСвойств(нСтрокаТаблицы, ПоказательЗапрос);
			Если ПоказательЗапрос.СтруктураЗапроса.Свойство("ОбъектЗапрос") Тогда
				ПоказательЗапрос.СтруктураЗапроса.ОбъектЗапрос = Неопределено;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;		

КонецПроцедуры

Процедура СформироватьДанныеДляРасчетаКлассическимДвижкомРасчета(
	тТаблицаДанных,
	СтрокаОперанд,
	тТекущихПравилИспользованияПолейЗапроса,
	тТекущихПараметровОтбораБД,
	МаксКлючевыхАналитик)
	
	// Заполним таблицу операндов
	ТаблицаОперандов = Новый ТаблицаЗначений;
	ТаблицаОперандов.Колонки.Добавить("АналитикВидаОтчета");
	ТаблицаОперандов.Колонки.Добавить("ВидИтогаПоказателя");
	ТаблицаОперандов.Колонки.Добавить("Код");
	ТаблицаОперандов.Колонки.Добавить("КоррСчет");
	ТаблицаОперандов.Колонки.Добавить("Наименование");
	ТаблицаОперандов.Колонки.Добавить("Показатель");
	ТаблицаОперандов.Колонки.Добавить("ПоказательОтбор");
	ТаблицаОперандов.Колонки.Добавить("ПравилаИспользованияПолейЗапроса");
	ТаблицаОперандов.Колонки.Добавить("Ресурс");
	ТаблицаОперандов.Колонки.Добавить("Ссылка");
	ТаблицаОперандов.Колонки.Добавить("Счет");
	ТаблицаОперандов.Колонки.Добавить("ТипЗначения");
	ТаблицаОперандов.Колонки.Добавить("ТипЗначенияПоказателя");
	ТаблицаОперандов.Колонки.Добавить("ТолькоАналитическиеЗначения");
	ТаблицаОперандов.Колонки.Добавить("ЧислоАналитикГруппыРаскрытия");
	
	нСтрокаТаблицыОперандов = ТаблицаОперандов.Добавить();
	ЗаполнитьЗначенияСвойств(нСтрокаТаблицыОперандов, СтрокаОперанд);
	нСтрокаТаблицыОперандов.АналитикВидаОтчета = МаксКлючевыхАналитик;
	нСтрокаТаблицыОперандов.Показатель = СтрокаОперанд.ПотребительРасчета;
	нСтрокаТаблицыОперандов.ПравилаИспользованияПолейЗапроса = тТекущихПравилИспользованияПолейЗапроса;
	нСтрокаТаблицыОперандов.Ресурс = СтрокаОперанд.РесурсРегистра;
	нСтрокаТаблицыОперандов.ЧислоАналитикГруппыРаскрытия = СтрокаОперанд.ЧислоАналитик;
	
	// Добавим строку в таблицу данных
	нСтрокаТаблицы = тТаблицаДанных.Добавить();
	нСтрокаТаблицы.ТаблицаОперандов = ТаблицаОперандов;
	нСтрокаТаблицы.СпособПолучения = СтрокаОперанд.СпособПолучения;
	нСтрокаТаблицы.ТекстЗапроса = СтрокаОперанд.ТекстЗапросаМодуля;
	
	нСтрокаТаблицы.СтруктураЗапроса = Новый Структура;
	
	тТекущихПараметровОтбораБД.Колонки.Добавить("ЗначениеДляПроверки");
	нСтрокаТаблицы.ПравилаВычисленияПараметров = тТекущихПараметровОтбораБД;	
	
КонецПроцедуры	

Процедура ОпределитьПравилаТрансформацииПолей(
	тПоказателиОперанды, 
	тПравилаИспользованияПолейЗапроса, 
	тИспользуемыеАналитики, 
	МаксКлючевыхАналитик, 
	УровниСВременнымРасчетом, 
	МаксУровеньРасчетаПоказателей)
	
	тИспользуемыеКлючевыеАналитики 	= Новый Структура;
	Для Сч = 1 По МаксКлючевыхАналитик Цикл
		тИспользуемыеКлючевыеАналитики.Вставить("Аналитика" + Сч);
	КонецЦикла;	
	ИндексГруппыТрансформации = 1;
	РазличныеГруппыТрансформации = Новый Соответствие;
	
	Для Каждого СтрОперанд Из тПоказателиОперанды Цикл		
		
		ПравилаИспользованияПолейЗапроса = тПравилаИспользованияПолейЗапроса.НайтиСтроки(
			Новый Структура("Ссылка",стрОперанд.ИсточникДанныхДляРасчетов));
		
		МаксимальныйУровеньДополненияАналитик = 0;
		ТекстТрансформацииДополненияАналитик = "";
		ТекстТрансформации = "";			
		
		Для Каждого Поле Из ПравилаИспользованияПолейЗапроса Цикл
			
			Если СтрОперанд.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнешниеДанныеADO
				И (Поле.КодАналитики <> "Значение") Тогда
				
				ТекстТрансформации = ТекстТрансформации+Строка(Перечисления.СпособыЗаполненияПолейИсточника.ПолеИсходнойТаблицы)+"@"+Поле.КодАналитики+"@"+Поле.КодАналитики+";";
				Если стрОперанд.УровеньРасчетаОперанда = 1 Тогда
					Если тИспользуемыеАналитики.НайтиСтроки(Новый Структура("УровеньРасчета,Поле",0,Поле.КодАналитики)).Количество() = 0 Тогда						
						нСтр 						= тИспользуемыеАналитики.Добавить();
						нСтр.УровеньРасчета  		= 0;
						нСтр.Поле 					= Поле.КодАналитики;
						нСтр.ПолеВерсии 			= Ложь;
						нСтр.ПолеТрансформации		= Поле.КодАналитики;
					КонецЕсли;
				КонецЕсли;
				Если тИспользуемыеАналитики.НайтиСтроки(Новый Структура("УровеньРасчета,Поле",стрОперанд.УровеньРасчетаОперанда,Поле.КодАналитики)).Количество() = 0 Тогда					
					нСтр 						= тИспользуемыеАналитики.Добавить();
					нСтр.УровеньРасчета  		= стрОперанд.УровеньРасчетаОперанда;
					нСтр.Поле 					= Поле.КодАналитики;
					нСтр.ПолеВерсии 			= Ложь;				
				КонецЕсли;
			
			ИначеЕсли Поле.СпособЗаполнения = Перечисления.СпособыЗаполненияПолейИсточника.ПустаяСсылка() Тогда
				Продолжить;
				
			ИначеЕсли (Поле.КодАналитики = "Период" ИЛИ Поле.КодАналитики = "Значение")
				И СтрОперанд.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеПроизвольныйЗапрос Тогда
				Продолжить;
				
			ИначеЕсли Поле.СпособЗаполнения = Перечисления.СпособыЗаполненияПолейИсточника.ПолеИсходнойТаблицы И ЗначениеЗаполнено(Поле.Поле) Тогда
				
				Если ЗначениеЗаполнено(СтрОперанд.ПоказательОперанд) Тогда
					// Поле из другого отчета
					ПолеИмя = Поле.Поле;
				Иначе
					// Поле из внешних источников
					ПолеИмя = Поле.КодАналитики;
					Если ПолеИмя = "Значение" Тогда
						Продолжить;
					КонецЕсли;
				КонецЕсли;
				
				ПолеВерсии = тИспользуемыеКлючевыеАналитики.Свойство(Поле.Синоним) ИЛИ СтрНайти(ПолеИмя,"Версия.");
				ПолеИмя = СтрЗаменить(ПолеИмя,"Версия.","");
				
				Если ПолеИмя <> Поле.КодАналитики Тогда				
					// Это трансформация полей
					Если тИспользуемыеАналитики.НайтиСтроки(Новый Структура("УровеньРасчета,Поле",стрОперанд.УровеньРасчетаОперанда,Поле.КодАналитики)).Количество() = 0 Тогда					
						нСтр 						= тИспользуемыеАналитики.Добавить();
						нСтр.УровеньРасчета  		= стрОперанд.УровеньРасчетаОперанда;
						нСтр.Поле 					= Поле.КодАналитики;
						нСтр.ПолеВерсии 			= Ложь;					
					КонецЕсли;				
				Иначе				
					Если тИспользуемыеАналитики.НайтиСтроки(Новый Структура("УровеньРасчета,Поле",стрОперанд.УровеньРасчетаОперанда,ПолеИмя)).Количество() = 0 Тогда						
						нСтр 						= тИспользуемыеАналитики.Добавить();
						нСтр.УровеньРасчета  		= стрОперанд.УровеньРасчетаОперанда;
						нСтр.Поле 					= ПолеИмя;
						нСтр.ПолеВерсии 			= ПолеВерсии;
						нСтр.ПолеТрансформации		= Поле.КодАналитики;
					КонецЕсли;				
				КонецЕсли;
				
				Если стрОперанд.УровеньРасчетаОперанда = 1 Тогда
					Если тИспользуемыеАналитики.НайтиСтроки(Новый Структура("УровеньРасчета,Поле",0,ПолеИмя)).Количество() = 0 Тогда						
						нСтр 						= тИспользуемыеАналитики.Добавить();
						нСтр.УровеньРасчета  		= 0;
						нСтр.Поле 					= ПолеИмя;
						нСтр.ПолеВерсии 			= ПолеВерсии;
						нСтр.ПолеТрансформации		= Поле.КодАналитики;
					КонецЕсли;
				КонецЕсли;
				
				ТекстТрансформации = ТекстТрансформации+Строка(Поле.СпособЗаполнения)+"@"+ПолеИмя+"@"+Поле.КодАналитики+";"
				
			ИначеЕсли Поле.СпособЗаполнения = Перечисления.СпособыЗаполненияПолейИсточника.ФиксированноеЗначение Тогда	   
				
				ТекстТрансформации = ТекстТрансформации+Строка(Поле.СпособЗаполнения)+"@"+ЗначениеВСтрокуВнутр(Поле.ФиксированноеЗначение)+"@"+Поле.КодАналитики+";";
				
				Если тИспользуемыеАналитики.НайтиСтроки(Новый Структура("УровеньРасчета,Поле",стрОперанд.УровеньРасчетаОперанда,Поле.КодАналитики)).Количество() = 0 Тогда					
					нСтр 						= тИспользуемыеАналитики.Добавить();
					нСтр.УровеньРасчета  		= стрОперанд.УровеньРасчетаОперанда;
					нСтр.Поле 					= Поле.КодАналитики;
					нСтр.ПолеВерсии 			= Ложь;				
				КонецЕсли;
				
			ИначеЕсли Поле.СпособЗаполнения = Перечисления.СпособыЗаполненияПолейИсточника.КонтекстОбъектаЗагрузки Тогда
				
				ТекстТрансформации = ТекстТрансформации+Строка(Поле.СпособЗаполнения)+"@"+Строка(Поле.Поле)+"@"+Поле.КодАналитики+";";
				
				Если тИспользуемыеАналитики.НайтиСтроки(Новый Структура("УровеньРасчета,Поле",стрОперанд.УровеньРасчетаОперанда,Поле.КодАналитики)).Количество() = 0 Тогда					
					нСтр 						= тИспользуемыеАналитики.Добавить();
					нСтр.УровеньРасчета  		= стрОперанд.УровеньРасчетаОперанда;
					нСтр.Поле 					= Поле.КодАналитики;
					нСтр.ПолеВерсии 			= Ложь;				
				КонецЕсли;
				
			ИначеЕсли Поле.СпособЗаполнения = Перечисления.СпособыЗаполненияПолейИсточника.ПолеДругогоИсточникаДанных Тогда
				
				ДанныеПоказателя = ОбщегоНазначенияУХ.ЗначенияРеквизитовОбъекта(Поле.ФиксированноеЗначение,"ПоказательОтбор,Код");
				СтрокаПоказателя = тПоказателиОперанды.НайтиСтроки(
				Новый Структура("ПоказательОперанд,КодВФормуле",ДанныеПоказателя.ПоказательОтбор,СокрЛП(ДанныеПоказателя.Код))).Получить(0);
				
				ТекстТрансформацииДополненияАналитик = ТекстТрансформацииДополненияАналитик+Строка(Поле.СпособЗаполнения)
				+"@"+ЗначениеВСтрокуВнутр(СтрокаПоказателя.ПоказательОперанд)
				+"@"+Поле.КодАналитики
				+"@"+СтрокаПоказателя.УровеньРасчетаОперанда+";";
				
				МаксимальныйУровеньДополненияАналитик = Макс(МаксимальныйУровеньДополненияАналитик,СтрокаПоказателя.УровеньРасчетаОперанда);	
				
				Если тИспользуемыеАналитики.НайтиСтроки(Новый Структура("УровеньРасчета,Поле",стрОперанд.УровеньРасчетаОперанда,Поле.КодАналитики)).Количество() = 0 Тогда					
					нСтр 						= тИспользуемыеАналитики.Добавить();
					нСтр.УровеньРасчета  		= стрОперанд.УровеньРасчетаОперанда;
					нСтр.Поле 					= Поле.КодАналитики;
					нСтр.ПолеВерсии 			= Ложь;				
				КонецЕсли;			
				
			КонецЕсли;
			
		КонецЦикла;
		
		Если МаксимальныйУровеньДополненияАналитик > стрОперанд.УровеньРасчетаОперанда Тогда
			
			// Есть дополнения аналитик вышестоящего уровня. Добавим еще один операнд в таблицу.
			НСтрока = тПоказателиОперанды.Добавить();
			ЗаполнитьЗначенияСвойств(НСтрока, стрОперанд); 
			НСтрока.УровеньРасчетаОперанда = МаксимальныйУровеньДополненияАналитик+1;				
			НСтрока.УровеньРасчетаПотребителя = МаксимальныйУровеньДополненияАналитик+1;
			НСтрока.ВариантРасчета = 2;
			
			МаксУровеньРасчетаПоказателей = Макс(МаксУровеньРасчетаПоказателей, НСтрока.УровеньРасчетаПотребителя);
			
			УровниСВременнымРасчетом.Добавить(МаксимальныйУровеньДополненияАналитик);				
			
			стрОперанд.ВременныйРасчет = Истина;
			стрОперанд.ТрансформацияПолей = ТекстТрансформации;
			
		Иначе
			стрОперанд.ТрансформацияПолей = ТекстТрансформации + ТекстТрансформацииДополненияАналитик;
		КонецЕсли;
		
		ГруппаТрансформации = РазличныеГруппыТрансформации.Получить(стрОперанд.ТрансформацияПолей);
		Если ГруппаТрансформации = Неопределено Тогда
			ИндексГруппыТрансформации = ИндексГруппыТрансформации + 1;
			РазличныеГруппыТрансформации.Вставить(стрОперанд.ТрансформацияПолей,ИндексГруппыТрансформации);
			СтрОперанд.УИДГруппыТрансформации = ИндексГруппыТрансформации;
		Иначе
			СтрОперанд.УИДГруппыТрансформации = ГруппаТрансформации;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры	

Процедура ПодготовитьПоляВыборкиЗапроса(СтруктураВозврата)
	
	ДанныеВидаОтчета 				= СтруктураВозврата.ДанныеВидаОтчета;
	тРасшифровкаГруппОтборов		= СтруктураВозврата.тРасшифровкаГруппОтборов;
	МаксКлючевыхАналитик			= СтруктураВозврата.МаксКлючевыхАналитик;
	тПоказателиОперанды 			= СтруктураВозврата.тПоказателиОперанды;
	тИспользуемыеАналитики			= СтруктураВозврата.тИспользуемыеАналитики;
	тИспользуемыеРесурсы			= СтруктураВозврата.тИспользуемыеРесурсы;
	
	// Подготовим соответствие "стандартных" отборов
	СтандартныеОтборы = Новый Соответствие;
	СтандартныеОтборы.Вставить("Валюта",Перечисления.СпособыВычисленияПараметровОперандов.ВалютаОтчета);
	СтандартныеОтборы.Вставить("Организация",Перечисления.СпособыВычисленияПараметровОперандов.ОрганизацияОтчета);
	СтандартныеОтборы.Вставить("Сценарий",Перечисления.СпособыВычисленияПараметровОперандов.СценарийОтчета);
	СтандартныеОтборы.Вставить("ПериодОтчета",Перечисления.СпособыВычисленияПараметровОперандов.ПериодОтчета);
	Если ДанныеВидаОтчета.РазделениеПоПроектам Тогда
		СтандартныеОтборы.Вставить("Проект",Перечисления.СпособыВычисленияПараметровОперандов.ПроектОтчета);
	КонецЕсли;	
	Для ИндПоля = 1 По МаксКлючевыхАналитик Цикл
		СтандартныеОтборы.Вставить("Аналитика" + ИндПоля,Перечисления.СпособыВычисленияПараметровОперандов["Аналитика" + ИндПоля]);
	КонецЦикла;
	
	ИспользуемыеАналитики = Новый Массив;
	Для Каждого СтрПолей Из тИспользуемыеАналитики Цикл
		Если СтрПолей.ПолеТрансформации = "" Тогда
			ИспользуемыеАналитики.Добавить(СтрПолей.Поле);
		Иначе
			ИспользуемыеАналитики.Добавить(СтрПолей.ПолеТрансформации);
		КонецЕсли;
	КонецЦикла;
	
	// Определим уровень расчета для каждого операнда
	Для Каждого СтрОтбор Из тРасшифровкаГруппОтборов Цикл
		
		НайденныеСтроки = тПоказателиОперанды.НайтиСтроки(Новый Структура("ПоказательОперанд,УИДГруппыОтборов",СтрОтбор.ПоказательОперанд,СтрОтбор.УИДГруппыОтборов));
		МинУровень = 999999;
		Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
			МинУровень = Мин(МинУровень,НайденнаяСтрока.УровеньРасчетаОперанда,НайденнаяСтрока.УровеньРасчетаПотребителя);			
		КонецЦикла;
		СтрОтбор.УровеньРасчета = МинУровень;
		
	КонецЦикла;

	// Рекурсивно вычислим поля, которые будут участвовать в отборах таблиц
	УИДОтборов = тРасшифровкаГруппОтборов.Скопировать(,"УИДГруппыОтборов");
	УИДОтборов.Свернуть("УИДГруппыОтборов");	
	Для Каждого СтрУИДГруппыОтборов Из УИДОтборов Цикл
		РассчитатьПоляОтборовРекурсивно(тРасшифровкаГруппОтборов,ИспользуемыеАналитики,СтандартныеОтборы,СтрУИДГруппыОтборов.УИДГруппыОтборов);			
	КонецЦикла;
	
	// Добавим поля, которые участвуют в отборах будущих уровней
	СтрокиПолей = тРасшифровкаГруппОтборов.НайтиСтроки(Новый Структура("ВключаетсяВПоля",Истина));
	Для Каждого СтрОтбор Из СтрокиПолей Цикл
		
		Если СтрОтбор.ПолеБД = "" Тогда
			Продолжить;
		КонецЕсли;
		
		ПерваяТочка = СтрНайти(СтрОтбор.ПолеБД,".");
		Если ПерваяТочка > 0 Тогда
			ПолеБД = Лев(СтрОтбор.ПолеБД,ПерваяТочка-1);
		Иначе
			ПолеБД = СтрОтбор.ПолеБД;
		КонецЕсли;

		Для Сч = 0 По СтрОтбор.УровеньРасчета-1 Цикл
			НайденныеСтроки = тИспользуемыеАналитики.НайтиСтроки(Новый Структура("Поле,УровеньРасчета",ПолеБД,Сч));
			Если НайденныеСтроки.Количество() = 0 Тогда
				НПоле = тИспользуемыеАналитики.Добавить();
				НПоле.Поле = ПолеБД;
				НПоле.ПолеТрансформации = ПолеБД;
				НПоле.УровеньРасчета = Сч;
				НПоле.ПолеВерсии = СтандартныеОтборы.Получить(ПолеБД) <> Неопределено;
			КонецЕсли;
		КонецЦикла;
		
	КонецЦикла;
	
	// Добавим числовые и нечисловые показатели
	Для Каждого СтрПолей Из тПоказателиОперанды Цикл
		
		Если СтрПолей.ТипПотребителя = Перечисления.ТипыЗначенийПоказателейОтчетов.Число Тогда
			Поле = "Значение";
			Суммируется = Истина;
		Иначе
			Поле = "ЗначениеНечисловое";
			Суммируется = Ложь;
		КонецЕсли;
		
		// Добавим текущий уровень потребителя
		Для СчУровень = 1 По СтрПолей.УровеньРасчетаПотребителя Цикл
			НайденныеСтроки = тИспользуемыеРесурсы.НайтиСтроки(Новый Структура("Поле,УровеньРасчета",Поле,СчУровень));
			Если НайденныеСтроки.Количество() = 0 Тогда
				НПоле = тИспользуемыеРесурсы.Добавить();
				НПоле.Поле 				= Поле;			
				НПоле.УровеньРасчета 	= СчУровень;
				НПоле.Суммируется 		= Суммируется;
				НПоле.ВыводитсяВОтчет	= Истина;
			Иначе
				Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
					Если Не НайденнаяСтрока.ВыводитсяВОтчет Тогда
						НайденнаяСтрока.ВыводитсяВОтчет	= Истина;
					КонецЕсли;
				КонецЦикла;					
			КонецЕсли;
		КонецЦикла;
		
		Если СтрПолей.ТипПоказателя = Перечисления.ТипыЗначенийПоказателейОтчетов.Число Тогда
			Поле = "Значение";
			Суммируется = Истина;
		Иначе
			Поле = "ЗначениеНечисловое";
			Суммируется = Ложь;
		КонецЕсли;
		
		Для СчУровень = 1 По СтрПолей.УровеньРасчетаОперанда Цикл
			НайденныеСтроки = тИспользуемыеРесурсы.НайтиСтроки(Новый Структура("Поле,УровеньРасчета",Поле,СчУровень-1));
			Если НайденныеСтроки.Количество() = 0 Тогда
				НПоле = тИспользуемыеРесурсы.Добавить();
				НПоле.Поле 				= Поле;			
				НПоле.УровеньРасчета 	= СчУровень-1;
				НПоле.Суммируется 		= Суммируется;
				НПоле.ВыводитсяВОтчет	= Ложь;
			КонецЕсли;
		КонецЦикла;
		
		Если НЕ ЗначениеЗаполнено(СтрПолей.ПоказательОперанд) Тогда
			СтрПолей.ПоказательОперанд = СтрПолей.Потребитель;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Функция РассчитатьПоляОтборовРекурсивно(тРасшифровкаГруппОтборов,ИспользуемыеАналитики,СтандартныеОтборы,УИДГруппыОтборов,
	ИдентификаторРодителя=0,Знач ВключаетсяВПоля=Ложь)
	
	ОтборГруппОтборов = тРасшифровкаГруппОтборов.НайтиСтроки(
		Новый Структура("УИДГруппыОтборов,ИдентификаторРодителя",УИДГруппыОтборов,ИдентификаторРодителя));
		
	Для Каждого СтрОтбор Из ОтборГруппОтборов Цикл
		
		Если СтрОтбор.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ГруппаИ
			ИЛИ СтрОтбор.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ГруппаИЛИ
			ИЛИ СтрОтбор.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ГруппаНЕ Тогда			
			
			СтрОтбор.ВключаетсяВПоля = РассчитатьПоляОтборовРекурсивно(тРасшифровкаГруппОтборов,ИспользуемыеАналитики,СтандартныеОтборы,УИДГруппыОтборов,СтрОтбор.ИдентификаторСтроки,ВключаетсяВПоля);
				
		Иначе
			
			Если СтрОтбор.УровеньРасчета = 1 Тогда
				Если ИспользуемыеАналитики.Найти(СтрОтбор.ПолеБД) <> Неопределено Тогда
					СтрОтбор.ВключаетсяВПоля = Истина;
				ИначеЕсли Лев(СтрОтбор.ПолеБД,9) = "Аналитика" И СтандартныеОтборы.Получить(СтрОтбор.ПолеБД) = Неопределено Тогда
					// Может быть отбором на показатель с аналитиками
					СтрОтбор.ВключаетсяВПоля = Истина;
				КонецЕсли;
			Иначе
				Если СтандартныеОтборы.Получить(СтрОтбор.ПолеБД) <> СтрОтбор.СпособВычисленияПараметра Тогда
					СтрОтбор.ВключаетсяВПоля = Истина;
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
		Если ИдентификаторРодителя > 0 Тогда
			ВключаетсяВПоля = Макс(СтрОтбор.ВключаетсяВПоля,ВключаетсяВПоля);
		КонецЕсли;
		
	КонецЦикла;
	
	Если ИдентификаторРодителя > 0 Тогда
		Для Каждого СтрОтбор Из ОтборГруппОтборов Цикл
			
			Если СтрОтбор.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ГруппаИ
				ИЛИ СтрОтбор.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ГруппаИЛИ
				ИЛИ СтрОтбор.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ГруппаНЕ Тогда
				
				СтрОтбор.ВключаетсяВПоля = РассчитатьПоляОтборовРекурсивно(тРасшифровкаГруппОтборов,ИспользуемыеАналитики,СтандартныеОтборы,УИДГруппыОтборов,СтрОтбор.ИдентификаторСтроки,ВключаетсяВПоля);
				
			Иначе
				
				СтрОтбор.ВключаетсяВПоля = ВключаетсяВПоля;
				
			КонецЕсли;
				
		КонецЦикла;
	КонецЕсли;
	
	Возврат ВключаетсяВПоля;
	
КонецФункции

#КонецОбласти


#Область ПроцедурыДляГенерацииЗапросаОперандов0Уровня

////////////////////////////////////////////////////////////////////////////////
// Процедуры для генерации текста запроса по операндам 0-го уровня выборки
//  
////////////////////////////////////////////////////////////////////////////////

Процедура СоздатьТаблицуПоказателейОперандов(СтруктураРасчетаПоказателей)
	 
	глТаблицаПересчетаПоказателей 	= СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей;
	тПоказателиОперанды				= СтруктураРасчетаПоказателей.тПоказателиОперанды;
	ЕстьДополненияАналитик			= СтруктураРасчетаПоказателей.ЕстьДополненияАналитик;
	ЕстьЗначениеВалюта				= СтруктураРасчетаПоказателей.ЕстьЗначениеВалюта;
	ЕстьВременныйРасчет				= СтруктураРасчетаПоказателей.УровниСВременнымРасчетом.Количество() > 0;
	
	тПараметрыПакета = ПолучитьОписаниеТаблицыПараметров();
	
	НОтбор 					= тПараметрыПакета.Добавить();
	НОтбор.ИмяОтбора 		= "тПоказателиОперанды";
	НОтбор.ТипОтбора		= Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение;
	НОтбор.ЗначениеОтбора	= тПоказателиОперанды;

	ТекстЗапроса = 
		"ВЫБРАТЬ
		|	ПоказателиОперанды.Потребитель КАК Потребитель,
		|	ПоказателиОперанды.ПоказательОперанд КАК ПоказательОперанд,
		|	ПоказателиОперанды.УровеньРасчетаПотребителя КАК УровеньРасчетаПотребителя,
		|	ПоказателиОперанды.УровеньРасчетаОперанда КАК УровеньРасчетаОперанда,
		|	ПоказателиОперанды.КодВФормуле КАК КодВФормуле,
		|	ПоказателиОперанды.ТипПотребителя КАК ТипПотребителя,
		|	ПоказателиОперанды.ТипПоказателя КАК ТипПоказателя,
		|	ПоказателиОперанды.ТекущийПериод КАК ТекущийПериод,
		|	ПоказателиОперанды.ИндексРегистраПотребителя КАК ИндексРегистраПотребителя,
		|	ПоказателиОперанды.УИДГруппыОтборов КАК УИДГруппыОтборов,
		|	ПоказателиОперанды.УИДГруппыТрансформации КАК УИДГруппыТрансформации,
		|	ПоказателиОперанды.ВидИтога КАК ВидИтога,
		|	ПоказателиОперанды.ВариантРасчета КАК ВариантРасчета %ПоляДополненияАналитик% %ВременныйРасчет% %ПоляЗначенияВалюта%
		|ПОМЕСТИТЬ втПоказателиОперанды
		|ИЗ
		|	&тПоказателиОперанды КАК ПоказателиОперанды
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ТекущийПериод,
		|	УровеньРасчетаПотребителя,
		|	ВариантРасчета,
		|	ПоказательОперанд,
		|	УИДГруппыОтборов,
		|	УИДГруппыТрансформации		
		|;
		|
		|//////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ 
		|	ПоказателиОперанды.ПоказательОперанд,
		|	ПоказателиОперанды.УИДГруппыОтборов,
		|	ПоказателиОперанды.КодВФормуле %ПоляДополненияАналитик%
		|ПОМЕСТИТЬ втПоказателиОперанды0
		|ИЗ
		|	втПоказателиОперанды КАК ПоказателиОперанды
		|ГДЕ
		|	ПоказателиОперанды.УровеньРасчетаОперанда = 1";
	
	Если ЕстьДополненияАналитик Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%ПоляДополненияАналитик%", ",
			|	ПоказателиОперанды.ДляДополненияАналитик КАК ДляДополненияАналитик");
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%ПоляДополненияАналитик%", "");
	КонецЕсли;
	
	Если ЕстьВременныйРасчет Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%ВременныйРасчет%", ",
			|	ПоказателиОперанды.ВременныйРасчет КАК ВременныйРасчет");
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%ВременныйРасчет%", "");
	КонецЕсли;	
	
	Если ЕстьЗначениеВалюта Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%ПоляЗначенияВалюта%", ",
			|	ПоказателиОперанды.ПересчитыватьВалютнуюСумму КАК ПересчитыватьВалютнуюСумму");
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%ПоляЗначенияВалюта%", "");
	КонецЕсли;

	нСтрокаТаблицыЗапросов 								= глТаблицаПересчетаПоказателей.Добавить();
	нСтрокаТаблицыЗапросов.ТекстПодзапросов      		= ТекстЗапроса;
	нСтрокаТаблицыЗапросов.КомментарийКПакету      		= "ТАБЛИЦА ВСЕХ ОПЕРАНДОВ ТЕКУЩЕГО РАСЧЕТА";
	нСтрокаТаблицыЗапросов.тПараметрыПакета 			= тПараметрыПакета;
	нСтрокаТаблицыЗапросов.ВидОперацииРасчета           = Перечисления.ВидыОперацийРасчетаПоказателей.ПолучениеТаблицыОперандов;
	
КонецПроцедуры	

Процедура ПолучитьПодзапросТекущейВерсии(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня)
	
	глТаблицаПересчетаПоказателей   = СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей;
	тИспользуемыеАналитики			= СтруктураРасчетаПоказателей.тИспользуемыеАналитики; 
	тРасшифровкаГруппОтборов  		= СтруктураРасчетаПоказателей.тРасшифровкаГруппОтборов;
	ПолучатьДанныеИзРегистров		= СтруктураРасчетаПоказателей.ПолучатьДанныеИзРегистров;
	
	Если Не ПолучатьДанныеИзРегистров Тогда
		Возврат;
	КонецЕсли;
	
	ВидыОтчетовСинтетика		    = СтруктураПараметровТекущегоУровня.ВидыОтчетовСинтетика;
	УИДГруппыОтборов 				= СтруктураПараметровТекущегоУровня.УИДГруппыОтборов;	
	ИндексРегистра					= СтруктураПараметровТекущегоУровня.ИндексРегистра;
	ПрефиксТаблицыВерсий			= СтруктураПараметровТекущегоУровня.ПрефиксТаблицыВерсий;
	УровеньРасчета					= СтруктураПараметровТекущегоУровня.УровеньРасчета;
	ВидОперацииРасчета				= СтруктураПараметровТекущегоУровня.ВидОперацииРасчета;
	ТекущийПериод					= СтруктураПараметровТекущегоУровня.ТекущийПериод;

	// Сформируем текст отборов
	тПараметрыПакета 		= ПолучитьОписаниеТаблицыПараметров();	
	
	НОтбор 					= тПараметрыПакета.Добавить();
	НОтбор.ИмяОтбора 		= "ВидыОтчетаСинтетика";
	НОтбор.ТипОтбора		= Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение;
	НОтбор.ЗначениеОтбора	= ВидыОтчетовСинтетика;
	
	НОтбор 					= тПараметрыПакета.Добавить();
	НОтбор.ИмяОтбора 		= "ИдентификаторСеанса";
	НОтбор.ТипОтбора		= "КонтекстВызоваЗаполнения";
	НОтбор.ЗначениеОтбора	= "ИдентификаторСеанса";
	
	// Добавим подзапросы в пакет
	НовСтрВерсии 					= глТаблицаПересчетаПоказателей.Добавить();
	НовСтрВерсии.тПараметрыПакета   = тПараметрыПакета;
	НовСтрВерсии.ВидОперацииРасчета = ВидОперацииРасчета;
	
	Если ИндексРегистра = -1 ИЛИ ИндексРегистра = -11 Тогда  
		// Это нечисловые значения. По ним срез по версиям не агрегируется. Просто берем последнюю версию.
				
		ТекстЗапроса = "
		|// ВЕРСИИ НЕЧИСЛОВЫХ
		|
		|ВЫБРАТЬ
		|	МАКСИМУМ(ЗначенияПоказателейОтчетов.Версия.Код) КАК ВерсияКод,
		|	ЗначенияПоказателейОтчетов.Показатель КАК Показатель,
		|	ЗначенияПоказателейОтчетов.Версия.ПериодОтчета КАК ПериодОтчета
		|ПОМЕСТИТЬ втВерсииБазаПредварительная
		|ИЗ
		|	РегистрСведений.ЗначенияПоказателейОтчетовНечисловые КАК ЗначенияПоказателейОтчетов
		|ГДЕ
		|	ЗначенияПоказателейОтчетов.Версия.ВидОтчета В (&ВидыОтчетаСинтетика)
		|	И ЗначенияПоказателейОтчетов.ИтоговоеЗначение = %ИтоговоеЗначение%
		|	И ((НЕ ЗначенияПоказателейОтчетов.Версия.ЧерноваяВерсия) ИЛИ ЗначенияПоказателейОтчетов.Версия.ИдентификаторСеанса = &ИдентификаторСеанса) %ТекстОтбораВерсии% 
		|
		|СГРУППИРОВАТЬ ПО
		|	ЗначенияПоказателейОтчетов.Показатель,
		|	ЗначенияПоказателейОтчетов.Версия.ПериодОтчета
		|;
		|/////////////////////////////////////////////////
		|
		|ВЫБРАТЬ
		|	втВерсииБазаПредварительная.Показатель,
		|	ВерсииЗначенийПоказателей.Ссылка КАК Версия,		
		|	%УИДГруппыОтборов% КАК УИДГруппыОтборов,
		|	%ТекстПериод% КАК ПериодОтчета %ТекстАналитик%
		|ПОМЕСТИТЬ %ПрефиксТаблицыВерсий%%УИДГруппыОтборов%_ИТОГ_%ИтоговоеЗначение%
		|ИЗ
		|	Справочник.ВерсииЗначенийПоказателей КАК ВерсииЗначенийПоказателей
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втВерсииБазаПредварительная КАК втВерсииБазаПредварительная
		|		ПО ВерсииЗначенийПоказателей.Код 			=  втВерсииБазаПредварительная.ВерсияКод
		|		И ВерсииЗначенийПоказателей.ПериодОтчета 	=  втВерсииБазаПредварительная.ПериодОтчета %СоединениеСТаблицейПериодов%
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Версия
		|;
		|/////////////////////////////////////////////////
		|
        |УНИЧТОЖИТЬ втВерсииБазаПредварительная";
		
		Если ИндексРегистра = -1 Тогда
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ИтоговоеЗначение%","ЛОЖЬ");
		Иначе
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ИтоговоеЗначение%","ИСТИНА");
		КонецЕсли;
		
		НовСтрВерсии.КомментарийКПакету = "ВЕРСИИ НЕЧИСЛОВЫХ " + Формат(УИДГруппыОтборов,"ЧН=0; ЧГ=0");
		
	Иначе
		
		ТекстЗапроса = "
		|// ВЕРСИИ ЧИСЛОВЫХ
		|
		|ВЫБРАТЬ
		|	ВерсииЗначенийПоказателей.Ссылка КАК Версия,
		|	%УИДГруппыОтборов% КАК УИДГруппыОтборов,
		|	%ТекстПериод% КАК ПериодОтчета %ТекстАналитик%  
		|ПОМЕСТИТЬ %ПрефиксТаблицыВерсий%%УИДГруппыОтборов%
		|ИЗ
		|	Справочник.ВерсииЗначенийПоказателей КАК ВерсииЗначенийПоказателей %СоединениеСТаблицейПериодов%
		|ГДЕ
		|	ВерсииЗначенийПоказателей.ВидОтчета В (&ВидыОтчетаСинтетика)
		|	И ((НЕ ВерсииЗначенийПоказателей.ЧерноваяВерсия) ИЛИ ВерсииЗначенийПоказателей.ИдентификаторСеанса = &ИдентификаторСеанса) %ТекстОтбора%
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Версия
		|";
		
		НовСтрВерсии.КомментарийКПакету = "ВЕРСИИ ЧИСЛОВЫХ " + Формат(УИДГруппыОтборов,"ЧН=0; ЧГ=0");
		
	КонецЕсли;
	
	// Обработаем периоды
	тСложныеОтборыПоПериоду = ПолучитьОписаниеТаблицыПараметров();
	Если ТекущийПериод Тогда		
		// Найдем отборы по периоду
		НайденныеСтроки = тРасшифровкаГруппОтборов.НайтиСтроки(Новый Структура("УИДГруппыОтборов,ПолеБД",УИДГруппыОтборов,"ПериодОтчета"));
		Если НайденныеСтроки.Количество() = 0 Тогда
			// Отбора по периоду нет
		    НСтрокаОтбор = тСложныеОтборыПоПериоду.Добавить();
			НСтрокаОтбор.ИмяОтбора = "ПериодОтчета";
			НСтрокаОтбор.ТипОтбора = Перечисления.СпособыВычисленияПараметровОперандов.НеИспользуется;
		КонецЕсли;
		// Проверим найденные строки на сложные отборы по периоду
		Для Каждого СтрокаОтбор Из НайденныеСтроки Цикл
			Если СтрокаОтбор.СпособВычисленияПараметра <> Перечисления.СпособыВычисленияПараметровОперандов.ПериодОтчета Тогда
				// Сложный отбор, подготовим данные для таблицы смещения периодов
				НСтрокаОтбор = тСложныеОтборыПоПериоду.Добавить();
				НСтрокаОтбор.ИмяОтбора = "ПериодОтчета";
				НСтрокаОтбор.ТипОтбора = СтрокаОтбор.СпособВычисленияПараметра;
				Если СтрокаОтбор.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеЗначение
					Или СтрокаОтбор.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеСписокЗначений Тогда
					НСтрокаОтбор.ЗначениеОтбора = СтрокаОтбор.ТекстМодуля;
				Иначе
					НСтрокаОтбор.ЗначениеОтбора = СтрокаОтбор.УточнениеСпособаОпределения;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	Если тСложныеОтборыПоПериоду.Количество() Тогда
		
		// Есть сложные отборы по периоду
		ТекстЗапроса = "
		|// СООТВЕТСТВИЕ ПЕРИОДОВ
		|
		|ВЫБРАТЬ
		|	СоответствиеПериодов.ПериодОтчета КАК ПериодОтчета,
		|	СоответствиеПериодов.ПериодИсточник КАК ПериодИсточник
		|ПОМЕСТИТЬ втСоответствиеПериодов%УИДГруппыОтборов%
		|ИЗ &тзСоответствиеПериодов КАК СоответствиеПериодов
		|;
		|/////////////////////////////////////////////////
		|" + ТекстЗапроса;
		
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстПериод%","СоответствиеПериодов.ПериодОтчета");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%СоединениеСТаблицейПериодов%","
		|		ЛЕВОЕ СОЕДИНЕНИЕ втСоответствиеПериодов%УИДГруппыОтборов% КАК СоответствиеПериодов
		|		ПО ВерсииЗначенийПоказателей.ПериодОтчета = СоответствиеПериодов.ПериодИсточник");
		
		НОтбор 					= тПараметрыПакета.Добавить();
		НОтбор.ИмяОтбора 		= "тзСоответствиеПериодов";
		НОтбор.ТипОтбора		= "СоответствиеПериодов";
		НОтбор.ЗначениеОтбора	= тСложныеОтборыПоПериоду;
		
		СтруктураПараметровТекущегоУровня.Вставить("ЕстьСоответствиеПериодов", Истина);
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстПериод%","ВерсииЗначенийПоказателей.ПериодОтчета");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%СоединениеСТаблицейПериодов%","");
		СтруктураПараметровТекущегоУровня.Вставить("ЕстьСоответствиеПериодов", Ложь);
	КонецЕсли;		
	
	ТекстАналитик 	= СформироватьТекстАналитик(тИспользуемыеАналитики,УровеньРасчета,0);
	ТекстОтбора 	= СформироватьТекстОтбора(тРасшифровкаГруппОтборов,тПараметрыПакета,УИДГруппыОтборов);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%УИДГруппыОтборов%",Формат(УИДГруппыОтборов,"ЧН=0; ЧГ=0"));
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ПрефиксТаблицыВерсий%",ПрефиксТаблицыВерсий);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстАналитик%",СтрЗаменить(ТекстАналитик,"%ИмяТаблицы%","ВерсииЗначенийПоказателей"));
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстОтбора%",СтрЗаменить(ТекстОтбора,"%ИмяТаблицы%","ВерсииЗначенийПоказателей"));
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстОтбораВерсии%",СтрЗаменить(ТекстОтбора,"%ИмяТаблицы%","ЗначенияПоказателейОтчетов.Версия"));
	
	НовСтрВерсии.ТекстПодзапросов = ТекстЗапроса;
	
КонецПроцедуры

Процедура ПолучитьТекстЗначенийПоказателей(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня, УстановкаЗначенийПоказателей=Ложь)
	
	тИспользуемыеАналитики 				= СтруктураРасчетаПоказателей.тИспользуемыеАналитики;
	тИспользуемыеРесурсы 				= СтруктураРасчетаПоказателей.тИспользуемыеРесурсы;
	тРасшифровкаГруппОтборов     		= СтруктураРасчетаПоказателей.тРасшифровкаГруппОтборов;
	РасчетПоИзмененнымПоказателям		= СтруктураРасчетаПоказателей.РасчетПоИзмененнымПоказателям;
	ПолучатьДанныеИзРегистров			= СтруктураРасчетаПоказателей.ПолучатьДанныеИзРегистров;
	
	УИДГруппыОтборов 					= СтруктураПараметровТекущегоУровня.УИДГруппыОтборов;
    ИндексРегистра 						= СтруктураПараметровТекущегоУровня.ИндексРегистра;
    ИндексЗапроса 						= СтруктураПараметровТекущегоУровня.ИндексЗапроса;
	тПодзапросыДанных					= СтруктураПараметровТекущегоУровня.тПодзапросыДанных;
	тПараметрыПакета            		= СтруктураПараметровТекущегоУровня.тПараметрыПакета;	
	ПрефиксТаблицыВерсий        		= СтруктураПараметровТекущегоУровня.ПрефиксТаблицыВерсий;	
	УровеньРасчета						= СтруктураПараметровТекущегоУровня.УровеньРасчета;	
	ЕстьСоответствиеПериодов			= СтруктураПараметровТекущегоУровня.ЕстьСоответствиеПериодов;
	
	Если ИндексРегистра = -1 ИЛИ ИндексРегистра = -11 Тогда
	
		// Добавим фильтр и объединение с уже рассчитанными раннее показателями
		ТекстЗапроса = "
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ 
		|	ДанныеРегистра.Показатель КАК Показатель, 
		|	%ТекстПериод% КАК ПериодОтчета %УИДГруппыОтборов% %ТекстДопПолейЛог%
		|//ПОМЕСТИТЬ
		|ИЗ
		|	втЛогИзмененныхПоказателей КАК ДанныеРегистра %СоединениеСТаблицейПериодов% %ТекстВерсииЛог% %ТекстНовыеЗначенияПоказателейЛог%
		|
		|ГДЕ
		|	ДанныеРегистра.ЗначениеНечисловое <> НЕОПРЕДЕЛЕНО
		|	И ДанныеРегистра.Показатель В (%ОтборПоказатель%)
		|	%ТекстОтбораЛог% %ТекстДопОтбораЛог%
		|";
		Если ПолучатьДанныеИзРегистров Тогда
			ТекстЗапроса = ТекстЗапроса + "
			|
			|//ВЛОЖЕННЫЙ ЗАПРОС ОБЪЕДИНИТЬ
			|
			|ВЫБРАТЬ 
			|	ДанныеРегистра.Показатель КАК Показатель, 
			|	ДанныеВерсий.ПериодОтчета КАК ПериодОтчета %УИДГруппыОтборов% %ТекстДопПолей%
			|ИЗ
			|	РегистрСведений.ЗначенияПоказателейОтчетовНечисловые КАК ДанныеРегистра
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ %ИмяТаблицы_Версии%_ИТОГ_%ИтоговоеЗначение% КАК ДанныеВерсий
			|			ПО ДанныеРегистра.Версия = ДанныеВерсий.Версия
			|			И ДанныеРегистра.Показатель = ДанныеВерсий.Показатель
			|			И ДанныеРегистра.Показатель В (%ОтборПоказатель%)
			|		ЛЕВОЕ СОЕДИНЕНИЕ втЛогИзмененныхПоказателей КАК ЛогИзмененныхПоказателей
			|			ПО ДанныеРегистра.Показатель = ЛогИзмененныхПоказателей.Показатель
			|			И ДанныеВерсий.ПериодОтчета = ЛогИзмененныхПоказателей.ПериодОтчета %ТекстСоединенияАналитикЛог% %ТекстОтбораЛогСоединение% %ТекстНовыеЗначенияПоказателей%
			|
			|ГДЕ
			|	ЛогИзмененныхПоказателей.Показатель ЕСТЬ NULL 
			|	И ДанныеРегистра.ИтоговоеЗначение = %ИтоговоеЗначение% %ТекстДопОтбора%
			|";
		КонецЕсли;
		
		Если ИндексРегистра = -1 Тогда
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ИтоговоеЗначение%","ЛОЖЬ");
		Иначе
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ИтоговоеЗначение%","ИСТИНА");
		КонецЕсли;
		
	Иначе
		
		ТекстЗапроса = "
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ 
		|	ДанныеРегистра.Показатель КАК Показатель,  
		|	%ТекстПериод% КАК ПериодОтчета %УИДГруппыОтборов% %ТекстДопПолей%
		|//ПОМЕСТИТЬ
		|ИЗ
		|	втЛогИзмененныхПоказателей КАК ДанныеРегистра %СоединениеСТаблицейПериодов% %ТекстВерсииЛог% %ТекстНовыеЗначенияПоказателейЛог%
		|
		|ГДЕ
		|	ДанныеРегистра.Значение <> 0
		|	И ДанныеРегистра.Показатель В (%ОтборПоказатель%) 
		|	%ТекстОтбораЛог% %ТекстДопОтбораЛог% 
		|";
		Если ПолучатьДанныеИзРегистров Тогда
			ТекстЗапроса = ТекстЗапроса + "
			|
			|//ВЛОЖЕННЫЙ ЗАПРОС ОБЪЕДИНИТЬ
			|
			|ВЫБРАТЬ 
			|	ДанныеРегистра.Показатель КАК Показатель, 
			|	ДанныеВерсий.ПериодОтчета КАК ПериодОтчета %УИДГруппыОтборов% %ТекстДопПолей%			
			|ИЗ
			|	РегистрСведений.%ИмяТаблицы_Регистр% КАК ДанныеРегистра
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ %ИмяТаблицы_Версии% КАК ДанныеВерсий
			|			ПО ДанныеРегистра.Версия = ДанныеВерсий.Версия 
			|			И ДанныеРегистра.Показатель В (%ОтборПоказатель%) %ТекстНовыеЗначенияПоказателей%
			|
			|ГДЕ
			|	ДанныеРегистра.Значение <> 0 %ТекстДопОтбора%			
			|";
		КонецЕсли;
		
	КонецЕсли;	
		
	// Режим установки значений показателей
	Если УстановкаЗначенийПоказателей Тогда		
	
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстНовыеЗначенияПоказателей%","
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (
		|			ВЫБРАТЬ РАЗЛИЧНЫЕ
		|				ЗначенияПоказателей.Показатель,
		|				ЗначенияПоказателей.ПериодОтчета %ТекстАналитик%
		|			ИЗ втЗначенияПотребителейРасчет КАК ЗначенияПоказателей) КАК НовыеЗначенияПоказателей
		|			ПО ДанныеРегистра.Показатель = НовыеЗначенияПоказателей.Показатель
		|			И ДанныеВерсий.ПериодОтчета = НовыеЗначенияПоказателей.ПериодОтчета %ТекстСоединенияАналитик%");
		
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстНовыеЗначенияПоказателейЛог%","
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (
		|			ВЫБРАТЬ РАЗЛИЧНЫЕ
		|				ЗначенияПоказателей.Показатель,
		|				ЗначенияПоказателей.ПериодОтчета %ТекстАналитик%
		|			ИЗ втЗначенияПотребителейРасчет КАК ЗначенияПоказателей) КАК НовыеЗначенияПоказателей
		|			ПО ДанныеРегистра.Показатель = НовыеЗначенияПоказателей.Показатель
		|			И ДанныеРегистра.ПериодОтчета = НовыеЗначенияПоказателей.ПериодОтчета %ТекстСоединенияАналитик%");		
	
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстНовыеЗначенияПоказателей%","");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстНовыеЗначенияПоказателейЛог%","");
	КонецЕсли;	
	
	// Если необходимо, добавим соединение с таблицей соответствия периодов
	Если ЕстьСоответствиеПериодов Тогда		
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстПериод%","СоответствиеПериодов.ПериодОтчета");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%СоединениеСТаблицейПериодов%","
		|		ЛЕВОЕ СОЕДИНЕНИЕ втСоответствиеПериодов" + Формат(УИДГруппыОтборов,"ЧН=0; ЧГ=0") + " КАК СоответствиеПериодов
		|		ПО ДанныеРегистра.ПериодОтчета = СоответствиеПериодов.ПериодИсточник");
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстПериод%","ДанныеРегистра.ПериодОтчета");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%СоединениеСТаблицейПериодов%","");		
	КонецЕсли;
	
	// Установим УИДГруппыОтборов 
	Если УИДГруппыОтборов = 0 Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%УИДГруппыОтборов%","");
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%УИДГруппыОтборов%",",
		|	" + Формат(УИДГруппыОтборов,"ЧН=0; ЧГ=0") + " КАК УИДГруппыОтборов");
	КонецЕсли;
		
	// Подготовим текст аналитик, ресурсов и отборов
	ТекстДополнительныхПолей 	= СформироватьТекстАналитик(тИспользуемыеАналитики,УровеньРасчета) + СформироватьТекстРесурсов(тИспользуемыеРесурсы,УровеньРасчета);
	ТекстДополнительногоОтбора 	= СформироватьТекстОтбора(тРасшифровкаГруппОтборов,тПараметрыПакета,УИДГруппыОтборов,,,Истина);
	ТекстОтбораЛог 				= СформироватьТекстОтбора(тРасшифровкаГруппОтборов,тПараметрыПакета,УИДГруппыОтборов);

	// Имена таблиц
	ТекИндексРегистра = ИндексРегистра; 		
	Если ИндексРегистра = -1 ИЛИ ИндексРегистра = -11 Тогда
		
		// Нечисловые
		ТекИндексРегистра = ПараметрыСеанса.ЧислоДопАналитик;
	
		ТекстДополнительныхПолей 	= СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%.АналитикаВалюта","ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)");
		ТекстДополнительныхПолей 	= СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%.ЗначениеНечисловое","ДанныеРегистра.Значение");
		ТекстДополнительныхПолей 	= СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%.ЗначениеВалюта","0");
		ТекстДополнительныхПолей 	= СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%.Значение","0");
		
	ИначеЕсли ИндексРегистра = -2 Тогда
		
		// Валютные
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ИмяТаблицы_Регистр%","ЗначенияПоказателейОтчетовВалютные");
	
		ТекстДополнительныхПолей 	= СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%.АналитикаВалюта","ДанныеРегистра.АналитикаВалюта");
		ТекстДополнительныхПолей 	= СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%.ЗначениеНечисловое","НЕОПРЕДЕЛЕНО");
		ТекстДополнительныхПолей 	= СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%.Значение","ДанныеРегистра.Значение");				
		
		ТекстДополнительногоОтбора 	= СтрЗаменить(ТекстДополнительногоОтбора,"%ИмяТаблицы%.АналитикаВалюта","ДанныеРегистра.АналитикаВалюта");
		
	ИначеЕсли ИндексРегистра = 0 ИЛИ ИндексРегистра=NULL Тогда
		
		// Синтетика
		ТекстЗапроса 				= СтрЗаменить(ТекстЗапроса,"%ИмяТаблицы_Регистр%","ЗначенияПоказателейОтчетовСинтетика");
		
		ТекстДополнительныхПолей 	= СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%.АналитикаВалюта","ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)");
		ТекстДополнительныхПолей 	= СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%.ЗначениеВалюта","0");
		ТекстДополнительныхПолей 	= СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%.ЗначениеНечисловое","НЕОПРЕДЕЛЕНО");
		ТекстДополнительныхПолей 	= СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%.Значение","ДанныеРегистра.Значение");	
		
	Иначе
		
		// Значения показателей N
		ТекстЗапроса 				= СтрЗаменить(ТекстЗапроса,"%ИмяТаблицы_Регистр%","ЗначенияПоказателейОтчетов"+ИндексРегистра);
		
		ТекстДополнительныхПолей 	= СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%.АналитикаВалюта","ДанныеРегистра.АналитикаВалюта");
		ТекстДополнительныхПолей 	= СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%.ЗначениеНечисловое","НЕОПРЕДЕЛЕНО");
		ТекстДополнительныхПолей 	= СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%.Значение","ДанныеРегистра.Значение");				
		
		ТекстДополнительногоОтбора 	= СтрЗаменить(ТекстДополнительногоОтбора,"%ИмяТаблицы%.АналитикаВалюта","ДанныеРегистра.АналитикаВалюта");
		
	КонецЕсли;
	
	ЕстьПоляВерсии = Ложь;
	ТекстАналитик = "";
	ТекстСоединенияАналитик = "";
	ТекстСоединенияАналитикЛог = "";
	
	тАналитикиТекУровня = тИспользуемыеАналитики.Скопировать(Новый Структура("УровеньРасчета",УровеньРасчета));
	тАналитикиТекУровня.Сортировать("Поле убыв");
	Для Каждого текАналитика Из тАналитикиТекУровня Цикл
		
		Поле = текАналитика.Поле;
		Если Поле = "АналитикаВалюта" Тогда
			Если ИндексРегистра <> 0 Тогда
				ТекстАналитик = ТекстАналитик + ",
				|				ЗначенияПоказателей." + Поле + " КАК " + Поле;
				ТекстСоединенияАналитик = ТекстСоединенияАналитик + "
				|			И ДанныеРегистра." + Поле + " = НовыеЗначенияПоказателей." + Поле;
				ТекстСоединенияАналитикЛог = ТекстСоединенияАналитикЛог + "
				|			И ДанныеРегистра." + Поле + " = ЛогИзмененныхПоказателей." + Поле;
			КонецЕсли;
		ИначеЕсли Лев(Поле,9) = "Аналитика" Тогда
			Инд = Число(Сред(Поле,10,1));
			Если ТекИндексРегистра < Инд Тогда
				ТекстДополнительныхПолей = СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%." + Поле,"НЕОПРЕДЕЛЕНО");
			Иначе
				ТекстДополнительныхПолей = СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%." + Поле,"ДанныеРегистра." + Поле);
				ТекстДополнительногоОтбора = СтрЗаменить(ТекстДополнительногоОтбора,"%ИмяТаблицы%." + Поле,"ДанныеРегистра." + Поле);
				ТекстАналитик = ТекстАналитик + ",
				|				ЗначенияПоказателей." + Поле + " КАК " + Поле;
				ТекстСоединенияАналитик = ТекстСоединенияАналитик + "
				|			И ДанныеРегистра." + Поле + " = НовыеЗначенияПоказателей." + Поле;
				ТекстСоединенияАналитикЛог = ТекстСоединенияАналитикЛог + "
				|			И ДанныеРегистра." + Поле + " = ЛогИзмененныхПоказателей." + Поле;
			КонецЕсли;
		ИначеЕсли Поле = "ПериодОтчета" Тогда
			Продолжить;
		Иначе 
			ЕстьПоляВерсии = Истина;
		КонецЕсли;
		
		Если текАналитика.ПолеВерсии Тогда
			ЕстьПоляВерсии = Истина;
		КонецЕсли;
		
	КонецЦикла;
	
	Если ЕстьПоляВерсии Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстВерсииЛог%",",
		|	%ИмяТаблицы_Версии% КАК ДанныеВерсий");
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстВерсииЛог%","");
	КонецЕсли;
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ИмяТаблицы_Версии%",ПрефиксТаблицыВерсий + Формат(УИДГруппыОтборов,"ЧН=0; ЧГ=0"));
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстАналитик%",ТекстАналитик);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстСоединенияАналитик%",ТекстСоединенияАналитик);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстСоединенияАналитикЛог%",ТекстСоединенияАналитикЛог);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстДопПолей%",СтрЗаменить(ТекстДополнительныхПолей,"%ИмяТаблицы%","ДанныеВерсий"));
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстДопПолейЛог%",СтрЗаменить(ТекстДополнительныхПолей,"ДанныеРегистра.Значение КАК ЗначениеНечисловое","ДанныеРегистра.ЗначениеНечисловое КАК ЗначениеНечисловое"));
	ТекстДополнительногоОтбора = СтрЗаменить(ТекстДополнительногоОтбора,"%ИмяТаблицы%","ДанныеВерсий");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстДопОтбора%",ТекстДополнительногоОтбора);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстДопОтбораЛог%",СтрЗаменить(ТекстДополнительногоОтбора,"ДанныеВерсий.ПериодОтчета","ДанныеРегистра.ПериодОтчета"));
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ОтборПоказатель%","&ОтборПоказателей_"+Формат(УИДГруппыОтборов,"ЧН=0; ЧГ=0")+"_ИндексЗапроса_"+Формат(ИндексЗапроса,"ЧН=0; ЧГ=0"));
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстОтбораЛог%", СтрЗаменить(ТекстОтбораЛог,"%ИмяТаблицы%","ДанныеРегистра"));
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстОтбораЛогСоединение%", СтрЗаменить(ТекстОтбораЛог,"%ИмяТаблицы%","ЛогИзмененныхПоказателей"));
	
	НовСтрДанные 							= тПодзапросыДанных.Добавить();
	НовСтрДанные.НомерПодзапроса 			= тПодзапросыДанных.Количество();
	НовСтрДанные.ТекстПодзапроса 			= ТекстЗапроса;                              
	НовСтрДанные.КомментарийКПодзапросу 	= "ПОДЗАПРОС ДЛЯ ПОЛУЧЕНИЯ ДАННЫХ " + Формат(УИДГруппыОтборов,"ЧН=0; ЧГ=0");
	
КонецПроцедуры	

Процедура ПодготовитьЗапросУровня0(СтруктураРасчетаПоказателей)
	
	глТаблицаПересчетаПоказателей	= СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей;
	тРасшифровкаГруппОтборов       	= СтруктураРасчетаПоказателей.тРасшифровкаГруппОтборов;
	тКэшИменПоказателей 			= СтруктураРасчетаПоказателей.тКэшИменПоказателей;
	тКэшГруппОтборовПоказателей 	= СтруктураРасчетаПоказателей.тКэшГруппОтборовПоказателей;
	
	// Подготовим структуру параметров для расчета текущего уровня	
	СтруктураПараметровТекущегоУровня = Новый Структура;

	тПодзапросыДанных = ПолучитьОписаниеТаблицыПодзапроса();
	СтруктураПараметровТекущегоУровня.Вставить("тПодзапросыДанных",тПодзапросыДанных);
	
	тПодзапросыДанныхВТ = ПолучитьОписаниеТаблицыПодзапроса();
	СтруктураПараметровТекущегоУровня.Вставить("тПодзапросыДанныхВТ",тПодзапросыДанныхВТ);
	
	тПараметрыПакета = ПолучитьОписаниеТаблицыПараметров();
	СтруктураПараметровТекущегоУровня.Вставить("тПараметрыПакета",тПараметрыПакета);
	
	тПараметрыПакетаВТ = ПолучитьОписаниеТаблицыПараметров();
	СтруктураПараметровТекущегоУровня.Вставить("тПараметрыПакетаВТ",тПараметрыПакетаВТ);	
	
	// Запросы для получения данных из регистров и справочников
	ПодготовитьТаблицуВнутренниеДанные(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня);
	
	// Запросы для получения данных из произвольного запроса
	ПодготовитьТекстЗапросаПоПроизвольномуЗапросу(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня);
	
	// Запросы для получения данных из внешних источников
	ПодготовитьТекстЗапросаПоИсточникуВнешнему(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня);
	
	// Запросы для получения данных рассчитанных произвольным кодом
	ПодготовитьТекстЗапросаПоПроизвольномуКоду(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня);

	// Запросы для получения данных из показателей отчетов	
	ВидыОтчетовСинтетика = тКэшИменПоказателей.Скопировать();
	ВидыОтчетовСинтетика.Свернуть("ВидОтчета");
	СтруктураПараметровТекущегоУровня.Вставить("ВидыОтчетовСинтетика",ВидыОтчетовСинтетика.ВыгрузитьКолонку("ВидОтчета"));
	СтруктураПараметровТекущегоУровня.Вставить("ПрефиксТаблицыВерсий","втВерсииБаза_");
	СтруктураПараметровТекущегоУровня.Вставить("УровеньРасчета",0);
	СтруктураПараметровТекущегоУровня.Вставить("ВидОперацииРасчета",Перечисления.ВидыОперацийРасчетаПоказателей.ПолучениеЗначенийОперандов);
    СтруктураПараметровТекущегоУровня.Вставить("ТекущийПериод",Истина);
	СтруктураПараметровТекущегоУровня.Вставить("ЕстьСоответствиеПериодов",Ложь);
	
	// Получим запросы подъема данных
	КэшИменПоказателейТек = тКэшИменПоказателей.Скопировать();
	КэшИменПоказателейТек.Свернуть("УИДГруппыОтборов,Показатель,УровеньРасчета");	
	Для Каждого СтрГруппаУИД Из тКэшГруппОтборовПоказателей Цикл
		
		ПоказателиТекущейОбласти = КэшИменПоказателейТек.Скопировать(Новый Структура("УИДГруппыОтборов,УровеньРасчета",СтрГруппаУИД.УИДГруппыОтборов,1)).ВыгрузитьКолонку("Показатель");
		Если ПоказателиТекущейОбласти.Количество() = 0 Тогда
			 Продолжить;
		КонецЕсли;
		
		// Получим запрос для версий
		СтруктураПараметровТекущегоУровня.Вставить("УИДГруппыОтборов",СтрГруппаУИД.УИДГруппыОтборов);
        СтруктураПараметровТекущегоУровня.Вставить("ИндексРегистра",СтрГруппаУИД.ИндексРегистра);
		СтруктураПараметровТекущегоУровня.Вставить("ТекущийПериод",СтрГруппаУИД.ТекущийПериод);
		СтруктураПараметровТекущегоУровня.Вставить("ИндексЗапроса",0);
		
		ПолучитьПодзапросТекущейВерсии(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня); 			
		ПолучитьТекстЗначенийПоказателей(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня);
		
		НОтбор 					= тПараметрыПакета.Добавить();
		НОтбор.ИмяОтбора 		= "ОтборПоказателей_"+Формат(СтрГруппаУИД.УИДГруппыОтборов,"ЧН=0; ЧГ=0")+"_ИндексЗапроса_0";
		НОтбор.ТипОтбора 		= Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение;
		НОтбор.ЗначениеОтбора	= ПоказателиТекущейОбласти;
		НОтбор.УИДГруппыОтбора  = СтрГруппаУИД.УИДГруппыОтборов;
		
	КонецЦикла;
	
	Если тПодзапросыДанныхВТ.Количество() > 0 Тогда
		нСтрокаТаблицыЗапросов 						= глТаблицаПересчетаПоказателей.Добавить();
		нСтрокаТаблицыЗапросов.ТекстПодзапросов     = ПолучитьТекстПоТаблицеПодзапросовВТ(тПодзапросыДанныхВТ);
		нСтрокаТаблицыЗапросов.КомментарийКПакету 	= "ВРЕМЕННЫЕ ТАБЛИЦЫ ДЛЯ ПОЛУЧЕНИЯ ДАННЫХ ВНЕШНИХ ТАБЛИЦ";
	    нСтрокаТаблицыЗапросов.тПараметрыПакета     = тПараметрыПакетаВТ;
		нСтрокаТаблицыЗапросов.ВидОперацииРасчета   = Перечисления.ВидыОперацийРасчетаПоказателей.ВнешниеТаблицы;
	КонецЕсли;
	
	нСтрокаТаблицыЗапросов 						= глТаблицаПересчетаПоказателей.Добавить();
	нСтрокаТаблицыЗапросов.ТекстПодзапросов     = ПолучитьТекстПоТаблицеПодзапросов(тПодзапросыДанных,"втПоказателиРаскрытия0");
	нСтрокаТаблицыЗапросов.КомментарийКПакету 	= "ЗАПРОС ДЛЯ ПОДЪЕМА ОПЕРАНДОВ УРОВНЯ - 0";
    нСтрокаТаблицыЗапросов.тПараметрыПакета     = тПараметрыПакета;
	нСтрокаТаблицыЗапросов.ВидОперацииРасчета   = Перечисления.ВидыОперацийРасчетаПоказателей.ПолучениеЗначенийОперандов;
	
	ПодготовитьТекстТрансформацииТекущегоУровня(СтруктураРасчетаПоказателей, 0);
	
КонецПроцедуры

Процедура ПодготовитьТекстТрансформацииТекущегоУровня(СтруктураРасчетаПоказателей, УровеньРасчета)
	
	глТаблицаПересчетаПоказателей 	= СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей;
	тПоказателиОперанды				= СтруктураРасчетаПоказателей.тПоказателиОперанды;
	тИспользуемыеАналитики			= СтруктураРасчетаПоказателей.тИспользуемыеАналитики;
	тИспользуемыеРесурсы            = СтруктураРасчетаПоказателей.тИспользуемыеРесурсы;
	МаксКлючевыхАналитик			= СтруктураРасчетаПоказателей.МаксКлючевыхАналитик;
	МаксИспользуемыхАналитик		= СтруктураРасчетаПоказателей.МаксИспользуемыхАналитик;
	МаксУровеньРучныхРасчетов		= СтруктураРасчетаПоказателей.МаксУровеньРучныхРасчетов;
	ЕстьДополненияАналитик			= СтруктураРасчетаПоказателей.ЕстьДополненияАналитик;
	тРасшифровкаГруппОтборов		= СтруктураРасчетаПоказателей.тРасшифровкаГруппОтборов;

	тПараметрыПакета 	= ПолучитьОписаниеТаблицыПараметров();
	тПодзапросыДанных 	= ПолучитьОписаниеТаблицыПодзапроса();
	
	// Тексты аналитик, ресурсов и группировок
	глСтруктураИспользуемыхАналитик = Новый Структура;
	тГруппыИтоговыхПоказателейТекущегоУровня = тПоказателиОперанды.Скопировать(Новый Структура("УровеньРасчетаОперанда",УровеньРасчета+1));
	
	ТекстРесурсовПолей = СформироватьТекстРесурсов(тИспользуемыеРесурсы,УровеньРасчета,2) + СформироватьТекстАналитик(тИспользуемыеАналитики,УровеньРасчета+1,2,Истина);
	ТекстРесурсовПолей = СтрЗаменить(ТекстРесурсовПолей,"%ИмяТаблицы%","ПоказателиРаскрытия"); 
		
	ТекстРесурсовПолейГруппировка = СформироватьТекстРесурсов(тИспользуемыеРесурсы,УровеньРасчета,3) + СформироватьТекстАналитик(тИспользуемыеАналитики,УровеньРасчета+1,3,Истина);; 
	ТекстРесурсовПолейГруппировка = СтрЗаменить(ТекстРесурсовПолейГруппировка,"%ИмяТаблицы%","ПоказателиРаскрытия");
	
	ЕстьАналитикаВалюта = тИспользуемыеАналитики.Скопировать(Новый Структура("УровеньРасчета,Поле",УровеньРасчета+1,"АналитикаВалюта")).Количество() > 0;
		
	// Тексты запросов
	Если УровеньРасчета = 0 Тогда
		
		ТекстШаблонЗапроса = "
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|	
		|ВЫБРАТЬ
		|   %КодВФормуле% КАК КодВФормуле,
		|	ПоказателиРаскрытия.Показатель КАК Показатель,
		|	ПоказателиРаскрытия.ПериодОтчета КАК ПериодОтчета,
		|	ПоказателиРаскрытия.УИДГруппыОтборов КАК УИДГруппыОтборов %ТекстАналитикРесурсов%
		|//ПОМЕСТИТЬ
		|ИЗ
		|	втПоказателиРаскрытия0 КАК ПоказателиРаскрытия
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втПоказателиОперанды0 КАК ПоказателиОперанды
		|		ПО ПоказателиРаскрытия.Показатель = ПоказателиОперанды.ПоказательОперанд
		|			И ПоказателиРаскрытия.УИДГруппыОтборов = ПоказателиОперанды.УИДГруппыОтборов
		|	%СоединениеДругиеИсточники%
		|
		|ГДЕ 
		|	ПоказателиОперанды.КодВФормуле В (&%ОтборПоказателей%)
		|
		|СГРУППИРОВАТЬ ПО
		|   %КодВФормуле%,
		|	ПоказателиРаскрытия.Показатель,
		|	ПоказателиРаскрытия.УИДГруппыОтборов,
		|	ПоказателиРаскрытия.ПериодОтчета %ТекстАналитикРесурсовГруппировка%";
		
		Если ЕстьДополненияАналитик Тогда
			ТекстШаблонЗапроса = СтрЗаменить(ТекстШаблонЗапроса, "%КодВФормуле%", "ВЫБОР
			|		КОГДА ПоказателиОперанды.ДляДополненияАналитик 
			|			ТОГДА """"
			|		ИНАЧЕ ПоказателиОперанды.КодВФормуле
			|	КОНЕЦ");
		Иначе
			ТекстШаблонЗапроса = СтрЗаменить(ТекстШаблонЗапроса, "%КодВФормуле%", "ПоказателиОперанды.КодВФормуле");
		КонецЕсли;
		
		тГруппыИтоговыхПоказателей = тГруппыИтоговыхПоказателейТекущегоУровня.Скопировать(,"ТрансформацияПолей");
		тГруппыИтоговыхПоказателей.Свернуть("ТрансформацияПолей");		
		
	Иначе
		
		ТекстШаблонЗапроса = "
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|	
		|ВЫБРАТЬ
		|	ПоказателиРаскрытия.Показатель КАК Показатель,
		|	ПоказателиРаскрытия.ПериодОтчета КАК ПериодОтчета,
		|	%УИДГруппыОтборов% КАК УИДГруппыОтборов,
		|	%УИДГруппыТрансформации% КАК УИДГруппыТрансформации %ТекстАналитикРесурсов%
		|//ПОМЕСТИТЬ
		|ИЗ
		|	втПоказателиРаскрытия%УровеньРасчета% КАК ПоказателиРаскрытия
		|	%СоединениеДругиеИсточники%
		|
		|ГДЕ 
		|	ПоказателиРаскрытия.Показатель В (&%ОтборПоказателей%)
		|	%ТекстОтбора%
		|
		|СГРУППИРОВАТЬ ПО
		|	ПоказателиРаскрытия.Показатель,
		|	ПоказателиРаскрытия.ПериодОтчета %ТекстАналитикРесурсовГруппировка%";
		
		тГруппыИтоговыхПоказателей = тГруппыИтоговыхПоказателейТекущегоУровня.Скопировать(,"УИДГруппыОтборов,УИДГруппыТрансформации");
		тГруппыИтоговыхПоказателей.Свернуть("УИДГруппыОтборов,УИДГруппыТрансформации");
		
	КонецЕсли;
	
	Для Каждого СтрГруппа Из тГруппыИтоговыхПоказателей Цикл
		
		ТекстПодзапроса 			= ТекстШаблонЗапроса;
		СоединениеДругиеИсточники	= "";
		
		Если УровеньРасчета = 0 Тогда
			ПоказателиТекущейГруппы = тГруппыИтоговыхПоказателейТекущегоУровня.Скопировать(
				Новый Структура("ТрансформацияПолей",СтрГруппа.ТрансформацияПолей),"КодВФормуле").ВыгрузитьКолонку("КодВФормуле");
			ТрансформацияПолей = СтрГруппа.ТрансформацияПолей;			
		Иначе
			ПоказателиТекущейГруппы = тГруппыИтоговыхПоказателейТекущегоУровня.Скопировать(
				Новый Структура("УИДГруппыОтборов,УИДГруппыТрансформации",СтрГруппа.УИДГруппыОтборов,СтрГруппа.УИДГруппыТрансформации),"ПоказательОперанд").ВыгрузитьКолонку("ПоказательОперанд");
			ТрансформацияПолей	=  тГруппыИтоговыхПоказателейТекущегоУровня.Найти(СтрГруппа.УИДГруппыТрансформации,"УИДГруппыТрансформации").ТрансформацияПолей;
			
			ТекстОтбора = СформироватьТекстОтбора(тРасшифровкаГруппОтборов,тПараметрыПакета,СтрГруппа.УИДГруппыОтборов,,,Истина);
        	ТекстОтбора = СтрЗаменить(ТекстОтбора,"%ИмяТаблицы%","ПоказателиРаскрытия");
			ТекстПодзапроса = СтрЗаменить(ТекстПодзапроса,"%ТекстОтбора%",ТекстОтбора);
			
			ТекстПодзапроса = СтрЗаменить(ТекстПодзапроса,"%УИДГруппыОтборов%",Формат(СтрГруппа.УИДГруппыОтборов,"ЧН=0; ЧГ=0"));
			ТекстПодзапроса = СтрЗаменить(ТекстПодзапроса,"%УИДГруппыТрансформации%",Формат(СтрГруппа.УИДГруппыТрансформации,"ЧН=0; ЧГ=0"));
			ТекстПодзапроса = СтрЗаменить(ТекстПодзапроса,"%УровеньРасчета%",УровеньРасчета);
			
		КонецЕсли;
		
		// Установим отбор по показателям
		НОтбор 					= тПараметрыПакета.Добавить();
		НОтбор.ИмяОтбора 		= "ОтборПоказателейДляТрансформации_"+СтрЗаменить(Новый УникальныйИдентификатор,"-","");
		НОтбор.ТипОтбора 		= Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение;
		НОтбор.ЗначениеОтбора	= ПоказателиТекущейГруппы;
		
		ТекстПодзапроса			= СтрЗаменить(ТекстПодзапроса,"%ОтборПоказателей%",НОтбор.ИмяОтбора);
		
		// Подготовим текст по аналитикам 
		Для Инд = МаксКлючевыхАналитик+1 По МаксИспользуемыхАналитик Цикл
			СтруктураИспользованияПолей = Новый Структура;
			СтруктураИспользованияПолей.Вставить("ТекстАналитик",",
			|	НЕОПРЕДЕЛЕНО КАК Аналитика"+Инд);
			СтруктураИспользованияПолей.Вставить("ТекстГруппировкиАналитик","");
			глСтруктураИспользуемыхАналитик.Вставить("Аналитика"+Инд,СтруктураИспользованияПолей);			
		КонецЦикла;
		Если ЕстьАналитикаВалюта Тогда
			СтруктураИспользованияПолей = Новый Структура;
			СтруктураИспользованияПолей.Вставить("ТекстАналитик",",
			|	ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка) КАК АналитикаВалюта");
			СтруктураИспользованияПолей.Вставить("ТекстГруппировкиАналитик","");
			глСтруктураИспользуемыхАналитик.Вставить("АналитикаВалюта",СтруктураИспользованияПолей);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ТрансформацияПолей) Тогда
			
			ПравилаИспользованияАналитик = СтрРазделить(ТрансформацияПолей,";");
			
			Для Каждого СтрПравило Из ПравилаИспользованияАналитик Цикл
				
				Если ЗначениеЗаполнено(СтрПравило) Тогда
					
					ЗначенияПравилИспользованияПолей = СтрРазделить(СтрПравило,"@");
					
					Если ЗначенияПравилИспользованияПолей[0] = "Поле источника" Тогда
						
						ТекстАналитик = ",
						|	ПоказателиРаскрытия."+СтрЗаменить(ЗначенияПравилИспользованияПолей[1],".","")+" КАК "+ЗначенияПравилИспользованияПолей[2];
						
						ТекстГруппировкиАналитик = ",
						|	ПоказателиРаскрытия."+СтрЗаменить(ЗначенияПравилИспользованияПолей[1],".","");
						
						СтруктураИспользованияПолей = Новый Структура;
						СтруктураИспользованияПолей.Вставить("ТекстАналитик",ТекстАналитик);
						СтруктураИспользованияПолей.Вставить("ТекстГруппировкиАналитик",ТекстГруппировкиАналитик);
						глСтруктураИспользуемыхАналитик.Вставить(ЗначенияПравилИспользованияПолей[2],СтруктураИспользованияПолей);						
						
					ИначеЕсли ЗначенияПравилИспользованияПолей[0] = "Фиксированное значение" Тогда
						
						нПараметр = ДобавитьПараметрВПакет(тПараметрыПакета,
							Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение,
							ЗначениеИзСтрокиВнутр(СтрЗаменить(ЗначенияПравилИспользованияПолей[1],".","")),
							ЗначенияПравилИспользованияПолей[2]);
		    						
						ТекстАналитик = ",
						|	&" + нПараметр.ИмяОтбора + " КАК " + ЗначенияПравилИспользованияПолей[2];
						
						СтруктураИспользованияПолей = Новый Структура;
						СтруктураИспользованияПолей.Вставить("ТекстАналитик",ТекстАналитик);
						СтруктураИспользованияПолей.Вставить("ТекстГруппировкиАналитик","");
						глСтруктураИспользуемыхАналитик.Вставить(ЗначенияПравилИспользованияПолей[2],СтруктураИспользованияПолей);
						
					ИначеЕсли ЗначенияПравилИспользованияПолей[0] = "Контекст вызова заполнения" Тогда
						
						нПараметр = ДобавитьПараметрВПакет(тПараметрыПакета,
							"КонтекстВызоваЗаполнения",
							ЗначенияПравилИспользованияПолей[1],
							ЗначенияПравилИспользованияПолей[2]);
					
						ТекстАналитик = ",
						|	&" + нПараметр.ИмяОтбора + " КАК " + ЗначенияПравилИспользованияПолей[2];
						
						СтруктураИспользованияПолей = Новый Структура;
						СтруктураИспользованияПолей.Вставить("ТекстАналитик",ТекстАналитик);
						СтруктураИспользованияПолей.Вставить("ТекстГруппировкиАналитик","");
						глСтруктураИспользуемыхАналитик.Вставить(ЗначенияПравилИспользованияПолей[2],СтруктураИспользованияПолей);
						
					ИначеЕсли ЗначенияПравилИспользованияПолей[0] = "Поле другого источника" Тогда
						
						Показатель = ЗначениеИзСтрокиВнутр(СтрЗаменить(ЗначенияПравилИспользованияПолей[1],".",""));
						ИмяАналитики = ЗначенияПравилИспользованияПолей[2];
						нПараметр = ДобавитьПараметрВПакет(тПараметрыПакета,
							Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение,
							Показатель,
							"Показатель");							
						
						УровеньРасчетаИсточник = Число(ЗначенияПравилИспользованияПолей[3])-1;
						Если УровеньРасчетаИсточник = УровеньРасчета Тогда
							ТаблицаИсточник = "втПоказателиРаскрытия" + УровеньРасчетаИсточник;
						Иначе
							ТаблицаИсточник = "втЗначенияОперандов" + УровеньРасчетаИсточник;
						КонецЕсли;
							
						СоединениеДругиеИсточники = СоединениеДругиеИсточники + "
							|	ЛЕВОЕ СОЕДИНЕНИЕ 
							|		(ВЫБРАТЬ РАЗЛИЧНЫЕ
							|			ЗначенияОперандов.ПериодОтчета КАК ПериодОтчета,
							|			ЗначенияОперандов." + ИмяАналитики + " КАК " + ИмяАналитики + "
							|		ИЗ
							|			" + ТаблицаИсточник + " КАК ЗначенияОперандов
							|		ГДЕ
							|			ЗначенияОперандов.Показатель = &" + нПараметр.ИмяОтбора + ") КАК ПоказателиРаскрытияДругиеИсточники_" + ИмяАналитики + "
							|		ПО ПоказателиРаскрытияДругиеИсточники_" + ИмяАналитики + ".ПериодОтчета = ПоказателиРаскрытия.ПериодОтчета";
					
						ТекстАналитик = ",
						|	ISNULL(ПоказателиРаскрытияДругиеИсточники_" + ИмяАналитики + "."+ИмяАналитики+",НЕОПРЕДЕЛЕНО) КАК "+ИмяАналитики;
						
						ТекстГруппировкиАналитик = ",
						|	ISNULL(ПоказателиРаскрытияДругиеИсточники_" + ИмяАналитики + "."+ИмяАналитики+",НЕОПРЕДЕЛЕНО)";
						
						СтруктураИспользованияПолей = Новый Структура;
						СтруктураИспользованияПолей.Вставить("ТекстАналитик",ТекстАналитик);
						СтруктураИспользованияПолей.Вставить("ТекстГруппировкиАналитик",ТекстГруппировкиАналитик);
						глСтруктураИспользуемыхАналитик.Вставить(ИмяАналитики,СтруктураИспользованияПолей);
					
					КонецЕсли;	 
					
				КонецЕсли;	
				
			КонецЦикла;	
			
		КонецЕсли;
		
		ТекстАналитикРесурсов 				= ТекстРесурсовПолей;
		ТекстАналитикРесурсовГруппировка 	= ТекстРесурсовПолейГруппировка;
		Для Каждого СтрАналитика Из глСтруктураИспользуемыхАналитик Цикл
			ТекстАналитикРесурсов				= ТекстАналитикРесурсов + СтрАналитика.Значение.ТекстАналитик;
			ТекстАналитикРесурсовГруппировка    = ТекстАналитикРесурсовГруппировка + СтрАналитика.Значение.ТекстГруппировкиАналитик;
		КонецЦикла;
		
		ТекстПодзапроса = СтрЗаменить(ТекстПодзапроса,"%ТекстАналитикРесурсов%",ТекстАналитикРесурсов);
		ТекстПодзапроса = СтрЗаменить(ТекстПодзапроса,"%ТекстАналитикРесурсовГруппировка%",ТекстАналитикРесурсовГруппировка);
		ТекстПодзапроса = СтрЗаменить(ТекстПодзапроса,"%СоединениеДругиеИсточники%",СоединениеДругиеИсточники);
		
		// Добавим подзапрос в таблицу
		НовСтрДанные 							= тПодзапросыДанных.Добавить();		
		НовСтрДанные.НомерПодзапроса 			= тПодзапросыДанных.Количество();
		НовСтрДанные.ТекстПодзапроса 			= ТекстПодзапроса;                              
		НовСтрДанные.КомментарийКПодзапросу 	= "ПОДЗАПРОС ДЛЯ ПОЛУЧЕНИЯ СГУППИРОВАННЫХ ДАННЫХ ПО ПРАВИЛУ " + ТрансформацияПолей;
	
	КонецЦикла;
	
	НовСтрТаб 								= глТаблицаПересчетаПоказателей.Добавить();
	НовСтрТаб.ТекстПодзапросов 				= ПолучитьТекстПоТаблицеПодзапросов(тПодзапросыДанных,"втЗначенияОперандов"+УровеньРасчета);                              
	НовСтрТаб.КомментарийКПакету 			= "СГРУППИРОВАННЫЕ И ПРЕОБРАЗОВАННЫЕ ДАННЫЕ ОПЕРАНДОВ УРОВНЯ - " + УровеньРасчета;
	НовСтрТаб.тПараметрыПакета 				= тПараметрыПакета;
	НовСтрТаб.ВидОперацииРасчета           	= Перечисления.ВидыОперацийРасчетаПоказателей.ТрансформацияОперандов;
	НовСтрТаб.ВыгружатьРезультатВТаблицу	= УровеньРасчета < МаксУровеньРучныхРасчетов;
	
КонецПроцедуры	

#КонецОбласти


#Область ПроцедурыГенерацииЗапросовРегистровИСправочниковВнутр

////////////////////////////////////////////////////////////////////////////////
// Процедуры для подготовки текстов запросов для подъема данных из регистров и справочников
//  
////////////////////////////////////////////////////////////////////////////////

Процедура ДобавитьТаблицуПериодов(СтруктураПараметров)
	
	тПараметрыПакетаВТ		= СтруктураПараметров.тПараметрыПакетаВТ;
	тПодзапросыДанныхВТ		= СтруктураПараметров.тПодзапросыДанныхВТ;
	
	// Добавим временную таблицу с периодами
	Если тПодзапросыДанныхВТ.Найти("ПЕРИОДЫ","КомментарийКПодзапросу") = Неопределено Тогда
		
		ТекстЗапроса = 
		"ВЫБРАТЬ
		|	Периоды.ДатаНачала КАК ДатаНачала,
		|	Периоды.ДатаОкончания КАК ДатаОкончания,
		|	Периоды.Ссылка КАК ПериодОтчета		
		|ПОМЕСТИТЬ втПериоды
		|ИЗ
		|	Справочник.Периоды КАК Периоды
		|ГДЕ
		|	Периоды.Периодичность = &ПериодичностьОтчета
		|	И Периоды.ДатаНачала МЕЖДУ &НачалоПериодаОтчета И &КонецПериодаОтчета";
		
		НСтрокаДанные = тПодзапросыДанныхВТ.Вставить(0);
		НСтрокаДанные.НомерПодзапроса = 1;
		НСтрокаДанные.ТекстПодзапроса = ТекстЗапроса;                              
		НСтрокаДанные.КомментарийКПодзапросу = "ПЕРИОДЫ";
		
		ДобавитьПараметрВПакет(тПараметрыПакетаВТ, Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчета,,"НачалоПериодаОтчета");
		ДобавитьПараметрВПакет(тПараметрыПакетаВТ, Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаПериодаОтчета,,"КонецПериодаОтчета");
		ДобавитьПараметрВПакет(тПараметрыПакетаВТ, "ПериодичностьОтчета",,"ПериодичностьОтчета");
		
	КонецЕсли;
	
КонецПроцедуры

Функция ПривестиПериод(СтрокаДата,СпособВычисленияПараметра,Знач УточнениеСпособаОпределения,ПривестиКНачалуПериода = Ложь)
	
	Если СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчета Тогда
		
		Возврат "НАЧАЛОПЕРИОДА(" + СтрокаДата + ", %ПериодичностьОтчета%)";
		
	ИначеЕсли СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаПериодаОтчета Тогда
		
		Если ПривестиКНачалуПериода Тогда
			Возврат ПривестиПериод(СтрокаДата,Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчета,УточнениеСпособаОпределения);
		КонецЕсли;
		
		Возврат "КОНЕЦПЕРИОДА(" + СтрокаДата + ", %ПериодичностьОтчета%)";
		
	ИначеЕсли СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаВышестоящегоПериода Тогда
		
		Если УточнениеСпособаОпределения = Перечисления.Периодичность.ДевятьМесяцев Тогда
			ТекстОшибки = НСтр("ru = 'Дата начала вышестоящего периода с типом ""Девять месяцев"" не поддерживается'");
			ВызватьИсключение(ТекстОшибки);
		КонецЕсли;
		
		Если УточнениеСпособаОпределения = Неопределено Тогда
			УточнениеСпособаОпределения = "%ПериодичностьОтчета%";
		КонецЕсли;
		
		Возврат "НАЧАЛОПЕРИОДА(" + СтрокаДата + ", " + УточнениеСпособаОпределения + ")";
		
	ИначеЕсли СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаВышестоящегоПериода Тогда
		
		Если УточнениеСпособаОпределения = Перечисления.Периодичность.ДевятьМесяцев Тогда
			ТекстОшибки = НСтр("ru = 'Дата конца вышестоящего периода с типом ""Девять месяцев"" не поддерживается'");
			ВызватьИсключение(ТекстОшибки);
		КонецЕсли;
		
		Если ПривестиКНачалуПериода Тогда
			Возврат ПривестиПериод(СтрокаДата,Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаВышестоящегоПериода,УточнениеСпособаОпределения);
		КонецЕсли;
		
		Если УточнениеСпособаОпределения = Неопределено Тогда
			УточнениеСпособаОпределения = "%ПериодичностьОтчета%";
		КонецЕсли;
		
		Возврат "КОНЕЦПЕРИОДА(" + СтрокаДата + ", " + УточнениеСпособаОпределения + ")";
		
	ИначеЕсли СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГода Тогда
		
		Возврат "НАЧАЛОПЕРИОДА(" + СтрокаДата + ", ГОД)";
		
	ИначеЕсли СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГода Тогда
		
		Если ПривестиКНачалуПериода Тогда
			Возврат ПривестиПериод(СтрокаДата,Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГода,УточнениеСпособаОпределения);
		КонецЕсли;
		
		Возврат "КОНЕЦПЕРИОДА(" + СтрокаДата + ", ГОД)";
		
	ИначеЕсли СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчетаСоСдвигом Тогда
		
		Если УточнениеСпособаОпределения = Неопределено ИЛИ УточнениеСпособаОпределения = 0 Тогда
			Возврат ПривестиПериод(СтрокаДата,Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчета,УточнениеСпособаОпределения);
		КонецЕсли;
		
		Возврат "ДОБАВИТЬКДАТЕ(" + СтрокаДата + ", %ПериодичностьОтчета%, " + Формат(УточнениеСпособаОпределения,"ЧН=0; ЧГ=0") + ")";
		
	ИначеЕсли СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаПериодаОтчетаСоСдвигом Тогда
		
		Если ПривестиКНачалуПериода Тогда
			Возврат ПривестиПериод(СтрокаДата,Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчетаСоСдвигом,УточнениеСпособаОпределения);
		КонецЕсли;
		
		Если УточнениеСпособаОпределения = Неопределено ИЛИ УточнениеСпособаОпределения = 0 Тогда
			Возврат ПривестиПериод(СтрокаДата,Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаПериодаОтчета,УточнениеСпособаОпределения);
		КонецЕсли;
			
		Возврат "КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(" + СтрокаДата + ", %ПериодичностьОтчета%, " + Формат(УточнениеСпособаОпределения,"ЧН=0; ЧГ=0") + "), %ПериодичностьОтчета%)";
		
	ИначеЕсли СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГодаСоСдвигом Тогда
		
		Если УточнениеСпособаОпределения = Неопределено ИЛИ УточнениеСпособаОпределения = 0 Тогда
			Возврат ПривестиПериод(СтрокаДата,Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГода,УточнениеСпособаОпределения);
		КонецЕсли;
				
		Возврат "ДОБАВИТЬКДАТЕ(НАЧАЛОПЕРИОДА(" + СтрокаДата + ", ГОД), ГОД, " + Формат(УточнениеСпособаОпределения,"ЧН=0; ЧГ=0") + ")";
		
	ИначеЕсли СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГодаСоСдвигом Тогда
		
		Если ПривестиКНачалуПериода Тогда
			Возврат ПривестиПериод(СтрокаДата,Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГодаСоСдвигом,УточнениеСпособаОпределения);;
		КонецЕсли;
		
		Если УточнениеСпособаОпределения = Неопределено ИЛИ УточнениеСпособаОпределения = 0 Тогда
			Возврат ПривестиПериод(СтрокаДата,Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГода,УточнениеСпособаОпределения);
		КонецЕсли;
				
		Возврат "ДОБАВИТЬКДАТЕ(КОНЕЦПЕРИОДА(" + СтрокаДата + ", ГОД), ГОД, " + Формат(УточнениеСпособаОпределения,"ЧН=0; ЧГ=0") + ")";
		
	Иначе
		
		Возврат "";
		
	КонецЕсли;
	
КонецФункции

Функция ШаблонЗапросаВнутрРегистрНакоплений(ДанныеДляРасчета)

	// Найдем условия вычисления периода регистра даты начала
	ПараметрПериодДН = ДанныеДляРасчета.ТаблицаПараметровОтбораБД.Найти("ДатаНач","ПолеБД");
	Если ПараметрПериодДН = Неопределено Тогда
		ТекстОшибки = НСтр("ru = 'Не найден обязательный отбор ""ДатаНач""'");
		ВызватьИсключение(ТекстОшибки);
	КонецЕсли;
	Если Не ЗначениеЗаполнено(ПараметрПериодДН.СпособВычисленияПараметра) Тогда
		ТекстОшибки = НСтр("ru = 'Не заполнен способ вычисления параметра для отбора ""ДатаНач""'");
		ВызватьИсключение(ТекстОшибки);
	КонецЕсли;
	
	// Найдем условия вычисления периода регистра даты окончания
	ПараметрПериодДК = ДанныеДляРасчета.ТаблицаПараметровОтбораБД.Найти("ДатаКон","ПолеБД");
	Если ПараметрПериодДК = Неопределено Тогда
		ТекстОшибки = НСтр("ru = 'Не найден обязательный отбор ""ДатаКон""'");
		ВызватьИсключение(ТекстОшибки);
	КонецЕсли;
	Если Не ЗначениеЗаполнено(ПараметрПериодДК.СпособВычисленияПараметра) Тогда
		ТекстОшибки = НСтр("ru = 'Не заполнен способ вычисления параметра для отбора ""ДатаКон"" источника данных %1'");
		ВызватьИсключение(ТекстОшибки);
	КонецЕсли;	

	// Сформируем тексты запросов
	Если ДанныеДляРасчета.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеРегистрНакопления Тогда
		
		Если ДанныеДляРасчета.Свойство("ЕстьОстатки") Тогда
			
			ТекстЗапросаВТ = "
			|ВЫБРАТЬ
			|	Периоды.ДатаНачала КАК ДатаНачала,
			|	Периоды.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсы%	
			|ПОМЕСТИТЬ втДанныеРегистра_%УИД%
			|ИЗ
			|	втПериоды КАК Периоды
			|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.%ИмяТаблицы%.ОстаткиИОбороты(%ОтборДатаНач%,%ОтборДатаКон%,%ПериодичностьОтчета%,,
			|		%ОтборВТ%) КАК ТаблицаДанных
			|		ПО %ТекстПериодСоединение%
			|		%ОтборПоПериоду%
			|;
			|
			|/////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	МаксимальныеНеПустыеПериоды.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсыОстатки% 
			|ПОМЕСТИТЬ втДанные_%УИД%
			|ИЗ
			|	(ВЫБРАТЬ
			|		МАКСИМУМ(ТаблицаДанных.ДатаНачала) КАК ДатаНачала,
			|		Данные.ПериодОтчета КАК ПериодОтчета %ТекстАналитики%
			|	ИЗ
			|		втДанныеРегистра_%УИД% КАК Данные
			|			ЛЕВОЕ СОЕДИНЕНИЕ втДанныеРегистра_%УИД% КАК ТаблицаДанных
			|			ПО Данные.ДатаНачала >= ТаблицаДанных.ДатаНачала
			|	ГДЕ %ТекстРесурсыУсловиеНО%
			|	
			|	СГРУППИРОВАТЬ ПО
			|		Данные.ПериодОтчета %ТекстАналитикиГруппировка%) КАК МаксимальныеНеПустыеПериоды
			|		ЛЕВОЕ СОЕДИНЕНИЕ втДанныеРегистра_%УИД% КАК ТаблицаДанных
			|		ПО ТаблицаДанных.ДатаНачала = МаксимальныеНеПустыеПериоды.ДатаНачала %ТекстАналитикиСоединение%";
			Если ДанныеДляРасчета.Свойство("ЕстьОбороты") Тогда
				ТекстЗапросаВТ = ТекстЗапросаВТ + "
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ТаблицаДанных.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсыОбороты% 
				|ИЗ
				|	втДанныеРегистра_%УИД% КАК ТаблицаДанных";
			КонецЕсли;			
						
		Иначе
				
			Если ДанныеДляРасчета.ОсновнаяТаблицаРегистра Тогда
				
				ТекстЗапросаВТ = "
				|ВЫБРАТЬ
				|	Периоды.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсы%	
				|ПОМЕСТИТЬ втДанные_%УИД%
				|ИЗ
				|	втПериоды КАК Периоды
				|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.%ИмяТаблицы% КАК ТаблицаДанных
				|		ПО %ТекстПериодСоединение%
				|		%Отбор% %ОтборПоПериоду%
				|";
				
			Иначе
				
				ТекстЗапросаВТ = "
				|ВЫБРАТЬ
				|	Периоды.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсы%	
				|ПОМЕСТИТЬ втДанные_%УИД%
				|ИЗ
				|	втПериоды КАК Периоды
				|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.%ИмяТаблицы%.Обороты(%ОтборДатаНач%,%ОтборДатаКон%,%ПериодичностьОтчета%,
				|		%ОтборВТ%) КАК ТаблицаДанных
				|		ПО %ТекстПериодСоединение%
				|		%ОтборПоПериоду%
				|";
					
			КонецЕсли;
				
		КонецЕсли;		
				
	ИначеЕсли ДанныеДляРасчета.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеРегистрБухгалтерии Тогда
		
		Если ДанныеДляРасчета.Свойство("ЕстьОстатки") Тогда
				
			ТекстЗапросаВТ = "
			|ВЫБРАТЬ
			|	ПоказателиСчета.НомерСреза КАК НомерСреза,
			|	ПоказателиСчета.Показатель КАК Показатель,
			|	ПоказателиСчета.УИДГруппыОтборов КАК УИДГруппыОтборов,
			|	ПоказателиСчета.Счет КАК Счет
			|ПОМЕСТИТЬ втПоказателиСчета_%УИД% 
			|	ИЗ &ПоказателиСчета_%УИД% КАК ПоказателиСчета
			|;
			|
			|/////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ТаблицаДанных.Счет КАК Счет,
			|	Периоды.ДатаНачала КАК ДатаНачала,
			|	Периоды.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсы%	
			|ПОМЕСТИТЬ втДанныеРегистра_%УИД%
			|ИЗ
			|	втПериоды КАК Периоды
			|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии.%ИмяТаблицы%.ОстаткиИОбороты(%ОтборДатаНач%, %ОтборДатаКон%, %ПериодичностьОтчета%, , 
			|		Счет В (&Счета_%УИД%), , %ОтборВТ%) КАК ТаблицаДанных
			|		ПО %ТекстПериодСоединение%
			|		%ОтборПоПериоду%
			|;
			|
			|/////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ТаблицаДанных.Счет,
			|	МаксимальныеНеПустыеПериоды.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсыОстатки% 
			|ПОМЕСТИТЬ втДанные_%УИД%
			|ИЗ
			|	(ВЫБРАТЬ
			|		МАКСИМУМ(ТаблицаДанных.ДатаНачала) КАК ДатаНачала,
			|		Данные.ПериодОтчета КАК ПериодОтчета %ТекстАналитики%
			|	ИЗ
			|		втДанныеРегистра_%УИД% КАК Данные
			|			ЛЕВОЕ СОЕДИНЕНИЕ втДанныеРегистра_%УИД% КАК ТаблицаДанных
			|			ПО Данные.ДатаНачала >= ТаблицаДанных.ДатаНачала
			|	ГДЕ %ТекстРесурсыУсловиеНО%
			|	
			|	СГРУППИРОВАТЬ ПО
			|		Данные.ПериодОтчета %ТекстАналитикиГруппировка%) КАК МаксимальныеНеПустыеПериоды
			|		ЛЕВОЕ СОЕДИНЕНИЕ втДанныеРегистра_%УИД% КАК ТаблицаДанных
			|		ПО ТаблицаДанных.ДатаНачала = МаксимальныеНеПустыеПериоды.ДатаНачала %ТекстАналитикиСоединение%
			|";
			Если ДанныеДляРасчета.Свойство("ЕстьОбороты") Тогда
				ТекстЗапросаВТ = ТекстЗапросаВТ + "
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ТаблицаДанных.Счет,
				|	ТаблицаДанных.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсыОбороты% 
				|ИЗ
				|	втДанныеРегистра_%УИД% КАК ТаблицаДанных";
			КонецЕсли;			
						
		Иначе
			
			Если ДанныеДляРасчета.КорреспонденцияСчетов Тогда
				
				ТекстЗапросаВТ = "
				|ВЫБРАТЬ
				|	ПоказателиСчета.НомерСреза КАК НомерСреза,
				|	ПоказателиСчета.Показатель КАК Показатель,
				|	ПоказателиСчета.УИДГруппыОтборов КАК УИДГруппыОтборов,
				|	ПоказателиСчета.Счет КАК Счет,
				|	ПоказателиСчета.КоррСчет КАК КоррСчет
				|ПОМЕСТИТЬ втПоказателиСчета_%УИД%
				|	ИЗ &ПоказателиСчета_%УИД% КАК ПоказателиСчета
				|;
				|
				|/////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ТаблицаДанных.СчетДт КАК Счет,
				|	ТаблицаДанных.СчетКт КАК КоррСчет,
				|	Периоды.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсы%	
				|ПОМЕСТИТЬ втДанные_%УИД%
				|ИЗ
				|	втПериоды КАК Периоды
				|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии.%ИмяТаблицы%.ОборотыДтКт(%ОтборДатаНач%, %ОтборДатаКон%, %ПериодичностьОтчета%, 
				|		СчетДт В (&Счета_%УИД%), , СчетКт В (&СчетаКт_%УИД%), , %ОтборВТ%) КАК ТаблицаДанных
				|		ПО %ТекстПериодСоединение%
				|		%ОтборПоПериоду%
				|";			
					
			Иначе
				
				ТекстЗапросаВТ = "
				|ВЫБРАТЬ
				|	ПоказателиСчета.НомерСреза КАК НомерСреза,
				|	ПоказателиСчета.Показатель КАК Показатель,
				|	ПоказателиСчета.УИДГруппыОтборов КАК УИДГруппыОтборов,
				|	ПоказателиСчета.Счет КАК Счет
				|ПОМЕСТИТЬ втПоказателиСчета_%УИД% 
				|	ИЗ &ПоказателиСчета_%УИД% КАК ПоказателиСчета
				|;
				|
				|/////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ТаблицаДанных.Счет КАК Счет,
				|	Периоды.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсы%	
				|ПОМЕСТИТЬ втДанные_%УИД%
				|ИЗ
				|	втПериоды КАК Периоды
				|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии.%ИмяТаблицы%.Обороты(%ОтборДатаНач%, %ОтборДатаКон%, %ПериодичностьОтчета%, 
				|		Счет В (&Счета_%УИД%), , %ОтборВТ%, ,) КАК ТаблицаДанных
				|		ПО %ТекстПериодСоединение%
				|		%ОтборПоПериоду%
				|";			

			КонецЕсли;
				
		КонецЕсли;		
	
	КонецЕсли; 
			
	// Сформируем текст соединения с таблицей Периоды		
	Если (ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.Дата
		ИЛИ ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеЗначение
		ИЛИ ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.НеИспользуется)			
		И (ПараметрПериодДК.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.Дата
		ИЛИ ПараметрПериодДК.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеЗначение
		ИЛИ ПараметрПериодДК.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.НеИспользуется) Тогда
		
		// 1. Все даты фиксированы
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодичностьОтчета%","");
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ТекстПериодСоединение%","ИСТИНА");		
		
		// Тексты запросов сформированы
		Возврат ТекстЗапросаВТ;
		
	ИначеЕсли (ПараметрПериодДК.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.Дата
		ИЛИ ПараметрПериодДК.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеЗначение) Тогда
		
		// 2. Дата окончания фиксирована
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодичностьОтчета%","ЧАС");
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ТекстПериодСоединение%","ТаблицаДанных.Период МЕЖДУ "
			+ ПривестиПериод("Периоды.ДатаНачала",ПараметрПериодДН.СпособВычисленияПараметра,ПараметрПериодДН.УточнениеСпособаОпределения)
			+ " И %ОтборДатаКон%");
			
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ОтборДатаНач%",
			ПривестиПериод("&НачалоПериодаОтчета",ПараметрПериодДН.СпособВычисленияПараметра,ПараметрПериодДН.УточнениеСпособаОпределения));
			
		// Тексты запросов сформированы
		Возврат ТекстЗапросаВТ;
		
	ИначеЕсли ПараметрПериодДК.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.НеИспользуется Тогда
		
		// 3. Дата окончания не задана
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодичностьОтчета%","ЧАС");
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ТекстПериодСоединение%","ТаблицаДанных.Период >= "
			+ ПривестиПериод("Периоды.ДатаНачала",ПараметрПериодДН.СпособВычисленияПараметра,ПараметрПериодДН.УточнениеСпособаОпределения));
			
		// Тексты запросов сформированы
		Возврат ТекстЗапросаВТ;	
		
	ИначеЕсли (ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.Дата
		ИЛИ ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеЗначение) Тогда
		
		// 4. Дата начала фиксирована
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодичностьОтчета%","ЧАС");
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ТекстПериодСоединение%","ТаблицаДанных.Период МЕЖДУ %ОтборДатаНач% И "
			+ ПривестиПериод("КОНЕЦПЕРИОДА(Периоды.ДатаОкончания,%ПериодичностьОтчета%)",ПараметрПериодДК.СпособВычисленияПараметра,ПараметрПериодДК.УточнениеСпособаОпределения));	
			
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ОтборДатаКон%",
			ПривестиПериод("&НачалоПериодаОтчета",ПараметрПериодДН.СпособВычисленияПараметра,ПараметрПериодДН.УточнениеСпособаОпределения));
			
		// Тексты запросов сформированы
		Возврат ТекстЗапросаВТ;
		
	ИначеЕсли ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.НеИспользуется Тогда
		
		// 4. Дата начала не задана
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодичностьОтчета%","ЧАС");
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ТекстПериодСоединение%","ТаблицаДанных.Период <= "
			+ ПривестиПериод("КОНЕЦПЕРИОДА(Периоды.ДатаОкончания,%ПериодичностьОтчета%)",ПараметрПериодДК.СпособВычисленияПараметра,ПараметрПериодДК.УточнениеСпособаОпределения));	
			
		// Тексты запросов сформированы
		Возврат ТекстЗапросаВТ;	
		
	ИначеЕсли (ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчета
		И ПараметрПериодДК.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаПериодаОтчета)
		ИЛИ (ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчетаСоСдвигом
		И ПараметрПериодДК.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаПериодаОтчетаСоСдвигом
		И ПараметрПериодДК.УточнениеСпособаОпределения = ПараметрПериодДН.УточнениеСпособаОпределения)
		ИЛИ (ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГода
		И ПараметрПериодДК.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГода)
		ИЛИ (ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГодаСоСдвигом
		И ПараметрПериодДК.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГодаСоСдвигом
		И ПараметрПериодДК.УточнениеСпособаОпределения = ПараметрПериодДН.УточнениеСпособаОпределения)
		ИЛИ (ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаВышестоящегоПериода
		И ПараметрПериодДК.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаВышестоящегоПериода) Тогда
		
		// 5. Периодичность отборов дат совпадает с периодичностью получения данных
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ТекстПериодСоединение%",ПривестиПериод("Периоды.ДатаНачала",
			ПараметрПериодДН.СпособВычисленияПараметра,ПараметрПериодДН.УточнениеСпособаОпределения,Истина) 
			+ " = НАЧАЛОПЕРИОДА(ТаблицаДанных.Период,%ПериодичностьОтчета%)");				
	
	Иначе	
		
		// 6. Сложный случай с произвольными отборами по периоду
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодичностьОтчета%","ЧАС");
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ТекстПериодСоединение%","ТаблицаДанных.Период МЕЖДУ "
			+ СтрЗаменить(
				ПривестиПериод("Периоды.ДатаНачала",ПараметрПериодДН.СпособВычисленияПараметра,ПараметрПериодДН.УточнениеСпособаОпределения),
				"%ПериодичностьОтчета%","%ПериодичностьОтчетаДН%")
			+ " И " 
			+ СтрЗаменить(
				ПривестиПериод("КОНЕЦПЕРИОДА(Периоды.ДатаОкончания,%ПериодичностьОтчета%)",ПараметрПериодДК.СпособВычисленияПараметра,ПараметрПериодДК.УточнениеСпособаОпределения),
				"%ПериодичностьОтчета%","%ПериодичностьОтчетаДК%"));		
	
	КонецЕсли;	
	
	// Установим параметры по периоду
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ОтборДатаНач%",
		ПривестиПериод("&НачалоПериодаОтчета",ПараметрПериодДН.СпособВычисленияПараметра,ПараметрПериодДН.УточнениеСпособаОпределения));
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ОтборДатаКон%",
		ПривестиПериод("&КонецПериодаОтчета",ПараметрПериодДК.СпособВычисленияПараметра,ПараметрПериодДК.УточнениеСпособаОпределения));

	// Изменим периодичность отчета, если это необходимо
	Если ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаВышестоящегоПериода 
		ИЛИ ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаВышестоящегоПериода Тогда
		
		Если ЗначениеЗаполнено(ПараметрПериодДН.УточнениеСпособаОпределения) Тогда
			ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодичностьОтчета%",ПараметрПериодДН.УточнениеСпособаОпределения);
			ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодичностьОтчетаДН%",ПараметрПериодДН.УточнениеСпособаОпределения);
		КонецЕсли;
		
	ИначеЕсли ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГода
		ИЛИ ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГода
		ИЛИ ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГодаСоСдвигом
		ИЛИ ПараметрПериодДН.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГодаСоСдвигом Тогда
		
	 	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодичностьОтчета%","ГОД");
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодичностьОтчетаДН%","ГОД");
		
	КонецЕсли;
	
	Если ПараметрПериодДК.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаВышестоящегоПериода Тогда
		
		Если ЗначениеЗаполнено(ПараметрПериодДК.УточнениеСпособаОпределения) Тогда
			ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодичностьОтчетаДК%",ПараметрПериодДК.УточнениеСпособаОпределения);
		КонецЕсли;
		
	ИначеЕсли ПараметрПериодДК.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГода
		ИЛИ ПараметрПериодДК.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГодаСоСдвигом Тогда
		
		ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодичностьОтчетаДК%","ГОД");
		
	КонецЕсли;	
	
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодичностьОтчетаДН%","%ПериодичностьОтчета%");
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодичностьОтчетаДК%","%ПериодичностьОтчета%");
	
	Возврат ТекстЗапросаВТ;
	
КонецФункции 

Функция ШаблонЗапросаВнутрРегистрСведений(ДанныеДляРасчета)
	
	Если ЗначениеЗаполнено(ДанныеДляРасчета.ВидСреза) Тогда
		
		// Найдем условия вычисления периода периодического регистра
		ПараметрПериод = ДанныеДляРасчета.ТаблицаПараметровОтбораБД.Найти("ДатаНач","ПолеБД");
		Если ПараметрПериод = Неопределено Тогда
			ТекстОшибки = СтрШаблон(НСтр("ru = 'Не найден обязательный отбор ""ДатаНач""'"));
			ВызватьИсключение(ТекстОшибки);
		КонецЕсли;
		СпособВычисленияПараметра = ПараметрПериод.СпособВычисленияПараметра;
		Если Не ЗначениеЗаполнено(СпособВычисленияПараметра) Тогда
			ТекстОшибки = СтрШаблон(НСтр("ru = 'Не заполнен способ вычисления параметра для отбора ""ДатаНач""'"));
			ВызватьИсключение(ТекстОшибки);
		КонецЕсли;
		
		Если СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.Дата
			Или СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеЗначение
			Или СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.НеИспользуется Тогда
			
			ТекстЗапросаВТ = "
			|ВЫБРАТЬ
			|	Периоды.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсы%
			|ПОМЕСТИТЬ втДанные_%УИД%
			|ИЗ
			|	втПериоды КАК Периоды
			|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.%ИмяТаблицы%.%ВидСреза%(
			|		%ОтборДатаНач%, 
			|		%ОтборВТ%) КАК ТаблицаДанных
			|		ПО ИСТИНА
			|";
			
			ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ВидСреза%",ДанныеДляРасчета.ВидСреза);
			
		Иначе
			
			Если ДанныеДляРасчета.ВидСреза = "СрезПоследних" Тогда				
				
				ТекстЗапросаВТ = " 
				|ВЫБРАТЬ
				|	%ОтборДатаНач% КАК Период,
				|	НАЧАЛОПЕРИОДА(%ОтборДатаНач%, %ПериодичностьОтчета%) КАК ДатаДляСреза %ТекстАналитики% %ТекстРесурсы%
				|ПОМЕСТИТЬ втДанныеРегистра_%УИД%
				|ИЗ
				|	РегистрСведений.%ИмяТаблицы%.СрезПоследних(
				|			%ОтборДатаНач%,
				|			%ОтборВТ%) КАК ТаблицаДанных
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ТаблицаДанных.Период КАК Период,
				|	ВЫБОР
				|		КОГДА ТаблицаДанных.Период = НАЧАЛОПЕРИОДА(ТаблицаДанных.Период, %ПериодичностьОтчета%)
				|			ТОГДА ТаблицаДанных.Период
				|		ИНАЧЕ НАЧАЛОПЕРИОДА(%ПериодРСДляСреза%, %ПериодичностьОтчета%) 
				|	КОНЕЦ КАК ДатаДляСреза %ТекстАналитики% %ТекстРесурсы%
				|ИЗ
				|	РегистрСведений.%ИмяТаблицы% КАК ТаблицаДанных
				|
				|ГДЕ
				|	ТаблицаДанных.Период МЕЖДУ ДОБАВИТЬКДАТЕ(%ОтборДатаНач%, СЕКУНДА, 1) И %ОтборДатаКон%
				|	%Отбор%
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	Периоды.ДатаНачала КАК ДатаНачала,
				|	Периоды.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсы%
				|ПОМЕСТИТЬ втДанныеРегистраСПериодами_%УИД%
				|ИЗ
				|	втПериоды КАК Периоды
				|		ЛЕВОЕ СОЕДИНЕНИЕ втДанныеРегистра_%УИД% КАК ТаблицаДанных
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
				|				МАКСИМУМ(ТаблицаДанных.Период) КАК МаксимальныйПериод,
				|				ТаблицаДанных.ДатаДляСреза КАК ДатаДляСреза %ТекстАналитики%
				|			ИЗ
				|				втДанныеРегистра_%УИД% КАК ТаблицаДанных
				|			
				|			СГРУППИРОВАТЬ ПО
				|				ТаблицаДанных.ДатаДляСреза %ТекстАналитикиГруппировка%
				|			) КАК МаксимальныеНеПустыеПериоды
				|			ПО ТаблицаДанных.Период = МаксимальныеНеПустыеПериоды.МаксимальныйПериод
				|				И ТаблицаДанных.ДатаДляСреза = МаксимальныеНеПустыеПериоды.ДатаДляСреза %ТекстАналитикиСоединение% 
				|		ПО %ТекстПериодСоединение% = ТаблицаДанных.ДатаДляСреза  
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	МаксимальныеНеПустыеПериоды.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсы%
				|ПОМЕСТИТЬ втДанные_%УИД%
				|ИЗ
				|	(ВЫБРАТЬ
				|		Данные.ПериодОтчета КАК ПериодОтчета,
				|		МАКСИМУМ(ТаблицаДанных.ДатаНачала) КАК ДатаНачала %ТекстАналитики%
				|	ИЗ
				|		втДанныеРегистраСПериодами_%УИД% КАК Данные
				|			ЛЕВОЕ СОЕДИНЕНИЕ втДанныеРегистраСПериодами_%УИД% КАК ТаблицаДанных
				|			ПО Данные.ДатаНачала >= ТаблицаДанных.ДатаНачала
				|	ГДЕ %ТекстРесурсыУсловие%
				|	
				|	СГРУППИРОВАТЬ ПО
				|		Данные.ПериодОтчета %ТекстАналитикиГруппировка%) КАК МаксимальныеНеПустыеПериоды
				|		ЛЕВОЕ СОЕДИНЕНИЕ втДанныеРегистраСПериодами_%УИД% КАК ТаблицаДанных
				|		ПО (ТаблицаДанных.ДатаНачала = МаксимальныеНеПустыеПериоды.ДатаНачала) %ТекстАналитикиСоединение%";
	
			ИначеЕсли ДанныеДляРасчета.ВидСреза = "СрезПервых" Тогда
	
				ТекстЗапросаВТ = " 
				|ВЫБРАТЬ
				|	%ОтборДатаКон% КАК Период,
				|	НАЧАЛОПЕРИОДА(%ОтборДатаКон%, %ПериодичностьОтчета%) КАК ДатаДляСреза %ТекстАналитики% %ТекстРесурсы%
				|ПОМЕСТИТЬ втДанныеРегистра_%УИД%
				|ИЗ
				|	РегистрСведений.%ИмяТаблицы%.СрезПервых(
				|			%ОтборДатаКон%,
				|			%ОтборВТ%) КАК ТаблицаДанных
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ТаблицаДанных.Период КАК Период,
				|	ВЫБОР
				|		КОГДА ТаблицаДанных.Период = НАЧАЛОПЕРИОДА(ТаблицаДанных.Период, %ПериодичностьОтчета%)
				|			ТОГДА %ПериодРСДляСреза%
				|		ИНАЧЕ НАЧАЛОПЕРИОДА(%ПериодРСДляСреза%, %ПериодичностьОтчета%) 
				|	КОНЕЦ КАК ДатаДляСреза %ТекстАналитики% %ТекстРесурсы%
				|ИЗ
				|	РегистрСведений.%ИмяТаблицы% КАК ТаблицаДанных
				|
				|ГДЕ
				|	ТаблицаДанных.Период МЕЖДУ %ОтборДатаНач% И ДОБАВИТЬКДАТЕ(КОНЕЦПЕРИОДА(%ОтборДатаКон%, %ПериодичностьОтчета%), СЕКУНДА, -1)
				|	%Отбор%
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	Периоды.ДатаНачала КАК ДатаНачала,
				|	Периоды.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсы%
				|ПОМЕСТИТЬ втДанныеРегистраСПериодами_%УИД%
				|ИЗ
				|	втПериоды КАК Периоды
				|		ЛЕВОЕ СОЕДИНЕНИЕ втДанныеРегистра_%УИД% КАК ТаблицаДанных
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
				|				МИНИМУМ(ТаблицаДанных.Период) КАК МинимальныйПериод,
				|				ТаблицаДанных.ДатаДляСреза КАК ДатаДляСреза %ТекстАналитики%
				|			ИЗ
				|				втДанныеРегистра_%УИД% КАК ТаблицаДанных
				|			
				|			СГРУППИРОВАТЬ ПО
				|				ТаблицаДанных.ДатаДляСреза %ТекстАналитикиГруппировка%
				|			) КАК МаксимальныеНеПустыеПериоды
				|			ПО ТаблицаДанных.Период = МаксимальныеНеПустыеПериоды.МинимальныйПериод
				|				И ТаблицаДанных.ДатаДляСреза = МаксимальныеНеПустыеПериоды.ДатаДляСреза %ТекстАналитикиСоединение% 
				|		ПО %ТекстПериодСоединение% = ТаблицаДанных.ДатаДляСреза  
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	МаксимальныеНеПустыеПериоды.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсы%
				|ПОМЕСТИТЬ втДанные_%УИД%
				|ИЗ
				|	(ВЫБРАТЬ
				|		Данные.ПериодОтчета КАК ПериодОтчета,
				|		МИНИМУМ(ТаблицаДанных.ДатаНачала) КАК ДатаНачала %ТекстАналитики%
				|	ИЗ
				|		втДанныеРегистраСПериодами_%УИД% КАК Данные
				|			ЛЕВОЕ СОЕДИНЕНИЕ втДанныеРегистраСПериодами_%УИД% КАК ТаблицаДанных
				|			ПО Данные.ДатаНачала <= ТаблицаДанных.ДатаНачала
				|	ГДЕ %ТекстРесурсыУсловие%
				|	
				|	СГРУППИРОВАТЬ ПО
				|		Данные.ПериодОтчета %ТекстАналитикиГруппировка%) КАК МаксимальныеНеПустыеПериоды
				|		ЛЕВОЕ СОЕДИНЕНИЕ втДанныеРегистраСПериодами_%УИД% КАК ТаблицаДанных
				|		ПО (ТаблицаДанных.ДатаНачала = МаксимальныеНеПустыеПериоды.ДатаНачала) %ТекстАналитикиСоединение%";

			КонецЕсли;
							
			Если СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчета 
				ИЛИ СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаВышестоящегоПериода 
				ИЛИ СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГода
				ИЛИ СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчетаСоСдвигом
				ИЛИ СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГодаСоСдвигом
				Тогда
			
				Если ДанныеДляРасчета.ВидСреза = "СрезПоследних" Тогда
					ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодРСДляСреза%","ДОБАВИТЬКДАТЕ(ТаблицаДанных.Период, %ПериодичностьОтчета%, 1)");
				ИначеЕсли ДанныеДляРасчета.ВидСреза = "СрезПервых" Тогда
					ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодРСДляСреза%","ТаблицаДанных.Период");
				КонецЕсли;
					
			ИначеЕсли СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаПериодаОтчета
				ИЛИ СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаВышестоящегоПериода
				ИЛИ СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГода
				ИЛИ СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаПериодаОтчетаСоСдвигом
				ИЛИ СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГодаСоСдвигом
				Тогда
				
				Если ДанныеДляРасчета.ВидСреза = "СрезПоследних" Тогда
					ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодРСДляСреза%","ТаблицаДанных.Период");
				ИначеЕсли ДанныеДляРасчета.ВидСреза = "СрезПервых" Тогда
					ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодРСДляСреза%","ДОБАВИТЬКДАТЕ(ТаблицаДанных.Период, %ПериодичностьОтчета%, -1)");
				КонецЕсли;
				
			Иначе
				
				ТекстОшибки = СтрШаблон(НСтр("ru = 'Способ вычисления параметра %1 для отбора ""ДатаНач""'"),СпособВычисленияПараметра);
				ВызватьИсключение(ТекстОшибки);
				
			КонецЕсли;
			
			ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ОтборДатаНач%",
				ПривестиПериод("&НачалоПериодаОтчета",ПараметрПериод.СпособВычисленияПараметра,ПараметрПериод.УточнениеСпособаОпределения));
			ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ОтборДатаКон%",
				ПривестиПериод("&КонецПериодаОтчета",ПараметрПериод.СпособВычисленияПараметра,ПараметрПериод.УточнениеСпособаОпределения));
			ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ТекстПериодСоединение%",
				ПривестиПериод("Периоды.ДатаНачала",ПараметрПериод.СпособВычисленияПараметра,ПараметрПериод.УточнениеСпособаОпределения,Истина));			
			
			Если СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаВышестоящегоПериода
				ИЛИ СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаВышестоящегоПериода Тогда
				
				ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодичностьОтчета%",ПараметрПериод.УточнениеСпособаОпределения);				
				
			ИначеЕсли СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГода
				ИЛИ СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГода
				ИЛИ СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГодаСоСдвигом
				ИЛИ СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГодаСоСдвигом Тогда
				
			 	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ПериодичностьОтчета%","ГОД");
				
			КонецЕсли;			

		КонецЕсли;
		
	Иначе
		
		ТекстЗапросаВТ = "
		|ВЫБРАТЬ
		|	Периоды.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсы%
		|ПОМЕСТИТЬ втДанные_%УИД%
		|ИЗ
		|	втПериоды КАК Периоды
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.%ИмяТаблицы% КАК ТаблицаДанных
		|		ПО ИСТИНА
		|		%ОтборПоПериоду%
		|		%Отбор%
		|";	

	КонецЕсли; 
	
	Возврат ТекстЗапросаВТ
	
КонецФункции

Функция ШаблонЗапросаВнутрСправочник(ДанныеДляРасчета)
	
	ТекстЗапросаВТ = "
	|ВЫБРАТЬ
	|	Периоды.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсы%
	|ПОМЕСТИТЬ втДанные_%УИД%
	|ИЗ
	|	втПериоды КАК Периоды
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.%ИмяТаблицы% КАК ТаблицаДанных
	|		ПО ИСТИНА
	|		%ОтборПоПериоду%
	|		%Отбор%
	|";
	
	Возврат ТекстЗапросаВТ;
	
КонецФункции	

Функция ШаблонЗапросаВнутрПроизвольныйЗапрос(ДанныеДляРасчета, тПараметрыПакетаВТ)

	ТекстЗапросаВТ = "";
	Если СтрНайти(ДанныеДляРасчета.ТекстЗапроса,"ПОМЕСТИТЬ") > 0 Тогда
		
		УИДЗапросов = СтрЗаменить(Новый УникальныйИдентификатор,"-","");
		СхемаЗапроса = Новый СхемаЗапроса();
		СхемаЗапроса.УстановитьТекстЗапроса(ДанныеДляРасчета.ТекстЗапроса);
		Для Каждого Пакет Из СхемаЗапроса.ПакетЗапросов Цикл
			Если Не ПустаяСтрока(Пакет.ТаблицаДляПомещения) Тогда
				Пакет.ТаблицаДляПомещения = Пакет.ТаблицаДляПомещения + "_" + УИДЗапросов;
				ТекстЗапросаВТ = ТекстЗапросаВТ + Пакет.ПолучитьТекстЗапроса() + "
				|;
				|
				|";
			Иначе
				ТекстИтоговогоЗапроса = Пакет.ПолучитьТекстЗапроса();
			КонецЕсли;
		КонецЦикла;
		
	Иначе
		ТекстИтоговогоЗапроса = ДанныеДляРасчета.ТекстЗапроса;
	КонецЕсли;
	
	ТекстЗапросаВТ = ТекстЗапросаВТ + "
	|ВЫБРАТЬ
	|	Периоды.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстРесурсы%	
	|ПОМЕСТИТЬ втДанные_%УИД%
	|ИЗ
	|	втПериоды КАК Периоды
	|	ЛЕВОЕ СОЕДИНЕНИЕ (
	|
	|%ТекстЗапроса%
	|
	|		) КАК ТаблицаДанных
	|		ПО %ТекстУсловияСоединенияПЗ%
	|		%ОтборПоПериоду%
	|		%Отбор%
	|";
	
	// Условие соединения для произвольного запроса
	СтрокаПериод = ДанныеДляРасчета.ПоляАналитикПоказателей.Найти("Период","КодАналитики");
	Если СтрокаПериод = Неопределено Тогда
		ТекстОшибки = НСтр("ru = 'Не найден ресурс ""Период"" для произвольного запроса'");
		ВызватьИсключение(ТекстОшибки);
	КонецЕсли;	

	ТекстУсловияСоединенияПЗ = "";
	Если СтрокаПериод.СпособЗаполнения = Перечисления.СпособыЗаполненияПолейИсточника.ПолеИсходнойТаблицы Тогда
		ТекстУсловияСоединенияПЗ = "ТаблицаДанных." + СтрокаПериод.Поле + " МЕЖДУ Периоды.ДатаНачала И Периоды.ДатаОкончания";
	ИначеЕсли СтрокаПериод.СпособЗаполнения = Перечисления.СпособыЗаполненияПолейИсточника.ФиксированноеЗначение Тогда
		нПараметр = ДобавитьПараметрВПакет(тПараметрыПакетаВТ, 
			Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение,
			СтрокаПериод.ФиксированноеЗначение, "Период");
		ТекстУсловияСоединенияПЗ = "&" + нПараметр.ИмяОтбора + " МЕЖДУ Периоды.ДатаНачала И Периоды.ДатаОкончания";
	ИначеЕсли СтрокаПериод.СпособЗаполнения = Перечисления.СпособыЗаполненияПолейИсточника.КонтекстОбъектаЗагрузки Тогда
		нПараметр = ДобавитьПараметрВПакет(тПараметрыПакетаВТ, 
			"КонтекстВызоваЗаполнения",
			СтрокаПериод.Поле, "Период");
		ТекстУсловияСоединенияПЗ 	= "&" + нПараметр.ИмяОтбора + " МЕЖДУ Периоды.ДатаНачала И Периоды.ДатаОкончания";
	Иначе
		ТекстОшибки = СтрШаблон(НСтр("ru = 'Способ заполнения параметра ""%1"" для отбора ""Период"" не поддерживается.'"),СтрокаПериод.СпособЗаполнения);
		ВызватьИсключение(ТекстОшибки);
	КонецЕсли;
	
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ТекстУсловияСоединенияПЗ%",ТекстУсловияСоединенияПЗ);
	
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ТекстЗапроса%",ТекстИтоговогоЗапроса);
	
	Возврат ТекстЗапросаВТ;
		
КонецФункции	

Процедура ПодготовитьТаблицуВнутренниеДанные(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня)
	
	тВнутренниеДанные 		= СтруктураРасчетаПоказателей.тВнутренниеДанные;	
	тПоказателиОперанды 	= СтруктураРасчетаПоказателей.тПоказателиОперанды;
	
	Если тВнутренниеДанные.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	// Добавим временную таблицу с периодами
	ДобавитьТаблицуПериодов(СтруктураПараметровТекущегоУровня);

	ИсходнаяТаблица = тВнутренниеДанные.Скопировать();
	
	ПоляСвертки = "СпособПолучения,РегистрБД,ОбъектБД,ТабличнаяЧастьБД,ОсновнаяТаблицаРегистра,КорреспонденцияСчетов,ВидСреза,ТекстЗапроса,ХешОтбораПоказателей";
	тВнутренниеДанные.Свернуть(ПоляСвертки); 
	
	Для Каждого ТекущийСрез Из тВнутренниеДанные Цикл
		
		// Найдем строки по одному срезу
		СтруктураОтбора = Новый Структура(ПоляСвертки);
		ЗаполнитьЗначенияСвойств(СтруктураОтбора, ТекущийСрез);
		СтрокиСреза = ИсходнаяТаблица.НайтиСтроки(СтруктураОтбора);
		
		// Соберем таблицу значений по регистру
		ПоляЗначенийПоказателей = Новый ТаблицаЗначений;
		ПоляЗначенийПоказателей.Колонки.Добавить("Показатель");
		ПоляЗначенийПоказателей.Колонки.Добавить("Поле");
		ПоляЗначенийПоказателей.Колонки.Добавить("ТипЗначения");
		ПоляЗначенийПоказателей.Колонки.Добавить("Код");
		ПоляЗначенийПоказателей.Колонки.Добавить("Счет");
		ПоляЗначенийПоказателей.Колонки.Добавить("КоррСчет");
		ПоляЗначенийПоказателей.Колонки.Добавить("УИДГруппыОтборов");
		ПоляЗначенийПоказателей.Колонки.Добавить("УИДЗаполненияАналитик");
		
		ПоляАналитикПоказателей = Новый ТаблицаЗначений;
		ПоляАналитикПоказателей.Колонки.Добавить("Показатель");
		ПоляАналитикПоказателей.Колонки.Добавить("Поле");
		ПоляАналитикПоказателей.Колонки.Добавить("КодАналитики");
		ПоляАналитикПоказателей.Колонки.Добавить("СпособЗаполнения");
		ПоляАналитикПоказателей.Колонки.Добавить("ФиксированноеЗначение");
		
		Для Каждого СтрокаСреза Из СтрокиСреза Цикл
			
			НСтрокаПоказатель = ПоляЗначенийПоказателей.Добавить();
			ЗаполнитьЗначенияСвойств(НСтрокаПоказатель, СтрокаСреза);
			НайденнаяСтрока = тПоказателиОперанды.НайтиСтроки(
				Новый Структура("ПоказательОперанд,КодВФормуле",НСтрокаПоказатель.Показатель,НСтрокаПоказатель.Код));
			НСтрокаПоказатель.УИДГруппыОтборов = НайденнаяСтрока.Получить(0).УИДГруппыОтборов;
			НСтрокаПоказатель.УИДЗаполненияАналитик = "";
			
			Для Каждого СтрокаПравила Из СтрокаСреза.ПравилаИспользованияПолейЗапроса Цикл
				
				Если СтрокаПравила.КодАналитики = "Значение" Тогда				
					
					Если СтрокаСреза.ОсновнаяТаблицаРегистра Тогда
						НСтрокаПоказатель.Поле = СтрокаСреза.РесурсРегистра;
					Иначе
						
						НСтрокаПоказатель.Поле = СтрокаПравила.Поле;
						Если ЗначениеЗаполнено(СтрокаСреза.КоррСчет) Тогда
							Если Прав(НСтрокаПоказатель.Поле,2) = "Кт"
								И Прав(НСтрокаПоказатель.Поле,6) <> "ОборотКт" Тогда
								НСтрокаПоказатель.Поле = СтрЗаменить(НСтрокаПоказатель.Поле, "Кт", "ОборотКт");					
							ИначеЕсли Прав(НСтрокаПоказатель.Поле,2) = "Дт"
								И Прав(НСтрокаПоказатель.Поле,6) <> "ОборотДт" Тогда
								НСтрокаПоказатель.Поле = СтрЗаменить(НСтрокаПоказатель.Поле, "Дт", "ОборотДт");
							ИначеЕсли Прав(НСтрокаПоказатель.Поле,6) <> "Оборот" Тогда
								НСтрокаПоказатель.Поле = НСтрокаПоказатель.Поле + "Оборот";
							КонецЕсли;
						КонецЕсли;
						
					КонецЕсли;
					
				Иначе
			
					// Поля аналитик
					НСтрока = ПоляАналитикПоказателей.Добавить();
					НСтрока.Показатель = СтрокаСреза.Показатель;
					ЗаполнитьЗначенияСвойств(НСтрока, СтрокаПравила);
					НСтрокаПоказатель.УИДЗаполненияАналитик = НСтрокаПоказатель.УИДЗаполненияАналитик 
						+ "$" + НСтрока.Поле + "@" + НСтрока.КодАналитики + "@" 
						+ ЗначениеВСтрокуВнутр(НСтрока.СпособЗаполнения) + "@" 
						+ ЗначениеВСтрокуВнутр(НСтрока.ФиксированноеЗначение)
					
				КонецЕсли;
				
			КонецЦикла;

		КонецЦикла;
		
		// Подготовим данные для расчета
		ДанныеДляРасчета = Новый Структура;
		ДанныеДляРасчета.Вставить("УИДСреза", СтрЗаменить(Новый УникальныйИдентификатор,"-",""));
		ДанныеДляРасчета.Вставить("СпособПолучения", ТекущийСрез.СпособПолучения);
		ДанныеДляРасчета.Вставить("ОсновнаяТаблицаРегистра", ТекущийСрез.ОсновнаяТаблицаРегистра);
		ДанныеДляРасчета.Вставить("КорреспонденцияСчетов", ТекущийСрез.КорреспонденцияСчетов);
		ДанныеДляРасчета.Вставить("ВидСреза", ТекущийСрез.ВидСреза);
		ДанныеДляРасчета.Вставить("ТекстЗапроса", ТекущийСрез.ТекстЗапроса);
		ДанныеДляРасчета.Вставить("ТаблицаПараметровОтбораБД", СтрокиСреза.Получить(0).ТаблицаПараметровОтбораБД); 
		ДанныеДляРасчета.Вставить("ПоляЗначенийПоказателей", ПоляЗначенийПоказателей);
		ДанныеДляРасчета.Вставить("ПоляАналитикПоказателей", ПоляАналитикПоказателей);
		
		// Вычислим имя таблицы 		
		Если ЗначениеЗаполнено(ТекущийСрез.РегистрБД) Тогда
			ДанныеДляРасчета.Вставить("ИмяТаблицы", ОбщегоНазначенияУХ.ЗначениеРеквизитаОбъекта(ТекущийСрез.РегистрБД,"Наименование"));
		ИначеЕсли ЗначениеЗаполнено(ТекущийСрез.ОбъектБД) Тогда
			ИмяОбъектаМетаданных = ОбщегоНазначенияУХ.ЗначениеРеквизитаОбъекта(ТекущийСрез.ОбъектБД,"ИмяОбъектаМетаданных");
			Если ЗначениеЗаполнено(ТекущийСрез.ТабличнаяЧастьБД) Тогда
				ИмяОбъектаМетаданных = ИмяОбъектаМетаданных + "." + ОбщегоНазначенияУХ.ЗначениеРеквизитаОбъекта(ТекущийСрез.ТабличнаяЧастьБД,"Имя")
			КонецЕсли;
			ДанныеДляРасчета.Вставить("ИмяТаблицы", ИмяОбъектаМетаданных);
		Иначе
			ДанныеДляРасчета.Вставить("ИмяТаблицы", "");
		КонецЕсли;
		
		ПодготовитьТекстыЗапросовПоИсточникуВнутр(ДанныеДляРасчета, СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ПодготовитьТекстыЗапросовПоИсточникуВнутр(ДанныеДляРасчета, СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня)
	
	тИспользуемыеАналитики              = СтруктураРасчетаПоказателей.тИспользуемыеАналитики;
	тИспользуемыеРесурсы              	= СтруктураРасчетаПоказателей.тИспользуемыеРесурсы;
	тСчетаСИерархией					= СтруктураРасчетаПоказателей.тСчетаСИерархией;

	тПараметрыПакетаВТ					= СтруктураПараметровТекущегоУровня.тПараметрыПакетаВТ;
	тПодзапросыДанныхВТ					= СтруктураПараметровТекущегоУровня.тПодзапросыДанныхВТ;	
	тПараметрыПакета            		= СтруктураПараметровТекущегоУровня.тПараметрыПакета;
	тПодзапросыДанных					= СтруктураПараметровТекущегоУровня.тПодзапросыДанных;	
	
	#Область ВременныеТаблицыДляРасчетов
	
	// Сформируем комментарий по показателям
	ТаблицаРесурсов = ДанныеДляРасчета.ПоляЗначенийПоказателей.Скопировать();
	
	// Сформируем текст ресурсов
	ТекстРесурсы = "";
	ТекстРесурсыОстатки = "";
	ТекстРесурсыУсловие = "";
	ТекстРесурсыУсловиеНО = "";
	ТекстРесурсыОбороты = "";
	ТаблицаРесурсов.Свернуть("Поле");	
	Для Каждого СтрокаРесурс Из ТаблицаРесурсов Цикл
		
		ТекстРесурсы = ТекстРесурсы + ",
		|	ТаблицаДанных." + СтрокаРесурс.Поле + " КАК " + СтрЗаменить(СтрокаРесурс.Поле,".","");
		
		ТекстРесурсыУсловие = ТекстРесурсыУсловие + Символы.ПС + Символы.Таб + Символы.Таб 
			+ ?(ТекстРесурсыУсловие = "","", "И ") + "НЕ ТаблицаДанных." + СтрокаРесурс.Поле + " ЕСТЬ NULL";
		
		Если СтрНайти(СтрокаРесурс.Поле,"НачальныйОстаток") > 0
			ИЛИ СтрНайти(СтрокаРесурс.Поле,"НачальныйРазвернутыйОстаток") > 0 Тогда
			
			// Начальный остаток добавим вручную
			ПолеКО = СтрЗаменить(СтрокаРесурс.Поле,"НачальныйРазвернутыйОстаток","КонечныйРазвернутыйОстаток");
			ПолеКО = СтрЗаменить(ПолеКО,"НачальныйОстаток","КонечныйОстаток");
			ТекстРесурсыОстатки = ТекстРесурсыОстатки + ",
			|	ВЫБОР
			|		КОГДА МаксимальныеНеПустыеПериоды.ПериодОтчета <> ТаблицаДанных.ПериодОтчета
			|			ТОГДА ТаблицаДанных." + ПолеКО + "
			|		ИНАЧЕ ТаблицаДанных." + СтрокаРесурс.Поле + "
			|	КОНЕЦ КАК " + СтрокаРесурс.Поле;
			
			// Добавим конечные остаток, если его нет в ресурсах
			Если ТаблицаРесурсов.Найти(ПолеКО, "Поле") = Неопределено Тогда
				ТекстРесурсы = ТекстРесурсы + ",
				|	ТаблицаДанных." + ПолеКО + " КАК " + ПолеКО;
			КонецЕсли;
			
			ТекстРесурсыУсловиеНО = ТекстРесурсыУсловиеНО + Символы.ПС + Символы.Таб + Символы.Таб 
				+ ?(ТекстРесурсыУсловиеНО = "","", "И ") + "НЕ ТаблицаДанных." + СтрокаРесурс.Поле + " ЕСТЬ NULL";
			
			ТекстРесурсыОбороты = ТекстРесурсыОбороты + ",
			|	0 КАК " + СтрокаРесурс.Поле;
			
			ДанныеДляРасчета.Вставить("ЕстьОстатки", Истина);
		
		ИначеЕсли СтрНайти(СтрокаРесурс.Поле,"КонечныйОстаток") > 0
			ИЛИ СтрНайти(СтрокаРесурс.Поле,"КонечныйРазвернутыйОстаток") > 0 Тогда
			
			// Конечный остаток добавим вручную
			ПолеНО = СтрЗаменить(СтрокаРесурс.Поле,"КонечныйРазвернутыйОстаток","НачальныйРазвернутыйОстаток");
			ПолеНО = СтрЗаменить(ПолеНО,"КонечныйОстаток","НачальныйОстаток");
			ТекстРесурсыОстатки = ТекстРесурсыОстатки + ",
			|	ТаблицаДанных." + СтрокаРесурс.Поле + " КАК " + СтрокаРесурс.Поле;
			
			// Добавим начальный остаток, если его не в ресурсах
			Если ТаблицаРесурсов.Найти(ПолеНО, "Поле") = Неопределено Тогда
				ТекстРесурсы = ТекстРесурсы + ",
				|	ТаблицаДанных." + ПолеНО + " КАК " + ПолеНО;
				ТекстРесурсыУсловиеНО = ТекстРесурсыУсловиеНО + Символы.ПС + Символы.Таб + Символы.Таб 
					+ ?(ТекстРесурсыУсловиеНО = "","", "И ") + "НЕ ТаблицаДанных." + ПолеНО + " ЕСТЬ NULL";
			КонецЕсли;
			
			ТекстРесурсыОбороты = ТекстРесурсыОбороты + ",
			|	0 КАК " + СтрокаРесурс.Поле;
			
			ДанныеДляРасчета.Вставить("ЕстьОстатки", Истина);
			
		Иначе
				
			ТекстРесурсыОбороты = ТекстРесурсыОбороты + ",
			|	ТаблицаДанных." + СтрокаРесурс.Поле + " КАК " + СтрокаРесурс.Поле;	
			
			ТекстРесурсыОстатки = ТекстРесурсыОстатки + ",
			|	0 КАК " + СтрокаРесурс.Поле;
			
			ДанныеДляРасчета.Вставить("ЕстьОбороты", Истина);
	
		КонецЕсли;
		
	КонецЦикла;
	
	// Сформируем текст аналитик
	ТекстАналитики = "";
	ТекстАналитикиГруппировка = "";
	ТекстАналитикиСоединение = "";
	ПоляАналитикПоказателей = ДанныеДляРасчета.ПоляАналитикПоказателей.Скопировать(
		Новый Структура("СпособЗаполнения",Перечисления.СпособыЗаполненияПолейИсточника.ПолеИсходнойТаблицы));
	ПоляАналитикПоказателей.Свернуть("Поле");
	Для Каждого СтрокаАналитика Из ПоляАналитикПоказателей Цикл 
		Если ТаблицаРесурсов.Найти(СтрокаАналитика.Поле, "Поле") <> Неопределено Тогда 
			// Поле уже есть в ресурсах
			Продолжить;
		КонецЕсли;
		Если ДанныеДляРасчета.Свойство("ЕстьОстатки") Тогда
			ТекстАналитики = ТекстАналитики + ",
			|	ISNULL(ТаблицаДанных." + СтрокаАналитика.Поле + ",НЕОПРЕДЕЛЕНО) КАК " + СтрЗаменить(СтрокаАналитика.Поле,".","");
		Иначе
			ТекстАналитики = ТекстАналитики + ",
			|	ТаблицаДанных." + СтрокаАналитика.Поле + " КАК " + СтрЗаменить(СтрокаАналитика.Поле,".","");
		КонецЕсли;
		ТекстАналитикиГруппировка = ТекстАналитикиГруппировка + ",
		|		ТаблицаДанных." + СтрокаАналитика.Поле;
		ТекстАналитикиСоединение = ТекстАналитикиСоединение + "
		|		И ТаблицаДанных." + СтрокаАналитика.Поле + " = МаксимальныеНеПустыеПериоды." + СтрокаАналитика.Поле;
	КонецЦикла;

	// Получим текст шаблонов запросов для подъема данных
	Если ДанныеДляРасчета.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеРегистрНакопления		
		Или ДанныеДляРасчета.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеРегистрБухгалтерии Тогда	
		ТекстЗапросаВТ = ШаблонЗапросаВнутрРегистрНакоплений(ДанныеДляРасчета);
	ИначеЕсли ДанныеДляРасчета.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеРегистрСведений Тогда	
		ТекстЗапросаВТ = ШаблонЗапросаВнутрРегистрСведений(ДанныеДляРасчета);
	ИначеЕсли ДанныеДляРасчета.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеСправочники Тогда
		ТекстЗапросаВТ = ШаблонЗапросаВнутрСправочник(ДанныеДляРасчета);
	ИначеЕсли ДанныеДляРасчета.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеПроизвольныйЗапрос Тогда	
		ТекстЗапросаВТ = ШаблонЗапросаВнутрПроизвольныйЗапрос(ДанныеДляРасчета, тПараметрыПакетаВТ);
	КонецЕсли;
	
	// Заменим вставки в тексте запроса
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ, "%УИД%", ДанныеДляРасчета.УИДСреза);
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ, "%ТекстРесурсы%", ТекстРесурсы);
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ, "%ТекстРесурсыОстатки%", ТекстРесурсыОстатки);
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ, "%ТекстРесурсыУсловие%", ТекстРесурсыУсловие);
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ, "%ТекстРесурсыУсловиеНО%", ТекстРесурсыУсловиеНО);
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ, "%ТекстРесурсыОбороты%", ТекстРесурсыОбороты);
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ, "%ТекстАналитики%", ТекстАналитики);
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ, "%ТекстАналитикиГруппировка%", ТекстАналитикиГруппировка);
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ, "%ТекстАналитикиСоединение%", ТекстАналитикиСоединение);
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ, "%ИмяТаблицы%", ДанныеДляРасчета.ИмяТаблицы);

	// Обработаем отборы
	ОбработанныеСтроки = Новый Массив;
	ТаблицаПараметровОтбораБД = ДанныеДляРасчета.ТаблицаПараметровОтбораБД.Скопировать();
	
	// Обработаем отборы произвольного запроса
	Для Каждого ПравилоВычисления Из ТаблицаПараметровОтбораБД Цикл 
		ПолеБД = ПравилоВычисления.ПолеБД;
		Если ПолеБД <> "" И СтрНайти(ТекстЗапросаВТ,"&" + ПолеБД) > 0 Тогда
			Если ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеЗначение
				Или ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеСписокЗначений Тогда
				нПараметр = ДобавитьПараметрВПакет(тПараметрыПакетаВТ,
					ПравилоВычисления.СпособВычисленияПараметра,ПравилоВычисления.ТекстМодуля,ПравилоВычисления.ПолеБД);
			Иначе
				нПараметр = ДобавитьПараметрВПакет(тПараметрыПакетаВТ,
					ПравилоВычисления.СпособВычисленияПараметра,ПравилоВычисления.УточнениеСпособаОпределения,ПравилоВычисления.ПолеБД);
			КонецЕсли;
			ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"&" + ПолеБД,"&" + нПараметр.ИмяОтбора);
			ОбработанныеСтроки.Добавить(ПравилоВычисления);
		КонецЕсли;	
	КонецЦикла;
	
	Для Каждого ОбработаннаяСтрока Из ОбработанныеСтроки Цикл
		ТаблицаПараметровОтбораБД.Удалить(ОбработаннаяСтрока);
	КонецЦикла;
	ОбработанныеСтроки.Очистить();
	
	// Обработаем отборы по периоду
	ТекстОтбораПоПериоду = "";
	Для Каждого ПравилоВычисления Из ТаблицаПараметровОтбораБД Цикл
		
		ПолеБД = ПравилоВычисления.ПолеБД;
		Если ПолеБД = "ДатаНач"
			Или ПолеБД = "ДатаКон" Тогда
			
			Если ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.Дата Тогда
				
				нПараметр = ДобавитьПараметрВПакет(тПараметрыПакетаВТ,
					ПравилоВычисления.СпособВычисленияПараметра,ПравилоВычисления.УточнениеСпособаОпределения,ПолеБД);
				ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%Отбор" + ПолеБД + "%","&" + нПараметр.ИмяОтбора);
				
			ИначеЕсли ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеЗначение
				Или ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеСписокЗначений Тогда
				
				нПараметр = ДобавитьПараметрВПакет(тПараметрыПакетаВТ,
					ПравилоВычисления.СпособВычисленияПараметра,ПравилоВычисления.ТекстМодуля,ПолеБД);
				ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%Отбор" + ПолеБД + "%","&" + нПараметр.ИмяОтбора);
				
			ИначеЕсли ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчета
				ИЛИ ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчетаСоСдвигом
				ИЛИ ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГода
				ИЛИ ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГодаСоСдвигом
				ИЛИ ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаВышестоящегоПериода
				Тогда
				
				нПараметр = ДобавитьПараметрВПакет(тПараметрыПакетаВТ,
					Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчета,,ПолеБД);
				ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%Отбор" + ПолеБД + "%","&" + нПараметр.ИмяОтбора);
				
			ИначеЕсли ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаПериодаОтчета
				ИЛИ ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаПериодаОтчетаСоСдвигом
				ИЛИ ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГода
				ИЛИ ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГодаСоСдвигом
				ИЛИ ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаВышестоящегоПериода
				Тогда
				
				нПараметр = ДобавитьПараметрВПакет(тПараметрыПакетаВТ,
					Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаПериодаОтчета,,ПолеБД);
				ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%Отбор" + ПолеБД + "%","&" + нПараметр.ИмяОтбора);
				
			ИначеЕсли ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.НеИспользуется Тогда
				
				ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%Отбор" + ПолеБД + "%","");
				
			Иначе				
				
				ТекстОшибки = СтрШаблон(НСтр("ru = 'Способ вычисления параметра ""%1"" для отбора ""%2"" не поддерживается.'"),
					ПравилоВычисления.СпособВычисленияПараметра,ПолеБД);
				ВызватьИсключение(ТекстОшибки);
				
			КонецЕсли;			
			
			ОбработанныеСтроки.Добавить(ПравилоВычисления);
			
		ИначеЕсли ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчета Тогда
			ТекстОтбораПоПериоду = ТекстОтбораПоПериоду + " И ТаблицаДанных." + ПолеБД 
				+ " = Периоды.ДатаНачала";
			ОбработанныеСтроки.Добавить(ПравилоВычисления);

		ИначеЕсли ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаПериодаОтчета Тогда
			ТекстОтбораПоПериоду = ТекстОтбораПоПериоду + " И ТаблицаДанных." + ПолеБД 
				+ " = КОНЕЦПЕРИОДА(Периоды.ДатаНачала,%ПериодичностьОтчета%)";
			ОбработанныеСтроки.Добавить(ПравилоВычисления);
			
		ИначеЕсли ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаВышестоящегоПериода Тогда
			ТекстОтбораПоПериоду = ТекстОтбораПоПериоду + " И ТаблицаДанных." + ПолеБД 
				+ " = НАЧАЛОПЕРИОДА(Периоды.ДатаНачала," + Строка(ПравилоВычисления.УточнениеСпособаОпределения) + ")";
			ОбработанныеСтроки.Добавить(ПравилоВычисления);
			
		ИначеЕсли ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаВышестоящегоПериода Тогда
			ТекстОтбораПоПериоду = ТекстОтбораПоПериоду + " И ТаблицаДанных." + ПолеБД 
				+ " = КОНЕЦПЕРИОДА(Периоды.ДатаНачала," + Строка(ПравилоВычисления.УточнениеСпособаОпределения) + ")";
			ОбработанныеСтроки.Добавить(ПравилоВычисления);
			
		ИначеЕсли ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГода Тогда
			ТекстОтбораПоПериоду = ТекстОтбораПоПериоду + " И ТаблицаДанных." + ПолеБД 
				+ " = КОНЕЦПЕРИОДА(Периоды.ДатаНачала,ГОД)";
			ОбработанныеСтроки.Добавить(ПравилоВычисления);
			
		ИначеЕсли ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГода Тогда
			ТекстОтбораПоПериоду = ТекстОтбораПоПериоду + " И ТаблицаДанных." + ПолеБД 
				+ " = НАЧАЛОПЕРИОДА(Периоды.ДатаНачала,ГОД)";
			ОбработанныеСтроки.Добавить(ПравилоВычисления);
			
		ИначеЕсли ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГодаСоСдвигом Тогда
			ТекстОтбораПоПериоду = ТекстОтбораПоПериоду + " И ТаблицаДанных." + ПолеБД 
				+ " = ДОБАВИТЬКДАТЕ(КОНЕЦПЕРИОДА(Периоды.ДатаНачала,ГОД),ГОД," + Формат(ПравилоВычисления.УточнениеСпособаОпределения,"ЧН=0; ЧГ=0") + ")";
			ОбработанныеСтроки.Добавить(ПравилоВычисления);
			
		ИначеЕсли ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГодаСоСдвигом Тогда
			ТекстОтбораПоПериоду = ТекстОтбораПоПериоду + " И ТаблицаДанных." + ПолеБД 
				+ " = ДОБАВИТЬКДАТЕ(НАЧАЛОПЕРИОДА(Периоды.ДатаНачала,ГОД),ГОД," + Формат(ПравилоВычисления.УточнениеСпособаОпределения,"ЧН=0; ЧГ=0") + ")";
			ОбработанныеСтроки.Добавить(ПравилоВычисления);
			
		ИначеЕсли ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаПериодаОтчетаСоСдвигом Тогда
		    ТекстОтбораПоПериоду = ТекстОтбораПоПериоду + " И ТаблицаДанных." + ПолеБД 
				+ " = ДОБАВИТЬКДАТЕ(КОНЕЦПЕРИОДА(Периоды.ДатаНачала,%ПериодичностьОтчета%),%ПериодичностьОтчета%," + Формат(ПравилоВычисления.УточнениеСпособаОпределения,"ЧН=0; ЧГ=0") + ")";
			ОбработанныеСтроки.Добавить(ПравилоВычисления);
			
		ИначеЕсли ПравилоВычисления.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчетаСоСдвигом Тогда
			
			ТекстОтбораПоПериоду = ТекстОтбораПоПериоду + " И ТаблицаДанных." + ПолеБД 
				+ " = ДОБАВИТЬКДАТЕ(Периоды.ДатаНачала,%ПериодичностьОтчета%," + Формат(ПравилоВычисления.УточнениеСпособаОпределения,"ЧН=0; ЧГ=0") + ")";
			ОбработанныеСтроки.Добавить(ПравилоВычисления);
			
		КонецЕсли;
		
	КонецЦикла;
	
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ОтборДатаНач%","&НачалоПериодаОтчета");
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ОтборДатаКон%","&КонецПериодаОтчета");
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ОтборПоПериоду%",ТекстОтбораПоПериоду);
	Для Каждого ОбработаннаяСтрока Из ОбработанныеСтроки Цикл
		ТаблицаПараметровОтбораБД.Удалить(ОбработаннаяСтрока);
	КонецЦикла;
	
	// Добавим остальные отборы
	ТаблицаПараметровОтбораБД.Колонки.Добавить("УИДГруппыОтборов");
	ТаблицаПараметровОтбораБД.ЗаполнитьЗначения(0,"УИДГруппыОтборов");
	ТаблицаПараметровОтбораБД.Колонки.Добавить("ВключаетсяВПоля");
	ТаблицаПараметровОтбораБД.ЗаполнитьЗначения(Ложь,"ВключаетсяВПоля");
	
	ТекстОтбора = СформироватьТекстОтбора(ТаблицаПараметровОтбораБД,тПараметрыПакетаВТ,0,,,Ложь);
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%Отбор%",СтрЗаменить(ТекстОтбора,"%ИмяТаблицы%","ТаблицаДанных"));
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ОтборВТ%","Истина" + СтрЗаменить(ТекстОтбора,"%ИмяТаблицы%.",""));
	
	// Добавим запрос ВТ в таблицы
	НСтрокаДанные = тПодзапросыДанныхВТ.Добавить();
	НСтрокаДанные.НомерПодзапроса = тПодзапросыДанныхВТ.Количество();
	НСтрокаДанные.ТекстПодзапроса = ТекстЗапросаВТ;                              
	НСтрокаДанные.КомментарийКПодзапросу = "ПОДЗАПРОС ВРЕМЕННОЙ ТАБЛИЦЫ ДЛЯ ПОЛУЧЕНИЯ ДАННЫХ ИЗ ТЕКУЩЕЙ ИБ";

	#КонецОбласти

	#Область ТаблицыДляИтоговыхДанных
	
	// Подготовительные данные
	Если ДанныеДляРасчета.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеРегистрБухгалтерии Тогда
	
		тПоказателейИсходная = ДанныеДляРасчета.ПоляЗначенийПоказателей;
		тПоказателей = тПоказателейИсходная.Скопировать();
		тПоказателей.Свернуть("Поле,ТипЗначения,УИДЗаполненияАналитик");
		
		СчетаДт = Новый Массив;
		СчетаКт = Новый Массив; 		
				
		тПоказателиСчета = Новый ТаблицаЗначений;
		тПоказателиСчета.Колонки.Добавить("НомерСреза", ОбщегоНазначенияУХ.ПолучитьОписаниеТиповЧисла(5));
		тПоказателиСчета.Колонки.Добавить("Показатель", ОбщегоНазначенияУХ.ПолучитьОписаниеТиповСсылка("СправочникСсылка.ПоказателиОтчетов"));
		тПоказателиСчета.Колонки.Добавить("УИДГруппыОтборов", ОбщегоНазначенияУХ.ПолучитьОписаниеТиповЧисла(5));
		МассивТиповСчет = Новый Массив;
		МассивТиповСчет.Добавить(ТипЗнч(тПоказателейИсходная.Получить(0).Счет));
		тПоказателиСчета.Колонки.Добавить("Счет", Новый ОписаниеТипов(МассивТиповСчет));
		Если ДанныеДляРасчета.КорреспонденцияСчетов Тогда
			тПоказателиСчета.Колонки.Добавить("КоррСчет", Новый ОписаниеТипов(МассивТиповСчет));
		КонецЕсли;
		
		ТекстШаблонаЗапроса = "
		|
		|// ДАННЫЕ ИЗ РЕГИСТРА БУХГАЛТЕРИИ
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ПоказателиСчета.Показатель КАК Показатель,
		|	ТаблицаДанных.ПериодОтчета КАК ПериодОтчета,
		|	ПоказателиСчета.УИДГруппыОтборов КАК УИДГруппыОтборов %ТекстАналитики% %ТекстРесурсов%
		|//ПОМЕСТИТЬ
		|ИЗ
		|	втДанные_%УИД% КАК ТаблицаДанных
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втПоказателиСчета_%УИД% КАК ПоказателиСчета 
		|		ПО ПоказателиСчета.НомерСреза = %НомерСреза%
		|		И ТаблицаДанных.Счет = ПоказателиСчета.Счет";
		
		Если ДанныеДляРасчета.КорреспонденцияСчетов Тогда
			ТекстШаблонаЗапроса = ТекстШаблонаЗапроса + "
			|		И ТаблицаДанных.КоррСчет = ПоказателиСчета.КоррСчет";
		КонецЕсли;
		
	Иначе
		
		тПоказателей = ДанныеДляРасчета.ПоляЗначенийПоказателей;
		
		ТекстШаблонаЗапроса = "
		|
		|// ДАННЫЕ ИЗ ВНУТРЕННИХ ИСТОЧНИКОВ
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	%Показатель% КАК Показатель,
		|	ТаблицаДанных.ПериодОтчета КАК ПериодОтчета,		
		|	%УИДГруппыОтборов% КАК УИДГруппыОтборов %ТекстАналитики% %ТекстРесурсов%
		|//ПОМЕСТИТЬ
		|ИЗ
		|	втДанные_%УИД% КАК ТаблицаДанных";

	КонецЕсли;
	
	НомерСреза = 0;
	ТекстШаблонаЗапроса = СтрЗаменить(ТекстШаблонаЗапроса,"%УИД%",ДанныеДляРасчета.УИДСреза);
	
	// Общие тексты аналитик и ресурсов
	ТекстРесурсовОбщая = СформироватьТекстРесурсов(тИспользуемыеРесурсы,0);
	ТекстАналитикиОбщая = СформироватьТекстАналитик(тИспользуемыеАналитики,0,1);	 
	
	// Формирование текстов запросов
	Для Каждого СтрокаРесурс Из тПоказателей Цикл	
		
		// Текст ресурсов
		Если СтрокаРесурс.ТипЗначения = Перечисления.ТипыЗначенийПоказателейОтчетов.Число Тогда
			ТекстРесурсов = СтрЗаменить(ТекстРесурсовОбщая,"%ИмяТаблицы%.ЗначениеНечисловое","НЕОПРЕДЕЛЕНО");
			Если ДанныеДляРасчета.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеПроизвольныйЗапрос
				Или ДанныеДляРасчета.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеСправочники Тогда
				ТекстРесурсов = СтрЗаменить(ТекстРесурсов,"%ИмяТаблицы%.Значение","ВЫРАЗИТЬ(ТаблицаДанных." + СтрЗаменить(СтрокаРесурс.Поле,".","") + " КАК Число)");
			Иначе				
				ТекстРесурсов = СтрЗаменить(ТекстРесурсов,"%ИмяТаблицы%.Значение","ТаблицаДанных." + СтрЗаменить(СтрокаРесурс.Поле,".",""));
			КонецЕсли;
		Иначе
			ТекстРесурсов = СтрЗаменить(ТекстРесурсовОбщая,"%ИмяТаблицы%.ЗначениеНечисловое","ТаблицаДанных." + СтрЗаменить(СтрокаРесурс.Поле,".",""));
			ТекстРесурсов = СтрЗаменить(ТекстРесурсов,"%ИмяТаблицы%.Значение","0");
		КонецЕсли;
		ТекстЗапроса = СтрЗаменить(ТекстШаблонаЗапроса,"%ТекстРесурсов%",ТекстРесурсов);
		
		// Текст для установки показателей
		НомерСреза = НомерСреза + 1;
		Если ДанныеДляРасчета.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеРегистрБухгалтерии Тогда			
			
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%НомерСреза%",Формат(НомерСреза, "ЧН=0; ЧГ="));
			
			// Таблица счетов и показателей
			СтрокиПоказателей = тПоказателейИсходная.НайтиСтроки(
				Новый Структура("Поле,ТипЗначения,УИДЗаполненияАналитик",
				СтрокаРесурс.Поле,СтрокаРесурс.ТипЗначения,СтрокаРесурс.УИДЗаполненияАналитик));			
				
			Для Каждого СтрокаПоказатель Из СтрокиПоказателей Цикл
					
				СтрокаСчетаСИерархией = тСчетаСИерархией.Найти(СтрокаПоказатель.Счет,"Счет");
				Если СтрокаСчетаСИерархией = Неопределено Тогда
					
					// Счет без иерархии
					Если СчетаДт.Найти(СтрокаПоказатель.Счет) = Неопределено Тогда
						СчетаДт.Добавить(СтрокаПоказатель.Счет);
					КонецЕсли;
					
					Если ЗначениеЗаполнено(СтрокаПоказатель.КоррСчет) Тогда
						
						СтрокаСчетаСИерархией = тСчетаСИерархией.Найти(СтрокаПоказатель.КоррСчет,"Счет");
						Если СтрокаСчетаСИерархией = Неопределено Тогда
							
							// КоррСчет без иерархии
							Если СчетаКт.Найти(СтрокаПоказатель.КоррСчет) = Неопределено Тогда
								СчетаКт.Добавить(СтрокаПоказатель.КоррСчет);
							КонецЕсли;
							
							НСтрока = тПоказателиСчета.Добавить();
							ЗаполнитьЗначенияСвойств(НСтрока, СтрокаПоказатель);
							НСтрока.НомерСреза = НомерСреза;
							
						Иначе
							
							// КоррСчет с иерархией
							Для Каждого ТекКоррСчет Из СтрокаСчетаСИерархией.МассивПодчиненныхСчетов Цикл
							
								Если СчетаКт.Найти(ТекКоррСчет) = Неопределено Тогда
									СчетаКт.Добавить(ТекКоррСчет);
								КонецЕсли;								
						
								НСтрока = тПоказателиСчета.Добавить();
								ЗаполнитьЗначенияСвойств(НСтрока, СтрокаПоказатель);
								НСтрока.КоррСчет = ТекКоррСчет;
								НСтрока.НомерСреза = НомерСреза;
								
							КонецЦикла;						
							
						КонецЕсли;
						
					Иначе
						
						НСтрока = тПоказателиСчета.Добавить();
						ЗаполнитьЗначенияСвойств(НСтрока, СтрокаПоказатель);
						НСтрока.НомерСреза = НомерСреза;
						
					КонецЕсли;
					
				Иначе
					
					Для Каждого ТекСчет Из СтрокаСчетаСИерархией.МассивПодчиненныхСчетов Цикл 					
						
						Если СчетаДт.Найти(ТекСчет) = Неопределено Тогда
							СчетаДт.Добавить(ТекСчет);
						КонецЕсли;
						
						Если ЗначениеЗаполнено(СтрокаПоказатель.КоррСчет) Тогда
						
							СтрокаСчетаСИерархией = тСчетаСИерархией.Найти(СтрокаПоказатель.КоррСчет,"Счет");
							Если СтрокаСчетаСИерархией = Неопределено Тогда
								
								// КоррСчет без иерархии
								Если СчетаКт.Найти(СтрокаПоказатель.КоррСчет) = Неопределено Тогда
									СчетаКт.Добавить(СтрокаПоказатель.КоррСчет);
								КонецЕсли;
								
								НСтрока = тПоказателиСчета.Добавить();
								ЗаполнитьЗначенияСвойств(НСтрока, СтрокаПоказатель);
								НСтрока.Счет = ТекСчет;
								НСтрока.НомерСреза = НомерСреза;
								
							Иначе
								
								// КоррСчет с иерархией
								Для Каждого ТекКоррСчет Из СтрокаСчетаСИерархией.МассивПодчиненныхСчетов Цикл
								
									Если СчетаКт.Найти(ТекКоррСчет) = Неопределено Тогда
										СчетаКт.Добавить(ТекКоррСчет);
									КонецЕсли;								
							
									НСтрока = тПоказателиСчета.Добавить();
									ЗаполнитьЗначенияСвойств(НСтрока, СтрокаПоказатель);
									НСтрока.Счет = ТекКоррСчет;
									НСтрока.КоррСчет = ТекСчет;
									НСтрока.НомерСреза = НомерСреза;
									
								КонецЦикла;						
								
							КонецЕсли;
							
						Иначе
							
							НСтрока = тПоказателиСчета.Добавить();
							ЗаполнитьЗначенияСвойств(НСтрока, СтрокаПоказатель);
							НСтрока.Счет = ТекСчет;
							НСтрока.НомерСреза = НомерСреза;
							
						КонецЕсли;
						
					КонецЦикла;					
					
				КонецЕсли;								
				
			КонецЦикла;
			
			ПоказательОтбор = СтрокаПоказатель.Показатель;
			
		Иначе
			
			ПоказательОтбор = СтрокаРесурс.Показатель;
			
			// Добавим параметр-показатель
			НСтрока = тПараметрыПакета.Добавить();
			НСтрока.ИмяОтбора = "Показатель_" + Формат(НомерСреза, "ЧН=0; ЧГ=") + "_" + ДанныеДляРасчета.УИДСреза;
			НСтрока.ТипОтбора = Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение;
			НСтрока.ЗначениеОтбора = ПоказательОтбор;

			ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%Показатель%","&" + НСтрока.ИмяОтбора);
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%УИДГруппыОтборов%",Формат(СтрокаРесурс.УИДГруппыОтборов,"ЧН=0; ЧГ=0"));

		КонецЕсли;
		
		// Текст аналитик
		ТекстАналитики = ТекстАналитикиОбщая;
		ПоляАналитикПоказателей = ДанныеДляРасчета.ПоляАналитикПоказателей.НайтиСтроки(
			Новый Структура("Показатель", ПоказательОтбор));
		Для Каждого СтрокаАналитика Из ПоляАналитикПоказателей Цикл
				
			Если СтрокаАналитика.СпособЗаполнения = Перечисления.СпособыЗаполненияПолейИсточника.ПолеИсходнойТаблицы Тогда
				Если СтрокаАналитика.КодАналитики = "АналитикаВалюта" Тогда
					ТекстАналитики = СтрЗаменить(ТекстАналитики,"%ИмяТаблицы%." + СтрокаАналитика.КодАналитики,"ISNULL(ВЫБОР
					|		КОГДА ТаблицаДанных." + СтрокаАналитика.Поле + " = НЕОПРЕДЕЛЕНО ТОГДА
					|			ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)
					|		ИНАЧЕ
					|			ТаблицаДанных." + СтрокаАналитика.Поле + "
					|		КОНЕЦ, ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка))");
				Иначе
					ТекстАналитики = СтрЗаменить(ТекстАналитики,"%ИмяТаблицы%." + СтрокаАналитика.КодАналитики,"ISNULL(ТаблицаДанных." + СтрокаАналитика.Поле + ",НЕОПРЕДЕЛЕНО)");
				КонецЕсли;
			ИначеЕсли СтрокаАналитика.СпособЗаполнения = Перечисления.СпособыЗаполненияПолейИсточника.ФиксированноеЗначение Тогда
				нПараметр = ДобавитьПараметрВПакет(тПараметрыПакета,
					Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение,СтрокаАналитика.ФиксированноеЗначение,СтрокаАналитика.КодАналитики);
				ТекстАналитики = СтрЗаменить(ТекстАналитики,"%ИмяТаблицы%." + СтрокаАналитика.КодАналитики,"&" + нПараметр.ИмяОтбора);
			ИначеЕсли СтрокаАналитика.СпособЗаполнения = Перечисления.СпособыЗаполненияПолейИсточника.КонтекстОбъектаЗагрузки Тогда
				нПараметр = ДобавитьПараметрВПакет(тПараметрыПакета,
					"КонтекстВызоваЗаполнения",СтрокаАналитика.Поле,СтрокаАналитика.КодАналитики);
				ТекстАналитики =  СтрЗаменить(ТекстАналитики,"%ИмяТаблицы%." + СтрокаАналитика.КодАналитики,"&" + нПараметр.ИмяОтбора);
			Иначе
				Если СтрокаАналитика.КодАналитики = "АналитикаВалюта" Тогда
					ТекстАналитики = СтрЗаменить(ТекстАналитики,"%ИмяТаблицы%." + СтрокаАналитика.КодАналитики, "ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)");
				Иначе
					ТекстАналитики = СтрЗаменить(ТекстАналитики,"%ИмяТаблицы%." + СтрокаАналитика.КодАналитики, "НЕОПРЕДЕЛЕНО");
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
		
		Для Сч = 1 По ПараметрыСеанса.ЧислоДопАналитик Цикл
			ТекстАналитики = СтрЗаменить(ТекстАналитики,"%ИмяТаблицы%.Аналитика" + Сч,"НЕОПРЕДЕЛЕНО");
		КонецЦикла;
		ТекстАналитики = СтрЗаменить(ТекстАналитики,"%ИмяТаблицы%.АналитикаВалюта","ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)");
		Если СтрНайти(ТекстАналитики,"%ИмяТаблицы%") > 0 Тогда
			// В зависимых операндах есть отборы по отличным от аналитик реквизитам. 
			ТекстОшибки = НСтр("ru = 'Отбор по отличным от аналитик реквизитам не поддерживается'");
			ВызватьИсключение(ТекстОшибки);
		КонецЕсли;		
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстАналитики%",ТекстАналитики);
				
		// Добавляем запрос в таблицы
		НСтрокаДанные = тПодзапросыДанных.Добавить();
		НСтрокаДанные.НомерПодзапроса = тПодзапросыДанных.Количество();
		НСтрокаДанные.ТекстПодзапроса = ТекстЗапроса;                              
		НСтрокаДанные.КомментарийКПодзапросу = "ПОДЗАПРОС ДЛЯ ПОЛУЧЕНИЯ ДАННЫХ ИЗ ТЕКУЩЕЙ ИБ";
		
	КонецЦикла;
	
	Если ДанныеДляРасчета.СпособПолучения = Перечисления.СпособыПолученияОперандов.ВнутренниеДанныеРегистрБухгалтерии Тогда
		
		// Добавляем таблицу счетов и показателей в параметры
		НСтрока = тПараметрыПакетаВТ.Добавить();
		НСтрока.ИмяОтбора = "ПоказателиСчета_" + ДанныеДляРасчета.УИДСреза;
		НСтрока.ТипОтбора = Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение;
		НСтрока.ЗначениеОтбора = тПоказателиСчета;
			
		// Счета для РБ
		НСтрока = тПараметрыПакетаВТ.Добавить();
		НСтрока.ИмяОтбора = "Счета_" + ДанныеДляРасчета.УИДСреза;
		НСтрока.ТипОтбора = Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение;
		НСтрока.ЗначениеОтбора = СчетаДт;
		
		Если ДанныеДляРасчета.КорреспонденцияСчетов Тогда
			НСтрока = тПараметрыПакетаВТ.Добавить();
			НСтрока.ИмяОтбора = "СчетаКт_" + ДанныеДляРасчета.УИДСреза;
			НСтрока.ТипОтбора = Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение;
			НСтрока.ЗначениеОтбора = СчетаКт;
		КонецЕсли;
	
	КонецЕсли;
	
	#КонецОбласти
	
КонецПроцедуры

#КонецОбласти


#Область ПроцедурыГенерацииЗапросовРегистровИСправочниковВнешних

////////////////////////////////////////////////////////////////////////////////
// Процедуры для подготовки текстов запросов для подъема данных из внешних регистров и справочников
//  
////////////////////////////////////////////////////////////////////////////////

Процедура ПодготовитьТекстЗапросаПоПроизвольномуКоду(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня)
	
	тПроизвольныйКод 		= СтруктураРасчетаПоказателей.тПроизвольныйКод;
	Если тПроизвольныйКод.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	тИспользуемыеАналитики	= СтруктураРасчетаПоказателей.тИспользуемыеАналитики;
	тИспользуемыеРесурсы    = СтруктураРасчетаПоказателей.тИспользуемыеРесурсы;	
	
	тПараметрыПакета        = СтруктураПараметровТекущегоУровня.тПараметрыПакета;
	тПодзапросыДанных		= СтруктураПараметровТекущегоУровня.тПодзапросыДанных;	
	тПараметрыПакетаВТ		= СтруктураПараметровТекущегоУровня.тПараметрыПакетаВТ;
	тПодзапросыДанныхВТ		= СтруктураПараметровТекущегоУровня.тПодзапросыДанныхВТ;	
	
	// Сформируем текст аналитик и ресурсов
	ТекстРесурсов = СтрЗаменить(СформироватьТекстРесурсов(тИспользуемыеРесурсы,0),"%ИмяТаблицы%","ПроизвольныйКод");
	ТекстАналитик = "";
	Для Каждого СтрАналитика Из тИспользуемыеАналитики.НайтиСтроки(Новый Структура("УровеньРасчета",0)) Цикл
		ТекстАналитик = ТекстАналитик  + ",
		|	НЕОПРЕДЕЛЕНО КАК " + СтрАналитика.Поле;
	КонецЦикла;
	
	// Запрос для временной таблицы
	ТекстЗапросаВТ = "
	|ВЫБРАТЬ 
	|	ПроизвольныйКод.Показатель КАК Показатель,
	|	ПроизвольныйКод.ПериодОтчета КАК ПериодОтчета %ТекстРесурсов%
	|ПОМЕСТИТЬ втДанныеПроизвольныйКод
	|ИЗ
	|	&тзДанныеПроизвольныйКод КАК ПроизвольныйКод";
	
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ТекстРесурсов%",СокрЛП(ТекстРесурсов));
	
	нПараметр = тПараметрыПакетаВТ.Добавить();
	нПараметр.ИмяОтбора 		= "тзДанныеПроизвольныйКод";
	нПараметр.ТипОтбора 		= "ДанныеПроизвольныйКод";
	нПараметр.ЗначениеОтбора 	= тПроизвольныйКод;
	
	// Подзапрос для запроса 0 уровня	
	ТекстЗапроса = "
	|
	|// ДАННЫЕ ИЗ ПРОИЗВОЛЬНОГО ЗАПРОСА
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ 
	|	ПроизвольныйКод.Показатель КАК Показатель,
	|	ПроизвольныйКод.ПериодОтчета КАК ПериодОтчета,
	|	ПоказателиОперанды.УИДГруппыОтборов КАК УИДГруппыОтборов %ТекстАналитик% %ТекстРесурсов%
	|//ПОМЕСТИТЬ
	|ИЗ
	|	втПоказателиОперанды КАК ПоказателиОперанды
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ втДанныеПроизвольныйКод КАК ПроизвольныйКод
	|		ПО ПоказателиОперанды.ПоказательОперанд = ПроизвольныйКод.Показатель
	|		И ПоказателиОперанды.УровеньРасчетаОперанда = 1";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстАналитик%",СокрЛП(ТекстАналитик));
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстРесурсов%",СокрЛП(ТекстРесурсов));
	
	// Добавим запросы в таблицы
	НСтрокаДанные = тПодзапросыДанныхВТ.Добавить();
	НСтрокаДанные.НомерПодзапроса = тПодзапросыДанныхВТ.Количество();
	НСтрокаДанные.ТекстПодзапроса = ТекстЗапросаВТ;                              
	НСтрокаДанные.КомментарийКПодзапросу = "ПОДЗАПРОС ВРЕМЕННОЙ ТАБЛИЦЫ ДЛЯ ПОЛУЧЕНИЯ ДАННЫХ РАССЧИТАННЫХ ПРОИЗВОЛЬНЫМ КОДОМ";
	
	НСтрокаДанные = тПодзапросыДанных.Добавить();
	НСтрокаДанные.НомерПодзапроса = тПодзапросыДанных.Количество();
	НСтрокаДанные.ТекстПодзапроса = ТекстЗапроса;                              
	НСтрокаДанные.КомментарийКПодзапросу = "ПОДЗАПРОС ДЛЯ ПОЛУЧЕНИЯ ДАННЫХ РАССЧИТАННЫХ ПРОИЗВОЛЬНЫМ КОДОМ";	
	
КонецПроцедуры

Процедура ПодготовитьТекстЗапросаПоПроизвольномуЗапросу(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня)
	
	тПроизвольныеЗапросы 				= СтруктураРасчетаПоказателей.тПроизвольныеЗапросы;
	Если тПроизвольныеЗапросы.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	тИспользуемыеАналитики              = СтруктураРасчетаПоказателей.тИспользуемыеАналитики;
	тИспользуемыеРесурсы              	= СтруктураРасчетаПоказателей.тИспользуемыеРесурсы;	
	
	тПараметрыПакета            		= СтруктураПараметровТекущегоУровня.тПараметрыПакета;
	тПодзапросыДанных					= СтруктураПараметровТекущегоУровня.тПодзапросыДанных;	
	тПараметрыПакетаВТ					= СтруктураПараметровТекущегоУровня.тПараметрыПакетаВТ;
	тПодзапросыДанныхВТ					= СтруктураПараметровТекущегоУровня.тПодзапросыДанныхВТ;	
	
	// Сформируем текст аналитик и ресурсов
	ТекстАналитик = СтрЗаменить(СформироватьТекстАналитик(тИспользуемыеАналитики,0),"%ИмяТаблицы%","ПроизвольныйЗапрос");
	ТекстРесурсов = СтрЗаменить(СформироватьТекстРесурсов(тИспользуемыеРесурсы,0),"%ИмяТаблицы%","ПроизвольныйЗапрос");
	
	// Запрос для временной таблицы
	ТекстЗапросаВТ = "
	|ВЫБРАТЬ 
	|	ПроизвольныйЗапрос.Показатель КАК Показатель,
	|	ПроизвольныйЗапрос.КодВФормуле КАК КодВФормуле,
	|	ПроизвольныйЗапрос.ПериодОтчета КАК ПериодОтчета %ТекстАналитик% %ТекстРесурсов%
	|ПОМЕСТИТЬ втДанныеПроизвольныйЗапрос
	|ИЗ
	|	&тзДанныеПроизвольныйЗапрос КАК ПроизвольныйЗапрос";
	
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ТекстАналитик%",ТекстАналитик);
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ТекстРесурсов%",ТекстРесурсов);
	
	нПараметр = тПараметрыПакетаВТ.Добавить();
	нПараметр.ИмяОтбора = "тзДанныеПроизвольныйЗапрос";
	нПараметр.ТипОтбора = "ДанныеПроизвольныйЗапрос";
	нПараметр.ЗначениеОтбора = тПроизвольныеЗапросы;
	
	// Подзапрос для запроса 0 уровня	
	ТекстЗапроса = "
	|
	|// ДАННЫЕ ИЗ ПРОИЗВОЛЬНОГО ЗАПРОСА
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ 
	|	ПроизвольныйЗапрос.Показатель КАК Показатель,
	|	ПроизвольныйЗапрос.ПериодОтчета КАК ПериодОтчета,
	|	тПоказателиОперанды.УИДГруппыОтборов КАК УИДГруппыОтборов %ТекстАналитик% %ТекстРесурсов%
	|//ПОМЕСТИТЬ
	|ИЗ
	|	втПоказателиОперанды КАК тПоказателиОперанды
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ втДанныеПроизвольныйЗапрос КАК ПроизвольныйЗапрос
	|		ПО тПоказателиОперанды.ПоказательОперанд = ПроизвольныйЗапрос.Показатель
	|		И тПоказателиОперанды.КодВФормуле = ПроизвольныйЗапрос.КодВФормуле
	|		И тПоказателиОперанды.УровеньРасчетаОперанда = 1";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстАналитик%",СокрЛП(ТекстАналитик));
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстРесурсов%",СокрЛП(ТекстРесурсов));
	
	// Добавим запросы в таблицы
	НСтрокаДанные = тПодзапросыДанныхВТ.Добавить();
	НСтрокаДанные.НомерПодзапроса = тПодзапросыДанныхВТ.Количество();
	НСтрокаДанные.ТекстПодзапроса = ТекстЗапросаВТ;                              
	НСтрокаДанные.КомментарийКПодзапросу = "ПОДЗАПРОС ВРЕМЕННОЙ ТАБЛИЦЫ ДЛЯ ПОЛУЧЕНИЯ ДАННЫХ ИЗ ПРОИЗВОЛЬНОГО ЗАПРОСА";
	
	НСтрокаДанные = тПодзапросыДанных.Добавить();
	НСтрокаДанные.НомерПодзапроса = тПодзапросыДанных.Количество();
	НСтрокаДанные.ТекстПодзапроса = ТекстЗапроса;                              
	НСтрокаДанные.КомментарийКПодзапросу = "ПОДЗАПРОС ДЛЯ ПОЛУЧЕНИЯ ДАННЫХ ИЗ ПРОИЗВОЛЬНОГО ЗАПРОСА";	
	
КонецПроцедуры

Процедура ПодготовитьТекстЗапросаПоИсточникуВнешнему(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня)
	
	тВнешниеДанные		 				= СтруктураРасчетаПоказателей.тВнешниеДанные;
	Если тВнешниеДанные.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	тИспользуемыеАналитики              = СтруктураРасчетаПоказателей.тИспользуемыеАналитики;
	тИспользуемыеРесурсы              	= СтруктураРасчетаПоказателей.тИспользуемыеРесурсы;
	
	тПараметрыПакета            		= СтруктураПараметровТекущегоУровня.тПараметрыПакета;
	тПодзапросыДанных					= СтруктураПараметровТекущегоУровня.тПодзапросыДанных;	
	тПараметрыПакетаВТ					= СтруктураПараметровТекущегоУровня.тПараметрыПакетаВТ;
	тПодзапросыДанныхВТ					= СтруктураПараметровТекущегоУровня.тПодзапросыДанныхВТ;	
	
	// Сформируем текст аналитик и ресурсов
	ТекстАналитик = СтрЗаменить(СформироватьТекстАналитик(тИспользуемыеАналитики,0),"%ИмяТаблицы%","ВнешниеДанные");
	ТекстРесурсов = СтрЗаменить(СформироватьТекстРесурсов(тИспользуемыеРесурсы,0),"%ИмяТаблицы%","ВнешниеДанные");
	
	// Запрос для временной таблицы
	ТекстЗапросаВТ = "
	|ВЫБРАТЬ 
	|	ВнешниеДанные.Показатель КАК Показатель,
	|	ВнешниеДанные.КодВФормуле КАК КодВФормуле,
	|	ВнешниеДанные.ПериодОтчета КАК ПериодОтчета %ТекстАналитик% %ТекстРесурсов%
	|ПОМЕСТИТЬ втДанныеВнешнийИсточник
	|ИЗ
	|	&тзДанныеВнешнийИсточник КАК ВнешниеДанные";
	
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ТекстАналитик%",ТекстАналитик);
	ТекстЗапросаВТ = СтрЗаменить(ТекстЗапросаВТ,"%ТекстРесурсов%",ТекстРесурсов);
	
	нПараметр = тПараметрыПакетаВТ.Добавить();
	нПараметр.ИмяОтбора = "тзДанныеВнешнийИсточник";
	нПараметр.ТипОтбора = "ДанныеВнешнийИсточник";
	нПараметр.ЗначениеОтбора = тВнешниеДанные;
	
	// Подзапрос для запроса 0 уровня	
	ТекстЗапроса = "
	|
	|// ДАННЫЕ ИЗ ВНЕШНИХ ИСТОЧНИКОВ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ 
	|	ВнешниеДанные.Показатель КАК Показатель,
	|	ВнешниеДанные.ПериодОтчета КАК ПериодОтчета,
	|	тПоказателиОперанды.УИДГруппыОтборов КАК УИДГруппыОтборов %ТекстАналитик% %ТекстРесурсов%
	|//ПОМЕСТИТЬ
	|ИЗ
	|	втПоказателиОперанды КАК тПоказателиОперанды
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ втДанныеВнешнийИсточник КАК ВнешниеДанные
	|		ПО тПоказателиОперанды.ПоказательОперанд = ВнешниеДанные.Показатель
	|		И тПоказателиОперанды.КодВФормуле = ВнешниеДанные.КодВФормуле
	|		И тПоказателиОперанды.УровеньРасчетаОперанда = 1";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстАналитик%",СокрЛП(ТекстАналитик));
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстРесурсов%",СокрЛП(ТекстРесурсов));
	
	// Добавим запросы в таблицы
	НСтрокаДанные = тПодзапросыДанныхВТ.Добавить();
	НСтрокаДанные.НомерПодзапроса = тПодзапросыДанныхВТ.Количество();
	НСтрокаДанные.ТекстПодзапроса = ТекстЗапросаВТ;                              
	НСтрокаДанные.КомментарийКПодзапросу = "ПОДЗАПРОС ВРЕМЕННОЙ ТАБЛИЦЫ ДЛЯ ПОЛУЧЕНИЯ ДАННЫХ ИЗ ВНЕШНЕЙ ИБ";
	
	НСтрокаДанные = тПодзапросыДанных.Добавить();
	НСтрокаДанные.НомерПодзапроса = тПодзапросыДанных.Количество();
	НСтрокаДанные.ТекстПодзапроса = ТекстЗапроса;                              
	НСтрокаДанные.КомментарийКПодзапросу = "ПОДЗАПРОС ДЛЯ ПОЛУЧЕНИЯ ДАННЫХ ИЗ ВНЕШНЕЙ ИБ";	
	
КонецПроцедуры

#КонецОбласти


#Область ПроцедурыПодготовкиЗапросовДляРасчетаВыраженийОперандов

////////////////////////////////////////////////////////////////////////////////
// Процедуры для подготовки текстов запросов для расчета операндов
//  
////////////////////////////////////////////////////////////////////////////////

Процедура ПодготовитьТекстЗапросаОперандовРучнойПодсчет(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня)
	
	тИспользуемыеАналитики				= СтруктураРасчетаПоказателей.тИспользуемыеАналитики;
	тИспользуемыеРесурсы				= СтруктураРасчетаПоказателей.тИспользуемыеРесурсы;
	МаксИспользуемыхАналитик        	= СтруктураРасчетаПоказателей.МаксИспользуемыхАналитик;
	МаксКлючевыхАналитик				= СтруктураРасчетаПоказателей.МаксКлючевыхАналитик;
	УровниСВременнымРасчетом			= СтруктураРасчетаПоказателей.УровниСВременнымРасчетом;
	
	тПодзапросыДанных  					= СтруктураПараметровТекущегоУровня.тПодзапросыДанных;
	тПараметрыПакета           			= СтруктураПараметровТекущегоУровня.тПараметрыПакета;
	УровеньРасчетаПотребителя 			= СтруктураПараметровТекущегоУровня.УровеньРасчета;	
	ПоказателиТекущегоУровня			= СтруктураПараметровТекущегоУровня.ПоказателиТекущегоУровня;	
	
	// Запрос с временной таблицей
	ТекстШаблонОбщегоЗапроса = "
	|
	|// ВРЕМЕННАЯ ТАБЛИЦА С РАССЧИТАННЫМИ ДАННЫМИ УРОВЕНЬ - %УровеньРасчетаПотребителя% 
	|
	|ВЫБРАТЬ
	|	РассчитанныеЗначения.Показатель КАК Показатель,
	|	РассчитанныеЗначения.ПериодОтчета КАК ПериодОтчета %ТекстАналитик% %ТекстРесурсов%
	|ПОМЕСТИТЬ втРассчитанныеЗначения  
	|ИЗ
	|	&тзРассчитанныеЗначения КАК РассчитанныеЗначения
	|;";	
	
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%УровеньРасчетаПотребителя%",Строка(УровеньРасчетаПотребителя));
	
	// Замены текстов аналитик
	ТекстАналитик = СформироватьТекстАналитик(тИспользуемыеАналитики,УровеньРасчетаПотребителя);
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%ТекстАналитик%",СтрЗаменить(ТекстАналитик,"%ИмяТаблицы%","РассчитанныеЗначения"));

	// Замеры текстов ресурсов
	ТекстРесурсов = СформироватьТекстРесурсов(тИспользуемыеРесурсы,УровеньРасчетаПотребителя);
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%ТекстРесурсов%",СтрЗаменить(ТекстРесурсов,"%ИмяТаблицы%","РассчитанныеЗначения"));
	
	НСтрокаДанные 							= тПодзапросыДанных.Вставить(0); 		
	НСтрокаДанные.НомерПодзапроса 			= 0;
	НСтрокаДанные.ТекстПодзапроса 			= ТекстШаблонОбщегоЗапроса;                              
	НСтрокаДанные.КомментарийКПодзапросу 	= "ВРЕМЕННАЯ ТАБЛИЦА С РАССЧИТАННЫМИ ДАННЫМИ УРОВЕНЬ - " + Строка(УровеньРасчетаПотребителя);
	
	// Создадим таблицу с формулами для расчета
	тФормулыДляРасчетаВКоде = Новый ТаблицаЗначений;
	тФормулыДляРасчетаВКоде.Колонки.Добавить("Потребитель");
	тФормулыДляРасчетаВКоде.Колонки.Добавить("ТипПотребителя");
	тФормулыДляРасчетаВКоде.Колонки.Добавить("ФормулаРасчета");
	тФормулыДляРасчетаВКоде.Колонки.Добавить("ПоказателиДляРасчета");
	
	ПоказателиДляРасчета = Новый ТаблицаЗначений;
	ПоказателиДляРасчета.Колонки.Добавить("Показатель");
	ПоказателиДляРасчета.Колонки.Добавить("ТипПоказателя");
	ПоказателиДляРасчета.Колонки.Добавить("КодВФормуле");
	ПоказателиДляРасчета.Колонки.Добавить("УИДГруппыОтборов");
	ПоказателиДляРасчета.Колонки.Добавить("УИДГруппыТрансформации");
	
	Для Каждого СтрПоказатель Из ПоказателиТекущегоУровня Цикл
		
		Если Не ЗначениеЗаполнено(СтрПоказатель.Потребитель) Тогда
			Продолжить;
		КонецЕсли;
		
		СтрФормулаДляРасчета = тФормулыДляРасчетаВКоде.Найти(СтрПоказатель.Потребитель,"Потребитель");
		Если СтрФормулаДляРасчета = Неопределено Тогда
			СтрФормулаДляРасчета 						= тФормулыДляРасчетаВКоде.Добавить();
			ЗаполнитьЗначенияСвойств(СтрФормулаДляРасчета,СтрПоказатель);
			СтрФормулаДляРасчета.ФормулаРасчета 		= СтрПоказатель.Процедура;
			СтрФормулаДляРасчета.ПоказателиДляРасчета 	= ПоказателиДляРасчета.Скопировать();
		КонецЕсли;
		
		СтрокаПоказателя = СтрФормулаДляРасчета.ПоказателиДляРасчета.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаПоказателя,СтрПоказатель);
		СтрокаПоказателя.Показатель 		= СтрПоказатель.ПоказательОперанд;
		
	КонецЦикла;
	
	СтруктураОтбора	= Новый Структура;
	СтруктураОтбора.Вставить("МаксИспользуемыхАналитик",МаксИспользуемыхАналитик);
	СтруктураОтбора.Вставить("МаксКлючевыхАналитик",МаксКлючевыхАналитик);
	СтруктураОтбора.Вставить("тФормулыДляРасчетаВКоде",тФормулыДляРасчетаВКоде);
	
	нСтрПараметр 				= тПараметрыПакета.Добавить();
    нСтрПараметр.ИмяОтбора 		= "тзРассчитанныеЗначения";
	нСтрПараметр.ТипОтбора 		= "РассчитанныеЗначения";
	нСтрПараметр.ЗначениеОтбора	= СтруктураОтбора;
	
	ТекстШаблонОбщегоЗапроса = "
	|
	|// РАСЧЕТ ПОКАЗАТЕЛЕЙ БЕЗ ФОРМУЛ УРОВЕНЬ - %УровеньРасчетаПотребителя%
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ 
	|	ЗначенияОперандов.Показатель КАК Показатель,
	|	ЗначенияОперандов.ПериодОтчета КАК ПериодОтчета %ТекстАналитик% %ТекстРесурсов% %ВременныйРасчет%
	|//ПОМЕСТИТЬ 
	|ИЗ
	|	втРассчитанныеЗначения КАК ЗначенияОперандов %ВременныРасчетСоединение%
	|";
	
	// Установим флаг временного расчета
	Если УровниСВременнымРасчетом.Найти(УровеньРасчетаПотребителя) = Неопределено Тогда
		ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса, "%ВременныйРасчет%", "");
		ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса, "%ВременныРасчетСоединение%", "");
	Иначе
		ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса, "%ВременныйРасчет%", ",
		|	ПоказателиОперанды.ВременныйРасчет КАК ВременныйРасчет");
		ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса, "%ВременныРасчетСоединение%", "
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
		|		(ВЫБРАТЬ
		|			ПоказателиОперанды.Потребитель,
		|			МАКСИМУМ(ПоказателиОперанды.ВременныйРасчет) КАК ВременныйРасчет
		|		ИЗ
		|			втПоказателиОперанды КАК ПоказателиОперанды
		|		СГРУППИРОВАТЬ ПО
		|			ПоказателиОперанды.Потребитель) КАК ПоказателиОперанды
		|		ПО ЗначенияОперандов.Показатель = ПоказателиОперанды.Потребитель");
	КонецЕсли;
	
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%УровеньРасчетаПотребителя%",Строка(УровеньРасчетаПотребителя));
	
	// Замены текстов аналитик
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%ТекстАналитик%",СтрЗаменить(ТекстАналитик,"%ИмяТаблицы%","ЗначенияОперандов"));

	// Замеры текстов ресурсов
	ТекстРесурсов = СформироватьТекстРесурсов(тИспользуемыеРесурсы,УровеньРасчетаПотребителя);
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%ТекстРесурсов%",СтрЗаменить(ТекстРесурсов,"%ИмяТаблицы%","ЗначенияОперандов"));
	
	НСтрокаДанные 							= тПодзапросыДанных.Добавить(); 		
	НСтрокаДанные.НомерПодзапроса 			= тПодзапросыДанных.Количество();
	НСтрокаДанные.ТекстПодзапроса 			= ТекстШаблонОбщегоЗапроса;                              
	НСтрокаДанные.КомментарийКПодзапросу 	= "РАСЧЕТ ПОКАЗАТЕЛЕЙ ФОРМУЛОЙ В КОДЕ УРОВЕНЬ " + Строка(УровеньРасчетаПотребителя);
	
КонецПроцедуры	

Процедура ПодготовитьТекстЗапросаОперандовБезФормул(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня)
	
	тИспользуемыеАналитики				= СтруктураРасчетаПоказателей.тИспользуемыеАналитики;
	тИспользуемыеРесурсы				= СтруктураРасчетаПоказателей.тИспользуемыеРесурсы;
	УровниСВременнымРасчетом			= СтруктураРасчетаПоказателей.УровниСВременнымРасчетом;
	
	тПодзапросыДанных					= СтруктураПараметровТекущегоУровня.тПодзапросыДанных;
	УровеньРасчетаПотребителя			= СтруктураПараметровТекущегоУровня.УровеньРасчета;	
	ПоказателиТекущегоУровня			= СтруктураПараметровТекущегоУровня.ПоказателиТекущегоУровня;
	
	ТекстШаблонОбщегоЗапроса = "
		|
		|// РАСЧЕТ ПОКАЗАТЕЛЕЙ БЕЗ ФОРМУЛ УРОВЕНЬ - %УровеньРасчетаПотребителя%
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ 
		|	ПоказателиОперанды.Потребитель КАК Показатель,
		|	ЗначенияОперандов.ПериодОтчета КАК ПериодОтчета %ТекстАналитик% %ТекстРесурсов% %ВременныйРасчет%
		|//ПОМЕСТИТЬ
		|ИЗ
		|	втПоказателиОперанды КАК ПоказателиОперанды
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ втЗначенияОперандов%УровеньРасчетаОперанда% КАК ЗначенияОперандов
		|		ПО ПоказателиОперанды.ТекущийПериод = ИСТИНА
		|		И ПоказателиОперанды.УровеньРасчетаПотребителя = %УровеньРасчетаПотребителя%
		|		И ПоказателиОперанды.ВариантРасчета = 2
		|		%УсловияСоединения%
		|";
	
	// Установим флаг временного расчета
	Если УровниСВременнымРасчетом.Найти(УровеньРасчетаПотребителя) = Неопределено Тогда
		ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса, "%ВременныйРасчет%", "");
	Иначе
		ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса, "%ВременныйРасчет%", ",
		|	ПоказателиОперанды.ВременныйРасчет КАК ВременныйРасчет");
	КонецЕсли;
		
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%УровеньРасчетаПотребителя%",Формат(УровеньРасчетаПотребителя,"ЧН=0; ЧГ=0"));
		
	// Замены текстов аналитик
	ТекстАналитик = СформироватьТекстАналитик(тИспользуемыеАналитики,УровеньРасчетаПотребителя);
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%ТекстАналитик%",СтрЗаменить(ТекстАналитик,"%ИмяТаблицы%","ЗначенияОперандов")); 

	// Формируем тексты запросов
	ИспользуемыеПредыдущиеУровниОперандов = ПоказателиТекущегоУровня.Скопировать(Новый Структура("УровеньРасчетаПотребителя",УровеньРасчетаПотребителя));
	ИспользуемыеПредыдущиеУровниОперандов.Свернуть("УровеньРасчетаОперанда");
	
	Для Каждого СтрУровеньИспОперандов Из ИспользуемыеПредыдущиеУровниОперандов Цикл
		
		УровеньРасчетаОперанда = СтрУровеньИспОперандов.УровеньРасчетаОперанда-1;		
		ТекстЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%УровеньРасчетаОперанда%",Формат(УровеньРасчетаОперанда,"ЧГ=0;ЧН=0"));
		
		// Сформируем текст ресурсов
		ТекстРесурсов = "";
		тПоляУровняПотребителя = тИспользуемыеРесурсы.Скопировать(Новый Структура("УровеньРасчета",УровеньРасчетаПотребителя), "Поле");
		тПоляУровняОперанда = тИспользуемыеРесурсы.Скопировать(Новый Структура("УровеньРасчета",УровеньРасчетаОперанда), "Поле");
		Для Каждого СтрокаТаблицы Из тПоляУровняПотребителя Цикл
			Если тПоляУровняОперанда.Найти(СтрокаТаблицы.Поле, "Поле") = Неопределено Тогда
				Если СтрокаТаблицы.Поле = "Значение" Тогда
					ТекстРесурсов = ТекстРесурсов + ",
					|	0 КАК Значение";
				Иначе
					ТекстРесурсов = ТекстРесурсов + ",
					|	НЕОПРЕДЕЛЕНО КАК ЗначениеНечисловое";
				КонецЕсли;
			Иначе
				ТекстРесурсов = ТекстРесурсов + ",
				|	ЗначенияОперандов." + СтрокаТаблицы.Поле + " КАК " + СтрокаТаблицы.Поле;
			КонецЕсли;
		КонецЦикла;
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%ТекстРесурсов%", ТекстРесурсов); 

		Если УровеньРасчетаОперанда = 0 Тогда				 
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%УсловияСоединения%","И ПоказателиОперанды.КодВФормуле = ЗначенияОперандов.КодВФормуле");
		Иначе
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%УсловияСоединения%","И ПоказателиОперанды.ПоказательОперанд = ЗначенияОперандов.Показатель
			|		И ПоказателиОперанды.УИДГруппыОтборов = ЗначенияОперандов.УИДГруппыОтборов
			|		И ПоказателиОперанды.УИДГруппыТрансформации = ЗначенияОперандов.УИДГруппыТрансформации");
		КонецЕсли;
		
		НСтрокаДанные 							= тПодзапросыДанных.Добавить();	
		НСтрокаДанные.НомерПодзапроса 			= тПодзапросыДанных.Количество();
		НСтрокаДанные.ТекстПодзапроса 			= ТекстЗапроса;                              
		НСтрокаДанные.КомментарийКПодзапросу 	= "РАСЧЕТ ПОКАЗАТЕЛЕЙ БЕЗ ФОРМУЛ УРОВЕНЬ - "+Строка(УровеньРасчетаПотребителя);
		
	КонецЦикла;
	
КонецПроцедуры	

Процедура ПодготовитьТекстЗапросаОперандовТолькоСумма(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня)

	тИспользуемыеАналитики				= СтруктураРасчетаПоказателей.тИспользуемыеАналитики;
	тИспользуемыеРесурсы				= СтруктураРасчетаПоказателей.тИспользуемыеРесурсы;
	УровниСВременнымРасчетом			= СтруктураРасчетаПоказателей.УровниСВременнымРасчетом;
	
	тПодзапросыДанных					= СтруктураПараметровТекущегоУровня.тПодзапросыДанных;
	УровеньРасчетаПотребителя			= СтруктураПараметровТекущегоУровня.УровеньРасчета;	
	ПоказателиТекущегоУровня 			= СтруктураПараметровТекущегоУровня.ПоказателиТекущегоУровня;
	
	ТекстШаблонОбщегоЗапроса = "
		|
		|// РАСЧЕТ ПОКАЗАТЕЛЕЙ АГРЕГАЦИЕЙ УРОВЕНЬ - %УровеньРасчетаПотребителя%
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВложенныйЗапрос.Потребитель КАК Показатель,
		|	ВложенныйЗапрос.ПериодОтчета КАК ПериодОтчета %ТекстАналитикУр1% %ТекстРесурсовУр1% %ВременныйРасчетУр1%
		|//ПОМЕСТИТЬ 
		|ИЗ
		|	(
		|%ТекстВложенныйЗапрос%
		|	) КАК ВложенныйЗапрос
		|
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапрос.Потребитель,
		|	ВложенныйЗапрос.ПериодОтчета %ТекстАналитикиГруппировка% %ТекстРесурсыГруппировка%
		|
		|ИМЕЮЩИЕ
		|	СУММА(ВложенныйЗапрос.Значение) <> 0";
		
	ТекстШаблонВложенногоЗапроса = 
		"	ВЫБРАТЬ
		|     	ПоказателиОперанды.Потребитель КАК Потребитель,
		|		ПоказателиОперанды.ПоказательОперанд КАК Показатель,
		|     	ЗначенияОперандов.ПериодОтчета КАК ПериодОтчета %ТекстАналитик% %ТекстРесурсов% %ВременныйРасчет%
		|	ИЗ
		|		втПоказателиОперанды КАК ПоказателиОперанды
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втЗначенияОперандов%УровеньРасчетаОперанда% КАК ЗначенияОперандов
		|			ПО ПоказателиОперанды.ТекущийПериод = ИСТИНА
		|			И ПоказателиОперанды.УровеньРасчетаПотребителя = %УровеньРасчетаПотребителя%
		|			И ПоказателиОперанды.ВариантРасчета = 3
		|			%УсловияСоединения%";
	
	// Установим флаг временного расчета
	Если УровниСВременнымРасчетом.Найти(УровеньРасчетаПотребителя) = Неопределено Тогда
		ТекстШаблонВложенногоЗапроса = СтрЗаменить(ТекстШаблонВложенногоЗапроса, "%ВременныйРасчет%", "");
		ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса, "%ВременныйРасчетУр1%", "");
	Иначе
		ТекстШаблонВложенногоЗапроса = СтрЗаменить(ТекстШаблонВложенногоЗапроса, "%ВременныйРасчет%", ",
		|	ПоказателиОперанды.ВременныйРасчет КАК ВременныйРасчет");
		ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса, "%ВременныйРасчетУр1%", ",
		|	МАКСИМУМ(ВложенныйЗапрос.ВременныйРасчет) КАК ВременныйРасчет");
	КонецЕсли;
		
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%УровеньРасчетаПотребителя%",Формат(УровеньРасчетаПотребителя,"ЧН=0; ЧГ=0"));
	ТекстШаблонВложенногоЗапроса = СтрЗаменить(ТекстШаблонВложенногоЗапроса,"%УровеньРасчетаПотребителя%",Формат(УровеньРасчетаПотребителя,"ЧН=0; ЧГ=0"));
	
	// Замены текстов аналитик
	ТекстАналитик = СформироватьТекстАналитик(тИспользуемыеАналитики,УровеньРасчетаПотребителя);
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%ТекстАналитикУр1%",СтрЗаменить(ТекстАналитик,"%ИмяТаблицы%","ВложенныйЗапрос"));

	ТекстШаблонВложенногоЗапроса = СтрЗаменить(ТекстШаблонВложенногоЗапроса,"%ТекстАналитик%",СтрЗаменить(ТекстАналитик,"%ИмяТаблицы%",Символы.Таб + "ЗначенияОперандов"));
	
	ТекстАналитик = СформироватьТекстАналитик(тИспользуемыеАналитики,УровеньРасчетаПотребителя,3);
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%ТекстАналитикиГруппировка%",СтрЗаменить(ТекстАналитик,"%ИмяТаблицы%","ВложенныйЗапрос"));
	
	// Замены текстов ресурсов
	ТекстРесурсов = СформироватьТекстРесурсов(тИспользуемыеРесурсы,УровеньРасчетаПотребителя,2);
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%ТекстРесурсовУр1%",СтрЗаменить(ТекстРесурсов,"%ИмяТаблицы%","ВложенныйЗапрос"));

	ТекстРесурсов = СформироватьТекстРесурсов(тИспользуемыеРесурсы,УровеньРасчетаПотребителя,3);
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%ТекстРесурсыГруппировка%",СтрЗаменить(ТекстРесурсов,"%ИмяТаблицы%","ВложенныйЗапрос"));	
	
	// Формируем тексты запросов
	ТекстВложенногоЗапроса = "";
	ИспользуемыеПредыдущиеУровниОперандов = ПоказателиТекущегоУровня.Скопировать(Новый Структура("УровеньРасчетаПотребителя",УровеньРасчетаПотребителя),"УровеньРасчетаОперанда");
	ИспользуемыеПредыдущиеУровниОперандов.Свернуть("УровеньРасчетаОперанда");	
	
	Для Каждого СтрУровеньИспОперандов Из ИспользуемыеПредыдущиеУровниОперандов Цикл
		
		Если НЕ ПустаяСтрока(ТекстВложенногоЗапроса) Тогда
			ТекстВложенногоЗапроса = ТекстВложенногоЗапроса + "
			|
			|	//ВЛОЖЕННЫЙ ЗАПРОС ОБЪЕДИНИТЬ
			|";
		КонецЕсли;
		
		УровеньРасчетаОперанда = СтрУровеньИспОперандов.УровеньРасчетаОперанда-1;		
		ТекстВложенногоЗапроса = ТекстВложенногоЗапроса + СтрЗаменить(ТекстШаблонВложенногоЗапроса,"%УровеньРасчетаОперанда%",Формат(УровеньРасчетаОперанда,"ЧГ=0;ЧН=0"));		
		
		// Сформируем текст ресурсов
		ТекстРесурсов = "";
		тПоляУровняПотребителя = тИспользуемыеРесурсы.Скопировать(Новый Структура("УровеньРасчета",УровеньРасчетаПотребителя), "Поле");
		тПоляУровняОперанда = тИспользуемыеРесурсы.Скопировать(Новый Структура("УровеньРасчета",УровеньРасчетаОперанда), "Поле");
		Для Каждого СтрокаТаблицы Из тПоляУровняПотребителя Цикл
			Если тПоляУровняОперанда.Найти(СтрокаТаблицы.Поле, "Поле") = Неопределено Тогда
				Если СтрокаТаблицы.Поле = "Значение" Тогда
					ТекстРесурсов = ТекстРесурсов + ",
					|	0 КАК Значение";
				Иначе
					ТекстРесурсов = ТекстРесурсов + ",
					|	НЕОПРЕДЕЛЕНО КАК ЗначениеНечисловое";
				КонецЕсли;
			Иначе
				ТекстРесурсов = ТекстРесурсов + ",
				|	ЗначенияОперандов." + СтрокаТаблицы.Поле + " КАК " + СтрокаТаблицы.Поле;
			КонецЕсли;
		КонецЦикла;
		ТекстВложенногоЗапроса = СтрЗаменить(ТекстВложенногоЗапроса, "%ТекстРесурсов%", ТекстРесурсов);		

		Если УровеньРасчетаОперанда = 0 Тогда				 
			ТекстВложенногоЗапроса = СтрЗаменить(ТекстВложенногоЗапроса,"%УсловияСоединения%","И ПоказателиОперанды.КодВФормуле = ЗначенияОперандов.КодВФормуле");
		Иначе
			ТекстВложенногоЗапроса = СтрЗаменить(ТекстВложенногоЗапроса,"%УсловияСоединения%","И ПоказателиОперанды.ПоказательОперанд = ЗначенияОперандов.Показатель
			|		И ПоказателиОперанды.УИДГруппыОтборов = ЗначенияОперандов.УИДГруппыОтборов
			|		И ПоказателиОперанды.УИДГруппыТрансформации = ЗначенияОперандов.УИДГруппыТрансформации");
		КонецЕсли;
	
	КонецЦикла;
	
	ТекстОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%ТекстВложенныйЗапрос%",ТекстВложенногоЗапроса);
	
	НСтрокаДанные 							= тПодзапросыДанных.Добавить(); 		
	НСтрокаДанные.НомерПодзапроса 			= тПодзапросыДанных.Количество();
	НСтрокаДанные.ТекстПодзапроса 			= ТекстОбщегоЗапроса;                              
	НСтрокаДанные.КомментарийКПодзапросу 	= "РАСЧЕТ ПОКАЗАТЕЛЕЙ АГРЕГАЦИЕЙ УРОВЕНЬ - "+Строка(УровеньРасчетаПотребителя);
			
КонецПроцедуры	

Процедура ПодготовитьТекстЗапросаОперандовВыражение(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня)

	тИспользуемыеАналитики				= СтруктураРасчетаПоказателей.тИспользуемыеАналитики;
	тИспользуемыеРесурсы				= СтруктураРасчетаПоказателей.тИспользуемыеРесурсы;
	УровниСВременнымРасчетом			= СтруктураРасчетаПоказателей.УровниСВременнымРасчетом;	
	
	тПодзапросыДанных  					= СтруктураПараметровТекущегоУровня.тПодзапросыДанных;
	тПараметрыПакета          			= СтруктураПараметровТекущегоУровня.тПараметрыПакета;
	УровеньРасчетаПотребителя 			= СтруктураПараметровТекущегоУровня.УровеньРасчета;
	ПоказателиТекущегоУровня  			= СтруктураПараметровТекущегоУровня.ПоказателиТекущегоУровня;	

	ТекстШаблонОбщегоЗапроса = "
		|
		|// РАСЧЕТ ПОКАЗАТЕЛЕЙ ФОРМУЛОЙ В ЗАПРОСЕ УРОВЕНЬ - %УровеньРасчетаПотребителя%
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВложенныйЗапросУр2.Показатель КАК Показатель,
		|	ВложенныйЗапросУр2.ПериодОтчета КАК ПериодОтчета %ТекстАналитикУр2% %ТекстРесурсовУр2% %ВременныйРасчетУр2%
		|//ПОМЕСТИТЬ 
		|ИЗ
		|	(
		|	ВЫБРАТЬ
		|		ВложенныйЗапросУр1.Потребитель КАК Показатель,
		|		ВложенныйЗапросУр1.ПериодОтчета КАК ПериодОтчета %ТекстАналитикУр1% %ТекстРесурсовУр1% %ВременныйРасчетУр1%		
		|	ИЗ 
		|		(
		|%ТекстВложенныйЗапрос%
		|		) КАК ВложенныйЗапросУр1
		|
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапросУр1.Потребитель,
		|	ВложенныйЗапросУр1.ПериодОтчета %ТекстАналитикиГруппировка%) КАК ВложенныйЗапросУр2";
		
	ТекстШаблонВложенногоЗапроса = 
		"		ВЫБРАТЬ
		|			ПоказателиОперанды.Потребитель КАК Потребитель,
		|			ПоказателиОперанды.ПоказательОперанд КАК Показатель,
		|			ПоказателиОперанды.КодВФормуле КАК КодВФормуле,
		|			ЗначенияОперандов.ПериодОтчета КАК ПериодОтчета %ТекстАналитик% %ТекстРесурсов% %ВременныйРасчет%
		|		ИЗ
		|			втПоказателиОперанды КАК ПоказателиОперанды
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ втЗначенияОперандов%УровеньРасчетаОперанда% КАК ЗначенияОперандов
		|			ПО ПоказателиОперанды.ТекущийПериод = ИСТИНА
		|				И ПоказателиОперанды.УровеньРасчетаПотребителя = %УровеньРасчетаПотребителя%
		|				И ПоказателиОперанды.ВариантРасчета = 4
		|				%УсловияСоединения%
		|		ГДЕ 
		|			ПоказателиОперанды.Потребитель = &Потребитель_%ИндексПотребителя%";
	
	// Установим флаг временного расчета
	Если УровниСВременнымРасчетом.Найти(УровеньРасчетаПотребителя) = Неопределено Тогда
		ТекстШаблонВложенногоЗапроса = СтрЗаменить(ТекстШаблонВложенногоЗапроса, "%ВременныйРасчет%", "");
		ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса, "%ВременныйРасчетУр1%", "");
		ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса, "%ВременныйРасчетУр2%", "");
	Иначе
		ТекстШаблонВложенногоЗапроса = СтрЗаменить(ТекстШаблонВложенногоЗапроса, "%ВременныйРасчет%", ",
		|	ПоказателиОперанды.ВременныйРасчет КАК ВременныйРасчет");
		ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса, "%ВременныйРасчетУр1%", ",
		|	МАКСИМУМ(ВложенныйЗапросУр1.ВременныйРасчет) КАК ВременныйРасчет");
		ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса, "%ВременныйРасчетУр2%", ",
		|	ВложенныйЗапросУр2.ВременныйРасчет КАК ВременныйРасчет");
	КонецЕсли;
		
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%УровеньРасчетаПотребителя%",Формат(УровеньРасчетаПотребителя,"ЧН=0; ЧГ=0"));
	ТекстШаблонВложенногоЗапроса = СтрЗаменить(ТекстШаблонВложенногоЗапроса,"%УровеньРасчетаПотребителя%",Формат(УровеньРасчетаПотребителя,"ЧН=0; ЧГ=0"));
			
	// Замены текстов аналитик
	ТекстАналитик = СформироватьТекстАналитик(тИспользуемыеАналитики,УровеньРасчетаПотребителя);
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%ТекстАналитикУр1%",СтрЗаменить(ТекстАналитик,"%ИмяТаблицы%",Символы.Таб + "ВложенныйЗапросУр1"));
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%ТекстАналитикУр2%",СтрЗаменить(ТекстАналитик,"%ИмяТаблицы%","ВложенныйЗапросУр2"));
	
	ТекстШаблонВложенногоЗапроса = СтрЗаменить(ТекстШаблонВложенногоЗапроса,"%ТекстАналитик%",СтрЗаменить(ТекстАналитик,"%ИмяТаблицы%",Символы.Таб + Символы.Таб + "ЗначенияОперандов"));
	
	ТекстАналитик = СформироватьТекстАналитик(тИспользуемыеАналитики,УровеньРасчетаПотребителя,3);
	ТекстШаблонОбщегоЗапроса = СтрЗаменить(ТекстШаблонОбщегоЗапроса,"%ТекстАналитикиГруппировка%",СтрЗаменить(ТекстАналитик,"%ИмяТаблицы%","ВложенныйЗапросУр1"));
	
	ТекстРесурсовОбщий = СформироватьТекстРесурсов(тИспользуемыеРесурсы,УровеньРасчетаПотребителя);
	
	// Формируем тексты запросов
	ИндексПотребителя = 1;
	ПотребителиТекущегоУровня = ПоказателиТекущегоУровня.Скопировать(,"Потребитель,ТипПотребителя,Процедура");
	ПотребителиТекущегоУровня.Свернуть("Потребитель,ТипПотребителя,Процедура");	
	Для Каждого стрПотребитель Из ПотребителиТекущегоУровня Цикл
		
		ТекстЗапроса = ТекстШаблонОбщегоЗапроса;		
		ТекстРесурсов = "";
		ТекстРесурсовУр1 = "";
		ТекстРесурсовУр2 = "";
		
		// Получим выражения для ресурсов итогового запроса
		ТекстДляЯзыкаЗапросов = ПолучитьФормулуДляЯзыкаЗапросов(стрПотребитель.Процедура,"ВложенныйЗапросУр2");
		
		Если стрПотребитель.ТипПотребителя = Перечисления.ТипыЗначенийПоказателейОтчетов.Число Тогда
			ТекстРесурсовУр2 = СтрЗаменить(ТекстРесурсовОбщий,"%ИмяТаблицы%.ЗначениеНечисловое","НЕОПРЕДЕЛЕНО");
			ТекстРесурсовУр2 = СтрЗаменить(ТекстРесурсовУр2,"%ИмяТаблицы%.Значение","ВЫРАЗИТЬ(" + ТекстДляЯзыкаЗапросов + " КАК ЧИСЛО(18,5))");
		Иначе
			ТекстРесурсовУр2 = СтрЗаменить(ТекстРесурсовОбщий,"%ИмяТаблицы%.ЗначениеНечисловое",ТекстДляЯзыкаЗапросов);
			ТекстРесурсовУр2 = СтрЗаменить(ТекстРесурсовУр2,"%ИмяТаблицы%.Значение","0");
		КонецЕсли;	
		
		// Получим выражения для ресурсов вложенного запроса
		УровниРасчетаОперандов = Новый Массив;
		ИспользуемыеПредыдущиеУровниОперандов = ПоказателиТекущегоУровня.Скопировать(Новый Структура("Потребитель,УровеньРасчетаПотребителя",стрПотребитель.Потребитель,УровеньРасчетаПотребителя));
		Для Каждого СтрОперанд Из ИспользуемыеПредыдущиеУровниОперандов Цикл
			
			Если СтрНайти(ТекстДляЯзыкаЗапросов,СтрОперанд.КодВФормуле) = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			Если СтрОперанд.ТипПоказателя = Перечисления.ТипыЗначенийПоказателейОтчетов.Число Тогда
				ТекстРесурсов = ТекстРесурсов+",
				|			ВЫБОР КОГДА ПоказателиОперанды.КодВФормуле = &Параметр_%КодВФормуле% ТОГДА ЗначенияОперандов.Значение ИНАЧЕ 0 КОНЕЦ КАК %КодВФормуле%";
				ТекстРесурсовУр1 = ТекстРесурсовУр1+",
				|		СУММА(ВложенныйЗапросУр1.%КодВФормуле%) КАК %КодВФормуле%";
			ИначеЕсли СтрОперанд.ТипПоказателя = Перечисления.ТипыЗначенийПоказателейОтчетов.Булево Тогда
				ТекстРесурсов = ТекстРесурсов+",
				|			ВЫБОР КОГДА ПоказателиОперанды.КодВФормуле = &Параметр_%КодВФормуле% ТОГДА ВЫРАЗИТЬ(ЗначенияОперандов.ЗначениеНечисловое КАК БУЛЕВО) ИНАЧЕ ЛОЖЬ КОНЕЦ КАК %КодВФормуле%";
				ТекстРесурсовУр1 = ТекстРесурсовУр1+",
				|		МАКСИМУМ(ВложенныйЗапросУр1.%КодВФормуле%) КАК %КодВФормуле%";
			ИначеЕсли СтрОперанд.ТипПоказателя = Перечисления.ТипыЗначенийПоказателейОтчетов.Дата Тогда
				ТекстРесурсов = ТекстРесурсов+",
				|			ВЫБОР КОГДА ПоказателиОперанды.КодВФормуле = &Параметр_%КодВФормуле% ТОГДА ВЫРАЗИТЬ(ЗначенияОперандов.ЗначениеНечисловое КАК ДАТА) ИНАЧЕ ДАТАВРЕМЯ(1,1,1) КОНЕЦ КАК %КодВФормуле%";
				ТекстРесурсовУр1 = ТекстРесурсовУр1+",
				|		МАКСИМУМ(ВложенныйЗапросУр1.%КодВФормуле%) КАК %КодВФормуле%";
			ИначеЕсли СтрОперанд.ТипПоказателя = Перечисления.ТипыЗначенийПоказателейОтчетов.Строка Тогда
				ТекстРесурсов = ТекстРесурсов+",
				|			ВЫБОР КОГДА ПоказателиОперанды.КодВФормуле = &Параметр_%КодВФормуле% ТОГДА ВЫРАЗИТЬ(ЗначенияОперандов.ЗначениеНечисловое КАК СТРОКА(1024)) ИНАЧЕ """" КОНЕЦ КАК %КодВФормуле%";
				ТекстРесурсовУр1 = ТекстРесурсовУр1+",
				|		МАКСИМУМ(ВложенныйЗапросУр1.%КодВФормуле%) КАК %КодВФормуле%";
			КонецЕсли;
			
			НОтбор 					= тПараметрыПакета.Добавить();
            НОтбор.ИмяОтбора 		= "Параметр_"+СтрОперанд.КодВФормуле;
			НОтбор.ТипОтбора 		= Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение;
			НОтбор.ЗначениеОтбора	= СтрОперанд.КодВФормуле;
			
			ТекстРесурсов 			= СтрЗаменить(ТекстРесурсов,"%КодВФормуле%",СтрОперанд.КодВФормуле);
			ТекстРесурсовУр1 		= СтрЗаменить(ТекстРесурсовУр1,"%КодВФормуле%",СтрОперанд.КодВФормуле);
			
			Если УровниРасчетаОперандов.Найти(СтрОперанд.УровеньРасчетаОперанда) = Неопределено Тогда
				УровниРасчетаОперандов.Добавить(СтрОперанд.УровеньРасчетаОперанда);
			КонецЕсли;
			
		КонецЦикла;	
		
		// Получим текст вложенного запроса
		ТекстВложенногоЗапроса = "";
		Для Каждого УровеньРасчетаОперанда Из УровниРасчетаОперандов Цикл
			
			Если ТекстВложенногоЗапроса <> "" Тогда
				ТекстВложенногоЗапроса = ТекстВложенногоЗапроса+"
				|
				|	//ВЛОЖЕННЫЙ ЗАПРОС ОБЪЕДИНИТЬ
				|"; 
			КонецЕсли;
			ТекстВложенногоЗапроса = ТекстВложенногоЗапроса + ТекстШаблонВложенногоЗапроса;
			
			ТекстВложенногоЗапроса = СтрЗаменить(ТекстВложенногоЗапроса,"%УровеньРасчетаОперанда%",Формат(УровеньРасчетаОперанда-1,"ЧГ=0;ЧН=0"));
			Если УровеньРасчетаОперанда=1 Тогда				 
				ТекстВложенногоЗапроса = СтрЗаменить(ТекстВложенногоЗапроса,"%УсловияСоединения%","И ПоказателиОперанды.КодВФормуле = ЗначенияОперандов.КодВФормуле");
			Иначе
				ТекстВложенногоЗапроса = СтрЗаменить(ТекстВложенногоЗапроса,"%УсловияСоединения%","И ПоказателиОперанды.ПоказательОперанд = ЗначенияОперандов.Показатель
				|				И ПоказателиОперанды.УИДГруппыОтборов = ЗначенияОперандов.УИДГруппыОтборов
				|				И ПоказателиОперанды.УИДГруппыТрансформации = ЗначенияОперандов.УИДГруппыТрансформации");
			КонецЕсли;	
			
		КонецЦикла;
		
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстВложенныйЗапрос%",ТекстВложенногоЗапроса);
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстРесурсов%",ТекстРесурсов);
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстРесурсовУр1%",ТекстРесурсовУр1);
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстРесурсовУр2%",ТекстРесурсовУр2);
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ИндексПотребителя%",Формат(ИндексПотребителя,"ЧГ=0;ЧН=0"));

		НСтрокаДанные 							= тПодзапросыДанных.Добавить();		
		НСтрокаДанные.НомерПодзапроса 			= тПодзапросыДанных.Количество();
		НСтрокаДанные.ТекстПодзапроса 			= ТекстЗапроса;                              
		НСтрокаДанные.КомментарийКПодзапросу 	= "РАСЧЕТ ПОКАЗАТЕЛЕЙ ФОРМУЛОЙ В ЗАПРОСЕ УРОВЕНЬ "+Строка(УровеньРасчетаПотребителя);
		
		НОтбор 					= тПараметрыПакета.Добавить();
		НОтбор.ИмяОтбора 		= "Потребитель_"+Формат(ИндексПотребителя,"ЧГ=0;ЧН=0");
		НОтбор.ТипОтбора 		= Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение;
		НОтбор.ЗначениеОтбора	= стрПотребитель.Потребитель;	
		
		ИндексПотребителя = ИндексПотребителя+1;
		
	КонецЦикла;	
	
КонецПроцедуры

Процедура ПодготовитьЗапросыРекурсивныхУровней(СтруктураРасчетаПоказателей)

	глТаблицаПересчетаПоказателей       = СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей;
    тПоказателиОперанды                 = СтруктураРасчетаПоказателей.тПоказателиОперанды;
	МаксУровеньРасчета					= СтруктураРасчетаПоказателей.МаксУровеньРасчета;
	
	Для СчПоУровнюРасчета = 1 По МаксУровеньРасчета Цикл
		
		Если СчПоУровнюРасчета = 1 Тогда
			тПоказателиОперандыТекущегоПериода = тПоказателиОперанды.Скопировать(
				Новый Структура("УровеньРасчетаПотребителя,ТекущийПериод,ДляДополненияАналитик,ВременныйРасчет",СчПоУровнюРасчета,Истина,Ложь,Ложь));	
		Иначе			
			тПоказателиОперандыТекущегоПериода = тПоказателиОперанды.Скопировать(
				Новый Структура("УровеньРасчетаПотребителя,ТекущийПериод,ДляДополненияАналитик",СчПоУровнюРасчета,Истина,Ложь));
		КонецЕсли;
		Если тПоказателиОперандыТекущегоПериода.Количество() = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		СтруктураПараметровТекущегоУровня = Новый Структура;
		СтруктураПараметровТекущегоУровня.Вставить("УровеньРасчета",СчПоУровнюРасчета);		
		СтруктураПараметровТекущегоУровня.Вставить("тПодзапросыДанных",ПолучитьОписаниеТаблицыПодзапроса());
		СтруктураПараметровТекущегоУровня.Вставить("тПараметрыПакета",ПолучитьОписаниеТаблицыПараметров());		
		
		// Получаем подзапрос для потребителей, для текущего варианта расчета
		Для СчПоВариантуРасчета = 1 По 4 Цикл			
			ПоказателиТекущегоУровня = тПоказателиОперандыТекущегоПериода.Скопировать(Новый Структура("ВариантРасчета",СчПоВариантуРасчета));
			Если ПоказателиТекущегоУровня.Количество()>0 Тогда				
				СтруктураПараметровТекущегоУровня.Вставить("ПоказателиТекущегоУровня",ПоказателиТекущегоУровня);
				Если СчПоВариантуРасчета = 1 Тогда
					ПодготовитьТекстЗапросаОперандовРучнойПодсчет(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня);
				ИначеЕсли СчПоВариантуРасчета = 2 Тогда
					ПодготовитьТекстЗапросаОперандовБезФормул(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня);
				ИначеЕсли СчПоВариантуРасчета = 3 Тогда
					ПодготовитьТекстЗапросаОперандовТолькоСумма(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня);
				Иначе
					ПодготовитьТекстЗапросаОперандовВыражение(СтруктураРасчетаПоказателей, СтруктураПараметровТекущегоУровня);
				КонецЕсли;	
			КонецЕсли;
		КонецЦикла;
		
		// Добавим запись в таблицу
		нСтрокаТаблицыЗапросов 						= глТаблицаПересчетаПоказателей.Добавить();
		нСтрокаТаблицыЗапросов.УровеньРасчета      	= СчПоУровнюРасчета;
		нСтрокаТаблицыЗапросов.ТекстПодзапросов     = ПолучитьТекстПоТаблицеПодзапросов(СтруктураПараметровТекущегоУровня.тПодзапросыДанных,"втПоказателиРаскрытия"+Строка(СчПоУровнюРасчета));
		нСтрокаТаблицыЗапросов.КомментарийКПакету 	= "ЗАПРОСЫ ДЛЯ РАСЧЕТА ПОКАЗАТЕЛЕЙ УРОВНЯ - "+Строка(СчПоУровнюРасчета);
		нСтрокаТаблицыЗапросов.тПараметрыПакета     = СтруктураПараметровТекущегоУровня.тПараметрыПакета;
		нСтрокаТаблицыЗапросов.ВидОперацииРасчета   = Перечисления.ВидыОперацийРасчетаПоказателей.РасчетВыраженийОперандов;
		
		Если СтруктураПараметровТекущегоУровня.тПодзапросыДанных.Количество()>0 Тогда
			ПодготовитьТекстТрансформацииТекущегоУровня(СтруктураРасчетаПоказателей, СчПоУровнюРасчета);	
		КонецЕсли;
							
	КонецЦикла;	
	
КонецПроцедуры	

#КонецОбласти


#Область ПроцедурыПодготовкиЗапросовДляЗаписиПоказателей

////////////////////////////////////////////////////////////////////////////////
// Процедуры для подготовки текстов запросов измененных показателей
//  
////////////////////////////////////////////////////////////////////////////////

Процедура СоздатьТаблицуИзмененныхПоказателей(СтруктураРасчетаПоказателей, тИзмененныеПоказатели)
	
	глТаблицаПересчетаПоказателей       = СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей;
	МаксКлючевыхАналитик				= СтруктураРасчетаПоказателей.МаксКлючевыхАналитик;		
	МаксИспользуемыхАналитик			= СтруктураРасчетаПоказателей.МаксИспользуемыхАналитик;
	ЕстьАналитикаВалюта				= СтруктураРасчетаПоказателей.ЕстьАналитикаВалюта;
	ЕстьЗначение						= СтруктураРасчетаПоказателей.ЕстьЗначение;
	ЕстьЗначениеВалюта				= СтруктураРасчетаПоказателей.ЕстьЗначениеВалюта;
	ЕстьЗначениеНечисловое            = СтруктураРасчетаПоказателей.ЕстьЗначениеНечисловое;
	
	// Текст аналитик	
	ТекстАналитикиЗначение = "";	
	Для Сч = МаксКлючевыхАналитик+1 По МаксИспользуемыхАналитик Цикл
		ТекстАналитикиЗначение = ТекстАналитикиЗначение + ",
		|	ЗначенияПоказателей.Аналитика" + Сч + " КАК Аналитика" + Сч;
	КонецЦикла;
	Если ЕстьАналитикаВалюта Тогда
		ТекстАналитикиЗначение = ТекстАналитикиЗначение + ",
		|	ЗначенияПоказателей.АналитикаВалюта КАК АналитикаВалюта";
	КонецЕсли;
	Если ЕстьЗначение Тогда
		ТекстАналитикиЗначение = ТекстАналитикиЗначение + ",
		|	ЗначенияПоказателей.Значение КАК Значение";
	КонецЕсли;
	Если ЕстьЗначениеВалюта Тогда
		ТекстАналитикиЗначение = ТекстАналитикиЗначение + ",
		|	ЗначенияПоказателей.ЗначениеВалюта КАК ЗначениеВалюта";
	КонецЕсли;
	Если ЕстьЗначениеНечисловое Тогда
		ТекстАналитикиЗначение = ТекстАналитикиЗначение + ",
		|	ЗначенияПоказателей.ЗначениеНечисловое КАК ЗначениеНечисловое";
	КонецЕсли;
	
	ТекстЗапроса = "
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗначенияПоказателей.Показатель КАК Показатель,
		|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета %ТекстАналитикиЗначение%
		|ПОМЕСТИТЬ втРассчитанныеПоказатели
		|ИЗ
		|	&ИзмененныеПоказатели КАК ЗначенияПоказателей
		|;";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%ТекстАналитикиЗначение%", ТекстАналитикиЗначение);	
	
	тПараметрыПакета = ПолучитьОписаниеТаблицыПараметров();
	
	НПараметр					= тПараметрыПакета.Добавить();
	НПараметр.ТипОтбора 		= Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение;
	НПараметр.ИмяОтбора			= "ИзмененныеПоказатели";
	НПараметр.ЗначениеОтбора 	= тИзмененныеПоказатели;
	
	нСтрокаТаблицыЗапросов 						= глТаблицаПересчетаПоказателей.Добавить();
	нСтрокаТаблицыЗапросов.КомментарийКПакету	= "ДОБАВЛЕНИЕ ТАБЛИЦЫ ИЗМЕНЕННЫХ ПОКАЗАТЕЛЕЙ";
	нСтрокаТаблицыЗапросов.ВидОперацииРасчета   = Перечисления.ВидыОперацийРасчетаПоказателей.ПолучениеИзмененныхПоказателей;
	нСтрокаТаблицыЗапросов.тПараметрыПакета 	= тПараметрыПакета;
	нСтрокаТаблицыЗапросов.ТекстПодзапросов 	= ТекстЗапроса;

КонецПроцедуры

Процедура ПодготовитьТаблицуНовыхЗначенийПотребителей(СтруктураРасчетаПоказателей)
	
    тПоказателиОперанды                 = СтруктураРасчетаПоказателей.тПоказателиОперанды;
	МаксИспользуемыхАналитик            = СтруктураРасчетаПоказателей.МаксИспользуемыхАналитик;
	МаксКлючевыхАналитик				= СтруктураРасчетаПоказателей.МаксКлючевыхАналитик;
	глТаблицаПересчетаПоказателей       = СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей;
	тИспользуемыеАналитики				= СтруктураРасчетаПоказателей.тИспользуемыеАналитики;
	тИспользуемыеРесурсы 				= СтруктураРасчетаПоказателей.тИспользуемыеРесурсы;
	МаксУровеньРасчета					= СтруктураРасчетаПоказателей.МаксУровеньРасчета;
	УровниСВременнымРасчетом			= СтруктураРасчетаПоказателей.УровниСВременнымРасчетом;
	ЕстьАналитикаВалюта					= СтруктураРасчетаПоказателей.ЕстьАналитикаВалюта;
	тРасшифровкаГруппОтборов			= СтруктураРасчетаПоказателей.тРасшифровкаГруппОтборов;
	
	тПараметрыПакета = ПолучитьОписаниеТаблицыПараметров();
	тПодзапросыДанных = ПолучитьОписаниеТаблицыПодзапроса();
	
	ТекстШаблонаЗапроса = "
		|
		|// ЗНАЧЕНИЯ ПОТРЕБИТЕЛЕЙ УРОВЕНЬ - %УровеньРасчетаПотребителя%
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	%УровеньРасчета% КАК УровеньРасчета,
		|	ПоказателиОперанды.Показатель КАК Показатель,
		|	ПоказателиОперанды.ПериодОтчета КАК ПериодОтчета %ТекстАналитик% %ТекстРесурсов%
		|//ПОМЕСТИТЬ
		|ИЗ
		|	втПоказателиРаскрытия%УровеньРасчетаПотребителя% КАК ПоказателиОперанды";
	
	ИтоговыеРесурсы = тИспользуемыеРесурсы.Скопировать(Новый Структура("ВыводитсяВОтчет",Истина));
	ИтоговыеРесурсы.Свернуть("Поле,Суммируется");
	
	// Рассчитанные значения для зависимых по периоду берутся из лога расчета по периодам
	тЗависимыеПоПериоду = тПоказателиОперанды.Скопировать(Новый Структура("ТекущийПериод",Ложь), 
		"Потребитель,ТипПотребителя,Процедура,ЭтоОперандТекущегоПериода,УровеньРасчетаПотребителя,УровеньРасчетаОперанда,КодВФормуле,ПоказательОперанд,ТипПоказателя,УИДГруппыОтборов,УИДГруппыТрансформации");
	Если тЗависимыеПоПериоду.Количество()>0 Тогда
		
		// Запрос с временной таблицей рассчитанных значений
		ТекстЗапросаПолученияЗависимыхПоПериоду = "
			|// ЗНАЧЕНИЯ ЗАВИСИМЫХ ПО ПЕРИОДУ ДЛЯ ВСЕХ УРОВНЕЙ
			|
			|ВЫБРАТЬ 
			|	ПоказателиОперанды.Показатель КАК Показатель,
			|	ПоказателиОперанды.ПериодОтчета КАК ПериодОтчета %ТекстАналитик% %ТекстРесурсов%
			|ПОМЕСТИТЬ втПоказателиРаскрытия_РассчитанныеЗначенияПоПериодам
			|ИЗ
			|	&РассчитанныеЗначенияПоПериодам КАК ПоказателиОперанды";
		
		// Добавим аналитики рассчитанных показателей
		ТекстАналитик = "";
		Для ИндПоля = МаксКлючевыхАналитик+1 По МаксИспользуемыхАналитик Цикл
			ТекстАналитик = ТекстАналитик + ",
			|	ПоказателиОперанды.Аналитика" + ИндПоля + " КАК Аналитика" + ИндПоля;
		КонецЦикла;
		Если ЕстьАналитикаВалюта Тогда
			ТекстАналитик = ТекстАналитик + ",
			|	ПоказателиОперанды.АналитикаВалюта КАК АналитикаВалюта";
		КонецЕсли;
		ТекстЗапросаПолученияЗависимыхПоПериоду = СтрЗаменить(ТекстЗапросаПолученияЗависимыхПоПериоду, "%ТекстАналитик%", ТекстАналитик);
		
		// Добавим ресурсы
		ТекстРесурсов = "";
		Для Каждого Ресурс Из ИтоговыеРесурсы Цикл
			ТекстРесурсов = ТекстРесурсов + ",
			|	ПоказателиОперанды." + Ресурс.Поле + " КАК " + Ресурс.Поле;
		КонецЦикла;
		ТекстЗапросаПолученияЗависимыхПоПериоду = СтрЗаменить(ТекстЗапросаПолученияЗависимыхПоПериоду, "%ТекстРесурсов%", ТекстРесурсов);
		
		// Сформируем таблицу параметров для расчета
		тЗависимыеПоПериоду.Сортировать("УровеньРасчетаПотребителя");
		тЗависимыеПоПериоду.Колонки.Добавить("ОтборПоПериоду");
		Для Каждого СтрокаПоказатель Из тЗависимыеПоПериоду Цикл
			
			ОтборПоПериоду = Новый ТаблицаЗначений;
			ОтборПоПериоду.Колонки.Добавить("ТипОтбора");
			ОтборПоПериоду.Колонки.Добавить("ЗначениеОтбора");
		
			тОтбор = тРасшифровкаГруппОтборов.НайтиСтроки(Новый Структура("УИДГруппыОтборов,ПолеБД",СтрокаПоказатель.УИДГруппыОтборов,"ПериодОтчета"));
			Для Каждого СтрокаОтбор Из тОтбор Цикл			
				
				нОтбор = ОтборПоПериоду.Добавить();
				нОтбор.ТипОтбора 		= СтрокаОтбор.СпособВычисленияПараметра;
				нОтбор.ЗначениеОтбора   = СтрокаОтбор.УточнениеСпособаОпределения;
				
			КонецЦикла;
			
			СтрокаПоказатель.ОтборПоПериоду = ОтборПоПериоду;
			
		КонецЦикла;
		
		// Добавим таблицу в параметры пакета
		тПараметрыПакета 		= ПолучитьОписаниеТаблицыПараметров();
		НОтбор 					= тПараметрыПакета.Добавить();
		НОтбор.ИмяОтбора 		= "РассчитанныеЗначенияПоПериодам";
		НОтбор.ТипОтбора 		= "РассчитанныеЗначенияПоПериодам";		
		НОтбор.ЗначениеОтбора	= тЗависимыеПоПериоду;	
		
		// Добавим строку в таблицу пересчета показателей
		нСтрокаТаблицыЗапросов						= глТаблицаПересчетаПоказателей.Добавить();
		нСтрокаТаблицыЗапросов.ТекстПодзапросов   	= ТекстЗапросаПолученияЗависимыхПоПериоду;
		нСтрокаТаблицыЗапросов.КомментарийКПакету 	= "ТАБЛИЦА НОВЫХ ЗНАЧЕНИЙ ПОТРЕБИТЕЛЕЙ РЕКУРСИВНО ЗАВИСИМЫХ ПО ПЕРИОДУ";
		нСтрокаТаблицыЗапросов.тПараметрыПакета     = тПараметрыПакета;		
		нСтрокаТаблицыЗапросов.ВидОперацииРасчета   = Перечисления.ВидыОперацийРасчетаПоказателей.РасчетВыраженийОперандовЗависимыхПоПериоду;
		
		// Таблица для объединения с рассчитанными показателями на нижних уровнях
		ТекстЗапроса = СтрЗаменить(ТекстШаблонаЗапроса,"%УровеньРасчетаПотребителя%","_РассчитанныеЗначенияПоПериодам");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%УровеньРасчета%","0");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстАналитик%",ТекстАналитик);
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстРесурсов%",ТекстРесурсов);
		
		НСтрокаДанные 							= тПодзапросыДанных.Добавить();	
		НСтрокаДанные.НомерПодзапроса 			= тПодзапросыДанных.Количество();
		НСтрокаДанные.ТекстПодзапроса 			= ТекстЗапроса;                              
		НСтрокаДанные.КомментарийКПодзапросу 	= "ЗНАЧЕНИЯ ПОТРЕБИТЕЛЕЙ ЗАВИСИМЫХ ПО ПЕРИОДУ";
		
	КонецЕсли;
	
	// Рассчитанные значения для независимых по периоду берутся из временных таблиц соответствующего уровня расчета
	тНезависимыеПоПериоду  = тПоказателиОперанды.Скопировать(Новый Структура("ТекущийПериод",Истина));
	тНезависимыеПоПериоду.Сортировать("УровеньРасчетаПотребителя");
	тНезависимыеПоПериоду.Свернуть("УровеньРасчетаПотребителя");
	Для Каждого СтрРасчетаПотребителя Из тНезависимыеПоПериоду Цикл
		
		УровеньРасчетаПотребителя = СтрРасчетаПотребителя.УровеньРасчетаПотребителя;
		
		ТекстЗапроса = СтрЗаменить(ТекстШаблонаЗапроса,"%УровеньРасчетаПотребителя%",Формат(УровеньРасчетаПотребителя,"ЧН=0; ЧГ=0"));
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%УровеньРасчета%",Формат(УровеньРасчетаПотребителя,"ЧН=0; ЧГ=0"));
		
		// Фильтр по операндам временного расчета
		Если УровниСВременнымРасчетом.Найти(УровеньРасчетаПотребителя) <> Неопределено Тогда
			ТекстЗапроса = ТекстЗапроса + "
			|ГДЕ
			|	НЕ ПоказателиОперанды.ВременныйРасчет";
		КонецЕсли;
		
		// Текст полей на текущем уровне
		ТекстАналитик = "";		
		Для ИндПоля = МаксКлючевыхАналитик+1 По МаксИспользуемыхАналитик Цикл
			Если тИспользуемыеАналитики.НайтиСтроки(Новый Структура("УровеньРасчета,Поле",УровеньРасчетаПотребителя,"Аналитика" + ИндПоля)).Количество() > 0 Тогда
				ТекстАналитик = ТекстАналитик + ",
				|	ПоказателиОперанды.Аналитика" + ИндПоля + " КАК " + "Аналитика" + ИндПоля;
			Иначе
				ТекстАналитик = ТекстАналитик + ",
				|	НЕОПРЕДЕЛЕНО КАК " + "Аналитика" + ИндПоля;
			КонецЕсли;
		КонецЦикла;
		
		// Текст ресурсов на текущем уровне
		ТекстРесурсов = "";
		Для Каждого Ресурс Из ИтоговыеРесурсы Цикл
			Если тИспользуемыеРесурсы.НайтиСтроки(Новый Структура("УровеньРасчета,Поле",УровеньРасчетаПотребителя,Ресурс.Поле)).Количество() > 0 Тогда
				ТекстРесурсов = ТекстРесурсов + ",
				|	ПоказателиОперанды." + Ресурс.Поле + " КАК " + Ресурс.Поле;				
			ИначеЕсли Ресурс.Суммируется Тогда
				ТекстРесурсов = ТекстРесурсов + ",
				|	0 КАК " + Ресурс.Поле;
			Иначе
				ТекстРесурсов = ТекстРесурсов + ",
				|	НЕОПРЕДЕЛЕНО КАК " + Ресурс.Поле;
			КонецЕсли;
		КонецЦикла;
		
		// Значение валюта
		Если ЕстьАналитикаВалюта Тогда
			Если тИспользуемыеАналитики.НайтиСтроки(Новый Структура("УровеньРасчета,Поле",УровеньРасчетаПотребителя,"АналитикаВалюта")).Количество() > 0 Тогда
				ТекстАналитик = ТекстАналитик + ",
				|	ПоказателиОперанды.АналитикаВалюта КАК АналитикаВалюта";
			Иначе
				ТекстАналитик = ТекстАналитик + ",
				|	ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка) КАК АналитикаВалюта";
			КонецЕсли;	
		КонецЕсли;
		
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстАналитик%",ТекстАналитик);
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстРесурсов%",ТекстРесурсов);
		
		НСтрокаДанные 							= тПодзапросыДанных.Добавить();	
		НСтрокаДанные.НомерПодзапроса 			= тПодзапросыДанных.Количество();
		НСтрокаДанные.ТекстПодзапроса 			= ТекстЗапроса;                              
		НСтрокаДанные.КомментарийКПодзапросу 	= "ЗНАЧЕНИЯ ПОТРЕБИТЕЛЕЙ УРОВЕНЬ " + Формат(УровеньРасчетаПотребителя,"ЧН=0; ЧГ=0");
		
	КонецЦикла;
		
	нСтрокаТаблицыЗапросов 						= глТаблицаПересчетаПоказателей.Добавить();
	нСтрокаТаблицыЗапросов.ТекстПодзапросов     = ПолучитьТекстПоТаблицеПодзапросов(тПодзапросыДанных, "втЗначенияПотребителейРасчет");
	нСтрокаТаблицыЗапросов.КомментарийКПакету 	= "ОБЪЕДИНЕННАЯ ТАБЛИЦА НОВЫХ ЗНАЧЕНИЙ ПОТРЕБИТЕЛЕЙ";
	нСтрокаТаблицыЗапросов.тПараметрыПакета     = тПараметрыПакета;
	нСтрокаТаблицыЗапросов.ВидОперацииРасчета   = Перечисления.ВидыОперацийРасчетаПоказателей.РасчетИтоговыхЗначенийПоказателей;
	
КонецПроцедуры

Процедура СвернутьТаблицуНовыхЗначенийПотребителей(СтруктураРасчетаПоказателей)

	глТаблицаПересчетаПоказателей	= СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей;
	МаксКлючевыхАналитик			= СтруктураРасчетаПоказателей.МаксКлючевыхАналитик;		
	МаксИспользуемыхАналитик		= СтруктураРасчетаПоказателей.МаксИспользуемыхАналитик;
	ЕстьЗначение					= СтруктураРасчетаПоказателей.ЕстьЗначение;
	ЕстьЗначениеНечисловое          = СтруктураРасчетаПоказателей.ЕстьЗначениеНечисловое;

	ТекстЗапроса = "
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗначенияПоказателей.УровеньРасчета КАК УровеньРасчета,
		|	ЗначенияПоказателей.Показатель КАК Показатель,
		|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета %ТекстАналитики% %ТекстЗначение%
		|ПОМЕСТИТЬ втРассчитанныеПоказатели
		|ИЗ
		|	втЗначенияПотребителейРасчет КАК ЗначенияПоказателей
		|
		|СГРУППИРОВАТЬ ПО
		|	ЗначенияПоказателей.УровеньРасчета,
		|	ЗначенияПоказателей.Показатель,
		|	ЗначенияПоказателей.ПериодОтчета %ТекстАналитики%	
		|";
	
	ТекстАналитики = "";		
	Для ИндПоля = МаксКлючевыхАналитик+1 По МаксИспользуемыхАналитик Цикл
		ТекстАналитики = ТекстАналитики + ",
		|	ЗначенияПоказателей.Аналитика" + ИндПоля;
	КонецЦикла;
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстАналитики%", ТекстАналитики);
	
	ТекстЗначение = "";
	Если ЕстьЗначение Тогда
		ТекстЗначение = ",
		|	СУММА(ЗначенияПоказателей.Значение) КАК Значение";
	КонецЕсли;
	Если ЕстьЗначениеНечисловое Тогда
		ТекстЗначение = ",
		|	МАКСИМУМ(ЗначенияПоказателей.ЗначениеНечисловое) КАК ЗначениеНечисловое"; 
	КонецЕсли;
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстЗначение%", ТекстЗначение);

	нСтрокаТаблицыЗапросов = глТаблицаПересчетаПоказателей.Добавить();	
	нСтрокаТаблицыЗапросов.ТекстПодзапросов 	= ТекстЗапроса;
	нСтрокаТаблицыЗапросов.КомментарийКПакету 	= "СВЕРНУТАЯ ТАБЛИЦА НОВЫХ ЗНАЧЕНИЙ ПОТРЕБИТЕЛЕЙ";
	нСтрокаТаблицыЗапросов.ВидОперацииРасчета   = Перечисления.ВидыОперацийРасчетаПоказателей.РасчетИтоговыхЗначенийПоказателей;
	
КонецПроцедуры

Процедура ДобавитьОтборыПоКлючевымСрезам(тРасшифровкаГруппОтборовТекВерсии, РазделениеПоПроектам, МаксКлючевыхАналитик, МассивОрганизацийПериметра=Неопределено)
	
	Если МассивОрганизацийПериметра = Неопределено Тогда
		нСтр 								= тРасшифровкаГруппОтборовТекВерсии.Добавить();
	    нСтр.ПолеБД 						= "Организация";
		нСтр.СпособВычисленияПараметра 		= Перечисления.СпособыВычисленияПараметровОперандов.ОрганизацияОтчета;
		нСтр.ИдентификаторРодителя 			= 0;
		нСтр.УИДГруппыОтборов 				= 0;
	Иначе
		нСтр 								= тРасшифровкаГруппОтборовТекВерсии.Добавить();
	    нСтр.ПолеБД 						= "Организация";
		нСтр.СпособВычисленияПараметра 		= Перечисления.СпособыВычисленияПараметровОперандов.СписокФиксированныхЗначений;
		нСтр.ИдентификаторРодителя 			= 0;
		нСтр.УИДГруппыОтборов 				= 0;
		нСтр.УточнениеСпособаОпределения	= МассивОрганизацийПериметра;
	КонецЕсли;
	
	нСтр 							= тРасшифровкаГруппОтборовТекВерсии.Добавить();
    нСтр.ПолеБД 					= "Валюта";
	нСтр.СпособВычисленияПараметра 	= Перечисления.СпособыВычисленияПараметровОперандов.ВалютаОтчета;
	нСтр.ИдентификаторРодителя 		= 0;
	нСтр.УИДГруппыОтборов 			= 0;
	
	нСтр 							= тРасшифровкаГруппОтборовТекВерсии.Добавить();
    нСтр.ПолеБД 					= "ПериодОтчета";
	нСтр.СпособВычисленияПараметра 	= Перечисления.СпособыВычисленияПараметровОперандов.ПериодОтчета;
	нСтр.ИдентификаторРодителя 		= 0;
	нСтр.УИДГруппыОтборов 			= 0;

	нСтр 							= тРасшифровкаГруппОтборовТекВерсии.Добавить();
    нСтр.ПолеБД 					= "Сценарий";
	нСтр.СпособВычисленияПараметра 	= Перечисления.СпособыВычисленияПараметровОперандов.СценарийОтчета;
	нСтр.ИдентификаторРодителя 		= 0;
	нСтр.УИДГруппыОтборов 			= 0;
	
	// Добавим фильтр по проекту, если он используется
	Если РазделениеПоПроектам Тогда
		нСтр 							= тРасшифровкаГруппОтборовТекВерсии.Добавить();
	    нСтр.ПолеБД 					= "Проект";
		нСтр.СпособВычисленияПараметра 	= Перечисления.СпособыВычисленияПараметровОперандов.ПроектОтчета;
		нСтр.ИдентификаторРодителя 		= 0;
		нСтр.УИДГруппыОтборов 			= 0;
	КонецЕсли;
	
	// Добавим фильтр по ключевым аналитикам
	Для ИндПоля = 1 По МаксКлючевыхАналитик Цикл
		нСтр							= тРасшифровкаГруппОтборовТекВерсии.Добавить();
	    нСтр.ПолеБД 					= "Аналитика"+ИндПоля;
		нСтр.СпособВычисленияПараметра 	= Перечисления.СпособыВычисленияПараметровОперандов[нСтр.ПолеБД];
		нСтр.ИдентификаторРодителя 		= 0;
		нСтр.УИДГруппыОтборов 			= 0;
	КонецЦикла;
	
КонецПроцедуры	

Процедура ПодготовитьТаблицуИсходныхЗначенийПотребителей(СтруктураРасчетаПоказателей, МассивОрганизацийПериметра = Неопределено, УстановкаЗначенийПоказателей = Ложь)
	
	глТаблицаПересчетаПоказателей       = СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей;
    тПоказателиОперанды                 = СтруктураРасчетаПоказателей.тПоказателиОперанды;	
	тИспользуемыеРесурсы                = СтруктураРасчетаПоказателей.тИспользуемыеРесурсы;
	тИспользуемыеАналитики              = СтруктураРасчетаПоказателей.тИспользуемыеАналитики;
	тРасшифровкаГруппОтборов 			= СтруктураРасчетаПоказателей.тРасшифровкаГруппОтборов;
	МаксКлючевыхАналитик				= СтруктураРасчетаПоказателей.МаксКлючевыхАналитик;
	МаксИспользуемыхАналитик 			= СтруктураРасчетаПоказателей.МаксИспользуемыхАналитик;
	ДанныеВидаОтчета 					= СтруктураРасчетаПоказателей.ДанныеВидаОтчета;
	МаксУровеньРасчета					= СтруктураРасчетаПоказателей.МаксУровеньРасчета;
	ЕстьАналитикаВалюта					= СтруктураРасчетаПоказателей.ЕстьАналитикаВалюта;
	ЕстьЗначениеВалюта					= СтруктураРасчетаПоказателей.ЕстьЗначениеВалюта;
	ПолучатьДанныеИзРегистров			= СтруктураРасчетаПоказателей.ПолучатьДанныеИзРегистров;
	
	// Добавим фильтры по всем срезам отчета
	тРасшифровкаГруппОтборовТекВерсии = тРасшифровкаГруппОтборов.СкопироватьКолонки();
	ДобавитьОтборыПоКлючевымСрезам(тРасшифровкаГруппОтборовТекВерсии,ДанныеВидаОтчета.РазделениеПоПроектам,МаксКлючевыхАналитик,МассивОрганизацийПериметра);
		
	// Добавим ресурсы
	тИспользуемыеРесурсыТекВерсии = тИспользуемыеРесурсы.Скопировать(Новый Структура("ВыводитсяВОтчет",Истина));
	тИспользуемыеРесурсыТекВерсии.ЗаполнитьЗначения(1,"УровеньРасчета");
	тИспользуемыеРесурсыТекВерсии.Свернуть("Поле,УровеньРасчета,Суммируется");
	
	// Добавим аналитики
	тИспользуемыеАналитикиТекВерсии	= тИспользуемыеАналитики.СкопироватьКолонки();
	
	Для ИндПоля = МаксКлючевыхАналитик+1 По МаксИспользуемыхАналитик Цикл
		нСтр							= тИспользуемыеАналитикиТекВерсии.Добавить();
		нСтр.УровеньРасчета				= 1;
		нСтр.Поле						= "Аналитика"+ИндПоля;
		нСтр.ПолеВерсии					= Ложь;
	КонецЦикла;
	
	// Добавим аналитику по валюте
	Если ЕстьАналитикаВалюта Тогда 		
		нСтр							= тИспользуемыеАналитикиТекВерсии.Добавить();
		нСтр.УровеньРасчета				= 1;
		нСтр.Поле						= "АналитикаВалюта";
		нСтр.ПолеВерсии					= Ложь;
	КонецЕсли;
	
	// Добавим значение в валюте
	Если ЕстьЗначениеВалюта Тогда		
		НСтр = тИспользуемыеРесурсыТекВерсии.Добавить();
		НСтр.Поле						= "ЗначениеВалюта";
		НСтр.УровеньРасчета 			= 1;
		НСтр.Суммируется				= Истина;		
	КонецЕсли;
	
	// Структура расчета показателей
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("глТаблицаПересчетаПоказателей",глТаблицаПересчетаПоказателей);
	СтруктураПараметров.Вставить("тИспользуемыеАналитики",тИспользуемыеАналитикиТекВерсии);
	СтруктураПараметров.Вставить("тИспользуемыеРесурсы",тИспользуемыеРесурсыТекВерсии);
	СтруктураПараметров.Вставить("тРасшифровкаГруппОтборов",тРасшифровкаГруппОтборовТекВерсии);
	СтруктураПараметров.Вставить("ПолучатьДанныеИзРегистров",ПолучатьДанныеИзРегистров);
	СтруктураПараметров.Вставить("РасчетПоИзмененнымПоказателям",Истина);	
	
	// Структура расчета показателей текущей версии
	СтруктураПараметровТекущегоУровня = Новый Структура;
	СтруктураПараметровТекущегоУровня.Вставить("УИДГруппыОтборов",0);
	СтруктураПараметровТекущегоУровня.Вставить("УровеньРасчета",0);
	СтруктураПараметровТекущегоУровня.Вставить("ТекущийПериод",МассивОрганизацийПериметра = Неопределено);	
	
	тПодзапросыДанных = ПолучитьОписаниеТаблицыПодзапроса();
	СтруктураПараметровТекущегоУровня.Вставить("тПодзапросыДанных",тПодзапросыДанных);
	тПараметрыПакета = ПолучитьОписаниеТаблицыПараметров();
	СтруктураПараметровТекущегоУровня.Вставить("тПараметрыПакета",тПараметрыПакета);
	
	ВидыОтчетовСинтетика = Новый Массив;
	ВидыОтчетовСинтетика.Добавить(ДанныеВидаОтчета.ВидОтчета);
	СтруктураПараметровТекущегоУровня.Вставить("ВидыОтчетовСинтетика",ВидыОтчетовСинтетика);
	
	УровниРегистраПотребителей = тПоказателиОперанды.Скопировать(,"Потребитель,ИндексРегистраПотребителя");
	УровниРегистраПотребителей.Свернуть("Потребитель,ИндексРегистраПотребителя");
	
	УровниРегистра = УровниРегистраПотребителей.Скопировать(,"ИндексРегистраПотребителя");
	УровниРегистра.Свернуть("ИндексРегистраПотребителя");
	УровниРегистра.Сортировать("ИндексРегистраПотребителя Возр");
	
	Если МассивОрганизацийПериметра = Неопределено Тогда
		ПрефиксТаблицыВерсий = "текВерсии_";
		СтруктураПараметровТекущегоУровня.Вставить("ВидОперацииРасчета",Перечисления.ВидыОперацийРасчетаПоказателей.ПолучениеЗначенийПотребителей);
	Иначе
		ПрефиксТаблицыВерсий = "втВерсииБаза_";
		СтруктураПараметровТекущегоУровня.Вставить("ВидОперацииРасчета",Перечисления.ВидыОперацийРасчетаПоказателей.ПолучениеДанныхТекущегоПериметра);
	КонецЕсли;
	
	// Запрос по версиям вида отчета
	Для Каждого СтрУровень Из УровниРегистра Цикл
		СтруктураПараметровТекущегоУровня.Вставить("ИндексРегистра",СтрУровень.ИндексРегистраПотребителя);	
		Если СтрУровень.ИндексРегистраПотребителя < 0 Тогда
			СтруктураПараметровТекущегоУровня.Вставить("ПрефиксТаблицыВерсий",ПрефиксТаблицыВерсий + "Нечисловые_");
			ПолучитьПодзапросТекущейВерсии(СтруктураПараметров, СтруктураПараметровТекущегоУровня);
		Иначе
			СтруктураПараметровТекущегоУровня.Вставить("ПрефиксТаблицыВерсий",ПрефиксТаблицыВерсий);
			ПолучитьПодзапросТекущейВерсии(СтруктураПараметров, СтруктураПараметровТекущегоУровня);
			Прервать;
		КонецЕсли;   
	КонецЦикла;
		
	СтруктураПараметровТекущегоУровня.Вставить("ЕстьСоответствиеПериодов", Ложь);
	СтруктураПараметровТекущегоУровня.Вставить("УровеньРасчета",1);
	
	Для Каждого СтрУровень Из УровниРегистра Цикл
		
		СтруктураПараметровТекущегоУровня.Вставить("ИндексРегистра",СтрУровень.ИндексРегистраПотребителя);
		СтруктураПараметровТекущегоУровня.Вставить("ИндексЗапроса",УровниРегистра.Индекс(СтрУровень));		
		
		Если СтрУровень.ИндексРегистраПотребителя < 0 Тогда
			СтруктураПараметровТекущегоУровня.Вставить("ПрефиксТаблицыВерсий",ПрефиксТаблицыВерсий + "Нечисловые_");
		Иначе
			СтруктураПараметровТекущегоУровня.Вставить("ПрефиксТаблицыВерсий",ПрефиксТаблицыВерсий);
		КонецЕсли;
		
		ПолучитьТекстЗначенийПоказателей(СтруктураПараметров,СтруктураПараметровТекущегоУровня,УстановкаЗначенийПоказателей);
		
		НОтбор 					= тПараметрыПакета.Добавить();
		НОтбор.ИмяОтбора 		= "ОтборПоказателей_0_ИндексЗапроса_" + УровниРегистра.Индекс(СтрУровень);
		НОтбор.ТипОтбора 		= Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение;
		НОтбор.ЗначениеОтбора	= УровниРегистраПотребителей.Скопировать(Новый Структура("ИндексРегистраПотребителя",СтрУровень.ИндексРегистраПотребителя)).ВыгрузитьКолонку("Потребитель");	
		
	КонецЦикла;		
	
	нСтрокаТаблицыЗапросов 									= глТаблицаПересчетаПоказателей.Добавить();
	нСтрокаТаблицыЗапросов.тПараметрыПакета                 = тПараметрыПакета;
	
	Если МассивОрганизацийПериметра = Неопределено Тогда
		нСтрокаТаблицыЗапросов.ТекстПодзапросов             = ПолучитьТекстПоТаблицеПодзапросов(тПодзапросыДанных,"втЗначенияПоказателейДоИзменения");
	    нСтрокаТаблицыЗапросов.КомментарийКПакету 			= "ЗАПРОС ДЛЯ ПОДЪЕМА НЕСГРУППИРОВАННЫХ ДАННЫХ РАСЧЕТНЫХ ПОКАЗАТЕЛЕЙ ТЕКУЩЕГО СРЕЗА";
		нСтрокаТаблицыЗапросов.ВидОперацииРасчета           = Перечисления.ВидыОперацийРасчетаПоказателей.ПолучениеЗначенийПотребителей;
	Иначе
		нСтрокаТаблицыЗапросов.ТекстПодзапросов             = ПолучитьТекстПоТаблицеПодзапросов(тПодзапросыДанных,"втЗначенияПотребителейРасчет");
	    нСтрокаТаблицыЗапросов.КомментарийКПакету 			= "ЗАПРОС ПО КОНСОЛИДИРОВАННОМУ ПЕРИМЕТРУ";
		нСтрокаТаблицыЗапросов.ВидОперацииРасчета           = Перечисления.ВидыОперацийРасчетаПоказателей.ПолучениеДанныхТекущегоПериметра;
	КонецЕсли;
		
КонецПроцедуры	

Процедура ПодготовитьТаблицуДляРасчетаОтклонений(СтруктураРасчетаПоказателей)
	
	глТаблицаПересчетаПоказателей	= СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей;
	МаксИспользуемыхАналитик        = СтруктураРасчетаПоказателей.МаксИспользуемыхАналитик;
	МаксКлючевыхАналитик			= СтруктураРасчетаПоказателей.МаксКлючевыхАналитик;
	ЕстьАналитикаВалюта				= СтруктураРасчетаПоказателей.ЕстьАналитикаВалюта; 
	ЕстьЗначение					= СтруктураРасчетаПоказателей.ЕстьЗначение;
	ЕстьЗначениеНечисловое			= СтруктураРасчетаПоказателей.ЕстьЗначениеНечисловое;
	
	// Подготовим тексты для аналитик
	ТекстАналитики   					= "";
	ТекстАналитикиВыбор					= "";
	ТекстЗначение						= "";
	ТекстЗначениеДоИзменения			= "";
	ТекстЗначениеНечисловое				= "";
	ТекстЗначениеНечисловоеДоИзменения 	= "";
	ТекстЗначениеНечисловоеNULL			= "";
	
	// Добавим аналитики рассчитанных показателей
	Для ИндПоля = МаксКлючевыхАналитик+1 По МаксИспользуемыхАналитик Цикл
		ТекстАналитики = ТекстАналитики + ",
		|	ЗначенияПоказателей.Аналитика" + ИндПоля;
		ТекстАналитикиВыбор = ТекстАналитикиВыбор + ",
		|	ВЫБОР
		|		КОГДА Потребители.ИндексРегистраПотребителя = -1
		|			ТОГДА ЗначенияПоказателей.Аналитика" + ИндПоля + "
		|		КОГДА Потребители.ИндексРегистраПотребителя >= " + ИндПоля + " 
		|			ТОГДА ЗначенияПоказателей.Аналитика" + ИндПоля + "
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК Аналитика" + ИндПоля;
	КонецЦикла;
	Если ЕстьАналитикаВалюта Тогда
		ТекстАналитики = ТекстАналитики + ",
		|	ЗначенияПоказателей.АналитикаВалюта";
		ТекстАналитикиВыбор = ТекстАналитикиВыбор + ",
		|	ЗначенияПоказателей.АналитикаВалюта";
	КонецЕсли;
	
	// ОБЪЕДИНЕННАЯ ТАБЛИЦА НОВЫХ И ИСХОДНЫХ ЗНАЧЕНИЙ ПОТРЕБИТЕЛЕЙ
	ТекстЗапроса = "
		|////////////////////////////////////////////////////////////////////////////////
		|// ОБЪЕДИНЕННАЯ ТАБЛИЦА НОВЫХ И ИСХОДНЫХ ЗНАЧЕНИЙ ПОТРЕБИТЕЛЕЙ
		|
		|ВЫБРАТЬ 
		|	ЗначенияПоказателей.Показатель КАК Показатель,
		|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета %ТекстЗначение% %ТекстЗначениеНечисловое% %ТекстАналитикиВыбор%
		|ПОМЕСТИТЬ втЗначенияПотребителейОбъединенные
		|ИЗ
		|	втЗначенияПотребителейРасчет КАК ЗначенияПоказателей
		|		ЛЕВОЕ СОЕДИНЕНИЕ
		|			(ВЫБРАТЬ РАЗЛИЧНЫЕ 
		|				втПоказателиОперанды.Потребитель,
		|				втПоказателиОперанды.ИндексРегистраПотребителя
		|			ИЗ
		|				втПоказателиОперанды) КАК Потребители
		|		ПО Потребители.Потребитель = ЗначенияПоказателей.Показатель
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ 
		|	ЗначенияПоказателей.Показатель КАК Показатель,
		|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета %ТекстЗначениеДоИзменения% %ТекстЗначениеНечисловоеДоИзменения% %ТекстАналитики%
		|ИЗ
		|	втЗначенияПоказателейДоИзменения КАК ЗначенияПоказателей
		|;
	 	|";
	
	Если ЕстьЗначение Тогда
		
		ТекстЗначение = ",
			|	ЗначенияПоказателей.Значение КАК Значение";
		ТекстЗначениеДоИзменения = ",
			|	-1 * ЗначенияПоказателей.Значение КАК Значение";
		
		Если ЕстьЗначениеНечисловое Тогда
			ТекстЗапроса = ТекстЗапроса + "
				|////////////////////////////////////////////////////////////////////////////////
				|// СГРУППИРОВАННАЯ ТАБЛИЦА НОВЫХ И ИСХОДНЫХ ЗНАЧЕНИЙ ПОТРЕБИТЕЛЕЙ 
				|
				|ВЫБРАТЬ 
				|	ЗначенияПоказателей.Показатель КАК Показатель,
				|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета, 			
				|	СУММА(ЗначенияПоказателей.Значение) КАК Значение,
				|	НЕОПРЕДЕЛЕНО КАК ЗначениеНечисловое %ТекстАналитики%
				|ПОМЕСТИТЬ втРассчитанныеПоказатели
				|ИЗ
				|	втЗначенияПотребителейОбъединенные КАК ЗначенияПоказателей
				|ГДЕ
				|	ЗначенияПоказателей.ЗначениеНечисловое = НЕОПРЕДЕЛЕНО
				|
				|СГРУППИРОВАТЬ ПО
				|	ЗначенияПоказателей.Показатель, 
				|	ЗначенияПоказателей.ПериодОтчета %ТекстАналитики%
				|
				|ИМЕЮЩИЕ 
				|	СУММА(ЗначенияПоказателей.Значение) <> 0
		   		|";
		Иначе
			ТекстЗапроса = ТекстЗапроса + "
				|////////////////////////////////////////////////////////////////////////////////
				|// СГРУППИРОВАННАЯ ТАБЛИЦА НОВЫХ И ИСХОДНЫХ ЗНАЧЕНИЙ ПОТРЕБИТЕЛЕЙ 
				|
				|ВЫБРАТЬ 
				|	ЗначенияПоказателей.Показатель КАК Показатель,
				|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета, 			
				|	СУММА(ЗначенияПоказателей.Значение) КАК Значение %ТекстАналитики%
				|ПОМЕСТИТЬ втРассчитанныеПоказатели
				|ИЗ
				|	втЗначенияПотребителейОбъединенные КАК ЗначенияПоказателей
				|
				|СГРУППИРОВАТЬ ПО
				|	ЗначенияПоказателей.Показатель, 
				|	ЗначенияПоказателей.ПериодОтчета %ТекстАналитики%
				|
				|ИМЕЮЩИЕ 
				|	СУММА(ЗначенияПоказателей.Значение) <> 0
		   		|";
		КонецЕсли;
		
	КонецЕсли;
		
	Если ЕстьЗначениеНечисловое Тогда
		
		ТекстЗначениеНечисловое = ",
			|	ЗначенияПоказателей.ЗначениеНечисловое КАК ЗначениеНечисловое,
			|	НЕОПРЕДЕЛЕНО КАК ЗначениеНечисловоеДоИзменения";
		ТекстЗначениеНечисловоеДоИзменения = ",
			|	НЕОПРЕДЕЛЕНО КАК ЗначениеНечисловое,
			|	ЗначенияПоказателей.ЗначениеНечисловое КАК ЗначениеНечисловоеДоИзменения";
		
		Если ЕстьЗначение Тогда
			ТекстЗапроса = ТекстЗапроса + "
				|
				|ОБЪЕДИНИТЬ ВСЕ 
				|
				|ВЫБРАТЬ 
				|	ЗначенияПоказателей.Показатель КАК Показатель,
				|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета, 
				|	0 КАК Значение, 
				|	МАКСИМУМ(ЗначенияПоказателей.ЗначениеНечисловое) КАК ЗначениеНечисловое %ТекстАналитики%
				|ИЗ
				|	втЗначенияПотребителейОбъединенные КАК ЗначенияПоказателей
				|ГДЕ
				|	ЗначенияПоказателей.Значение = 0
				|
				|СГРУППИРОВАТЬ ПО
				|	ЗначенияПоказателей.Показатель, 
				|	ЗначенияПоказателей.ПериодОтчета %ТекстАналитики%
				|
				|ИМЕЮЩИЕ
				|	МАКСИМУМ(ЗначенияПоказателей.ЗначениеНечисловое) <> МАКСИМУМ(ЗначенияПоказателей.ЗначениеНечисловоеДоИзменения)
				|";
		Иначе
			ТекстЗапроса = ТекстЗапроса + "
				|////////////////////////////////////////////////////////////////////////////////
				|// СГРУППИРОВАННАЯ ТАБЛИЦА НОВЫХ И ИСХОДНЫХ ЗНАЧЕНИЙ ПОТРЕБИТЕЛЕЙ 
				|
				|ВЫБРАТЬ 
				|	ЗначенияПоказателей.Показатель КАК Показатель,
				|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета, 
				|	МАКСИМУМ(ЗначенияПоказателей.ЗначениеНечисловое) КАК ЗначениеНечисловое %ТекстАналитики%
				|ПОМЕСТИТЬ втРассчитанныеПоказатели
				|ИЗ
				|	втЗначенияПотребителейОбъединенные КАК ЗначенияПоказателей
				|
				|СГРУППИРОВАТЬ ПО
				|	ЗначенияПоказателей.Показатель, 
				|	ЗначенияПоказателей.ПериодОтчета %ТекстАналитики%
				|
				|ИМЕЮЩИЕ
				|	МАКСИМУМ(ЗначенияПоказателей.ЗначениеНечисловое) <> МАКСИМУМ(ЗначенияПоказателей.ЗначениеНечисловоеДоИзменения)
				|";
		КонецЕсли;
		
	КонецЕсли;
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстАналитики%",ТекстАналитики);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстАналитикиВыбор%",ТекстАналитикиВыбор);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстЗначение%",ТекстЗначение);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстЗначениеДоИзменения%",ТекстЗначениеДоИзменения);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстЗначениеНечисловое%",ТекстЗначениеНечисловое);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстЗначениеНечисловоеДоИзменения%",ТекстЗначениеНечисловоеДоИзменения);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстЗначениеНечисловоеNULL%",ТекстЗначениеНечисловоеNULL);
		
	нСтрокаТаблицыЗапросов 						= глТаблицаПересчетаПоказателей.Добавить();
	нСтрокаТаблицыЗапросов.ТекстПодзапросов     = ТекстЗапроса;
	нСтрокаТаблицыЗапросов.КомментарийКПакету	= "ИТОГОВАЯ ТАБЛИЦА ЗНАЧЕНИЙ ПОТРЕБИТЕЛЕЙ";
	нСтрокаТаблицыЗапросов.ВидОперацииРасчета 	= Перечисления.ВидыОперацийРасчетаПоказателей.ИтоговаяТаблицаРасчетаПоказателей;
	
КонецПроцедуры

Функция ПодготовитьЗапросПересчетаКурсовВалют(СтруктураРасчетаПоказателей, тПараметрыПакета, ПересчетВДопВалюты)
	
	ДанныеВидаОтчета 						= СтруктураРасчетаПоказателей.ДанныеВидаОтчета;
	МаксКлючевыхАналитик 					= СтруктураРасчетаПоказателей.МаксКлючевыхАналитик;
	тРасшифровкаГруппОтборов				= СтруктураРасчетаПоказателей.тРасшифровкаГруппОтборов;
	ЕстьЗначение							= СтруктураРасчетаПоказателей.ЕстьЗначение;
	ЕстьЗначениеВалюта						= СтруктураРасчетаПоказателей.ЕстьЗначениеВалюта;
	ЕстьЗначениеНечисловое    		        = СтруктураРасчетаПоказателей.ЕстьЗначениеНечисловое;
	ЕстьВидКурсаПрочее						= СтруктураРасчетаПоказателей.ЕстьВидКурсаПрочее;
	ЕстьВидКурсаЗначениеУказанноеВДокументе	= СтруктураРасчетаПоказателей.ЕстьВидКурсаЗначениеУказанноеВДокументе;
	ЕстьВидКурсаКурсНаМоментНачисления		= СтруктураРасчетаПоказателей.ЕстьВидКурсаКурсНаМоментНачисления;
	
	Если ПересчетВДопВалюты Тогда
		ДобавитьПараметрВПакет(тПараметрыПакета, "ДополнительныеВалюты",, "ДополнительныеВалюты");
	КонецЕсли;
	
	// Если только нечисловые, тогда передадим только дополнительные валюты
	Если НЕ ЕстьЗначение Тогда
		
		ТекстОбщегоЗапроса = 
			"////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	РассчитанныеПоказатели.ПериодОтчета КАК ПериодОтчета,
			|	РассчитанныеПоказатели.Показатель КАК Показатель,
			|	Валюты.Ссылка КАК Валюта,
			|	1 КАК КоэффициентПересчета
			|ПОМЕСТИТЬ втКурсыВалют
			|ИЗ
			|	втРассчитанныеПоказатели КАК РассчитанныеПоказатели,
			|	Справочник.Валюты КАК Валюты
			|ГДЕ
			|	Валюты.Ссылка В (&ДополнительныеВалюты)
			|;";

		Возврат ТекстОбщегоЗапроса;
		
	КонецЕсли;
	
	// Шаблон запроса
	ТекстЗапроса = "
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	РассчитанныеПоказатели.Показатель КАК Показатель,
		|	РассчитанныеПоказатели.ПериодОтчета КАК ПериодОтчета
		|ПОМЕСТИТЬ втКурсыВсеПоказателиПериоды
		|ИЗ 
		|	втРассчитанныеПоказатели КАК РассчитанныеПоказатели
		|
		|ИНДЕКСИРОВАТЬ ПО 
		|	Показатель, 
		|	ПериодОтчета
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	РассчитанныеПоказатели.Показатель КАК Показатель
		|ПОМЕСТИТЬ втКурсыВсеПоказатели
		|ИЗ
		|	втКурсыВсеПоказателиПериоды КАК РассчитанныеПоказатели
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВсеПоказатели.Показатель КАК Показатель,
		|	ПоказателиОтчетов.ВидКурса КАК ВидКурса,
		|	ПоказателиОтчетов.СвязанныйПоказатель КАК СвязанныйПоказатель,
		|	ПоказателиОтчетов.НеФинансовый КАК НеФинансовый,
		|	ПоказателиОтчетов.ПересчитыватьВалютнуюСумму КАК ПересчитыватьВалютнуюСумму
		|ПОМЕСТИТЬ втКурсыДанныеПоказателей
		|ИЗ
		|	втКурсыВсеПоказатели КАК ВсеПоказатели
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПоказателиОтчетов КАК ПоказателиОтчетов
		|		ПО ВсеПоказатели.Показатель = ПоказателиОтчетов.Ссылка";
	
	Если ЕстьЗначениеВалюта Тогда
			
		Если ПересчетВДопВалюты Тогда			
			ТекстЗапроса = ТекстЗапроса + "
			|ИНДЕКСИРОВАТЬ ПО 
			|	Показатель
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	Валюты.Ссылка КАК Валюта
			|ПОМЕСТИТЬ втКурсыВсеВалюты 
			|ИЗ
			|	втРассчитанныеПоказатели КАК ПериодыПоказатели
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Валюты КАК Валюты
			|		ПО Валюты.Ссылка = ПериодыПоказатели.АналитикаВалюта
			|			ИЛИ Валюты.Ссылка В (&ДополнительныеВалюты)
			|;
			|";			
		Иначе			
			ТекстЗапроса = ТекстЗапроса + "
			|			И ПоказателиОтчетов.ПересчитыватьВалютнуюСумму
			|ИНДЕКСИРОВАТЬ ПО 
			|	Показатель
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	Валюты.Ссылка КАК Валюта
			|ПОМЕСТИТЬ втКурсыВсеВалюты 
			|ИЗ
			|	втРассчитанныеПоказатели КАК ПериодыПоказатели
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Валюты КАК Валюты
			|		ПО Валюты.Ссылка = ПериодыПоказатели.АналитикаВалюта
			|;
			|";			
		КонецЕсли;
		
	Иначе
		
		ТекстЗапроса = ТекстЗапроса + "
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	Валюты.Ссылка КАК Валюта
			|ПОМЕСТИТЬ втКурсыВсеВалюты 
			|ИЗ
			|	Справочник.Валюты КАК Валюты
			|ГДЕ
			|	Валюты.Ссылка В (&ДополнительныеВалюты)
			|;
			|";
	
	КонецЕсли;	
	
	ТекстОбщегоЗапроса = "
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ПоказателиПериоды.ПериодОтчета,
		|	ПоказателиПериоды.Показатель,
		|	Валюты.Валюта КАК Валюта,
		|	1 КАК Курс,
		|	1 КАК Кратность
		|ПОМЕСТИТЬ втКурсы 
		|ИЗ
		|	втКурсыВсеПоказателиПериоды КАК ПоказателиПериоды
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втКурсыДанныеПоказателей КАК ДанныеПоказателей
		|		ПО ПоказателиПериоды.Показатель = ДанныеПоказателей.Показатель
		|		ЛЕВОЕ СОЕДИНЕНИЕ втКурсыВсеВалюты КАК Валюты
		|		ПО ИСТИНА
		|ГДЕ
		|	ДанныеПоказателей.НеФинансовый
		|";
		
	Если ЕстьВидКурсаЗначениеУказанноеВДокументе Тогда 
		
		ТекстЗапроса = ТекстЗапроса + "
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ПоказателиДляКурсовВалют.Ссылка КАК Показатель,
			|	ПоказателиДляКурсовВалют.ПоказательКурса КАК ПоказательКурса,
			|	ПоказателиДляКурсовВалют.Кратность КАК Кратность,
			|	ПоказателиДляКурсовВалют.Валюта КАК Валюта
			|ПОМЕСТИТЬ втКурсыПоказателиДляКурсовВалют
			|ИЗ
			|	втКурсыДанныеПоказателей КАК ДанныеПоказателей
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПоказателиОтчетов.ПоказателиДляКурсовВалют КАК ПоказателиДляКурсовВалют
			|		ПО ДанныеПоказателей.Показатель = ПоказателиДляКурсовВалют.Ссылка
			|ГДЕ
			|	НЕ ДанныеПоказателей.НеФинансовый
			|	И ДанныеПоказателей.ВидКурса = ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.ЗначениеУказанноеВДокументе)
			|
			|ИНДЕКСИРОВАТЬ ПО
			|	ПоказательКурса	
			|;	
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ПоказателиДляКурсовВалют.Показатель КАК Показатель,
			|	ВерсииЗначенийПоказателей.ПериодОтчета КАК ПериодОтчета,
			|	ПоказателиДляКурсовВалют.Валюта КАК Валюта,
			|	ПоказателиДляКурсовВалют.Кратность КАК Кратность,
			|	ЗначенияПоказателейОтчетов.Значение КАК Курс
			|ПОМЕСТИТЬ втКурсыЗависящиеОтПоказателяОтчета
			|ИЗ
			|	втКурсыПоказателиДляКурсовВалют КАК ПоказателиДляКурсовВалют
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияПоказателейОтчетовСинтетика КАК ЗначенияПоказателейОтчетов
			|		ПО ПоказателиДляКурсовВалют.ПоказательКурса = ЗначенияПоказателейОтчетов.Показатель 
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВерсииЗначенийПоказателей КАК ВерсииЗначенийПоказателей 
			|		ПО (ЗначенияПоказателейОтчетов.Версия = ВерсииЗначенийПоказателей.Ссылка) %ТекстОтбора%
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	ПоказателиДляКурсовВалют.Показатель,
			|	РассчитанныеПоказатели.ПериодОтчета,
			|	ПоказателиДляКурсовВалют.Валюта,
			|	ПоказателиДляКурсовВалют.Кратность,
			|	РассчитанныеПоказатели.Значение
			|ИЗ
			|	втКурсыПоказателиДляКурсовВалют КАК ПоказателиДляКурсовВалют
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втРассчитанныеПоказатели КАК РассчитанныеПоказатели
			|		ПО ПоказателиДляКурсовВалют.ПоказательКурса = РассчитанныеПоказатели.Показатель
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	ПоказателиДляКурсовВалют.Показатель,
			|	ВерсииЗначенийПоказателей.ПериодОтчета,
			|	ПоказателиДляКурсовВалют.Валюта,
			|	ПоказателиДляКурсовВалют.Кратность,
			|	ВерсииЗначенийПоказателей.Значение
			|ИЗ
			|	втКурсыПоказателиДляКурсовВалют КАК ПоказателиДляКурсовВалют
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втЛогИзмененныхПоказателей КАК ВерсииЗначенийПоказателей
			|		ПО ПоказателиДляКурсовВалют.ПоказательКурса = ВерсииЗначенийПоказателей.Показатель %ТекстОтбора%
			|;
			|";
		
		Если МаксКлючевыхАналитик > 0 Тогда
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"ЗначенияПоказателейОтчетовСинтетика","ЗначенияПоказателейОтчетов"+Формат(МаксКлючевыхАналитик,"ЧН=; ЧГ=0"));
		КонецЕсли;
		
		ТекстОбщегоЗапроса = ТекстОбщегоЗапроса + "
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	КурсыЗависящиеОтПоказателяОтчета.ПериодОтчета КАК ПериодОтчета,
			|	КурсыЗависящиеОтПоказателяОтчета.Показатель КАК Показатель,
			|	КурсыЗависящиеОтПоказателяОтчета.Валюта КАК Валюта,
			|	ВЫБОР
			|		КОГДА КурсыЗависящиеОтПоказателяОтчета.Валюта = &Валюта
			|			ТОГДА 0
			|		ИНАЧЕ СУММА(КурсыЗависящиеОтПоказателяОтчета.Курс)
			|	КОНЕЦ КАК Курс,
			|	ВЫБОР
			|		КОГДА КурсыЗависящиеОтПоказателяОтчета.Валюта = &Валюта
			|			ТОГДА 0
			|		ИНАЧЕ МАКСИМУМ(КурсыЗависящиеОтПоказателяОтчета.Кратность)
			|	КОНЕЦ КАК Кратность		
			|ИЗ
			|	втКурсыЗависящиеОтПоказателяОтчета КАК КурсыЗависящиеОтПоказателяОтчета
			|
			|СГРУППИРОВАТЬ ПО
			|	КурсыЗависящиеОтПоказателяОтчета.Показатель,
			|	КурсыЗависящиеОтПоказателяОтчета.ПериодОтчета,
			|	КурсыЗависящиеОтПоказателяОтчета.Валюта
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	КурсыЗависящиеОтПоказателяОтчета.ПериодОтчета,
			|	КурсыЗависящиеОтПоказателяОтчета.Показатель,		
			|	&Валюта,
			|	1,
			|	1
			|ИЗ 
			|	втКурсыЗависящиеОтПоказателяОтчета КАК КурсыЗависящиеОтПоказателяОтчета
			|";
		
	КонецЕсли;
	
	Если ЕстьВидКурсаКурсНаМоментНачисления Тогда
		
		ТекстЗапроса = ТекстЗапроса + "		
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ДанныеПоказателей.Показатель КАК Показатель,
			|	ДанныеПоказателей.СвязанныйПоказатель КАК ПоказательДатыКурса
			|ПОМЕСТИТЬ втКурсыПоказателиДляДатыКурсовВалют
			|ИЗ
			|	втКурсыДанныеПоказателей КАК ДанныеПоказателей
			|ГДЕ
			|	НЕ ДанныеПоказателей.НеФинансовый
			|	И ДанныеПоказателей.ВидКурса = ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.КурсНаМоментНачисления)
			|
			|ИНДЕКСИРОВАТЬ ПО
			|	ПоказательДатыКурса	
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ДанныеПоказателей.Показатель КАК Показатель,
			|	ВерсииЗначенийПоказателей.ПериодОтчета КАК ПериодОтчета,
			|	ЗначенияПоказателейОтчетов.Значение КАК ДатаКурса,
			|	ВерсииЗначенийПоказателей.Код КАК КодВерсии
			|ПОМЕСТИТЬ втКурсыЗависящиеОтДатыПоказателяОтчетаИсходная
			|ИЗ
			|	втКурсыПоказателиДляДатыКурсовВалют КАК ДанныеПоказателей
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияПоказателейОтчетовНечисловые КАК ЗначенияПоказателейОтчетов
			|		ПО ДанныеПоказателей.ПоказательДатыКурса = ЗначенияПоказателейОтчетов.Показатель
			|		И ЗначенияПоказателейОтчетов.ИтоговоеЗначение
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВерсииЗначенийПоказателей КАК ВерсииЗначенийПоказателей 
			|		ПО (ЗначенияПоказателейОтчетов.Версия = ВерсииЗначенийПоказателей.Ссылка) %ТекстОтбора%
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	ДанныеПоказателей.Показатель,
			|	ВерсииЗначенийПоказателей.ПериодОтчета,
			|	ВерсииЗначенийПоказателей.ЗначениеНечисловое,
			|	10000000000
			|ИЗ
			|	втКурсыПоказателиДляДатыКурсовВалют КАК ДанныеПоказателей
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втЛогИзмененныхПоказателей КАК ВерсииЗначенийПоказателей
			|		ПО ДанныеПоказателей.ПоказательДатыКурса = ВерсииЗначенийПоказателей.Показатель %ТекстОтбора%";
		
		Если ЕстьЗначениеНечисловое Тогда
			ТекстЗапроса = ТекстЗапроса + "
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	ДанныеПоказателей.Показатель,
				|	РассчитанныеПоказатели.ПериодОтчета,
				|	РассчитанныеПоказатели.ЗначениеНечисловое,
				|	20000000000 КАК КодВерсии
				|ИЗ
				|	втКурсыПоказателиДляДатыКурсовВалют КАК ДанныеПоказателей
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втРассчитанныеПоказатели КАК РассчитанныеПоказатели
				|		ПО ДанныеПоказателей.ПоказательДатыКурса = РассчитанныеПоказатели.Показатель";
		КонецЕсли;
		
		ТекстЗапроса = ТекстЗапроса + "
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	КурсыЗависящиеОтДатыПоказателяОтчета.Показатель КАК Показатель,
			|	КурсыЗависящиеОтДатыПоказателяОтчета.ПериодОтчета КАК ПериодОтчета,		
			|	МАКСИМУМ(КурсыЗависящиеОтДатыПоказателяОтчета.КодВерсии) КАК КодВерсии
			|ПОМЕСТИТЬ втКурсыЗависящиеОтДатыПоказателяОтчетаМаксимальнаяВерсия 
			|ИЗ
			|	втКурсыЗависящиеОтДатыПоказателяОтчетаИсходная КАК КурсыЗависящиеОтДатыПоказателяОтчета
			|
			|СГРУППИРОВАТЬ ПО
			|	КурсыЗависящиеОтДатыПоказателяОтчета.Показатель,
			|	КурсыЗависящиеОтДатыПоказателяОтчета.ПериодОтчета	
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	КурсыЗависящиеОтДатыПоказателяОтчета.Показатель КАК Показатель,
			|	КурсыЗависящиеОтДатыПоказателяОтчета.ПериодОтчета КАК ПериодОтчета,
			|	КурсыЗависящиеОтДатыПоказателяОтчета.ДатаКурса КАК ДатаКурсаИсходная,
			|	КурсыВалют.Валюта КАК Валюта,
			|	МАКСИМУМ(КурсыВалют.Период) КАК ДатаКурса
			|ПОМЕСТИТЬ втКурсыЗависящиеОтДатыПоказателяОтчета
			|ИЗ
			|	втКурсыЗависящиеОтДатыПоказателяОтчетаИсходная КАК КурсыЗависящиеОтДатыПоказателяОтчета
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втКурсыЗависящиеОтДатыПоказателяОтчетаМаксимальнаяВерсия КАК КурсыЗависящиеОтДатыПоказателяОтчетаМаксимальнаяВерсия
			|		ПО КурсыЗависящиеОтДатыПоказателяОтчета.Показатель = КурсыЗависящиеОтДатыПоказателяОтчетаМаксимальнаяВерсия.Показатель
			|			И КурсыЗависящиеОтДатыПоказателяОтчета.ПериодОтчета = КурсыЗависящиеОтДатыПоказателяОтчетаМаксимальнаяВерсия.ПериодОтчета
			|			И КурсыЗависящиеОтДатыПоказателяОтчета.КодВерсии = КурсыЗависящиеОтДатыПоказателяОтчетаМаксимальнаяВерсия.КодВерсии
			|		ЛЕВОЕ СОЕДИНЕНИЕ втКурсыВсеВалюты КАК Валюты
			|		ПО ИСТИНА
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют КАК КурсыВалют 
			|		ПО КурсыЗависящиеОтДатыПоказателяОтчета.ДатаКурса >= КурсыВалют.Период
			|			И КурсыВалют.Валюта = Валюты.Валюта
			|
			|СГРУППИРОВАТЬ ПО
			|	КурсыЗависящиеОтДатыПоказателяОтчета.Показатель,
			|	КурсыЗависящиеОтДатыПоказателяОтчета.ПериодОтчета,
			|	КурсыЗависящиеОтДатыПоказателяОтчета.ДатаКурса,
			|	КурсыВалют.Валюта	
			|;
			|";
		
		ТекстОбщегоЗапроса = ТекстОбщегоЗапроса + "
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	КурсыЗависящиеОтДатыПоказателяОтчета.ПериодОтчета КАК ПериодОтчета,
			|	КурсыЗависящиеОтДатыПоказателяОтчета.Показатель КАК Показатель,		
			|	КурсыЗависящиеОтДатыПоказателяОтчета.Валюта КАК Валюта,
			|	ISNULL(КурсыВалют.Курс, 0) КАК Курс,
			|	ISNULL(КурсыВалют.Кратность, 0) КАК Кратность
			|ИЗ
			|	втКурсыЗависящиеОтДатыПоказателяОтчета КАК КурсыЗависящиеОтДатыПоказателяОтчета
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют КАК КурсыВалют 
			|		ПО КурсыЗависящиеОтДатыПоказателяОтчета.ДатаКурса = КурсыВалют.Период
			|			И КурсыЗависящиеОтДатыПоказателяОтчета.Валюта = КурсыВалют.Валюта
			|";
		
	КонецЕсли;
	
	Если ЕстьВидКурсаПрочее Тогда
		
		ТекстОбщегоЗапроса = ТекстОбщегоЗапроса + "		
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	ПоказателиПериоды.ПериодОтчета КАК ПериодОтчета,
			|	ПоказателиПериоды.Показатель КАК Показатель,
			|	Валюты.Валюта КАК Валюта,
			|	ВЫБОР
			|		КОГДА ДанныеПоказателей.ВидКурса = ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.ПустаяСсылка)
			|			ТОГДА ЕСТЬNULL(КурсыВалют.СреднийКурсЗаПериод, 0)
			|		КОГДА ДанныеПоказателей.ВидКурса = ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.СреднийКурсЗаПериод)
			|			ТОГДА ЕСТЬNULL(КурсыВалют.СреднийКурсЗаПериод, 0)
			|		КОГДА ДанныеПоказателей.ВидКурса = ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.СреднийКурсЗаПериодМСФО)
			|			ТОГДА ЕСТЬNULL(КурсыВалют.СреднийКурсЗаПериодМСФО, 0)
			|		КОГДА ДанныеПоказателей.ВидКурса = ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.КурсНаНачалоПериода)
			|			ТОГДА ЕСТЬNULL(КурсыВалют.КурсНаНачалоПериода, 0)
			|		КОГДА ДанныеПоказателей.ВидКурса = ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.КурсНаКонецПериода)
			|			ТОГДА ЕСТЬNULL(КурсыВалют.КурсНаКонецПериода, 0)
			|		КОГДА ДанныеПоказателей.ВидКурса = ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.КурсНаКонецПредыдущегоПериода)
			|			ТОГДА ЕСТЬNULL(КурсыВалют.КурсНаКонецПредыдущегоПериода, 0)
			|		КОГДА ДанныеПоказателей.ВидКурса = ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.СреднийКурсЗаПредыдущийПериод)
			|			ТОГДА ЕСТЬNULL(КурсыВалют.СреднийКурсЗаПредыдущийПериод, 0)
			|		КОГДА ДанныеПоказателей.ВидКурса = ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.СреднийКурсЗаПериодЦБ)
			|			ТОГДА ЕСТЬNULL(КурсыВалют.СреднийКурсЗаПериодЦБ, 0)
			|		КОГДА ДанныеПоказателей.ВидКурса = ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.СреднийКурсЗаПредыдущийПериодЦБ)
			|			ТОГДА ЕСТЬNULL(КурсыВалют.СреднийКурсЗаПредыдущийПериодЦБ, 0)
			|	КОНЕЦ КАК Курс,
			|	КурсыВалют.Кратность КАК Кратность
			|ИЗ
			|	втКурсыВсеПоказателиПериоды КАК ПоказателиПериоды
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втКурсыДанныеПоказателей КАК ДанныеПоказателей
			|		ПО ПоказателиПериоды.Показатель = ДанныеПоказателей.Показатель
			|			И НЕ ДанныеПоказателей.НеФинансовый			
			|		ЛЕВОЕ СОЕДИНЕНИЕ втКурсыВсеВалюты КАК Валюты
			|		ПО ИСТИНА
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПериодическиеКурсы КАК КурсыВалют
			|		ПО КурсыВалют.Сценарий = &Сценарий
			|			И КурсыВалют.ПериодКурса = ПоказателиПериоды.ПериодОтчета 
			|			И КурсыВалют.Валюта = Валюты.Валюта
			|ГДЕ
			|	ДанныеПоказателей.ВидКурса <> ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.КурсНаМоментНачисления)
			|	И ДанныеПоказателей.ВидКурса <> ЗНАЧЕНИЕ(Перечисление.ВидыКурсов.ЗначениеУказанноеВДокументе)
			|";
		
		ДобавитьПараметрВПакет(тПараметрыПакета, Перечисления.СпособыВычисленияПараметровОперандов.СценарийОтчета,,"Сценарий");
		
	КонецЕсли;
	
	ТекстОбщегоЗапроса = ТекстЗапроса + ТекстОбщегоЗапроса + "
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	КурсыВалют.ПериодОтчета КАК ПериодОтчета,
		|	КурсыВалют.Показатель КАК Показатель,
		|	КурсыВалют.Валюта КАК Валюта,
		|	ВЫБОР
		|		КОГДА (КурсВалютыОтчета.Кратность * КурсыВалют.Курс) = 0
		|			ТОГДА 0
		|		ИНАЧЕ (1000000 * КурсыВалют.Кратность * КурсВалютыОтчета.Курс) / (КурсВалютыОтчета.Кратность * КурсыВалют.Курс)
		|	КОНЕЦ КАК КоэффициентПересчета
		|ПОМЕСТИТЬ втКурсыВалют
		|ИЗ
		|	втКурсы КАК КурсыВалют
		|		ЛЕВОЕ СОЕДИНЕНИЕ втКурсы КАК КурсВалютыОтчета
		|		ПО КурсыВалют.ПериодОтчета = КурсВалютыОтчета.ПериодОтчета
		|			И КурсыВалют.Показатель = КурсВалютыОтчета.Показатель
		|			И (КурсВалютыОтчета.Валюта = &Валюта)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Показатель,
		|	ПериодОтчета,
		|	Валюта
		|;
		|";
		
	Если ЕстьЗначениеВалюта Тогда
	
		ТекстОбщегоЗапроса = ТекстОбщегоЗапроса + "
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ЗначенияПоказателей.Показатель КАК Показатель,
			|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета,
			|	ЗначенияПоказателей.АналитикаВалюта КАК АналитикаВалюта,
			|	ЗначенияПоказателей.Значение КАК Значение, 
			|	ВЫБОР 
			|		КОГДА ДанныеПоказателей.ПересчитыватьВалютнуюСумму ТОГДА
			|			ВЫРАЗИТЬ(ЗначенияПоказателей.Значение * ЕСТЬNULL(КурсыВалют.КоэффициентПересчета, 0) / 1000000 КАК Число(18,5))
			|		ИНАЧЕ 0
			|	КОНЕЦ КАК ЗначениеВалюта %ТекстАналитики% %ТекстЗначениеНечисловое%
			|ПОМЕСТИТЬ втРассчитанныеПоказатели_ПересчетЗначениеВалюта
			|ИЗ
			|	втРассчитанныеПоказатели КАК ЗначенияПоказателей
			|		ЛЕВОЕ СОЕДИНЕНИЕ втКурсыВалют КАК КурсыВалют
			|		ПО ЗначенияПоказателей.Показатель = КурсыВалют.Показатель
			|			И ЗначенияПоказателей.ПериодОтчета = КурсыВалют.ПериодОтчета
			|			И ЗначенияПоказателей.АналитикаВалюта = КурсыВалют.Валюта
			|		ЛЕВОЕ СОЕДИНЕНИЕ втКурсыДанныеПоказателей КАК ДанныеПоказателей
			|		ПО ЗначенияПоказателей.Показатель = ДанныеПоказателей.Показатель 
			|;";
		
	КонецЕсли;	

	// Сформируем текст отбора, если необходимо
	Если ЕстьВидКурсаЗначениеУказанноеВДокументе ИЛИ ЕстьВидКурсаКурсНаМоментНачисления Тогда	
		тРасшифровкаГруппОтборовТекВерсии = тРасшифровкаГруппОтборов.СкопироватьКолонки();
		ДобавитьОтборыПоКлючевымСрезам(тРасшифровкаГруппОтборовТекВерсии,ДанныеВидаОтчета.РазделениеПоПроектам,МаксКлючевыхАналитик);
		ТекстОтбора = СформироватьТекстОтбора(тРасшифровкаГруппОтборовТекВерсии,тПараметрыПакета,0);
		ТекстОбщегоЗапроса = СтрЗаменить(ТекстОбщегоЗапроса,"%ТекстОтбора%",СтрЗаменить(ТекстОтбора,"%ИмяТаблицы%","ВерсииЗначенийПоказателей"));		
	КонецЕсли;	

	Возврат ТекстОбщегоЗапроса;
	
КонецФункции

Процедура ДобавитьВЛогТаблицуИзмененныхПоказателей(СтруктураРасчетаПоказателей, ПересчетВДопВалюты=Ложь)
	
	глТаблицаПересчетаПоказателей       = СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей;
	МаксКлючевыхАналитик				= СтруктураРасчетаПоказателей.МаксКлючевыхАналитик;		
	МаксИспользуемыхАналитик			= СтруктураРасчетаПоказателей.МаксИспользуемыхАналитик;
	ЕстьАналитикаВалюта					= СтруктураРасчетаПоказателей.ЕстьАналитикаВалюта;
	ЕстьЗначение						= СтруктураРасчетаПоказателей.ЕстьЗначение;
	ЕстьЗначениеВалюта					= СтруктураРасчетаПоказателей.ЕстьЗначениеВалюта;
	ЕстьЗначениеНечисловое              = СтруктураРасчетаПоказателей.ЕстьЗначениеНечисловое;
	
	// Добавим валюту отчета
	тПараметрыПакета = ПолучитьОписаниеТаблицыПараметров();
	
	// Добавим аналитики рассчитанных показателей
	ТекстАналитики = "";
	Для Сч = 1 По ПараметрыСеанса.ЧислоДопАналитик Цикл
		
		Если Сч <= МаксКлючевыхАналитик Тогда
			
			// Ключевые аналитики вида отчета
			ТекстАналитики = ТекстАналитики + ",
			|	&Аналитика" + Сч + " КАК Аналитика" + Сч;
			
			ДобавитьПараметрВПакет(тПараметрыПакета, Перечисления.СпособыВычисленияПараметровОперандов["Аналитика" + Сч],,"Аналитика" + Сч);
			
		ИначеЕсли Сч <= МаксИспользуемыхАналитик Тогда
			
			// Аналитики показателей
			ТекстАналитики = ТекстАналитики + ",
			|	ЗначенияПоказателей.Аналитика" + Сч + " КАК Аналитика" + Сч;
			
		Иначе
			
			// Пустая аналитика
			ТекстАналитики = ТекстАналитики + ",
			|	НЕОПРЕДЕЛЕНО КАК Аналитика" + Сч;
			
		КонецЕсли;
		
	КонецЦикла;
	
	// Добавим аналитику по валюте
	Если ЕстьАналитикаВалюта Тогда
		ТекстАналитикиВалюта = ",
		|	ЗначенияПоказателей.АналитикаВалюта КАК АналитикаВалюта";
	Иначе
		ТекстАналитикиВалюта = ",
		|	ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка) КАК АналитикаВалюта";
	КонецЕсли;
	
	// Текст Значение
	Если ЕстьЗначение Тогда
		ТекстЗначение = ",
		|	ЗначенияПоказателей.Значение КАК Значение";
	Иначе
		ТекстЗначение = ",
		|	0 КАК Значение";
	КонецЕсли;	
	Если ЕстьЗначениеВалюта Тогда
		ТекстЗначение = ТекстЗначение + ",
		|	ЗначенияПоказателей.ЗначениеВалюта КАК ЗначениеВалюта";
	Иначе
		ТекстЗначение = ТекстЗначение + ",
		|	0 КАК ЗначениеВалюта";
	КонецЕсли;	
	Если ЕстьЗначениеНечисловое Тогда
		ТекстЗначение = ТекстЗначение + ",
		|	ЗначенияПоказателей.ЗначениеНечисловое КАК ЗначениеНечисловое";
		ТекстЗначениеНечисловое = ",
		|	ЗначенияПоказателей.ЗначениеНечисловое КАК ЗначениеНечисловое";
	Иначе
		ТекстЗначение = ТекстЗначение + ",
		|	НЕОПРЕДЕЛЕНО КАК ЗначениеНечисловое";
		ТекстЗначениеНечисловое = "";
	КонецЕсли;
	
	// Текст для пересчета валют
	Если ПересчетВДопВалюты ИЛИ ЕстьЗначениеВалюта Тогда
		ТекстЗапросаВалюты = ПодготовитьЗапросПересчетаКурсовВалют(
			СтруктураРасчетаПоказателей, тПараметрыПакета, ПересчетВДопВалюты);
	Иначе
		ТекстЗапросаВалюты = "";
	КонецЕсли;
	
	// Запрос с пересчетом в дополнительные валюты
	нСтрокаТаблицыЗапросов = глТаблицаПересчетаПоказателей.Добавить();
	
	ТекстЗапроса = "
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ		
		|	ЗначенияПоказателей.НомерТранзакции КАК НомерТранзакции,
		|	ЗначенияПоказателей.ПравилоОбработки КАК ПравилоОбработки,
		|	ЗначенияПоказателей.Сценарий КАК Сценарий,
		|	ЗначенияПоказателей.Организация КАК Организация,
		|	ЗначенияПоказателей.Проект КАК Проект,
		|	ЗначенияПоказателей.Валюта КАК Валюта,		
		|	ЗначенияПоказателей.Показатель КАК Показатель,
		|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета,
		|	ЗначенияПоказателей.Аналитика1 КАК Аналитика1,
		|	ЗначенияПоказателей.Аналитика2 КАК Аналитика2,
		|	ЗначенияПоказателей.Аналитика3 КАК Аналитика3,
		|	ЗначенияПоказателей.Аналитика4 КАК Аналитика4,
		|	ЗначенияПоказателей.Аналитика5 КАК Аналитика5,
		|	ЗначенияПоказателей.Аналитика6 КАК Аналитика6,
		|	ЗначенияПоказателей.АналитикаВалюта КАК АналитикаВалюта,
		|	ЗначенияПоказателей.Значение КАК Значение,
		|	ЗначенияПоказателей.ЗначениеВалюта КАК ЗначениеВалюта,
		|	ЗначенияПоказателей.ЗначениеНечисловое КАК ЗначениеНечисловое
		|ПОМЕСТИТЬ втЛогИзмененныхПоказателейВременная
		|ИЗ
		|	втЛогИзмененныхПоказателей КАК ЗначенияПоказателей
		|";
		
	Если ПересчетВДопВалюты Тогда
		
		// С пересчетом в доп. валюты
		
		ТекстЗначение = СтрЗаменить(ТекстЗначение, "ЗначенияПоказателей.Значение КАК Значение", 
			"ЗначенияПоказателей.Значение * КурсыВалют.КоэффициентПересчета / 1000000 КАК Значение");
		
		ТекстЗапроса = ТекстЗапросаВалюты + ТекстЗапроса + "
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	&НомерТранзакции,
			|	&ПравилоОбработки,
			|	&Сценарий,
			|	&Организация,
			|	&Проект,
			|	КурсыВалют.Валюта,
			|	ЗначенияПоказателей.Показатель,
			|	ЗначенияПоказателей.ПериодОтчета %ТекстАналитики% %ТекстАналитикиВалюта% %ТекстЗначение%
			|ИЗ
			|	втРассчитанныеПоказатели" + ?(ЕстьЗначениеВалюта,"_ПересчетЗначениеВалюта","") + " КАК ЗначенияПоказателей
			|		ЛЕВОЕ СОЕДИНЕНИЕ втКурсыВалют КАК КурсыВалют
			|		ПО ЗначенияПоказателей.Показатель = КурсыВалют.Показатель
			|       И ЗначенияПоказателей.ПериодОтчета = КурсыВалют.ПериодОтчета
			|;";
		
		нСтрокаТаблицыЗапросов.КомментарийКПакету 	= "ЗАПИСЬ В ЛОГ ИЗМЕНЕННЫХ ПОКАЗАТЕЛЕЙ С ПЕРЕСЧЕТОМ В ДОП. ВАЛЮТЫ";
		нСтрокаТаблицыЗапросов.ВидОперацииРасчета   = Перечисления.ВидыОперацийРасчетаПоказателей.ЗаписьВЛогИзмененныхПоказателейСДопВалютами;
				
	Иначе
		
		// Без пересчета в доп. валюты
		
		ТекстЗапроса = ТекстЗапросаВалюты + ТекстЗапроса + "
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	&НомерТранзакции,
			|	&ПравилоОбработки,
			|	&Сценарий,
			|	&Организация,
			|	&Проект,
			|	&Валюта,
			|	ЗначенияПоказателей.Показатель,
			|	ЗначенияПоказателей.ПериодОтчета %ТекстАналитики% %ТекстАналитикиВалюта% %ТекстЗначение%
			|ИЗ
			|	втРассчитанныеПоказатели" + ?(ЕстьЗначениеВалюта,"_ПересчетЗначениеВалюта","") + " КАК ЗначенияПоказателей
			|;";			
		
		нСтрокаТаблицыЗапросов.КомментарийКПакету 	= "ДОБАВЛЕНИЕ В ЛОГ ИЗМЕНЕННЫХ ПОКАЗАТЕЛЕЙ";
		нСтрокаТаблицыЗапросов.ВидОперацииРасчета   = Перечисления.ВидыОперацийРасчетаПоказателей.ЗаписьВЛогИзмененныхПоказателей;		

	КонецЕсли;
		
	ТекстЗапроса = ТекстЗапроса + "
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ втЛогИзмененныхПоказателей
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗначенияПоказателей.ПравилоОбработки КАК ПравилоОбработки,
		|	ЗначенияПоказателей.Показатель КАК Показатель,
		|	ЗначенияПоказателей.Сценарий КАК Сценарий,
		|	ЗначенияПоказателей.Организация КАК Организация,
		|	ЗначенияПоказателей.Проект КАК Проект,
		|	ЗначенияПоказателей.Аналитика1 КАК Аналитика1,
		|	ЗначенияПоказателей.Аналитика2 КАК Аналитика2,
		|	ЗначенияПоказателей.Аналитика3 КАК Аналитика3,
		|	ЗначенияПоказателей.Аналитика4 КАК Аналитика4,
		|	ЗначенияПоказателей.Аналитика5 КАК Аналитика5,
		|	ЗначенияПоказателей.Аналитика6 КАК Аналитика6,
		|	ЗначенияПоказателей.АналитикаВалюта КАК АналитикаВалюта,
		|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета,
		|	ЗначенияПоказателей.Валюта КАК Валюта,
		|	ЗначенияПоказателей.Значение КАК Значение,
		|	ЗначенияПоказателей.ЗначениеНечисловое КАК ЗначениеНечисловое,
		|	ЗначенияПоказателей.ЗначениеВалюта КАК ЗначениеВалюта,
		|	ЗначенияПоказателей.НомерТранзакции КАК НомерТранзакции
		|ПОМЕСТИТЬ втЛогИзмененныхПоказателей
		|ИЗ
		|	втЛогИзмененныхПоказателейВременная КАК ЗначенияПоказателей
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ втЛогИзмененныхПоказателейВременная
		|;";

	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстАналитики%", ТекстАналитики);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстАналитикиВалюта%", ТекстАналитикиВалюта);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстЗначение%", ТекстЗначение); 
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстЗначениеНечисловое%", ТекстЗначениеНечисловое); 	
	нСтрокаТаблицыЗапросов.ТекстПодзапросов = ТекстЗапроса;
	
	ДобавитьПараметрВПакет(тПараметрыПакета, "НомерТранзакции",, "НомерТранзакции");
	ДобавитьПараметрВПакет(тПараметрыПакета, "ПравилоОбработки",, "ПравилоОбработки");
	ДобавитьПараметрВПакет(тПараметрыПакета, Перечисления.СпособыВычисленияПараметровОперандов.СценарийОтчета,, "Сценарий");
	ДобавитьПараметрВПакет(тПараметрыПакета, Перечисления.СпособыВычисленияПараметровОперандов.ОрганизацияОтчета,, "Организация");
	ДобавитьПараметрВПакет(тПараметрыПакета, Перечисления.СпособыВычисленияПараметровОперандов.ПроектОтчета,, "Проект");
	ДобавитьПараметрВПакет(тПараметрыПакета, Перечисления.СпособыВычисленияПараметровОперандов.ВалютаОтчета,,"Валюта");
	нСтрокаТаблицыЗапросов.тПараметрыПакета = тПараметрыПакета;
	
КонецПроцедуры

Процедура ДобавитьВЛогТаблицуИзмененныхПоказателейУровень0(СтруктураРасчетаПоказателей)
	
	глТаблицаПересчетаПоказателей   = СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей;
	МаксКлючевыхАналитик			= СтруктураРасчетаПоказателей.МаксКлючевыхАналитик;		
	МаксИспользуемыхАналитик		= СтруктураРасчетаПоказателей.МаксИспользуемыхАналитик;
	тИспользуемыеАналитики 			= СтруктураРасчетаПоказателей.тИспользуемыеАналитики;
	тИспользуемыеРесурсы			= СтруктураРасчетаПоказателей.тИспользуемыеРесурсы;
	
	// Добавим валюту отчета
	тПараметрыПакета = ПолучитьОписаниеТаблицыПараметров();
	
	АналитикиУровень0 = тИспользуемыеАналитики.Скопировать(Новый Структура("УровеньРасчета",0));
	АналитикиУровень0.Свернуть("Поле");
	МаксИспользуемыхАналитик = АналитикиУровень0.Количество();
	РесурсыУровень0 = тИспользуемыеРесурсы.Скопировать(Новый Структура("УровеньРасчета",0)); 
	РесурсыУровень0.Свернуть("Поле");
	
	// Добавим аналитики рассчитанных показателей
	ТекстАналитики = "";
	Для Сч = 1 По ПараметрыСеанса.ЧислоДопАналитик Цикл
		
		Если Сч <= МаксКлючевыхАналитик Тогда
			
			// Ключевые аналитики вида отчета
			ТекстАналитики = ТекстАналитики + ",
			|	&Аналитика" + Сч + " КАК Аналитика" + Сч;
			
			ДобавитьПараметрВПакет(тПараметрыПакета, Перечисления.СпособыВычисленияПараметровОперандов["Аналитика" + Сч],,"Аналитика" + Сч);
			
		ИначеЕсли АналитикиУровень0.Найти("Аналитика" + Сч,"Поле") <> Неопределено Тогда
			
			// Аналитики показателей
			ТекстАналитики = ТекстАналитики + ",
			|	ЗначенияПоказателей.Аналитика" + Сч + " КАК Аналитика" + Сч;
			
		Иначе
			
			// Пустая аналитика
			ТекстАналитики = ТекстАналитики + ",
			|	НЕОПРЕДЕЛЕНО КАК Аналитика" + Сч;
			
		КонецЕсли;
		
	КонецЦикла;
	
	// Добавим аналитику по валюте
	ТекстАналитики = ТекстАналитики + ",
	|	ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка) КАК АналитикаВалюта";

	// Текст Значение
	Если РесурсыУровень0.Найти("Значение","Поле") = Неопределено Тогда
		ТекстЗначение = ",
		|	0 КАК Значение,
		|	0 КАК ЗначениеВалюта";
	Иначе
		ТекстЗначение = ",
		|	ЗначенияПоказателей.Значение КАК Значение,
		|	0 КАК ЗначениеВалюта";
	КонецЕсли;	
	Если РесурсыУровень0.Найти("ЗначениеНечисловое","Поле") = Неопределено Тогда
		ТекстЗначение = ТекстЗначение + ",
		|	НЕОПРЕДЕЛЕНО КАК ЗначениеНечисловое";
	Иначе
		ТекстЗначение = ТекстЗначение + ",
		|	ЗначенияПоказателей.ЗначениеНечисловое КАК ЗначениеНечисловое";
	КонецЕсли;	
		
	ТекстЗапроса = "
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ		
		|	ЗначенияПоказателей.НомерТранзакции КАК НомерТранзакции,
		|	ЗначенияПоказателей.ПравилоОбработки КАК ПравилоОбработки,
		|	ЗначенияПоказателей.Сценарий КАК Сценарий,
		|	ЗначенияПоказателей.Организация КАК Организация,
		|	ЗначенияПоказателей.Проект КАК Проект,
		|	ЗначенияПоказателей.Валюта КАК Валюта,		
		|	ЗначенияПоказателей.Показатель КАК Показатель,
		|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета,
		|	ЗначенияПоказателей.Аналитика1 КАК Аналитика1,
		|	ЗначенияПоказателей.Аналитика2 КАК Аналитика2,
		|	ЗначенияПоказателей.Аналитика3 КАК Аналитика3,
		|	ЗначенияПоказателей.Аналитика4 КАК Аналитика4,
		|	ЗначенияПоказателей.Аналитика5 КАК Аналитика5,
		|	ЗначенияПоказателей.Аналитика6 КАК Аналитика6,
		|	ЗначенияПоказателей.АналитикаВалюта КАК АналитикаВалюта,
		|	ЗначенияПоказателей.Значение КАК Значение,
		|	ЗначенияПоказателей.ЗначениеВалюта КАК ЗначениеВалюта,
		|	ЗначенияПоказателей.ЗначениеНечисловое КАК ЗначениеНечисловое
		|ПОМЕСТИТЬ втЛогИзмененныхПоказателейВременнаяУровень0
		|ИЗ
		|	втЛогИзмененныхПоказателейУровень0 КАК ЗначенияПоказателей
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	&НомерТранзакции,
		|	ЗНАЧЕНИЕ(Справочник.ПравилаОбработки.ПустаяСсылка),
		|	&Сценарий,
		|	&Организация,
		|	&Проект,
		|	&Валюта,
		|	ЗначенияПоказателей.Показатель,
		|	ЗначенияПоказателей.ПериодОтчета %ТекстАналитики% %ТекстЗначение%
		|ИЗ
		|	втПоказателиРаскрытия0 КАК ЗначенияПоказателей
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ втЛогИзмененныхПоказателейУровень0
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ЗначенияПоказателей.ПравилоОбработки КАК ПравилоОбработки,
		|	ЗначенияПоказателей.Показатель КАК Показатель,
		|	ЗначенияПоказателей.Сценарий КАК Сценарий,
		|	ЗначенияПоказателей.Организация КАК Организация,
		|	ЗначенияПоказателей.Проект КАК Проект,
		|	ЗначенияПоказателей.Аналитика1 КАК Аналитика1,
		|	ЗначенияПоказателей.Аналитика2 КАК Аналитика2,
		|	ЗначенияПоказателей.Аналитика3 КАК Аналитика3,
		|	ЗначенияПоказателей.Аналитика4 КАК Аналитика4,
		|	ЗначенияПоказателей.Аналитика5 КАК Аналитика5,
		|	ЗначенияПоказателей.Аналитика6 КАК Аналитика6,
		|	ЗначенияПоказателей.АналитикаВалюта КАК АналитикаВалюта,
		|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета,
		|	ЗначенияПоказателей.Валюта КАК Валюта,
		|	ЗначенияПоказателей.Значение КАК Значение,
		|	ЗначенияПоказателей.ЗначениеНечисловое КАК ЗначениеНечисловое,
		|	ЗначенияПоказателей.ЗначениеВалюта КАК ЗначениеВалюта,
		|	ЗначенияПоказателей.НомерТранзакции КАК НомерТранзакции
		|ПОМЕСТИТЬ втЛогИзмененныхПоказателейУровень0
		|ИЗ
		|	втЛогИзмененныхПоказателейВременнаяУровень0 КАК ЗначенияПоказателей
		|		ЛЕВОЕ СОЕДИНЕНИЕ втЛогИзмененныхПоказателей КАК ЛогИзмененныхПоказателей
		|		ПО ЗначенияПоказателей.Показатель = ЛогИзмененныхПоказателей.Показатель
		|		И ЗначенияПоказателей.Сценарий = ЛогИзмененныхПоказателей.Сценарий
		|		И ЗначенияПоказателей.Организация = ЛогИзмененныхПоказателей.Организация
		|		И ЗначенияПоказателей.Проект = ЛогИзмененныхПоказателей.Проект
		|		И ЗначенияПоказателей.Аналитика1 = ЛогИзмененныхПоказателей.Аналитика1
		|		И ЗначенияПоказателей.Аналитика2 = ЛогИзмененныхПоказателей.Аналитика2
		|		И ЗначенияПоказателей.Аналитика3 = ЛогИзмененныхПоказателей.Аналитика3
		|		И ЗначенияПоказателей.Аналитика4 = ЛогИзмененныхПоказателей.Аналитика4
		|		И ЗначенияПоказателей.Аналитика5 = ЛогИзмененныхПоказателей.Аналитика5
		|		И ЗначенияПоказателей.АналитикаВалюта = ЛогИзмененныхПоказателей.АналитикаВалюта
		|		И ЗначенияПоказателей.ПериодОтчета = ЛогИзмененныхПоказателей.ПериодОтчета
		|		И ЗначенияПоказателей.Валюта = ЛогИзмененныхПоказателей.Валюта
		|		И ЗначенияПоказателей.НомерТранзакции = ЛогИзмененныхПоказателей.НомерТранзакции
		|ГДЕ
		|	ЛогИзмененныхПоказателей.Показатель ЕСТЬ NULL
		|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстАналитики%", ТекстАналитики);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстЗначение%", ТекстЗначение); 
	
	ДобавитьПараметрВПакет(тПараметрыПакета, "НомерТранзакции",, "НомерТранзакции");
	ДобавитьПараметрВПакет(тПараметрыПакета, "ПравилоОбработки",, "ПравилоОбработки");
	ДобавитьПараметрВПакет(тПараметрыПакета, Перечисления.СпособыВычисленияПараметровОперандов.СценарийОтчета,, "Сценарий");
	ДобавитьПараметрВПакет(тПараметрыПакета, Перечисления.СпособыВычисленияПараметровОперандов.ОрганизацияОтчета,, "Организация");
	ДобавитьПараметрВПакет(тПараметрыПакета, Перечисления.СпособыВычисленияПараметровОперандов.ПроектОтчета,, "Проект");
	ДобавитьПараметрВПакет(тПараметрыПакета, Перечисления.СпособыВычисленияПараметровОперандов.ВалютаОтчета,,"Валюта");
	
	нСтрокаТаблицыЗапросов = глТаблицаПересчетаПоказателей.Добавить();
	нСтрокаТаблицыЗапросов.ТекстПодзапросов 	= ТекстЗапроса;
	нСтрокаТаблицыЗапросов.тПараметрыПакета 	= тПараметрыПакета;	
	нСтрокаТаблицыЗапросов.КомментарийКПакету 	= "ЗАПИСЬ В ЛОГ ИЗМЕНЕННЫХ ПОКАЗАТЕЛЕЙ УРОВЕНЬ 0";
	нСтрокаТаблицыЗапросов.ВидОперацииРасчета 	= Перечисления.ВидыОперацийРасчетаПоказателей.ЗаписьВЛогИзмененныхПоказателей;
	
КонецПроцедуры

Процедура ПодготовитьИзмененияВалютныхПоказателей(СтруктураРасчетаПоказателей)
	
	глТаблицаПересчетаПоказателей       = СтруктураРасчетаПоказателей.глТаблицаПересчетаПоказателей;
	МаксКлючевыхАналитик				= СтруктураРасчетаПоказателей.МаксКлючевыхАналитик;		
	МаксИспользуемыхАналитик			= СтруктураРасчетаПоказателей.МаксИспользуемыхАналитик;
	
	// Текст аналитик	
	ТекстАналитики = ",
	|	ЗначенияПоказателей.АналитикаВалюта";	
	Для Сч = МаксКлючевыхАналитик+1 По МаксИспользуемыхАналитик Цикл
		ТекстАналитики = ТекстАналитики + ",
		|	ЗначенияПоказателей.Аналитика" + Сч;
	КонецЦикла;
	
	ТекстЗапроса = "
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗначенияПоказателей.Показатель КАК Показатель,
		|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета,
		|	ЗначенияПоказателей.АналитикаВалюта КАК АналитикаВалюта,
		|	ЗначенияПоказателей.Значение КАК Значение,
		|	ЗначенияПоказателей.ЗначениеВалюта КАК ЗначениеВалюта %ТекстАналитики% 
		|ПОМЕСТИТЬ втРассчитанныеПоказатели_ЗначениеВалютаПредварительная
		|ИЗ
		|	втРассчитанныеПоказатели_ПересчетЗначениеВалюта КАК ЗначенияПоказателей
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗначенияПоказателей.Показатель КАК Показатель,
		|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета,
		|	ЗначенияПоказателей.АналитикаВалюта КАК АналитикаВалюта,
		|	ВЫРАЗИТЬ(ЗначенияПоказателей.ЗначениеВалюта / ЕСТЬNULL(КурсыВалют.КоэффициентПересчета, 0) * 1000000 КАК ЧИСЛО(18, 5)) КАК Значение,
		|	ЗначенияПоказателей.ЗначениеВалюта КАК ЗначениеВалюта %ТекстАналитики%
		|ИЗ
		|	втРассчитанныеПоказатели КАК ЗначенияПоказателей
		|		ЛЕВОЕ СОЕДИНЕНИЕ втКурсыВалют КАК КурсыВалют
		|		ПО ЗначенияПоказателей.Показатель = КурсыВалют.Показатель
		|			И ЗначенияПоказателей.ПериодОтчета = КурсыВалют.ПериодОтчета
		|			И ЗначенияПоказателей.АналитикаВалюта = КурсыВалют.Валюта
		|
		|ГДЕ
		|	ЗначенияПоказателей.Значение = 0
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗначенияПоказателей.Показатель КАК Показатель,
		|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета,
		|	ЗначенияПоказателей.АналитикаВалюта КАК АналитикаВалюта,
		|	-1 * ЗначенияПоказателей.Значение КАК Значение,
		|	-1 * ЗначенияПоказателей.ЗначениеВалюта КАК ЗначениеВалюта %ТекстАналитики%
		|ИЗ
		|	втРассчитанныеПоказатели КАК ЗначенияПоказателей
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗначенияПоказателей.Показатель КАК Показатель,
		|	ЗначенияПоказателей.ПериодОтчета КАК ПериодОтчета,
		|	СУММА(ЗначенияПоказателей.Значение) КАК Значение,
		|	СУММА(ЗначенияПоказателей.ЗначениеВалюта) КАК ЗначениеВалюта %ТекстАналитики%
		|ПОМЕСТИТЬ втРассчитанныеПоказатели_ЗначениеВалюта
		|ИЗ
		|	втРассчитанныеПоказатели_ЗначениеВалютаПредварительная КАК ЗначенияПоказателей
		|
		|СГРУППИРОВАТЬ ПО 
		|	ЗначенияПоказателей.Показатель,
		|	ЗначенияПоказателей.ПериодОтчета %ТекстАналитики%
		|
		|ИМЕЮЩИЕ
		|	СУММА(ЗначенияПоказателей.Значение) <> 0
		|	ИЛИ СУММА(ЗначенияПоказателей.ЗначениеВалюта) <> 0";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%ТекстАналитики%", ТекстАналитики);	
	
	нСтрокаТаблицыЗапросов 						= глТаблицаПересчетаПоказателей.Добавить();
	нСтрокаТаблицыЗапросов.КомментарийКПакету 	= "ПОЛУЧЕНИЕ ДАННЫХ ИЗМЕНИВШИХСЯ ВАЛЮТНЫХ ЗНАЧЕНИЙ";
	нСтрокаТаблицыЗапросов.ВидОперацииРасчета   = Перечисления.ВидыОперацийРасчетаПоказателей.ПолучениеДанныхВалютнойАналитики;
	нСтрокаТаблицыЗапросов.ТекстПодзапросов		= ТекстЗапроса;	
	
КонецПроцедуры

#КонецОбласти


#Область ПроцедурыПодготовкиЗапросовДляРаботыСОтборамиОперандов

////////////////////////////////////////////////////////////////////////////////
// Процедуры для работы с отборами
//  
////////////////////////////////////////////////////////////////////////////////

Функция СформироватьТекстОтбора(тРасшифровкаГруппОтборов,тПараметрыПакета,УИДГруппыОтборов,ОператорОбъединения=" И ",ИдентификаторРодителя=0,ВключаетсяВПоля=Ложь)
	
	ТекстЗапросаПоОтборам = "";
	ОтборГруппОтборов = тРасшифровкаГруппОтборов.НайтиСтроки(
		Новый Структура("УИДГруппыОтборов,ИдентификаторРодителя,ВключаетсяВПоля",УИДГруппыОтборов,ИдентификаторРодителя,ВключаетсяВПоля));
		
	Для Каждого СтрокаГруппыОтборов Из ОтборГруппОтборов Цикл
		
		Если СтрокаГруппыОтборов.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ГруппаИ Тогда			
			
			ТекстОтбора = СформироватьТекстОтбора(тРасшифровкаГруппОтборов,тПараметрыПакета,УИДГруппыОтборов,,СтрокаГруппыОтборов.ИдентификаторСтроки,ВключаетсяВПоля);
			Если СокрЛП(ТекстОтбора) <> "" Тогда
				ТекстЗапросаПоОтборам = ТекстЗапросаПоОтборам + ?(ТекстЗапросаПоОтборам = "","",Символы.ПС + Символы.Таб) + ОператорОбъединения + "(" + Сред(ТекстОтбора,3) + ")";
			КонецЕсли;	
				
		ИначеЕсли СтрокаГруппыОтборов.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ГруппаИЛИ Тогда
			
			ТекстОтбора = СформироватьТекстОтбора(тРасшифровкаГруппОтборов,тПараметрыПакета,УИДГруппыОтборов," ИЛИ ",СтрокаГруппыОтборов.ИдентификаторСтроки,ВключаетсяВПоля);
			Если СокрЛП(ТекстОтбора) <> "" Тогда				
				ТекстЗапросаПоОтборам = ТекстЗапросаПоОтборам + ?(ТекстЗапросаПоОтборам = "","",Символы.ПС + Символы.Таб) + ОператорОбъединения + "(" + Сред(ТекстОтбора,5) + ")";
			КонецЕсли;
			
		ИначеЕсли СтрокаГруппыОтборов.СпособВычисленияПараметра = Перечисления.СпособыВычисленияПараметровОперандов.ГруппаНЕ Тогда			
			
			ТекстОтбора = СформироватьТекстОтбора(тРасшифровкаГруппОтборов,тПараметрыПакета,УИДГруппыОтборов,,СтрокаГруппыОтборов.ИдентификаторСтроки,ВключаетсяВПоля);
			Если СокрЛП(ТекстОтбора) <> "" Тогда
				ТекстЗапросаПоОтборам = ТекстЗапросаПоОтборам + ?(ТекстЗапросаПоОтборам = "","",Символы.ПС + Символы.Таб) + ОператорОбъединения + "НЕ (" + Сред(ТекстОтбора,3) + ")";
			КонецЕсли;
			
		Иначе
			
			ТекстЗапросаПоОтборам = ТекстЗапросаПоОтборам + ?(ТекстЗапросаПоОтборам = "","",Символы.ПС + Символы.Таб)
				+ ПолучитьСвойстваОтбора(СтрокаГруппыОтборов,тПараметрыПакета,ОператорОбъединения).ТекстОтбора;					
			
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат ТекстЗапросаПоОтборам;
	
КонецФункции

Функция ПолучитьСвойстваОтбора(СтрокаОтбора,тПараметрыПакета,ОператорОбъединения="")
	
	Отбор = СтрокаОтбора.СпособВычисленияПараметра;
	Если ЗначениеЗаполнено(СтрокаОтбора.ТипЗначенияАналитики) Тогда
		ПервыйРазделитель = СтрНайти(СтрокаОтбора.ПолеБД, ".");
		Если ПервыйРазделитель = 0 Тогда
			ИмяПоля = ОператорОбъединения 
				+ "ВЫРАЗИТЬ(%ИмяТаблицы%." + СтрокаОтбора.ПолеБД + " КАК " + СтрокаОтбора.ТипЗначенияАналитики + ")";
		Иначе
			ИмяПоля = ОператорОбъединения 
				+ "ВЫРАЗИТЬ(%ИмяТаблицы%." + Лев(СтрокаОтбора.ПолеБД, ПервыйРазделитель-1) + " КАК " + СтрокаОтбора.ТипЗначенияАналитики + ")" 
				+ Сред(СтрокаОтбора.ПолеБД, ПервыйРазделитель);
		КонецЕсли;		
	Иначе	
		ИмяПоля = ОператорОбъединения + "%ИмяТаблицы%." + СтрокаОтбора.ПолеБД;
	КонецЕсли;
	
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("ТекстОтбора","");
	СтруктураВозврата.Вставить("ВидСравнения","");
	СтруктураВозврата.Вставить("ИмяПараметра","");
	
	Если Отбор = Перечисления.СпособыВычисленияПараметровОперандов.НеИспользуется Тогда
		Возврат СтруктураВозврата;
	КонецЕсли;
	
	Если Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеЗначение
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеСписокЗначений Тогда
		ЗначениеОтбора = СтрокаОтбора.ТекстМодуля;
	Иначе
		ЗначениеОтбора = СтрокаОтбора.УточнениеСпособаОпределения;
	КонецЕсли; 	
		
	НОтбор = ДобавитьПараметрВПакет(тПараметрыПакета, Отбор, ЗначениеОтбора, СтрокаОтбора.ПолеБД);
	ИмяПараметра = НОтбор.ИмяОтбора;	
	СтруктураВозврата.Вставить("ИмяПараметра", ИмяПараметра);
	
	Если Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ФиксированноеЗначение
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.СценарийОтчета
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ОрганизацияОтчета
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ПроектОтчета
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ВалютаОтчета
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчета
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаПериодаОтчета
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.Булево
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.Строка
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.Число
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.Дата
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаВышестоящегоПериода
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГода
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаГодаСоСдвигом
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ДатаНачалаПериодаОтчетаСоСдвигом
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаВышестоящегоПериода
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГода
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаГодаСоСдвигом
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ДатаКонцаПериодаОтчетаСоСдвигом		
		Или Лев(Отбор,9) = "Аналитика"
		Тогда
		
		СтруктураВозврата.ТекстОтбора	= ИмяПоля + " = &" + ИмяПараметра;
		СтруктураВозврата.ВидСравнения	= ВидСравнения.Равно;
		
	ИначеЕсли Отбор = Перечисления.СпособыВычисленияПараметровОперандов.НеРавноФиксированномуЗначению Тогда
		
		СтруктураВозврата.ТекстОтбора 	= ИмяПоля + " <> &" + ИмяПараметра;
		СтруктураВозврата.ВидСравнения	= ВидСравнения.НеРавно;
		
	ИначеЕсли Отбор = Перечисления.СпособыВычисленияПараметровОперандов.СписокФиксированныхЗначений
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ПериметрОтчета 
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ПериодОтчета 
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ВышестоящийПериод
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.АналогичныйПериодПредыдущегоГода
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.АналогичныйПериодГодаСоСдвигом
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ПериодОтчетаСоСдвигом Тогда
		
		СтруктураВозврата.ТекстОтбора 	= ИмяПоля + " В (&" + ИмяПараметра + ")";
		СтруктураВозврата.ВидСравнения	= ВидСравнения.ВСписке;
		
	ИначеЕсли Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеЗначение
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.ФункцияНаВстроенномЯзыкеСписокЗначений
		Тогда
		
		СтруктураВозврата.ТекстОтбора 	= ИмяПоля + " В (&" + ИмяПараметра + ")";
		СтруктураВозврата.ВидСравнения	= ВидСравнения.ВСписке;
		
	ИначеЕсли Отбор = Перечисления.СпособыВычисленияПараметровОперандов.НеВСпискеФиксированныхЗначений 
		Или Отбор = Перечисления.СпособыВычисленияПараметровОперандов.НеПериметрОтчета Тогда
		
		СтруктураВозврата.ТекстОтбора 	= ИмяПоля + " НЕ В (&" + ИмяПараметра + ")";
		СтруктураВозврата.ВидСравнения	= ВидСравнения.НеВСписке;
		
	ИначеЕсли Отбор = Перечисления.СпособыВычисленияПараметровОперандов.СписокПоИерархии Тогда
		
		СтруктураВозврата.ТекстОтбора 	= ИмяПоля + " В ИЕРАРХИИ(&" + ИмяПараметра + ")";
		СтруктураВозврата.ВидСравнения	= ВидСравнения.ВИерархии;
		
	ИначеЕсли Отбор = Перечисления.СпособыВычисленияПараметровОперандов.НеВСпискеПоИерархии Тогда
		
		СтруктураВозврата.ТекстОтбора 	= ИмяПоля + " НЕ В ИЕРАРХИИ(&" + ИмяПараметра + ")";
		СтруктураВозврата.ВидСравнения	= ВидСравнения.НеВИерархии;
		
	ИначеЕсли Отбор = Перечисления.СпособыВычисленияПараметровОперандов.Больше Тогда
		
		СтруктураВозврата.ТекстОтбора 	= ИмяПоля + " > &" + ИмяПараметра;
		СтруктураВозврата.ВидСравнения	= ВидСравнения.Больше;
		
	ИначеЕсли Отбор = Перечисления.СпособыВычисленияПараметровОперандов.БольшеИлиРавно Тогда
		
		СтруктураВозврата.ТекстОтбора 	= ИмяПоля + " >= &" + ИмяПараметра;
		СтруктураВозврата.ВидСравнения	= ВидСравнения.БольшеИлиРавно;
		
	ИначеЕсли Отбор = Перечисления.СпособыВычисленияПараметровОперандов.Меньше Тогда
		
		СтруктураВозврата.ТекстОтбора 	= ИмяПоля + " < &" + ИмяПараметра;
		СтруктураВозврата.ВидСравнения	= ВидСравнения.Меньше;
		
	ИначеЕсли Отбор = Перечисления.СпособыВычисленияПараметровОперандов.МеньшеИлиРавно Тогда
		
		СтруктураВозврата.ТекстОтбора 	= ИмяПоля + " <= &" + ИмяПараметра;
		СтруктураВозврата.ВидСравнения	= ВидСравнения.МеньшеИлиРавно;
		
	Иначе
		
		ТекстОшибки = СтрШаблон(НСтр("ru = 'Тип отборов %1 в настоящий момент не поддерживается.'"),Отбор);
		ВызватьИсключение(ТекстОшибки);
		
	КонецЕсли;
	
	Возврат СтруктураВозврата;
	
КонецФункции

Функция ДобавитьПараметрВПакет(тПараметрыПакета, ТипОтбора, ЗначениеОтбора=Неопределено, ПолеБД = "Параметр")
	
	УИДГруппыОтбора = ЗначениеВСтрокуВнутр(ТипОтбора) + "@" + ЗначениеВСтрокуВнутр(ЗначениеОтбора);
		
	НСтрока = тПараметрыПакета.Найти(УИДГруппыОтбора,"УИДГруппыОтбора");
	Если НСтрока = Неопределено Тогда
		НСтрока = тПараметрыПакета.Добавить();
		НСтрока.ИмяОтбора = СтрЗаменить(ПолеБД,".","") + ?(ЗначениеОтбора=Неопределено,"","_" + СтрЗаменить(Новый УникальныйИдентификатор,"-",""));
		НСтрока.ТипОтбора = ТипОтбора;
		НСтрока.ЗначениеОтбора = ЗначениеОтбора;
		НСтрока.УИДГруппыОтбора = УИДГруппыОтбора;
	КонецЕсли;
	
	Возврат НСтрока;	
	
КонецФункции

Функция СформироватьТекстАналитик(тИспользуемыеАналитики,УровеньРасчета,Режим = 1,ТрансформацияПолей=Ложь)

	// Режим:
	//	0 - Для запроса по версиям
	//	1 - Для запроса по таблицам
	//	2 - Для трансформации полей
	//	3 - Для группировки
	//	4 - Для соединения
	ТекстДополнительныхПолей = "";

	Если Режим = 0 Тогда
		тПоляУровня = тИспользуемыеАналитики.НайтиСтроки(Новый Структура("УровеньРасчета,ПолеВерсии",УровеньРасчета,Истина));
	Иначе
		тПоляУровня = тИспользуемыеАналитики.НайтиСтроки(Новый Структура("УровеньРасчета",УровеньРасчета));
	КонецЕсли;
	
	Для Каждого СтрПоле Из тПоляУровня Цикл		
		
		Если СтрПоле.Поле = "ПериодОтчета" Тогда
			Продолжить;
	
		ИначеЕсли Режим = 4 Тогда
			
			ТекстДополнительныхПолей = ТекстДополнительныхПолей + "
			|	И %ИмяТаблицы%." + СтрПоле.Поле + " = %ИмяТаблицыСоединение%." + СтрПоле.Поле;
			
		Иначе
			
			Если ТрансформацияПолей Тогда
				// Построение текста по аналитикам происходит в самой процедуре
				Если Лев(СтрПоле.Поле,9) = "Аналитика" Тогда
					Продолжить;
				КонецЕсли;
			КонецЕсли;
		
			ТекстДополнительныхПолей = ТекстДополнительныхПолей + ",
				|	%ИмяТаблицы%." + СтрПоле.Поле;
		
			Если Режим <> 3 Тогда
				ТекстДополнительныхПолей = ТекстДополнительныхПолей + " КАК " + СтрЗаменить(СтрПоле.Поле,".","");
			КонецЕсли;
			
		КонецЕсли;
	
	КонецЦикла;
	
	Возврат ТекстДополнительныхПолей;
	
КонецФункции

Функция СформироватьТекстРесурсов(тИспользуемыеРесурсы,УровеньРасчета,Режим = 1)

	// Режим:
	//	1 - Для запроса по таблицам
	//	2 - Для трансформации полей
	//	3 - Для группировки
	//	4 - Для отбора
	ТекстДополнительныхПолей = "";

	тПоляУровня = тИспользуемыеРесурсы.НайтиСтроки(Новый Структура("УровеньРасчета",УровеньРасчета));
	
	Для Каждого СтрПоле Из тПоляУровня Цикл
		
		Если Режим = 4 Тогда
			Если СтрПоле.Суммируется Тогда
				ТекстДополнительныхПолей = ТекстДополнительныхПолей + "
				|
				|ИМЕЮЩИЕ
				|	СУММА(%ИмяТаблицы%." + СтрПоле.Поле + ") <> 0";
			Иначе
				// Есть нечисловые показатели, не будем фильтровать
				Возврат "";
			КонецЕсли;	
		ИначеЕсли Режим = 2 Тогда 
			Если СтрПоле.Суммируется Тогда
		    	ТекстДополнительныхПолей = ТекстДополнительныхПолей + ",
					|	СУММА(%ИмяТаблицы%." + СтрПоле.Поле + ")";
			Иначе
				ТекстДополнительныхПолей = ТекстДополнительныхПолей + ",
					|	МАКСИМУМ(%ИмяТаблицы%." + СтрПоле.Поле + ")";
			КонецЕсли;
		ИначеЕсли Режим = 3 Тогда
			Продолжить;
		Иначе
			ТекстДополнительныхПолей = ТекстДополнительныхПолей + ",
				|	%ИмяТаблицы%." + СтрПоле.Поле;
		КонецЕсли;
		
		Если Режим < 3 Тогда
			ТекстДополнительныхПолей = ТекстДополнительныхПолей + " КАК " + СтрПоле.Поле;
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат ТекстДополнительныхПолей;
	
КонецФункции

#КонецОбласти


#Область ВспомогательныеПроцедурыИФункции

////////////////////////////////////////////////////////////////////////////////
// Служебные процедуры и функции
//  
////////////////////////////////////////////////////////////////////////////////

Функция ПолучитьОписаниеТаблицыПодзапроса()
	
	  ТаблицаПодзапроса = Новый ТаблицаЗначений;
	  ТаблицаПодзапроса.Колонки.Добавить("НомерПодзапроса",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповЧисла(5));	
	  ТаблицаПодзапроса.Колонки.Добавить("ТекстПодзапроса");		
	  ТаблицаПодзапроса.Колонки.Добавить("КомментарийКПодзапросу");	
	  
	  Возврат ТаблицаПодзапроса; 
	  
КонецФункции

Функция ПолучитьОписаниеТаблицыПараметров()
	
	тПараметрыПакета = Новый ТаблицаЗначений;
	тПараметрыПакета.Колонки.Добавить("ИмяОтбора");
	тПараметрыПакета.Колонки.Добавить("ТипОтбора");
	тПараметрыПакета.Колонки.Добавить("ЗначениеОтбора");
	тПараметрыПакета.Колонки.Добавить("УИДГруппыОтбора");
	
	Возврат тПараметрыПакета;
	
КонецФункции

Функция ПолучитьТекстПоТаблицеПодзапросов(ТаблицаПодзапросов,ИмяВременнойТаблицы)
	
	ТекстПодзапросов 	= "";
	ТекстУничтожить		= "";
	ПервыйЗапрос		= Истина;
			
	Для Каждого СтрЗапрос Из ТаблицаПодзапросов Цикл
		
		ТекстПодзапросов = ТекстПодзапросов + СтрЗапрос.ТекстПодзапроса;
	
		Если СтрНайти(СтрЗапрос.ТекстПодзапроса,"ПОМЕСТИТЬ втРассчитанныеЗначения") Тогда
			Продолжить;
		КонецЕсли;
		
		Если ПервыйЗапрос Тогда	
			ТекстПодзапросов = СтрЗаменить(ТекстПодзапросов,"ОБЪЕДИНИТЬ ВСЕ","");
			ТекстПодзапросов = СтрЗаменить(ТекстПодзапросов,"//ПОМЕСТИТЬ","ПОМЕСТИТЬ "+ИмяВременнойТаблицы);
			ПервыйЗапрос = Ложь;
		Иначе	 	 
			ТекстПодзапросов = СтрЗаменить(ТекстПодзапросов,"//ПОМЕСТИТЬ","");
		КонецЕсли;	
		
		ТекстПодзапросов = СтрЗаменить(ТекстПодзапросов,"//ВЛОЖЕННЫЙ ЗАПРОС ОБЪЕДИНИТЬ","ОБЪЕДИНИТЬ ВСЕ");
		
	КонецЦикла;	
		
	Возврат СокрЛП(ТекстПодзапросов + ТекстУничтожить);
	
КонецФункции

Функция ПолучитьТекстПоТаблицеПодзапросовВТ(ТаблицаПодзапросов)
	
	ТекстПодзапросов = "";
			
	Для Каждого СтрЗапрос Из ТаблицаПодзапросов Цикл
		
		ТекстПодзапросов = ТекстПодзапросов + ?(ТекстПодзапросов = "", "", "
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|") + СтрЗапрос.ТекстПодзапроса;
		
	КонецЦикла;	
		
	Возврат СокрЛП(ТекстПодзапросов);
	
КонецФункции	

Функция ПолучитьФормулуДляЯзыкаЗапросов(Знач ТекстПроцедуры, ИмяТаблицы)
	
	// Уберем все пробелы из строки формулы
	Пока СтрНайти(ТекстПроцедуры," ") > 0 Цикл
		ТекстПроцедуры = СтрЗаменить(ТекстПроцедуры, " ", "");
	КонецЦикла;
	
	// Проверим и обработаем условные операторы
	Пока СтрНайти(ТекстПроцедуры,"?") > 0 Цикл
		ОбработатьУсловныеОператорыРекурсивно(ТекстПроцедуры);
	КонецЦикла;	
	
	// Заменим фигурные скобки на идентификатор временной таблицы
	ТекстПроцедуры = СтрЗаменить(ТекстПроцедуры,"[",ИмяТаблицы + ".");
	ТекстПроцедуры = СтрЗаменить(ТекстПроцедуры,"]",""); 
	
	Возврат ТекстПроцедуры;		
	
КонецФункции

Процедура ОбработатьУсловныеОператорыРекурсивно(ТекстПроцедуры,нсТекущий = 1,Знач Отступ = "")
	
	нсВопрос			= СтрНайти(ТекстПроцедуры,"?",,нсТекущий);
	нсОткрытаяСкобка	= СтрНайти(ТекстПроцедуры,"(",,нсВопрос);
	нсТекущий			= нсОткрытаяСкобка + 1;
	ТекстПроцедуры 		= Лев(ТекстПроцедуры,нсВопрос-1) + ?(нсВопрос=1,"",Символы.ПС) + Отступ + "ВЫБОР " + Символы.ПС + Отступ + Символы.Таб + "КОГДА " + Сред(ТекстПроцедуры,нсТекущий);
	
	// Секция "ВЫБОР КОГДА"
	нсВопрос 			= СтрНайти(ТекстПроцедуры,"?",,нсТекущий);
	нсЗапятая 			= СтрНайти(ТекстПроцедуры,",",,нсТекущий);		
	
	Пока нсВопрос > 0 И нсВопрос < нсЗапятая Цикл
		// Далее идет вложенный оператор
        ОбработатьУсловныеОператорыРекурсивно(ТекстПроцедуры,нсТекущий,Отступ + Символы.Таб + Символы.Таб);
		нсВопрос 	= СтрНайти(ТекстПроцедуры,"?",,нсТекущий);
		нсЗапятая 	= СтрНайти(ТекстПроцедуры,",",,нсТекущий);
	КонецЦикла;
	
	Если нсЗапятая > 0 Тогда
		нсТекущий 		= нсЗапятая + 1;
		ТекстПроцедуры 	= Лев(ТекстПроцедуры,нсЗапятая-1) + " ТОГДА " + Сред(ТекстПроцедуры,нсТекущий);
	КонецЕсли;
	
	// Секция "ТОГДА"
	нсВопрос 		= СтрНайти(ТекстПроцедуры,"?",,нсТекущий);
	нсЗапятая 		= СтрНайти(ТекстПроцедуры,",",,нсТекущий);		
	
	Пока нсВопрос > 0 И нсВопрос < нсЗапятая Цикл
		// Далее идет вложенный оператор
        ОбработатьУсловныеОператорыРекурсивно(ТекстПроцедуры,нсТекущий,Отступ + Символы.Таб + Символы.Таб);
		нсВопрос 	= СтрНайти(ТекстПроцедуры,"?",,нсТекущий);
		нсЗапятая 	= СтрНайти(ТекстПроцедуры,",",,нсТекущий);
	КонецЦикла;
	
	Если нсЗапятая > 0 Тогда
		нсТекущий 		= нсЗапятая + 1;
		ТекстПроцедуры 	= Лев(ТекстПроцедуры,нсЗапятая-1) + Символы.ПС + Отступ + Символы.Таб + "ИНАЧЕ " + Сред(ТекстПроцедуры,нсТекущий);
	КонецЕсли;
	
	// Секция "КОНЕЦ"
	счСкобок = 0;
	Пока Истина Цикл
		нсВопрос 			= СтрНайти(ТекстПроцедуры,"?",,нсТекущий);
		нсОткрытаяСкобка	= СтрНайти(ТекстПроцедуры,"(",,нсТекущий);
		нсЗакрытаяСкобка	= СтрНайти(ТекстПроцедуры,")",,нсТекущий); 		
		Если нсВопрос > 0 И нсВопрос < нсЗакрытаяСкобка Тогда
			// Далее идет вложенный оператор
	        ОбработатьУсловныеОператорыРекурсивно(ТекстПроцедуры,нсТекущий,Отступ + Символы.Таб + Символы.Таб);
			нсВопрос 			= СтрНайти(ТекстПроцедуры,"?",,нсТекущий);
			нсОткрытаяСкобка	= СтрНайти(ТекстПроцедуры,"(",,нсТекущий);
			нсЗакрытаяСкобка	= СтрНайти(ТекстПроцедуры,")",,нсТекущий);
		КонецЕсли;	
		Если нсОткрытаяСкобка > 0 И нсОткрытаяСкобка < нсЗакрытаяСкобка Тогда
			// Далее идут вложенные скобки
			счСкобок 	= счСкобок + 1;
			нсТекущий 	= нсОткрытаяСкобка+1;
		ИначеЕсли счСкобок > 0 Тогда
			// Пропустим все закрывающие вложенные скобки
			счСкобок 	= счСкобок - 1;
			нсТекущий 	= нсЗакрытаяСкобка + 1;
		Иначе
			// Нашли "лишнюю" закрывающую скобку
			Прервать;
		КонецЕсли;
		Если нсТекущий > СтрДлина(ТекстПроцедуры) Тогда
			Прервать;
		КонецЕсли;
	КонецЦикла;

	нсТекущий		= нсЗакрытаяСкобка + 1;
	ТекстПроцедуры 	= Лев(ТекстПроцедуры,нсЗакрытаяСкобка-1) + Символы.ПС + Отступ + "КОНЕЦ " + Сред(ТекстПроцедуры,нсТекущий);

	Если нсВопрос > 0 И нсВопрос < нсЗакрытаяСкобка Тогда
		// Есть еще вложенные операторы
		ОбработатьУсловныеОператорыРекурсивно(ТекстПроцедуры,нсТекущий);	
	КонецЕсли;		
	
КонецПроцедуры

#КонецОбласти

