// ЭКСПОРТНЫЕ ФУНКЦИИ

Функция ОтправитьСообщение(Получатель, Отправитель, Порядок = 0, Сообщение, СтепеньСжатия = Неопределено) Экспорт
	
	Запись = РегистрыСведений.ОчередьСообщенийФоновыхЗаданий.СоздатьМенеджерЗаписи();
	Запись.Получатель = Получатель;
	Запись.Отправитель = Отправитель;
	Запись.Порядок = Порядок;
	Если СтепеньСжатия = Неопределено Тогда
		Запись.Сообщение = Новый ХранилищеЗначения(Сообщение);
	Иначе
		Запись.Сообщение = Новый ХранилищеЗначения(Сообщение, Новый СжатиеДанных(СтепеньСжатия));
	КонецЕсли;
	Запись.Дата = ТекущаяУниверсальнаяДата();
	
	Порядок = Порядок + 1;
	
	Попытка
		Запись.Записать();
		Возврат Истина;
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

Функция УстановитьСостояниеЗадания(Ключ, Состояние = Неопределено, Прогресс = Неопределено, Пояснение = Неопределено) Экспорт
	
	Если НЕ ЗначениеЗаполнено(Ключ) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Запись = РегистрыСведений.ОчередьФоновыхЗаданий.СоздатьМенеджерЗаписи();
	Запись.Ключ = Ключ;
	Запись.Прочитать();
	
	Если НЕ Состояние = Неопределено Тогда
		Запись.Состояние = Состояние;
	КонецЕсли;
	Если НЕ Прогресс = Неопределено Тогда
		Запись.Прогресс = Прогресс;
	КонецЕсли;
	Если НЕ Пояснение = Неопределено Тогда
		Запись.Пояснение = Пояснение;
	КонецЕсли;
	
	Попытка
		Запись.Записать();
		Возврат Истина;
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции
	
Процедура ОжидатьСек(Сек) Экспорт
	//scr = Новый COMОбъект("WScript.Shell");
	//scr.Run("timeout "+СокрЛП(Число(Сек)),0,1);
	Компьютер=".";
	Локатор=Новый COMОбъект("wbemscripting.swbemlocator");
	Сервис=Локатор.ConnectServer(Компьютер,"root\cimv2","","","","",128);
	Время = Сервис.ExecNotificationQuery("Select * from __instancemodificationevent WITHIN 1 where TargetInstance isa 'Win32_LocalTime' and TargetInstance.Second="+Секунда(ТекущаяДата()+Сек));
	СледующееСобытие = Время.NextEvent();
КонецПроцедуры