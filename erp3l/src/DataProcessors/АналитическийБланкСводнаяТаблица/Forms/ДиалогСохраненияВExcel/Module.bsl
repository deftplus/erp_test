
&НаКлиенте
Процедура КаталогНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	Перем АдресХранилища;
	СтандартнаяОбработка = Ложь;
	
	ДиалогВыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.ВыборКаталога);
	ДиалогВыбораФайла.Заголовок = Нстр("ru = 'Выберите каталог для экспорта'");
	ДиалогВыбораФайла.МножественныйВыбор = Ложь;
	
	ОповещениеВыборФайлаЗавершение = Новый ОписаниеОповещения("ВыборКаталогаЗавершение", ЭтаФорма);
	ДиалогВыбораФайла.Показать(ОповещениеВыборФайлаЗавершение);
	
КонецПроцедуры

&НаКлиенте
Процедура ФайлНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	Перем АдресХранилища;
	СтандартнаяОбработка = Ложь;
	
	ДиалогВыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ДиалогВыбораФайла.Заголовок = Нстр("ru = 'Выберите файл для экспорта'");
	ДиалогВыбораФайла.МножественныйВыбор = Ложь;
	ДиалогВыбораФайла.Фильтр = Нстр("ru = 'Таблица Excel'") + " (*.xlsx)|*.xlsx";
	
	ОповещениеВыборФайлаЗавершение = Новый ОписаниеОповещения("ВыборФайлаЗавершение", ЭтаФорма);
	ДиалогВыбораФайла.Показать(ОповещениеВыборФайлаЗавершение);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыборФайлаЗавершение(ВыбранныеФайлы,ДополнительныеПараметры) Экспорт
	
	Если ВыбранныеФайлы <> Неопределено Тогда
		
		ПутьКФайлу = ВыбранныеФайлы[0];
		
		Файл = Новый Файл(ПутьКФайлу);
		
		ИмяФайла = Файл.Имя;
		ПолноеИмяФайла = Файл.ПолноеИмя;
		Каталог =        Параметры.Каталог;
		СуществующийФайл=ПолноеИмяФайла;
			
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВыборКаталогаЗавершение(ВыбранныеФайлы,ДополнительныеПараметры) Экспорт
	
	Если ВыбранныеФайлы <> Неопределено Тогда	
		Каталог = ВыбранныеФайлы[0];		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура Сохранить(Команда)
	
	Если Не ЗначениеЗаполнено(СуществующийФайл) Тогда
		ОбщегоНазначенияУХ.СообщитьОбОшибке(Нстр("ru = 'Необходимо выбрать файл!'"));
		Возврат;
	КонецЕсли;	
	Если Не ЗначениеЗаполнено(ИмяЛиста) Тогда
		ОбщегоНазначенияУХ.СообщитьОбОшибке(Нстр("ru = 'Необходимо выбрать имя листа!'"));
		Возврат;
	КонецЕсли;	
		
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ВыриантСохранения",ВариантСохранения);
	СтруктураПараметров.Вставить("Каталог",Каталог);
	СтруктураПараметров.Вставить("СуществующийФайл",СуществующийФайл);
	СтруктураПараметров.Вставить("ИмяЛиста",ИмяЛиста);
	СтруктураПараметров.Вставить("СохранятьВФорматеИсточника", СохранятьВФорматеИсточника);
		
	СохранитьНастройки();
	Закрыть(СтруктураПараметров);
		
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	УстановитьПривилегированныйРежим (Истина);

	
	СуществующийФайл = Параметры.ИмяФайла;
	ИмяЛиста = Параметры.ИмяЛиста;	
	ВариантСохранения = "НовыйФайл";
	ВариантСохраненияПриИзмененииСервер();
	ВариантСводнойТаблицы = Параметры.ИмяФайла;
	
	Настройка = Строка(ВариантСводнойТаблицы.УникальныйИдентификатор());
	ЗначениеСохраняемойНастройки = ХранилищеОбщихНастроек.Загрузить(Настройка,,, ОбщегоНазначенияУХ.ПолучитьЗначениеПеременной("глТекущийПользователь"));
	
	Если ЗначениеСохраняемойНастройки = Неопределено Тогда
		Возврат;
	КонецЕсли;		
	
	Если ЗначениеСохраняемойНастройки.Свойство("Каталог") Тогда
		Каталог = ЗначениеСохраняемойНастройки.Каталог;
	КонецЕсли;
	
	СохранятьВФорматеИсточника = Истина;
		
	УстановитьПривилегированныйРежим(Ложь);

КонецПроцедуры

&НаКлиенте
Процедура ВыриантСохраненияПриИзменении(Элемент)
	
	ВариантСохраненияПриИзмененииСервер();

КонецПроцедуры

&НаСервере
Процедура ВариантСохраненияПриИзмененииСервер()
	
	Если ВариантСохранения = "НовыйФайл" Тогда
		Элементы.Каталог.Доступность = Истина;
		Элементы.СуществующийФайл.КнопкаВыбора = Ложь;		
		//Элементы.СуществующийФайл.ТолькоПросмотр = Ложь;

	ИначеЕсли ВариантСохранения = "СуществующийФайл" Тогда
		Элементы.Каталог.Доступность = Ложь;
		Элементы.СуществующийФайл.КнопкаВыбора = Истина;
		//Элементы.СуществующийФайл.ТолькоПросмотр = Истина;
	ИначеЕсли  ВариантСохранения = "СуществующийСеанс" Тогда
		Элементы.Каталог.Видимость = Ложь;
		Элементы.СуществующийФайл.КнопкаВыбора = Ложь;
		Элементы.СуществующийФайл.ТолькоПросмотр = Истина;
	КонецЕсли;	
	
		
КонецПроцедуры

&НаСервере
Процедура СохранитьНастройки()
	
	УстановитьПривилегированныйРежим(Истина);

	
	ЗначениеСохраняемойНастройки = Новый Структура();
	ЗначениеСохраняемойНастройки.Вставить("Каталог",Каталог);	
	
	Настройка = Строка(ВариантСводнойТаблицы.УникальныйИдентификатор());
	ХранилищеОбщихНастроек.Сохранить((Настройка),, ЗначениеСохраняемойНастройки,, ОбщегоНазначенияУХ.ПолучитьЗначениеПеременной("глТекущийПользователь"));
		
	
	УстановитьПривилегированныйРежим(Ложь);

	
КонецПроцедуры	


