
&НаКлиенте
Процедура Сохранить(Команда)
	
	
	Если НаименованиеНастройки = Строка(ИмяТекущегоВарианта) Тогда
		 //Не меняли название - сохраняем текущий вариант без вопросов.
		 Закрыть(Новый Структура("НовыйВариант",ИмяТекущегоВарианта));
	ИначеЕсли ПроверитьНаличиеВариантаПоИмени(НаименованиеНастройки) Тогда
		Оповещение = Новый ОписаниеОповещения("ПроверитьНаличиеВариантаЗавершение",ЭтаФорма);
		ПоказатьВопрос(Оповещение, Нстр("ru = 'Вариант уже существует. Заменить вариант?'"), РежимДиалогаВопрос.ДаНет);
	Иначе		
		СоздатьНовыйВариант(НаименованиеНастройки);	
		Закрыть(Новый Структура("НовыйВариант",ИмяТекущегоВарианта));
	КонецЕсли;
	
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьНаличиеВариантаЗавершение(Результат, ДополнительныеПараметры) Экспорт      
	
	Если Результат = Неопределено  Или Результат = КодВозвратаДиалога.Нет  Тогда
		Возврат;
	КонецЕсли;	
		
	Закрыть(Новый Структура("НовыйВариант",СуществующийВариант));
	
КонецПроцедуры



&НаСервере
Функция ПроверитьНаличиеВариантаПоИмени(НаименованиеНастройки) 
	

	   Запрос = Новый Запрос;
	   Запрос.Текст = "ВЫБРАТЬ
	   |	ВариантыСводныхТаблиц.Ссылка КАК Ссылка
	   |ИЗ
	   |	Справочник.ВариантыСводныхТаблиц КАК ВариантыСводныхТаблиц
	   |ГДЕ
	   |	ВариантыСводныхТаблиц.Наименование = &Наименование";
	   
	   Запрос.УстановитьПараметр("Наименование",НаименованиеНастройки);
	   
	   Результат = Запрос.Выполнить();
	   Выборка = Результат.Выбрать();
	   
	   Пока Выборка.Следующий() Цикл
	        СуществующийВариант = Выборка.Ссылка;
	   	    Возврат Истина;
	   
	   КонецЦикла;
	   
	   Возврат Ложь;
	
КонецФункции	

&НаСервере
Функция СоздатьНовыйВариант(НаименованиеНастройки) 
	
	ОНовыйВариант = Справочники.ВариантыСводныхТаблиц.СоздатьЭлемент();
	ОНовыйВариант.Наименование = НаименованиеНастройки;
	Если ЗначениеЗаполнено(Бланк) Тогда
		 ОНовыйВариант.Бланк = Бланк;
	КонецЕсли;	
	ОНовыйВариант.Записать();
	ИмяТекущегоВарианта  = ОНовыйВариант.Ссылка;
	
КонецФункции	

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ИмяТекущегоВарианта		= Параметры.ИмяТекущегоВарианта;
	
	Если ЗначениеЗаполнено(ИмяТекущегоВарианта) Тогда
		 НаименованиеНастройки = Строка(ИмяТекущегоВарианта);
	Иначе	
		 НаименованиеНастройки = "Новый вариант";
    КонецЕсли;	
	
	Бланк = Параметры.Бланк;
	
КонецПроцедуры

&НаКлиенте
Процедура НаименованиеНастройкиНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	Если ЗначениеЗаполнено(Бланк) Тогда	
		СтруктураОтбора = Новый Структура;
		СтруктураОтбора.Вставить("Бланк", Бланк);
		СтруктураОтбора.Вставить("ОсновнойВариант", Ложь);
		
		Параметры_ =  Новый Структура;
		Параметры_.Вставить("Отбор",СтруктураОтбора);		
	Иначе	
		Параметры_ =  Новый Структура;
	КонецЕсли;	

	Оповещение = Новый ОписаниеОповещения("ВыборВариантаЗавершение", ЭтаФорма);
	ОткрытьФорму("Справочник.ВариантыСводныхТаблиц.ФормаВыбора",Параметры_,ЭтаФорма,Истина,,,Оповещение,РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
	
КонецПроцедуры

&НаКлиенте
Процедура ВыборВариантаЗавершение(Результат, ДополнительныеПараметры) Экспорт      
	
	Если Результат = Неопределено  Или Результат = КодВозвратаДиалога.Отмена  Тогда
		Возврат;
	КонецЕсли;	
	
	НаименованиеНастройки = Результат;
	
КонецПроцедуры

