
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Параметры.Свойство("КомпоновщикНастроек", КомпоновщикНастроек);
	Параметры.Свойство("ИдентификаторПоля"  , ИдентификаторПоля);
	
	СписокРесурсов = ТиповыеОтчетыУХ.ПолучитьСписокДоступныхРесурсов(КомпоновщикНастроек, Ложь, Ложь);
	
	Элементы.Показатель.СписокВыбора.Очистить();
	Для каждого ЭлементСписка Из СписокРесурсов Цикл
		Элементы.Показатель.СписокВыбора.Добавить(Строка(ЭлементСписка.Значение));
	КонецЦикла;
	
	Если НЕ ПустаяСтрока(ИдентификаторПоля) Тогда
		
		ПользовательскоеПоле = КомпоновщикНастроек.Настройки.ПользовательскиеПоля.ПолучитьОбъектПоИдентификатору(ИдентификаторПоля);
		Наименование         = ПользовательскоеПоле.Заголовок;
		
		Если ПользовательскоеПоле =Неопределено Тогда
			
			СообщениеПользователю = Новый СообщениеПользователю;
			СообщениеПользователю.Текст = "Не удалось прочитать данные по произвольному полю";
			СообщениеПользователю.Сообщить();
			Отказ = Истина;
			
		Иначе
		
			Значение = ПользовательскоеПоле.Варианты.Элементы[0].Отбор.Элементы[0].ПравоеЗначение;
			Показатель = ТиповыеОтчетыУХ.ПолучитьПараметрИзСтроки(Значение, 2);
			
			Значение = ПользовательскоеПоле.Варианты.Элементы[0].Отбор.Элементы[0].ПравоеЗначение;
			Поле = ТиповыеОтчетыУХ.ПолучитьПараметрИзСтроки(Значение, 3);
			
			Значение = ПользовательскоеПоле.Варианты.Элементы[0].Отбор.Элементы[0].ПравоеЗначение;
			Значение = ТиповыеОтчетыУХ.ПолучитьПараметрИзСтроки(Значение);
			Процент1 = Число(Значение);
			
			Значение = ПользовательскоеПоле.Варианты.Элементы[1].Отбор.Элементы[0].ПравоеЗначение;
			Значение = ТиповыеОтчетыУХ.ПолучитьПараметрИзСтроки(Значение);
			Процент2 = Число(Значение);
			
			Значение = ПользовательскоеПоле.Варианты.Элементы[2].Отбор.Элементы[0].ПравоеЗначение;
			Значение = ТиповыеОтчетыУХ.ПолучитьПараметрИзСтроки(Значение);
			Процент3 = Число(Значение);
		
		КонецЕсли;
		
	КонецЕсли;
	

	
КонецПроцедуры

&НаСервере
Процедура ОбработкаПроверкиЗаполненияНаСервере(Отказ, ПроверяемыеРеквизиты)
	
	
	Если ПустаяСтрока(Наименование) Тогда
		Сообщение = Новый СообщениеПользователю();
		Сообщение.Текст = "Не заполнено поле ""Наименование""";
		Сообщение.Поле  = "Наименование";
		Сообщение.Сообщить();
		Отказ = истина;
	КонецЕсли;
	
	Если Поле = Неопределено Тогда
		
		Сообщение = Новый СообщениеПользователю();
		Сообщение.Текст = "Не выбран ""Анализируемый объект""";
		Сообщение.Поле  = "Поле";
		Сообщение.Сообщить();
		Отказ = истина;

	КонецЕсли;
	
	Если Показатель = Неопределено Тогда
		
		Сообщение = Новый СообщениеПользователю();
		Сообщение.Текст = "Не выбран ""Анализируемый параметр""";
		Сообщение.Поле  = "Показатель";
		Сообщение.Сообщить();
		Отказ = истина;

	КонецЕсли;
	
	Если Процент1 + Процент2 + Процент3 <> 100 Тогда
		
		Сообщение = Новый СообщениеПользователю();
		Сообщение.Текст = "Сумма процентов не равна 100%";
		Сообщение.Поле  = "Процент1";
		Сообщение.Сообщить();
		Отказ = истина;

	КонецЕсли;

	
КонецПроцедуры

&НаКлиенте
Процедура ПолеНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	Значение = Неопределено;

	
	ОткрытьФорму("ОбщаяФорма.ФормаВыбораДоступногоПоляКомпоновщикаНастроек_Управляемая", Новый Структура("КомпоновщикНастроек", КомпоновщикНастроек),,,,, Новый ОписаниеОповещения("ПолеНачалоВыбораЗавершение", ЭтотОбъект), РежимОткрытияОкнаФормы.БлокироватьВесьИнтерфейс);
	
КонецПроцедуры

&НаКлиенте
Процедура ПолеНачалоВыбораЗавершение(Результат, ДополнительныеПараметры) Экспорт
    
    Значение = Результат;
    Если Значение <> Неопределено Тогда
        Поле = Значение;
    КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ПоказательПриИзменении(Элемент)
	
	Если ПустаяСтрока(Наименование) Тогда
		Наименование = "ABC - классификация (" + Показатель + ")";
	КонецЕсли;

КонецПроцедуры


&НаКлиенте
Процедура КомандаОК(Команда)
	
	Если НЕ ПроверитьЗаполнение() Тогда
		Возврат;
	КонецЕсли;
	
	СозданоПользовательскоеПоле = Ложь;
	
	Если ПользовательскоеПоле = Неопределено Тогда
		ПользовательскоеПоле = КомпоновщикНастроек.Настройки.ПользовательскиеПоля.Элементы.Добавить(Тип("ПользовательскоеПолеВыборКомпоновкиДанных"));
		СозданоПользовательскоеПоле = Истина;
	Иначе
		ПользовательскоеПоле = КомпоновщикНастроек.Настройки.ПользовательскиеПоля.ПолучитьОбъектПоИдентификатору(ИдентификаторПоля);
		ПользовательскоеПоле.Варианты.Элементы.Очистить();
	КонецЕсли;
	
	ПользовательскоеПоле.Заголовок = Наименование;
	Вариант = ПользовательскоеПоле.Варианты.Элементы.Добавить();
	Вариант.Значение = "ДоработкаТаблицы,ABCКлассификация,AКласс";
	Вариант.Представление = "A - Класс";
	// Добавим фиктивный отбор
	ЭлементОтбора = Вариант.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.Использование = Ложь;
	ЭлементОтбора.ПравоеЗначение = "" + Процент1 + "," + Показатель + "," + Поле;
	
	Вариант = ПользовательскоеПоле.Варианты.Элементы.Добавить();
	Вариант.Значение = "ДоработкаТаблицы,ABCКлассификация,BКласс";
	Вариант.Представление = "B - Класс";
	// Добавим фиктивный отбор
	ЭлементОтбора = Вариант.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.Использование = Ложь;
	ЭлементОтбора.ПравоеЗначение = "" + Процент2 + "," + Показатель + "," + Поле;
	
	Вариант = ПользовательскоеПоле.Варианты.Элементы.Добавить();
	Вариант.Значение = "ДоработкаТаблицы,ABCКлассификация,СКласс";
	Вариант.Представление = "C - Класс";
	// Добавим фиктивный отбор
	ЭлементОтбора = Вариант.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.Использование = Ложь;
	ЭлементОтбора.ПравоеЗначение = "" + Процент3 + "," + Показатель + "," + Поле;
	
	Закрыть(КомпоновщикНастроек);
	
	
КонецПроцедуры

