
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Сертификат = Параметры.Сертификат;
	Свойства = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Сертификат,
		"ДанныеСертификата, УсиленнаяЗащитаЗакрытогоКлюча, Пользователь, Добавил, Программа");
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, Свойства);
	ДанныеСертификата = ДанныеСертификата.Получить();
	
	Если УсиленнаяЗащитаЗакрытогоКлюча Тогда
		Возврат;
	КонецЕсли;
	
	Если ОбщегоНазначения.ПодсистемаСуществует("ЭлектронноеВзаимодействие.ОбменСБанками") Тогда
		Запрос = Новый Запрос;
		Запрос.Текст =
			"ВЫБРАТЬ
			|	ПрограммыБанков.ПрограммаБанка
			|ИЗ
			|	РегистрСведений.СведенияОСертификатахОбменСБанками КАК ПрограммыБанков
			|ГДЕ
			|	ПрограммыБанков.СертификатЭП = &СертификатЭП";
		
		Запрос.УстановитьПараметр("СертификатЭП", Сертификат);
		УстановитьПривилегированныйРежим(Истина);
		Выборка = Запрос.Выполнить().Выбрать();
		УстановитьПривилегированныйРежим(Ложь);
		
		ПрограммаБанка = Неопределено;
		Пока Выборка.Следующий() Цикл
			ПрограммаБанка = Выборка.ПрограммаБанка;
		КонецЦикла;
	КонецЕсли;
	
	Если Не (ЗначениеЗаполнено(Программа) ИЛИ ЗначениеЗаполнено(ПрограммаБанка)) Тогда
		Возврат;
	КонецЕсли;
	
	ЕстьПравоЗаписиПароля = ЕстьПравоЗаписиПароля();
	
	УстановитьПривилегированныйРежим(Истина);
	Данные = КриптографияБЭДСлужебный.ДанныеПароляСертификата(Сертификат);
	УстановитьПривилегированныйРежим(Ложь);
	
	СохранятьДляВсех = Ложь;
	Если Параметры.Свойство("СохранятьДляВсех") Тогда
		СохранятьДляВсех = Параметры.СохранятьДляВсех;
	КонецЕсли;
	
	Если СохранятьДляВсех Тогда
		Пользователь = Справочники.Пользователи.ПустаяСсылка();
	Иначе
		Пользователь = Пользователи.ТекущийПользователь();
		Пароль = Данные.Получить(Пользователь);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Пароль) Тогда
		Пользователь = Справочники.Пользователи.ПустаяСсылка();
		Пароль = Данные.Получить(Пользователь);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Пароль) Тогда
		ПарольУстановлен = Истина;
		Пароль = "********";
	Иначе
		Если СохранятьДляВсех Тогда
			Пользователь = Справочники.Пользователи.ПустаяСсылка();
		Иначе
			Пользователь = Пользователи.ТекущийПользователь();
		КонецЕсли;
		ПарольУстановлен = Ложь;
	КонецЕсли;
	
	Элементы.ФормаУдалитьПароль.Доступность = ПарольУстановлен;
	УстановитьЗаголовокНадписиИПометкуКомандыДоступенВсем();
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	Если УсиленнаяЗащитаЗакрытогоКлюча Тогда
		ПоказатьПредупреждение(,
			НСтр("ru = 'У сертификата установлена усиленная защита закрытого ключа.
			           |В таком случае пароль запрашивает программа электронной подписи и шифрования,
			           |а программа 1С:Предприятия должна передать пустой пароль, чтобы не было ошибки.
			           |
			           |Запоминание и запись пароля невозможны.';
			           |en = 'Strong private key protection is set for the certificate.
			           |In such cases, application of digital signature and encryption requests a password,
			           |1C:Enterprise application should pass an empty password to avoid errors.
			           |
			           |Cannot remember or save the password.'"));
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если Не (ЗначениеЗаполнено(Программа) ИЛИ ЗначениеЗаполнено(ПрограммаБанка)) Тогда
		ПоказатьПредупреждение(,
			НСтр("ru = 'У сертификата не указана программа для закрытого ключа.
			           |Невозможно проверить пароль перед записью.';
			           |en = 'Application for a private key is not specified for the certificate.
			           |Cannot check the password before writing.'"));
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если Не ЕстьПравоЗаписиПароля Тогда
		ПоказатьПредупреждение(, ОписаниеОшибкиПраваДоступа(ПользовательСертификата, ДобавилСертификат));
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ПарольПриИзменении(Элемент)
	
	ПарольИзменен = Истина;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура УдалитьПароль(Команда)
	
	УдалитьПарольНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаписатьПароль(Команда)
	
	Если Не ЗначениеЗаполнено(Пароль) Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Поле ""Пароль"" не заполнено';
										|en = 'Password is not filled in'"));
		Возврат; 
	КонецЕсли;
	
	Если Не ПарольИзменен Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Введите пароль повторно.';
										|en = 'Enter the password again.'"));
		Возврат;
	КонецЕсли;
	
	ПроверитьПароль();
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаписатьПарольПослеПроверки(Результат, ОписаниеОшибки)
	
	Если Результат Тогда
		ЗаписатьПарольНаСервере();
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ОписаниеОшибки) Тогда
		ПоказатьПредупреждение(, СокрЛП(ОписаниеОшибки));
	КонецЕсли;
	
	Если Результат Тогда
		Оповестить("СохраненПарольСертификата", Сертификат);
		Закрыть();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПарольДоступенВсем(Команда)
	
	ПарольДоступенВсемНаСервере();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура УдалитьПарольНаСервере()
	
	УстановитьПривилегированныйРежим(Истина);
	
	КриптографияБЭДСлужебный.УдалитьПарольСертификата(Сертификат);
	
	УстановитьПривилегированныйРежим(Ложь);
	
	Элементы.ФормаУдалитьПароль.Доступность = Ложь;
	Пользователь = Пользователи.ТекущийПользователь();
	Пароль = "";
	ПарольИзменен = Ложь;
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьПароль()
	
	КонтекстДиагностики = ОбработкаНеисправностейБЭДКлиент.НовыйКонтекстДиагностики();
	ОписаниеОповещения = Новый ОписаниеОповещения("ЗакончитьПроверкуПодписания", ЭтотОбъект);
	ЭлектроннаяПодписьКлиент.УстановитьПарольСертификата(Сертификат, Пароль);
	ОписаниеДанных = Новый Структура;
	ОписаниеДанных.Вставить("Операция", НСтр("ru = 'Подписание для проверки пароля сертификата';
											|en = 'Sign for certificate password check'"));
	ОписаниеДанных.Вставить("ЗаголовокДанных", "");
	ОписаниеДанных.Вставить("Данные", ДанныеСертификата);
	ОписаниеДанных.Вставить("ОтборСертификатов", ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Сертификат));
	ОписаниеДанных.Вставить("БезПодтверждения", Истина);
	ОписаниеДанных.Вставить("ПрекратитьВыполнение", Истина);
	КриптографияБЭДКлиент.Подписать(ОписаниеДанных, КонтекстДиагностики, ЭтаФорма, ОписаниеОповещения);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗакончитьПроверкуПодписания(Результат, ДополнительныеПараметры) Экспорт
	
	Если Не Результат.Успех Тогда
		Если Результат.Свойство("ОписаниеОшибки") Тогда
			ТекстОшибки = СтрШаблон(НСтр("ru = 'Не удалось пройти проверку подписания с помощью программы %1 по причине:';
										|en = 'Cannot pass the signing check using application %1 due to:'"),
				Программа) + Символы.ПС + Результат.ОписаниеОшибки;
		Иначе
			ТекстОшибки = "";
		КонецЕсли;
		
		ЗаписатьПарольПослеПроверки(Ложь, ТекстОшибки);
	Иначе
		ЗаписатьПарольПослеПроверки(Истина, "");
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ЗаписатьПарольНаСервере()
	
	Если Не ЕстьПравоЗаписиПароля() Тогда
		ВызватьИсключение ОписаниеОшибкиПраваДоступа(ПользовательСертификата, ДобавилСертификат);
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	КриптографияБЭДСлужебный.ЗаписатьПарольСертификата(Сертификат, Пароль, Пользователь);
	
	Элементы.ФормаУдалитьПароль.Доступность = Истина;
	Пароль = "********";
	ПарольИзменен = Ложь;
	
	Возврат Истина;
	
КонецФункции

&НаСервере
Функция ЕстьПравоЗаписиПароля()
	
	Если Пользователи.ЭтоПолноправныйПользователь() Тогда
		Возврат Истина;
	КонецЕсли;
	
	// Проверка роли ДобавлениеИзменениеНастроекЭлектронногоВзаимодействия.
	Если Не ПравоДоступа("Изменение", Метаданные.РегистрыСведений.ПодписываемыеВидыЭД) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Свойства = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Сертификат, "Пользователь, Добавил");
	ПользовательСертификата = Свойства.Пользователь;
	ДобавилСертификат = Свойства.Добавил;
	Если Свойства.Добавил = Пользователи.ТекущийПользователь()
		Или Свойства.Пользователь = Пользователи.ТекущийПользователь() Тогда
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

&НаКлиентеНаСервереБезКонтекста
Функция ОписаниеОшибкиПраваДоступа(ПользовательСертификата, ДобавилСертификат)
	
	Шаблон = НСтр("ru = 'Недостаточно прав для записи пароля.
		           |
		           |Запись пароля могут сделать пользователи:
				   |%1,
				   |%2
				   |или администратор.';
				   |en = 'Insufficient right to save the password.
				   |
				   |Password can be saved by the following users:
				   |%1,
				   |%2
				   |or by administrator.'");
	Возврат СтрШаблон(Шаблон, ПользовательСертификата, ДобавилСертификат);
	
КонецФункции

&НаСервере
Процедура ПарольДоступенВсемНаСервере()
	
	Если Элементы.ПользователиПароляДоступенВсем.Пометка Тогда
		Пользователь = Пользователи.ТекущийПользователь();
	Иначе
		Пользователь = Справочники.Пользователи.ПустаяСсылка();
	КонецЕсли;
	
	УстановитьЗаголовокНадписиИПометкуКомандыДоступенВсем();
	
КонецПроцедуры

&НаСервере
Процедура УстановитьЗаголовокНадписиИПометкуКомандыДоступенВсем()
	
	Если ЗначениеЗаполнено(Пользователь) Тогда
		Элементы.НадписьДоступенПользователю.Заголовок = НСтр("ru = 'Пароль доступен пользователю:';
																|en = 'The password is available to user:'")
			+ " " + Пользователь;
	Иначе
		Элементы.НадписьДоступенПользователю.Заголовок = НСтр("ru = 'Пароль доступен всем пользователям.';
																|en = 'The password is available to all users.'")
	КонецЕсли;
	
	Элементы.ПользователиПароляДоступенВсем.Пометка = НЕ ЗначениеЗаполнено(Пользователь);
	
КонецПроцедуры

#КонецОбласти
