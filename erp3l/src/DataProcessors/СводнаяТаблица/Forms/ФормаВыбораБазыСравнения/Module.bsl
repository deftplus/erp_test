
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Элементы.Группа3.Видимость = Параметры.ВидОтчета.РазделениеПоПроектам;
	
	АдресТаблицИнтерфейса = Параметры.АдресТаблицИнтерфейса;
	
	ТаблицыИнтерфейса = ПолучитьИзВременногоХранилища(Параметры.АдресТаблицИнтерфейса);
	
	ТекущаяБаза = ТаблицыИнтерфейса.БазаДляОтклонений;
	
	ВидСравненияСценарий 	= "ТекущееЗначение";
	ВидСравненияОргЕдиница 	= "ТекущееЗначение";
	ВидСравненияПроект 		= "ТекущееЗначение";
	ВидСравненияПериод 		= "ТекущееЗначение";

	
	Для Каждого База  Из ТекущаяБаза Цикл
	
		Если НЕ База.Сценарии = "Значение источника" Тогда
			ВидСравненияСценарий = "Значение";
			Сценарий = База.Сценарии;
		КонецЕсли;	
		Если НЕ База.Организации = "Значение источника" Тогда
			ВидСравненияОргЕдиница = "Значение";
			ОрганизационнаяЕдиница = База.Организации;

		КонецЕсли;	
		Если НЕ База.Проекты = "Значение источника" Тогда
			ВидСравненияПроект = "Значение";
			Проект = База.Проекты;

		КонецЕсли;	
		Если  ТипЗнч(База.Периоды) = Тип("СправочникСсылка.Периоды") Тогда
			ВидСравненияПериод = "Значение";
			Период = База.Периоды;
		КонецЕсли;
		
		Если  СтрНайти(База.Периоды,"Сдвиг")>0 Тогда
			ВидСравненияПериод = "Сдвиг";
			СмещениеПоПериоду = Число(СтрЗаменить(База.Периоды, Нстр("ru = 'Сдвиг по периоду: '"), ""));
		КонецЕсли;

		
	КонецЦикла; 
	
	УстановитьВидимостьЭлементов();
		
КонецПроцедуры

&НаКлиенте
Процедура ВопросПередЗакрытиемЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = КодВозвратаДиалога.Да Тогда
		ПрименитьНаСервере();
		Закрыть(Истина);
	КонецЕсли;	
	
КонецПроцедуры

&НаКлиенте
Процедура КнопкаПрименить(Команда)

	
	Если Не ЕстьРасчетныеПоля() Тогда	
		ПрименитьНаСервере();
		Закрыть(Истина);
	Иначе	 
		Оповещение = Новый ОписаниеОповещения("ВопросПередЗакрытиемЗавершение",ЭтаФорма);
		ПоказатьВопрос(Оповещение, Нстр("ru = 'Расчетные колонки в таблице будут отключены, продолжить?'"), РежимДиалогаВопрос.ДаНет);
	КонецЕсли; 
		
	
КонецПроцедуры

Функция ЕстьРасчетныеПоля()

	  ТаблицыИнтерфейса = ПолучитьИзВременногоХранилища(АдресТаблицИнтерфейса);
	  ТабРасчетные = ТаблицыИнтерфейса.ДополнительныеПоля.Скопировать(Новый Структура("Использовать,Расчетный",Истина,Истина));
	  Возврат ТабРасчетные.Количество() > 0;
	  
 КонецФункции // ()
 


&НаКлиенте
Процедура ВидСравненияСценарийПриИзменении(Элемент)
	
	Элементы.Сценарий.Доступность = НЕ ВидСравненияСценарий = "ТекущееЗначение";
	
КонецПроцедуры

&НаКлиенте
Процедура ВидСравненияОргЕдиницаПриИзменении(Элемент)
	
	Элементы.ОрганизационнаяЕдиница.Доступность = НЕ ВидСравненияОргЕдиница = "ТекущееЗначение";
	
КонецПроцедуры

&НаКлиенте
Процедура ВидСравненияПроектПриИзменении(Элемент)
	
	Элементы.Проект.Доступность = НЕ ВидСравненияПроект = "ТекущееЗначение";

КонецПроцедуры

&НаКлиенте
Процедура ВидСравненияПериодПриИзменении(Элемент)
	
	Если ВидСравненияПериод = "ТекущееЗначение" Тогда
	
		Элементы.Период.Видимость = Истина;
		Элементы.Период.Доступность = Ложь;
		Элементы.СмещениеПоПериоду.Видимость = Ложь;
	
	ИначеЕсли ВидСравненияПериод = "Значение" Тогда
		
		Элементы.Период.Видимость = Истина;
		Элементы.Период.Доступность = Истина;
		Элементы.СмещениеПоПериоду.Видимость = Ложь;
	
	Иначе
	
		Элементы.Период.Видимость = Ложь;
		Элементы.СмещениеПоПериоду.Видимость = Истина;

	КонецЕсли; 
	
КонецПроцедуры

&НаСервере
Процедура ПрименитьНаСервере()
	
	ТаблицыИнтерфейса = ПолучитьИзВременногоХранилища(АдресТаблицИнтерфейса);
	ТекущаяБаза = ТаблицыИнтерфейса.БазаДляОтклонений;
	ТекущаяБаза.Очистить();
	
	Если ВидСравненияСценарий 		= "ТекущееЗначение" 
		И ВидСравненияОргЕдиница 	= "ТекущееЗначение" 
		И ВидСравненияПроект 		= "ТекущееЗначение"  
		И ВидСравненияПериод 		= "ТекущееЗначение"
		Тогда   Возврат;
		
	КонецЕсли; 
	
	ТаблицыИнтерфейса.БазаДляОтклонений  = ТаблицыИнтерфейса.ДополнительныеПоля.Скопировать(Новый Структура("Использовать,Расчетный",Истина,Ложь));
	
	Для каждого база Из ТаблицыИнтерфейса.БазаДляОтклонений  Цикл
		
		База.ИндексПоказателя = СтрЗаменить(Строка(Новый УникальныйИдентификатор()) ,"-","") ;
		База.КодПоказателя = База.ИндексПоказателя+"_"+База.КодПоказателя;
		
		Если ВидСравненияСценарий = "Значение"  Тогда
			База.Сценарии = Сценарий;
		КонецЕсли;	
		Если ВидСравненияОргЕдиница = "Значение"  Тогда
			База.Организации = ОрганизационнаяЕдиница;
		КонецЕсли;	
		Если ВидСравненияПроект = "Значение"  Тогда
			База.Проекты = Проект;
		КонецЕсли;	
		Если ВидСравненияПериод = "Значение"  Тогда
			База.Периоды = Период;
		ИначеЕсли ВидСравненияПериод = "Сдвиг" Тогда			
			База.Периоды = Нстр("ru = 'Сдвиг по периоду: '") + СмещениеПоПериоду;
		КонецЕсли;	
		
		База.Расчетный  = Истина;
		База.ВидОтклонения  = "АбсОтклонение";
	
	КонецЦикла; 

	// Если включено сравнение по базе - то расчетные поля не должны выводится
	Для каждого дПоле Из ТаблицыИнтерфейса.ДополнительныеПоля Цикл
	
		Если дПоле.Расчетный И дПоле.Использовать Тогда
		
			 дПоле.Использовать = Ложь;
		
		КонецЕсли; 
	
	КонецЦикла;  
	
КонецПроцедуры

&НаСервере
Процедура УстановитьВидимостьЭлементов()
	
	Элементы.Сценарий.Доступность = НЕ ВидСравненияСценарий = "ТекущееЗначение";
	Элементы.ОрганизационнаяЕдиница.Доступность = НЕ ВидСравненияОргЕдиница = "ТекущееЗначение";
    Элементы.Проект.Доступность = НЕ ВидСравненияПроект = "ТекущееЗначение";
	
	Если ВидСравненияПериод = "ТекущееЗначение" Тогда
	
		Элементы.Период.Видимость = Истина;
		Элементы.Период.Доступность = Ложь;
		Элементы.СмещениеПоПериоду.Видимость = Ложь;
	
	ИначеЕсли ВидСравненияПериод = "Значение" Тогда
		
		Элементы.Период.Видимость = Истина;
		Элементы.Период.Доступность = Истина;
		Элементы.СмещениеПоПериоду.Видимость = Ложь;
	
	Иначе
	
		Элементы.Период.Видимость = Ложь;
		Элементы.СмещениеПоПериоду.Видимость = Истина;

	КонецЕсли; 
	
КонецПроцедуры



