
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	ЗаполнитьДеревоСтрок();
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДеревоСтрок()
		
	
	ДеревоНастройкиСервер = Новый ДеревоЗначений;
	ДеревоНастройкиСервер.Колонки.Добавить("СтрокаВыбрана",ОбщегоНазначенияУХ.ПолучитьОписаниеТиповБулево());
	ДеревоНастройкиСервер.Колонки.Добавить("Строка");
		
	ЗапросКолонки = Новый Запрос;
	ЗапросКолонки.Текст= "ВЫБРАТЬ
	                     |	КолонкиОтчетов.Код КАК Код,
	                     |	КолонкиОтчетов.Представление КАК Представление,
	                     |	КолонкиОтчетов.Ссылка КАК Ссылка
	                     |ИЗ
	                     |	Справочник.КолонкиОтчетов КАК КолонкиОтчетов
	                     |ГДЕ
	                     |	КолонкиОтчетов.Владелец = &ВидОтчета
	                     |	И КолонкиОтчетов.ПометкаУдаления = ЛОЖЬ";
	
	ЗапросКолонки.УстановитьПараметр("ВидОтчета",ВидОтчета);
	Колонки = ЗапросКолонки.Выполнить().Выгрузить();
	
	Запрос=Новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	             |	СтрокиОтчетов.Ссылка КАК Ссылка,
	             |	СтрокиОтчетов.ГруппаРаскрытия КАК ГруппаРаскрытия,
	             |	СтрокиОтчетов.ПорядковыйНомер КАК ПорядковыйНомер
	             |ПОМЕСТИТЬ втМакетСтрок
	             |ИЗ
	             |	Справочник.СтрокиОтчетов КАК СтрокиОтчетов
	             |ГДЕ
	             |	СтрокиОтчетов.Владелец = &ВидОтчета
	             |	И СтрокиОтчетов.ПометкаУдаления = ЛОЖЬ
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	КолонкиОтчетов.Ссылка КАК Ссылка,
	             |	КолонкиОтчетов.ПорядковыйНомер КАК ПорядковыйНомер
	             |ПОМЕСТИТЬ втМакетКолонок
	             |ИЗ
	             |	Справочник.КолонкиОтчетов КАК КолонкиОтчетов
	             |ГДЕ
	             |	КолонкиОтчетов.Владелец = &ВидОтчета
	             |	И КолонкиОтчетов.ПометкаУдаления = ЛОЖЬ
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ПоказателиОтчетов.Ссылка КАК Ссылка,
	             |	ПоказателиОтчетов.Колонка КАК Колонка,
	             |	ПоказателиОтчетов.Строка КАК Строка
	             |ПОМЕСТИТЬ втПоказатели
	             |ИЗ
	             |	Справочник.ПоказателиОтчетов КАК ПоказателиОтчетов
	             |ГДЕ
	             |	ПоказателиОтчетов.Владелец = &ВидОтчета
	             |	И ПоказателиОтчетов.ПометкаУдаления = ЛОЖЬ
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	втМакетКолонок.Ссылка КАК КолонкаСсылка,
	             |	втМакетКолонок.ПорядковыйНомер КАК КолонкаПорядковыйНомер,
	             |	втМакетСтрок.Ссылка КАК СтрокаСсылка,
	             |	втМакетСтрок.ГруппаРаскрытия КАК ГруппаРаскрытия,
	             |	втМакетСтрок.ПорядковыйНомер КАК СтрокаКолонкаПорядковыйНомер
	             |ПОМЕСТИТЬ втМакет
	             |ИЗ
	             |	втМакетСтрок КАК втМакетСтрок
	             |		ЛЕВОЕ СОЕДИНЕНИЕ втМакетКолонок КАК втМакетКолонок
	             |		ПО (ИСТИНА)
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	втМакет.КолонкаСсылка КАК КолонкаСсылка,
	             |	втМакет.КолонкаПорядковыйНомер КАК КолонкаПорядковыйНомер,
	             |	втМакет.СтрокаСсылка КАК СтрокаСсылка,
	             |	втМакет.ГруппаРаскрытия КАК ГруппаРаскрытия,
	             |	втМакет.СтрокаКолонкаПорядковыйНомер КАК СтрокаКолонкаПорядковыйНомер,
	             |	втПоказатели.Ссылка КАК Ссылка
	             |ПОМЕСТИТЬ втМакетСКолонками
	             |ИЗ
	             |	втМакет КАК втМакет
	             |		ЛЕВОЕ СОЕДИНЕНИЕ втПоказатели КАК втПоказатели
	             |		ПО втМакет.СтрокаСсылка = втПоказатели.Строка
	             |			И втМакет.КолонкаСсылка = втПоказатели.Колонка
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
				 |	ЛОЖЬ КАК СтрокаВыбрана,
				 |	СтрокиОтчетов.Ссылка КАК Строка,
	             |	СтрокиОтчетов.ГруппаРаскрытия КАК ГруппаРаскрытия,
	             |	СтрокиОтчетов.ПорядковыйНомер КАК ПорядковыйНомер,
	             |	СтрокиОтчетов.Родитель КАК Родитель
				 |ИЗ
	             |	втМакетСКолонками КАК втМакетСКолонками
	             |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СтрокиОтчетов КАК СтрокиОтчетов
	             |		ПО втМакетСКолонками.СтрокаСсылка = СтрокиОтчетов.Ссылка
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	СтрокиОтчетов.Ссылка,
	             |	СтрокиОтчетов.ГруппаРаскрытия,
	             |	СтрокиОтчетов.ПорядковыйНомер,
	             |	СтрокиОтчетов.Родитель
	             |
	             |УПОРЯДОЧИТЬ ПО
	             |	СтрокиОтчетов.ПорядковыйНомер ИЕРАРХИЯ";

	
	СхемаЗапроса = Новый СхемаЗапроса;
	СхемаЗапроса.УстановитьТекстЗапроса(Запрос.Текст);
	
	Для Каждого СтрКолонка Из Колонки Цикл
		Нполе = СхемаЗапроса.ПакетЗапросов[4].Операторы[0].ВыбираемыеПоля.Добавить("ВЫБОР КОГДА ВтМакет.КолонкаСсылка = &Парам_"+СокрЛП(СтрКолонка.Код)+
		" ТОГДА ЛОЖЬ ИНАЧЕ ""Х"" КОНЕЦ ");
		Запрос.УстановитьПараметр("Парам_"+СокрЛП(СтрКолонка.Код),СтрКолонка.Ссылка);
		СхемаЗапроса.ПакетЗапросов[4].Колонки[СхемаЗапроса.ПакетЗапросов[4].Колонки.Количество()-1].Псевдоним = СокрЛП(СтрКолонка.Код);
		
		Нполе = СхемаЗапроса.ПакетЗапросов[5].Операторы[0].ВыбираемыеПоля.Добавить("МАКСИМУМ("+СокрЛП(СтрКолонка.Код)+") ");
		СхемаЗапроса.ПакетЗапросов[5].Колонки[СхемаЗапроса.ПакетЗапросов[5].Колонки.Количество()-1].Псевдоним = СокрЛП(СтрКолонка.Код);
		
		ДеревоНастройкиСервер.Колонки.Добавить(СокрЛП(СтрКолонка.Код),ОбщегоНазначенияУХ.ПолучитьОписаниеТиповБулево());

		
	КонецЦикла;	
	
	Запрос.Текст =  СхемаЗапроса.ПолучитьТекстЗапроса();
	
	Запрос.УстановитьПараметр("ВидОтчета",ВидОтчета);
				
	Результат=Запрос.Выполнить().Выбрать();
	
	ДеревоНастройкиСервер_Строки = ДеревоНастройкиСервер.Строки.Добавить();
	ДеревоНастройкиСервер_Строки.Строка = Нстр("ru = 'Выбранные строки'");
	
	ВыводимаяСтрокаОтчета=Справочники.СтрокиОтчетов.ПустаяСсылка();
	
	СоответствиеСтрок=Новый Соответствие;
	СоответствиеРодителей=Новый Соответствие;

	
	Пока Результат.Следующий() Цикл
		
		Если Результат.Строка<>ВыводимаяСтрокаОтчета Тогда
			
			ТекущаяСтрокаДерева=СоответствиеСтрок[Результат.Строка];
			
			Если ТекущаяСтрокаДерева=Неопределено Тогда
				
				Если Результат.Родитель=Справочники.СтрокиОтчетов.ПустаяСсылка() Тогда
					
					ТекущаяСтрокаДерева=ДеревоНастройкиСервер_Строки.Строки.Добавить();
					
				Иначе
					
					СтрокаРодитель=СоответствиеРодителей[Результат.Родитель];
					
					Если СтрокаРодитель=Неопределено Тогда
												
						СтрокаРодитель=ДеревоНастройкиСервер.Строки.Найти(Результат.Родитель,"Строка",Истина);
						СоответствиеРодителей.Вставить(Результат.Родитель,СтрокаРодитель);
						
					КонецЕсли;
					
					ТекущаяСтрокаДерева=СтрокаРодитель.Строки.Добавить();
					
				КонецЕсли;
				
				ЗаполнитьЗначенияСвойств(ТекущаяСтрокаДерева,Результат);
				СоответствиеСтрок.Вставить(Результат.Строка,ТекущаяСтрокаДерева);
				
			КонецЕсли;
			
			ВыводимаяСтрокаОтчета=Результат.Строка;
			
		КонецЕсли;
		
	КонецЦикла;

	РеквизитыКДобавлению=Новый Массив;
	РеквизитыКУдалению=Новый Массив;
	
	РеквизитыКУдалению=Новый Массив;
   	Для Каждого Реквизит Из ПолучитьРеквизиты("ДеревоСтрок") Цикл
		РеквизитыКУдалению.Добавить(Реквизит.Путь + "." + Реквизит.Имя);
	КонецЦикла; 
	
	Для Каждого Колонка ИЗ ДеревоНастройкиСервер.Колонки Цикл	
		МассивДоступныхТипов = Новый Массив;                                                 
		РеквизитыКДобавлению.Добавить(Новый РеквизитФормы(Колонка.Имя,
		Новый ОписаниеТипов(Колонка.ТипЗначения.Типы()),
		"ДеревоСтрок",
		Колонка.Заголовок,
		Ложь));	
	КонецЦикла;
	
	ИзменитьРеквизиты(РеквизитыКДобавлению,РеквизитыКУдалению);
	
	ЗначениеВРеквизитФормы(ДеревоНастройкиСервер,"ДеревоСтрок");
	
	УдаляемыеЭлементы = Новый Массив;
	Для Каждого Эл Из  Элементы.ДеревоСтрок.ПодчиненныеЭлементы Цикл
		УдаляемыеЭлементы.Добавить(Эл);
	КонецЦикла;
	
	Для Каждого уЭлемент Из УдаляемыеЭлементы Цикл
		ЭтаФорма.Элементы.Удалить(уЭлемент);
	КонецЦикла;	
	
	Для Каждого Колонка ИЗ ДеревоНастройкиСервер.Колонки Цикл	
		
		ЭтаФорма.Элементы.Добавить(Колонка.Имя,Тип("ПолеФормы"),ЭтаФорма.Элементы.ДеревоСтрок);	
		ЭтаФорма.Элементы[Колонка.Имя].ПутьКДанным		= "ДеревоСтрок."+Колонка.Имя;
		Если Колонка.Имя = "Строка" Тогда
			ЭтаФорма.Элементы[Колонка.Имя].Вид				= ВидПоляФормы.ПолеВвода;						
			ЭтаФорма.Элементы[Колонка.Имя].ВыбиратьТип		= Ложь;
			ЭтаФорма.Элементы[Колонка.Имя].КнопкаВыбора		= Ложь;
			ЭтаФорма.Элементы[Колонка.Имя].КнопкаОчистки	= Ложь;
			
		Иначе
			ЭтаФорма.Элементы[Колонка.Имя].Вид				= ВидПоляФормы.ПолеФлажка;
		КонецЕсли;
		
		Если Колонка.Имя = "СтрокаВыбрана" Тогда
			ЭтаФорма.Элементы[Колонка.Имя].Заголовок = " ";
		КонецЕсли;
		
	КонецЦикла;
		
КонецПроцедуры // ЗаполнитьДеревоСтрок()

&НаКлиенте
Процедура ВидОтчетаПриИзменении(Элемент)
	ЗаполнитьДеревоСтрок();
КонецПроцедуры
