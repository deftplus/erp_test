
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	МассивПротоколируемыхОбъектов = МассивПротоколируемыхОбъектов(ПараметрКоманды);
	
	Если МассивПротоколируемыхОбъектов = Неопределено Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Протокол не найден!'"), 5);
	Иначе
		ОткрытьФорму("Обработка.ОтображениеПротоколируемыхСобытий.Форма.Форма", Новый Структура("МассивПротоколируемыхОбъектов", МассивПротоколируемыхОбъектов));
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция МассивПротоколируемыхОбъектов(СсылкаНаДокумент)
	
	Попытка
		Реквизиты = ОбщегоНазначенияУХ.ПолучитьЗначенияРеквизитов(СсылкаНаДокумент, "УникальныйИдентификаторПравилаИмпорта,Дата,Организация,Сценарий");
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
	ПравилоИмпорта = Справочники.ПравилаИмпортаТаблиц.ПолучитьСсылку(Новый УникальныйИдентификатор(Реквизиты.УникальныйИдентификаторПравилаИмпорта));
	
	Если ПравилоИмпорта = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если ПравилоИмпорта.Пустая() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если ПравилоИмпорта.ПолучитьОбъект() = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ПравилоИмпортаТаблицы", ПравилоИмпорта);
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ПакетыПравилИмпортаТаблицПорядокИмпортаТаблиц.Ссылка
	|ИЗ
	|	Справочник.ПакетыПравилИмпортаТаблиц.ПорядокИмпортаТаблиц КАК ПакетыПравилИмпортаТаблицПорядокИмпортаТаблиц
	|ГДЕ
	|	ПакетыПравилИмпортаТаблицПорядокИмпортаТаблиц.ПравилоИмпортаТаблицы = &ПравилоИмпортаТаблицы";
	
	Рез = Запрос.Выполнить().Выгрузить();
	
	Если НЕ Рез.Количество() = 1 Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Массив = Новый Массив;
	Массив.Добавить(Рез[0].Ссылка);
	
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(Реквизиты.Дата));
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Периоды.Ссылка
	|ИЗ
	|	Справочник.Периоды КАК Периоды
	|ГДЕ
	|	КОНЕЦПЕРИОДА(Периоды.ДатаОкончания, ДЕНЬ) = &ДатаОкончания";
	
	Результат = Новый Массив;
	
	Структура = Новый Структура;
	Структура.Вставить("Организация", Реквизиты.Организация);
	Структура.Вставить("Сценарий", Реквизиты.Сценарий);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		
		Структура.Вставить("ПериодОтчета", Выборка.Ссылка);
		
		Для Каждого Об Из ПротоколируемыеСобытияУХ.ПолучитьМассивПротоколируемыхОбъектов(Массив, Структура) Цикл
			Результат.Добавить(Об);
		КонецЦикла; 
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции