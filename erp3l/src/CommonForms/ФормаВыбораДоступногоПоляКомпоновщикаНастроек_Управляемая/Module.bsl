
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Параметры.Свойство("РодителиПоля", РодителиПоля);
	
	Параметры.Свойство("Режим", Режим);
	Параметры.Свойство("КомпоновщикНастроек", КомпоновщикНастроек);
	
	ФиктивнаяСтрокаГруппировка = КомпоновщикНастроек.Настройки.Структура.Добавить(Тип("ГруппировкаКомпоновкиДанных"));
	Элементы.КомпоновщикНастроекНастройки.ТекущаяСтрока = КомпоновщикНастроек.Настройки.ПолучитьИдентификаторПоОбъекту(ФиктивнаяСтрокаГруппировка);
	
	Если Режим = "Отбор" Тогда
		Элементы.ОсновнаяПанель.ТекущаяСтраница = Элементы.Страница_Отбор;
		Заголовок = "Выбор поля отбора";
	ИначеЕсли Режим = "Дата" Тогда
		Элементы.ОсновнаяПанель.ТекущаяСтраница = Элементы.Страница_Группировка;
		Заголовок = "Выбор поля (дата)";
		Поле = Новый ПолеКомпоновкиДанных("UserFields");
		Ограничение = Элементы.Выбор.ОграниченияИспользования.Добавить();
		Ограничение.Доступность = Ложь;
		Ограничение.Поле = Поле;
	ИначеЕсли Режим = "ЧислоИСтрока" Тогда
		Элементы.ОсновнаяПанель.ТекущаяСтраница = Элементы.Страница_Выбор;
		Заголовок = "Выбор поля (строка или число)";
		Поле = Новый ПолеКомпоновкиДанных("UserFields");
		Ограничение = Элементы.Выбор.ОграниченияИспользования.Добавить();
		Ограничение.Доступность = Ложь;
		Ограничение.Поле = Поле;
	ИначеЕсли Режим = "Все" Тогда
		Элементы.ОсновнаяПанель.ТекущаяСтраница = Элементы.Страница_Выбор;
		Заголовок = "Выбор поля";
		Поле = Новый ПолеКомпоновкиДанных("UserFields");
		Ограничение = Элементы.Выбор.ОграниченияИспользования.Добавить();
		Ограничение.Доступность = Ложь;
		Ограничение.Поле = Поле;
	ИначеЕсли РодителиПоля <> Неопределено Тогда
		Для каждого РодительскоеПоле Из РодителиПоля Цикл
			Поле = Новый ПолеКомпоновкиДанных(РодительскоеПоле.Поле);
			Ограничение = Элементы.ПоляГруппировки.ОграниченияИспользования.Добавить();
			Ограничение.Доступность = Ложь;
			Ограничение.Поле = Поле;
		КонецЦикла;
		
		Элементы.ОсновнаяПанель.ТекущаяСтраница = Элементы.Страница_Группировка;
	Иначе
		
		Элементы.ОсновнаяПанель.ТекущаяСтраница = Элементы.Страница_Группировка;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВыборВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	СтандартнаяОбработка = НЕ ВыборПоля();
КонецПроцедуры


&НаКлиенте
Функция ВыборПоля()
	
	Если Режим = "Отбор" Тогда
		ТекущиеДанные = КомпоновщикНастроек.Настройки.Отбор.ДоступныеПоляОтбора.ПолучитьОбъектПоИдентификатору(Элементы.Отбор.ТекущаяСтрока);
	ИначеЕсли Режим = "ЧислоИСтрока" ИЛИ Режим = "Все" Тогда
		ТекущиеДанные = КомпоновщикНастроек.Настройки.ПолучитьОБъектПоИдентификатору(Элементы.КомпоновщикНастроекНастройки.ТекущаяСтрока).Выбор.ДоступныеПоляВыбора.ПолучитьОбъектПоИдентификатору(Элементы.Выбор.ТекущаяСтрока);
	ИначеЕсли Режим = "Дата" Тогда
		ТекущиеДанные = КомпоновщикНастроек.Настройки.ПолучитьОБъектПоИдентификатору(Элементы.КомпоновщикНастроекНастройки.ТекущаяСтрока).ПоляГруппировки.ДоступныеПоляПолейГруппировок.ПолучитьОбъектПоИдентификатору(Элементы.Группировка.ТекущаяСтрока);
	Иначе
		ТекущиеДанные = КомпоновщикНастроек.Настройки.ПолучитьОБъектПоИдентификатору(Элементы.КомпоновщикНастроекНастройки.ТекущаяСтрока).ПоляГруппировки.ДоступныеПоляПолейГруппировок.ПолучитьОбъектПоИдентификатору(Элементы.Группировка.ТекущаяСтрока);
	КонецЕсли;
	
	Если ТекущиеДанные = Неопределено ИЛИ ТекущиеДанные.Папка Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если Режим = "ЧислоИСтрока" ИЛИ Режим = "Дата" Тогда
		ТипЗначенияПоля = КомпоновщикНастроек.Настройки.ДоступныеПоляВыбора.НайтиПоле(Новый ПолеКомпоновкиДанных(ТекущиеДанные.Поле)).Тип;
		Если Режим = "ЧислоИСтрока" Тогда
			Если ТипЗначенияПоля.Типы().Найти(Тип("Строка")) <> Неопределено ИЛИ ТипЗначенияПоля.Типы().Найти(Тип("Число")) <> Неопределено Тогда
				Закрыть(Строка(ТекущиеДанные.Поле));
			КонецЕсли;
		ИначеЕсли Режим = "Дата" Тогда
			Если ТипЗначенияПоля.Типы().Найти(Тип("Дата")) <> Неопределено Тогда
				Закрыть(Строка(ТекущиеДанные.Поле));
			КонецЕсли;
		КонецЕсли;
	Иначе
		Закрыть(Строка(ТекущиеДанные.Поле));
	КонецЕсли;
	Возврат Истина;

КонецФункции

&НаКлиенте
Процедура ГруппировкаВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	СтандартнаяОбработка = НЕ ВыборПоля();
	
КонецПроцедуры
