&НаКлиенте
Перем глИзмененияСохранены;

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	СтрокаДляРедактирования = ЭтаФОрма.Параметры.Ключ;
	//СтрокаДляРедактирования = стрЗаменить(СтрокаДляРедактирования,";",";"+Символы.ПС);
	СтрокаДляРедактирования=стрЗаменить(СтрокаДляРедактирования,Символы.Таб," ");
	СтрокаДляРедактирования=стрЗаменить(СтрокаДляРедактирования,";","; ");
	СтрокаДляРедактирования = СокрЛП(СтрокаДляРедактирования);
	СтрокиКода = СтрРазделить(СтрокаДляРедактирования, " ", Ложь);
	СтрокаКода = "";
	Для Каждого Слово Из СтрокиКода Цикл
		Если Найти("если иначеесли тогда конецесли; для пока цикл конеццикла;", НРег(Слово)) > 0 Тогда
			Слово = ТРег(Слово);
			Слово = СтрЗаменить(Слово, "Конецесли", "КонецЕсли");
			Слово = СтрЗаменить(Слово, "Конеццикла", "КонецЦикла");
		КонецЕсли;
		СтрокаКода = СтрокаКода + " " + Слово;
	КонецЦикла;

	СтрокаКода=стрЗаменить(СтрокаКода,";",";"+Символы.ПС);
	СтрокаКода=стрЗаменить(СтрокаКода,"Тогда","Тогда"+Символы.ПС);
	СтрокаКода=стрЗаменить(СтрокаКода,"Иначе ","Иначе"+Символы.ПС);
	СтрокаКода=стрЗаменить(СтрокаКода,"Цикл ","Цикл"+Символы.ПС);
	МассивСтрок = СтрРазделить(СтрокаКода, Символы.ПС, Ложь);
	ТекстОбработчика = "";
	Отступ = 0;
	ОткрытоКавычек = 0;
	Для Каждого ТекСтр Из МассивСтрок Цикл
		ОчереднаяСтрока = СокрЛП(ТекСтр);
		Если СтрНачинаетсяС(ОчереднаяСтрока, "КонецЕсли")
			ИЛИ СтрНачинаетсяС(ОчереднаяСтрока, "Иначе")
			ИЛИ СтрНачинаетсяС(ОчереднаяСтрока, "КонецЦикла")
			Тогда
			Отступ = Отступ - 1;
		КонецЕсли;
		Для Сч = 0 По Отступ - 1 Цикл
			ОчереднаяСтрока = Символы.Таб + ОчереднаяСтрока;
		КонецЦикла;
		ТекстОбработчика = ТекстОбработчика + ОчереднаяСтрока + Символы.ПС;
		ОчереднаяСтрока = СокрЛП(ОчереднаяСтрока);
		Если СтрНачинаетсяС(ОчереднаяСтрока, "Если")
			ИЛИ СтрНачинаетсяС(ОчереднаяСтрока, "Иначе")
			ИЛИ СтрНачинаетсяС(ОчереднаяСтрока, "Для ")
			ИЛИ СтрНачинаетсяС(ОчереднаяСтрока, "Пока ")
			Тогда
			Отступ = Отступ + 1;
		КонецЕсли;
	КонецЦикла;
	//
	ЭтаФОрма.РедактируемоеЗначение = ТекстОбработчика;
	
	стр = ЭтаФорма.ИспользуемыеПеременныеИПодстановки.Добавить();
	стр.Наименование = "ВозвращаемаяСсылка";
	стр.Описание = "В результате выполнения процедуры поиска соответствия или заполнения в эту переменную должны помещаться вычисленные объекты, реквизит которых будет заполняться далее";
	
	стр = ЭтаФорма.ИспользуемыеПеременныеИПодстановки.Добавить();
	стр.Наименование = "ОбрабатываемыйОбъект";
	стр.Описание = "Переменная, в которую до начала выполнения процедур будет передан объект, над реквизитами которого осуществляются дальнейшие действия";
	
	стр = ЭтаФорма.ИспользуемыеПеременныеИПодстановки.Добавить();
	стр.Наименование = "ПОДСТАНОВКАИМЕНИСВОЙСТВА";
	стр.Описание = "При выполнении кода этот фрагмент кода будет заменен на имя метаданных из настройки соответствия реквизитов";
	
	стр = ЭтаФорма.ИспользуемыеПеременныеИПодстановки.Добавить();
	стр.Наименование = "ПОДСТАНОВКАПАРАМЕТРАЗНАЧЕНИЯ";
	стр.Описание = "В этой переменной находится значение, прочитанное из JSON";
	
	стр = ЭтаФорма.ИспользуемыеПеременныеИПодстановки.Добавить();
	стр.Наименование = "СтруктураШапки";
	стр.Описание = "Это структура шапки объекта, прочитанная из JSON";
	
	стр = ЭтаФорма.ИспользуемыеПеременныеИПодстановки.Добавить();
	стр.Наименование = "СтруктураСтрокиТабЧасти";
	стр.Описание = "(только для обработки строк табличной части). Структура строки таб части, прочитанная из JSON";
	
	стр = ЭтаФорма.ИспользуемыеПеременныеИПодстановки.Добавить();
	стр.Наименование = "СтруктураРаспознанныхЗначений";
	стр.Описание = "Полный пакет данных, прочитанный из JSON. 
		| СтруктураРаспознанныхЗначений.head - заголовок пакета, 
		| СтруктураРаспознанныхЗначений.caption - шапка объекта (справочника/документа),
		| СтруктураРаспознанныхЗначений.detal - табличная часть (справочника/документа).";
	
	стр = ЭтаФорма.ИспользуемыеПеременныеИПодстановки.Добавить();
	стр.Наименование = "УсловиеВыполнено";
	стр.Описание = "Если проверяется какое-то условие, в эту переменную поместить результат проверки";
	
	стр = ЭтаФорма.ИспользуемыеПеременныеИПодстановки.Добавить();
	стр.Наименование = "ГоловнойОбъект";
	стр.Описание = "(только для обработки строк табличной части). Объект, которому принадлежит заполняемая табличная часть";
	
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии(ЗавершениеРаботы)
	
	Если Модифицированность Тогда
		ЭтаФОрма.ОписаниеОповещенияОЗакрытии.ДополнительныеПараметры.РезультатЗакрытия  =  ЭтаФОрма.РедактируемоеЗначение;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ФорматироватьЗначение()
	
	РедактируемоеЗначение  =  ЭтаФорма.РедактируемоеЗначение;
	
	РедактируемоеЗначение  =  СтрЗаменить(РедактируемоеЗначение,Символы.ПС," ");
	РедактируемоеЗначение  =  СтрЗаменить(РедактируемоеЗначение,"|"," ");
	
	ЭтаФорма.РедактируемоеЗначение  =  РедактируемоеЗначение;
	
КонецПроцедуры


&НаСервере
Процедура ПередЗакрытиемНаСервере(СтрокаОшибок)
	
	ФорматироватьЗначение();
	
	ПроверяемаяСтрока = вРЕГ(ЭтаФорма.РедактируемоеЗначение);
	
	ПРОВЕРЯЕМАЯСТРОКА = СТРзАМЕНИТЬ(ПРОВЕРЯЕМАЯСТРОКА,"КОНЕЦЕСЛИ","КОНЕЦЪЪЪЪ");
	ПРОВЕРЯЕМАЯСТРОКА = СТРзАМЕНИТЬ(ПРОВЕРЯЕМАЯСТРОКА,"ИНАЧЕЕСЛИ","ЁЁЁЁ");
	ПРОВЕРЯЕМАЯСТРОКА = СТРзАМЕНИТЬ(ПРОВЕРЯЕМАЯСТРОКА,"ЕСЛИ","ЫЫЫЫ");
	
	
	КоличествоЕсли =  СтрЧислоВхождений(ПРОВЕРЯЕМАЯСТРОКА,"ЫЫЫЫ");
	КоличествоКонецЕсли = СтрЧислоВхождений(ПРОВЕРЯЕМАЯСТРОКА,"КОНЕЦЪЪЪЪ");
	
	КОЛИЧЕСТВОЦИКЛ = СтрЧислоВхождений(ПРОВЕРЯЕМАЯСТРОКА," ЦИКЛ");
	КОЛИЧЕСТВОКонецЦикла = СтрЧислоВхождений(ПРОВЕРЯЕМАЯСТРОКА,"КОНЕЦЦИКЛА");
	
	КоличествоОткрывающихСкобок = СтрЧислоВхождений(ЭтаФорма.РедактируемоеЗначение,"(");
	КоличествоЗакрывающихСкобок = СтрЧислоВхождений(ЭтаФорма.РедактируемоеЗначение,")");
	
	Если КоличествоЕсли>КоличествоКонецЕсли тогда
		СтрокаОшибок = СтрокаОшибок+"Количество слов ""если"" выше, чем слов ""конецесли"""+Символы.ПС;
	КонецЕсли;
	
	Если КоличествоЕсли<КоличествоКонецЕсли тогда
		СтрокаОшибок = СтрокаОшибок+"Количество слов ""если"" меньше, чем слов ""конецесли"""+Символы.ПС;
	КонецЕсли;
	
	Если КоличествоЦикл>КоличествоКонецЦикла тогда
		СтрокаОшибок = СтрокаОшибок+"Количество слов ""цикл"" выше, чем слов ""конеццикла"""+Символы.ПС;
	КонецЕсли;
	
	Если КоличествоЦикл<КоличествоКонецЦикла тогда
		СтрокаОшибок = СтрокаОшибок+"Количество слов ""цикл"" меньше, чем слов ""конеццикла"""+Символы.ПС;
	КонецЕсли;
	
	Если КоличествоОткрывающихСкобок>КоличествоЗакрывающихСкобок тогда
		СтрокаОшибок = СтрокаОшибок+"Количество открывающих скобок выше, чем закрывающих"+Символы.ПС;
	КонецЕсли;
	
	Если КоличествоОткрывающихСкобок<КоличествоЗакрывающихСкобок тогда
		СтрокаОшибок = СтрокаОшибок+"Количество открывающих скобок ниже, чем закрывающих"+Символы.ПС;
	КонецЕсли;
	
	Если стрНайти(ПроверяемаяСтрока,"ВОЗВРАТ;")+стрНайти(ПроверяемаяСтрока,"ВОЗВРАТ(")>0 тогда
		СтрокаОшибок = СтрокаОшибок+"Использование оператора ""возврат"" в этом месте недопустимо"+Символы.ПС;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьОтвет(Результат, ДопПараметры) Экспорт
	
	Если Результат <> КодВозвратаДиалога.Нет Тогда
		Модифицированность = Ложь;
		Закрыть();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, ЗавершениеРаботы, ТекстПредупреждения, СтандартнаяОбработка)    
	
	Если Модифицированность Тогда
		Если глИзмененияСохранены <> Истина Тогда
			Отказ = Истина;
			ОписаниеОповещения = Новый ОписаниеОповещения("ОбработатьОтвет", ЭтотОбъект);
			ТекстВопроса = "Внесённые изменения будут потеряны.
							|Продолжить?";
			ПоказатьВопрос(ОписаниеОповещения, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
		Иначе
			СтрокаОшибок = "";
			ПередЗакрытиемНаСервере(СтрокаОшибок);
			Если ЗначениеЗаполнено(СтрокаОшибок) тогда
				Отказ = истина;
				ТекстПредупреждения = СтрокаОшибок;
				Сообщить(ТекстПредупреждения);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура РедактируемоеЗначениеПриИзменении(Элемент)
	
	Модифицированность = Истина;
	
КонецПроцедуры

&НаКлиенте
Процедура Готово(Команда)
	
	глИзмененияСохранены = Истина;
	Закрыть(Модифицированность);
	
КонецПроцедуры
