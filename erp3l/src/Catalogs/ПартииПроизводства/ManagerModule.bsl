#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Соответствие со списком реквизитов, по которым определяется уникальность ключа
// 
// Возвращаемое значение:
//   Соответствие - ключ - имя реквизита 
//
Функция КлючевыеРеквизиты() Экспорт
	
	Результат = Новый Соответствие;
	Результат.Вставить("Код");
	Результат.Вставить("Документ");
	
	Возврат Результат;
	
КонецФункции

// Возвращает партию производства с полями, соответствующими указанным.
//
// Параметры:
//	ПоляПартии - Структура, СтрокаТаблицыЗначений - поля партии производства.
//		Обязательными для заполнения полями выступают "Документ", "Организация", "Номенклатура",
//		остальные поля являются необязательными и в случае отсутствия будут заполнены пустыми значениями.
//	ПроверятьПередСозданием	- Булево - флаг необходимости поиска партии производства перед созданием новой.
//	ОбновлятьСуществующие	- Булево - флаг необходимости обновления полей существующих партий производства.
//
// Возвращаемое значение:
//	СправочникСсылка.ПартииПроизводства - найденная или сформированная партия производства.
//
Функция ПолучитьПартиюПроизводства(ПоляПартии = Неопределено,
								ПроверятьПередСозданием = Истина,
								ОбновлятьСуществующие = Ложь) Экспорт
	
	КодОсновногоЯзыка = ОбщегоНазначения.КодОсновногоЯзыка();
	
	// Заполним все реквизиты партии производства.
	СтруктураРеквизитовПартии = Новый Структура("Код, Документ, Ссылка", 0, Неопределено, Неопределено);
	ЗаполнитьЗначенияСвойств(СтруктураРеквизитовПартии, ПоляПартии);
	
	Для Каждого МетаРеквизит Из Метаданные.Справочники.ПартииПроизводства.Реквизиты Цикл
		
		СтруктураРеквизита = Новый Структура(МетаРеквизит.Имя);
		ЗаполнитьЗначенияСвойств(СтруктураРеквизита, ПоляПартии); // в ПоляПартии такого свойства может и не быть
		
		СтруктураРеквизитовПартии.Вставить(
			МетаРеквизит.Имя,
			МетаРеквизит.Тип.ПривестиЗначение(СтруктураРеквизита[МетаРеквизит.Имя])); // а в СтруктураРеквизита такое свойство точно есть
		
	КонецЦикла;
	
	НачатьТранзакцию();
	
	Попытка
		
		Блокировка = Новый БлокировкаДанных;
		ЭлементБлокировки = Блокировка.Добавить("Справочник.ПартииПроизводства");
		ЭлементБлокировки.УстановитьЗначение("Код", СтруктураРеквизитовПартии.Код);
		ЭлементБлокировки.УстановитьЗначение("Документ", СтруктураРеквизитовПартии.Документ);
		ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
		
		Блокировка.Заблокировать();
		
		// Если необходимо - попытаемся найти подходящую партию.
		ДанныеПартии = Новый Структура;
		ДанныеПартии.Вставить("ПартияПроизводства", Справочники.ПартииПроизводства.ПустаяСсылка());
		
		Если ПроверятьПередСозданием Тогда
			СтруктураОтбора = Новый Структура(ПоляИдентификацииПартииПроизводства());
			ЗаполнитьЗначенияСвойств(СтруктураОтбора, СтруктураРеквизитовПартии);
			
			Запрос = Новый Запрос;
			Запрос.Текст =
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	Таблица.Ссылка КАК ПартияПроизводства
			|ИЗ
			|	Справочник.ПартииПроизводства КАК Таблица
			|ГДЕ
			|	НЕ Таблица.ПометкаУдаления
			|	И &УсловиеЗапроса
			|";
			
			УсловиеЗапроса = "ИСТИНА";
			
			Для Каждого КлючИЗначение Из СтруктураОтбора Цикл
				
				Запрос.УстановитьПараметр(КлючИЗначение.Ключ, КлючИЗначение.Значение);
				УсловиеЗапроса = УсловиеЗапроса + "
					|	И Таблица." + КлючИЗначение.Ключ + " = &" + КлючИЗначение.Ключ;
				
			КонецЦикла;
			
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеЗапроса", УсловиеЗапроса);
			
			УстановитьПривилегированныйРежим(Истина);
			Выборка = Запрос.Выполнить().Выбрать();
			УстановитьПривилегированныйРежим(Ложь);
			
			Если Выборка.Следующий() Тогда
				ЗаполнитьЗначенияСвойств(ДанныеПартии, Выборка);
			КонецЕсли;
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(ДанныеПартии.ПартияПроизводства)
			ИЛИ ОбновлятьСуществующие Тогда
			
			УстановитьПривилегированныйРежим(Истина);
			Если НЕ ЗначениеЗаполнено(ДанныеПартии.ПартияПроизводства) Тогда
				
				// Партии производства нет в справочнике - создадим элемент справочника.
				СправочникОбъект = Справочники.ПартииПроизводства.СоздатьЭлемент();
				
				Если ЗначениеЗаполнено(СтруктураРеквизитовПартии.Ссылка) Тогда
					СправочникОбъект.УстановитьСсылкуНового(СтруктураРеквизитовПартии.Ссылка);
				КонецЕсли;
				
			Иначе
				СправочникОбъект = ДанныеПартии.ПартияПроизводства.ПолучитьОбъект();
			КонецЕсли;
			
			ЗаполнитьЗначенияСвойств(СправочникОбъект, СтруктураРеквизитовПартии);
			СправочникОбъект.Записать();
			
			УстановитьПривилегированныйРежим(Ложь);
			
			ДанныеПартии.ПартияПроизводства = СправочникОбъект.Ссылка;
			
		КонецЕсли;
		
		ЗафиксироватьТранзакцию();
		
		Возврат ДанныеПартии.ПартияПроизводства;
		
	Исключение
		
		ОтменитьТранзакцию();
		
		ПредставлениеГруппыЗатрат = ГруппыЗатратСервер.ПредставлениеГруппыЗатрат(СтруктураРеквизитовПартии);
		НаименованиеПартии = НаименованиеПартииПроизводства(СтруктураРеквизитовПартии, ПредставлениеГруппыЗатрат);
		
		ТекстСообщения = НСтр("ru = 'Не удалось создать партию производства с параметрами: %ПартияПроизводства% по причине: %Причина%';
								|en = 'Cannot create a production lot with parameters: %ПартияПроизводства%. Reason:%Причина%'");
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "%ПартияПроизводства%", НаименованиеПартии);
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Причина%", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		
		ЗаписьЖурналаРегистрации(
			НСтр("ru = 'Справочник';
				|en = 'Catalog'", КодОсновногоЯзыка)
				+"." + НСтр("ru = 'Партии производства';
							|en = 'Production lots'", КодОсновногоЯзыка)
				+ "." + НСтр("ru = 'Получить партию производства';
							|en = 'Get production lot'", КодОсновногоЯзыка),
			УровеньЖурналаРегистрации.Ошибка,
			Метаданные.Справочники.ПартииПроизводства,,
			ТекстСообщения);
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ОписаниеОшибки());
		
		Возврат Неопределено;
		
	КонецПопытки;
	
КонецФункции

// Создает или обновляет данные партии производства при записи документа.
//
// Параметры:
//  ПартияПроизводства		 - СправочникСсылка.ПартииПроизводства	 - ссылка на партию производства.
//  ПоляПартии				 - Структура							 - описание партии производства.
//  ОбновлятьСуществующие	 - Булево								 - признак, необходимо обновлять существующие партии.
//  ПометкаУдаления			 - Булево								 - признак пометки на удаление
//  НоваяПартияПроизводства	 - Булево								 - возвращаемое значение, признак, партия производства новая.
//  НомерПартииПроизводства	 - Число								 - возвращаемое значение, номер партии производства.
//
Процедура СоздатьОбновитьПартиюПроизводства(ПартияПроизводства,
											ПоляПартии = Неопределено,
											ОбновлятьСуществующие = Истина,
											ПометкаУдаления = Ложь,
											НоваяПартияПроизводства = Ложь,
											НомерПартииПроизводства = 0) Экспорт
	
	Если Не ЗначениеЗаполнено(ПартияПроизводства) Тогда
		Возврат;
	КонецЕсли;
	
	ИменаРеквизитов = Новый Структура("Код, Документ, Ссылка, ПометкаУдаления");
	
	СтруктураРеквизитовПартии = Новый Структура;
	СтруктураРеквизитовПартии.Вставить("Код", 0);
	СтруктураРеквизитовПартии.Вставить("Документ", Неопределено);
	СтруктураРеквизитовПартии.Вставить("Ссылка", Неопределено);
	СтруктураРеквизитовПартии.Вставить("ПометкаУдаления", ПометкаУдаления);
	
	Для каждого МетаРеквизит Из Метаданные.Справочники.ПартииПроизводства.Реквизиты Цикл
		
		ИменаРеквизитов.Вставить(МетаРеквизит.Имя);
		
		СтруктураРеквизита = Новый Структура(МетаРеквизит.Имя);
		ЗаполнитьЗначенияСвойств(СтруктураРеквизита, ПоляПартии);
		
		СтруктураРеквизитовПартии.Вставить(
			МетаРеквизит.Имя,
			МетаРеквизит.Тип.ПривестиЗначение(СтруктураРеквизита[МетаРеквизит.Имя]));
		
	КонецЦикла;
	
	УстановитьПривилегированныйРежим(Истина);
	РеквизитыПартии = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ПартияПроизводства, ИменаРеквизитов);
	УстановитьПривилегированныйРежим(Ложь);
	
	НомерПартииПроизводства = РеквизитыПартии.Код;
	НоваяПартияПроизводства = (РеквизитыПартии.Код = Неопределено);
	
	Если НЕ НоваяПартияПроизводства
		И (НЕ ОбновлятьСуществующие ИЛИ СтруктурыРеквизитовПартийРавны(РеквизитыПартии, СтруктураРеквизитовПартии)) Тогда
		Возврат;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	Если НоваяПартияПроизводства Тогда
		
		Блокировка = Новый БлокировкаДанных;
		ЭлементБлокировки = Блокировка.Добавить("Справочник.ПартииПроизводства");
		ЭлементБлокировки.УстановитьЗначение("Документ", СтруктураРеквизитовПартии.Документ);
		ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
		
		Блокировка.Заблокировать();
		
		Запрос = Новый Запрос(
		"ВЫБРАТЬ
		|	ЕСТЬNULL(МАКСИМУМ(Таблица.Код), 0) + 1 КАК НомерПартииПроизводства
		|ИЗ
		|	Справочник.ПартииПроизводства КАК Таблица
		|ГДЕ
		|	Таблица.Документ = &Документ
		|");
		Запрос.УстановитьПараметр("Документ", СтруктураРеквизитовПартии.Документ);
		
		Выборка = Запрос.Выполнить().Выбрать();
		Выборка.Следующий();
		
		НомерПартииПроизводства = Выборка.НомерПартииПроизводства;
		
		СправочникОбъект = Справочники.ПартииПроизводства.СоздатьЭлемент();
		СправочникОбъект.УстановитьСсылкуНового(ПартияПроизводства);
		
	Иначе
		СправочникОбъект = ПартияПроизводства.ПолучитьОбъект();
	КонецЕсли;
	
	СтруктураРеквизитовПартии.Код				= НомерПартииПроизводства;
	
	ЗаполнитьЗначенияСвойств(СправочникОбъект, СтруктураРеквизитовПартии);
	СправочникОбъект.Записать();
	
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

// Заполняет партию производства в коллекции.
//
// Параметры:
//	Коллекция - ТаблицаЗначений	- Обязательными для заполнения полями выступают "Документ", "Организация", "Номенклатура".
//	ПроверятьПередСозданием		- Булево - флаг необходимости поиска партии производства перед созданием новой.
//	ОбновлятьСуществующие		- Булево - флаг необходимости обновления полей существующих партий производства.
//
Процедура ЗаполнитьПартиюПроизводстваВКоллекции(Коллекция,
												ПроверятьПередСозданием = Истина,
												ОбновлятьСуществующие = Ложь) Экспорт
	
	// Если значение колонки равняется Неопределено, то описание типов значений этой колонки будет пустым.
	// В этом случае в запросах платформа не сможет выбрать значения из нетипизированной колонки.
	// Для обхода этой ситуации создадим в таблице колонку с "правильным" типом значений и подменим ей исходную колонку.
	Коллекция.Колонки.Добавить("ДокументТипизированный",
		Метаданные.Справочники.ПартииПроизводства.Реквизиты.Документ.Тип);
	
	Для Каждого ТекСтр Из Коллекция Цикл
		ТекСтр.ПартияПроизводства = ПолучитьПартиюПроизводства(ТекСтр, ПроверятьПередСозданием, ОбновлятьСуществующие);
		ТекСтр.ДокументТипизированный = ТекСтр.Документ;
	КонецЦикла;
	
	Коллекция.Колонки.Удалить("Документ");
	Коллекция.Колонки.ДокументТипизированный.Имя = "Документ";
	
КонецПроцедуры

// Процедура получает данные для формирования партий производства и формирует их.
// 
// Параметры:
//	Запрос							- Запрос - запрос, с установленными для формирования партий параметрами.
//	ТекстВыборкаПолейПартий			- Строка -
//		текст запроса формирования временной таблицы ВТПоляПартийПроизводства с полями
//			Документ
//			ГруппировкаЗатрат
//			НомерГруппыЗатрат
//			Организация
//			ТипПроцесса
//			НаправлениеДеятельности
//			ВидДеятельностиНДС
//			ОсновноеИзделиеНоменклатура
//			ОсновноеИзделиеХарактеристика
//			Номенклатура
//			Характеристика
//			ГруппаПродукции
//			Спецификация
//			Назначение
//	ТаблицаПродукцииСформирована	- Булево - флаг необходимости формирования таблицы продукции.
//	ПроверятьПередСозданием			- Булево - флаг необходимости поиска партии производства перед созданием новой.
//	ОбновлятьСуществующие			- Булево - флаг необходимости обновления полей существующих партий производства.
//
Процедура СформироватьПартииПроизводства(Запрос,
										ТекстВыборкаПолейПартий,
										ПроверятьПередСозданием = Истина,
										ОбновлятьСуществующие = Ложь) Экспорт
	
	МассивТекстовЗапросов = Новый Массив;
	МассивТекстовЗапросов.Добавить(ТекстЗапросаНомераСтрокОсновныхИзделий());
	МассивТекстовЗапросов.Добавить(ТекстВыборкаПолейПартий);
	МассивТекстовЗапросов.Добавить(ТекстЗапросаКорректныеПоляПартийПроизводства());
	МассивТекстовЗапросов.Добавить(ТекстЗапросаТаблицаПартийПроизводстваПредварительная());
	МассивТекстовЗапросов.Добавить(ТекстЗапросаТаблицаПартийПроизводстваКОбработке(ОбновлятьСуществующие));
	
	Запрос.Текст = СтрСоединить(МассивТекстовЗапросов, ОбщегоНазначения.РазделительПакетаЗапросов());
	
	Запрос.УстановитьПараметр("АналитическийУчетПоГруппамПродукции",
		ПолучитьФункциональнуюОпцию("АналитическийУчетПоГруппамПродукции"));
	
	УстановитьПривилегированныйРежим(Истина);
	ТаблицаПартийКОбработке = Запрос.Выполнить().Выгрузить();
	УстановитьПривилегированныйРежим(Ложь);
	
	ЗаполнитьПартиюПроизводстваВКоллекции(ТаблицаПартийКОбработке, ПроверятьПередСозданием, ОбновлятьСуществующие);
	
КонецПроцедуры

// Возвращает номер партии производства.
// 
// Параметры:
// 	ПартияПроизводства - СправочникСсылка.ПартииПроизводства	 - партия производства.
// Возвращаемое значение:
// 	Число - номер партии производства.
Функция НомерПартииПроизводства(ПартияПроизводства) Экспорт
	
	НомерПартии = -1;
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	Таблица.Код КАК НомерПартии
	|ИЗ
	|	Справочник.ПартииПроизводства КАК Таблица
	|ГДЕ
	|	Таблица.Ссылка = &Ссылка
	|");
	Запрос.УстановитьПараметр("Ссылка", ПартияПроизводства);

	РезультатЗапроса = Запрос.Выполнить();
	
	Если Не РезультатЗапроса.Пустой() Тогда
		
		Выборка = РезультатЗапроса.Выбрать();
		Выборка.Следующий();
		
		НомерПартии = Выборка.НомерПартии;
		
	КонецЕсли;
	
	Возврат НомерПартии;
	
КонецФункции

// Возвращает наименование партии производства.
//
// Параметры:
//  СтруктураПартии				- СправочникОбъект.ПартииПроизводства, Структура - партия производства.
//  ПредставлениеГруппыЗатрат	- Строка - представление группы затрат партии производства.
// 
// Возвращаемое значение:
//  Строка - наименование партии производства.
//
Функция НаименованиеПартииПроизводства(СтруктураПартии, ПредставлениеГруппыЗатрат = "") Экспорт
	
	Если Не ЗначениеЗаполнено(ПредставлениеГруппыЗатрат) Тогда
		ПредставлениеГруппыЗатрат = ГруппыЗатратСервер.ПредставлениеГруппыЗатрат(СтруктураПартии);
	КонецЕсли;
	
	СписокРеквизитов = "Номер, Дата";
	РеквизитыДокумента = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СтруктураПартии.Документ, СписокРеквизитов);
	
	МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоСсылке(СтруктураПартии.Документ);
	
	ПредставлениеДокумента = МенеджерОбъекта.ПредставлениеОбъектаНаОсновномЯзыке();
	НомерДокумента = ПрефиксацияОбъектовКлиентСервер.УдалитьЛидирующиеНулиИзНомераОбъекта(РеквизитыДокумента.Номер);
	
	ПредставлениеПартии = НСтр("ru = '%ПредставлениеДокумента% (%Номер%.%НомерГруппы%, %Дата%);';
								|en = '%ПредставлениеДокумента% (%Номер%.%НомерГруппы%,%Дата%);'");
	Если ЗначениеЗаполнено(СтруктураПартии.ГруппировкаЗатрат) Тогда
		ПредставлениеПартии = ПредставлениеПартии + " "
			+ НСтр("ru = 'Группа затрат: %ГруппаЗатрат%';
					|en = 'Cost group: %ГруппаЗатрат%'", ОбщегоНазначения.КодОсновногоЯзыка());
	КонецЕсли;
	
	ПредставлениеПартии = СтрЗаменить(ПредставлениеПартии, "%ПредставлениеДокумента%",	ПредставлениеДокумента);
	ПредставлениеПартии = СтрЗаменить(ПредставлениеПартии, "%Номер%",					НомерДокумента);
	ПредставлениеПартии = СтрЗаменить(ПредставлениеПартии, "%НомерГруппы%",				Строка(СтруктураПартии.Код));
	ПредставлениеПартии = СтрЗаменить(ПредставлениеПартии, "%Дата%",					Формат(РеквизитыДокумента.Дата, "ДЛФ=D"));
	ПредставлениеПартии = СтрЗаменить(ПредставлениеПартии, "%ГруппаЗатрат%",			ПредставлениеГруппыЗатрат);
	
	Возврат ПредставлениеПартии;
	
КонецФункции

#Область СтандартныеПодсистемыКоманды

// Заполняет список команд создания на основании.
// 
// Параметры:
// 	КомандыСозданияНаОсновании - ТаблицаЗначений - перечень команд
// 	Параметры - Структура - параметры
//
Процедура ДобавитьКомандыСозданияНаОсновании(КомандыСозданияНаОсновании, Параметры) Экспорт
	
КонецПроцедуры

// Добавляет команду создания объекта на основании.
// 
// Параметры:
// 	КомандыСозданияНаОсновании - ТаблицаЗначений - перечень команд
// Возвращаемое значение:
// 	Неопределено, СтрокаТаблицыЗначений - Добавленная Команда.
//
Функция ДобавитьКомандуСоздатьНаОсновании(КомандыСозданияНаОсновании) Экспорт
	
КонецФункции

// Заполняет список команд отчетов.
// 
// Параметры:
// 	КомандыОтчетов - ТаблицаЗначений - перечень команд
// 	Параметры - Структура - параметры
//
Процедура ДобавитьКомандыОтчетов(КомандыОтчетов, Параметры) Экспорт
	
КонецПроцедуры

Процедура ПриОпределенииКомандПодключенныхКОбъекту(Команды) Экспорт
	
	КомандаОтчета = Команды.Найти("СвязанныеДокументы", "Вид");
	Если Не КомандаОтчета = Неопределено Тогда
		ПодключаемыеКоманды.ДобавитьУсловиеВидимостиКоманды(
			КомандаОтчета,
			"ТипПроцесса",
			Перечисления.ТипыПроизводственныхПроцессов.ПустаяСсылка(),
			ВидСравненияКомпоновкиДанных.НеРавно);
		
	КонецЕсли;
	
КонецПроцедуры

// Заполняет список команд печати.
//
// Параметры:
//   КомандыПечати - см. УправлениеПечатью.СоздатьКоллекциюКомандПечати
//
Процедура ДобавитьКомандыПечати(КомандыПечати) Экспорт
	
КонецПроцедуры

// СтандартныеПодсистемы.УправлениеДоступом

// См. УправлениеДоступомПереопределяемый.ПриЗаполненииСписковСОграничениемДоступа.
Процедура ПриЗаполненииОграниченияДоступа(Ограничение) Экспорт

	Ограничение.Текст =
	"РазрешитьЧтениеИзменение
	|ГДЕ
	|	ЗначениеРазрешено(Организация)";

КонецПроцедуры

// Конец СтандартныеПодсистемы.УправлениеДоступом

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Возвращает перечень полей, идентифицирующих партию производства
//
// Возвращаемое значение:
//	Строка - перечень полей, идентифицирующих партию производства.
//
Функция ПоляИдентификацииПартииПроизводства() Экспорт
	
	Возврат "Документ, Код";
	
КонецФункции

// Формирует структуру для описания полей партии производства
// 
// Возвращаемое значение:
//  Структура - структура полей партии производства
//
Функция ОписаниеПартииПроизводства() Экспорт
	
	СтруктураРеквизитовПартии = Новый Структура;
	
	Для каждого МетаРеквизит Из Метаданные.Справочники.ПартииПроизводства.Реквизиты Цикл
		
		СтруктураРеквизитовПартии.Вставить(
			МетаРеквизит.Имя,
			МетаРеквизит.Тип.ПривестиЗначение(Неопределено));
		
	КонецЦикла;
	
	Возврат СтруктураРеквизитовПартии;
	
КонецФункции

Функция СтруктурыРеквизитовПартийРавны(Структура1, Структура2)
	
	Для каждого ТекРеквизит Из Структура1 Цикл
		
		ИмяРеквизита = ТекРеквизит.Ключ;
		
		Если ИмяРеквизита = "Код"
			ИЛИ ИмяРеквизита = "Ссылка"
			ИЛИ ИмяРеквизита = "Наименование"
			ИЛИ ИмяРеквизита = "ГруппаЗатрат" Тогда
			Продолжить;
		КонецЕсли;
		
		Если Структура1[ИмяРеквизита] <> Структура2[ИмяРеквизита] Тогда
			Возврат Ложь;
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

Функция ТекстЗапросаНомераСтрокОсновныхИзделий()
	
	Возврат
	"ВЫБРАТЬ
	|	МИНИМУМ(ТаблицаТовары.НомерСтроки)	КАК НомерСтроки,
	|	ТаблицаТовары.Ссылка				КАК Ссылка,
	|	ТаблицаТовары.НомерГруппыЗатрат		КАК НомерГруппыЗатрат
	|ПОМЕСТИТЬ НомераСтрокОсновныхИзделий
	|ИЗ
	|	ТаблицаПродукция КАК ТаблицаТовары
	|
	|ГДЕ
	|	НЕ &ГруппировкаЗатрат = ЗНАЧЕНИЕ(Перечисление.ГруппировкиЗатратВЗаказеПереработчику.ПоЭтапамПроизводства)
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаТовары.Ссылка,
	|	ТаблицаТовары.НомерГруппыЗатрат
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка,
	|	НомерГруппыЗатрат
	|";
	
КонецФункции

Функция ТекстЗапросаКорректныеПоляПартийПроизводства()
	
	Возврат
	"ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.Документ) В (ТИП(Документ.ОтчетПереработчика),
	//++ НЕ УТКА
	|										ТИП(Документ.ЗаказНаПроизводство2_2),
	//-- НЕ УТКА
	|										ТИП(Документ.ПроизводствоБезЗаказа))
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Т.Документ
	|	КОНЕЦ						КАК Документ,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.ГруппировкаЗатрат) В (ТИП(Перечисление.ГруппировкиЗатратВЗаказеПереработчику),
	|													ТИП(Перечисление.ГруппировкиЗатратВПроизводствеБезЗаказа))
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Т.ГруппировкаЗатрат
	|	КОНЕЦ						КАК ГруппировкаЗатрат,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.НомерГруппыЗатрат) = ТИП(Число)
	|			ТОГДА 0
	|		ИНАЧЕ Т.НомерГруппыЗатрат
	|	КОНЕЦ						КАК НомерГруппыЗатрат,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.Организация) = ТИП(Справочник.Организации)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|		ИНАЧЕ Т.Организация
	|	КОНЕЦ						КАК Организация,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.ТипПроцесса) = ТИП(Перечисление.ТипыПроизводственныхПроцессов)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыПроизводственныхПроцессов.ПустаяСсылка)
	|		ИНАЧЕ Т.ТипПроцесса
	|	КОНЕЦ						КАК ТипПроцесса,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.НаправлениеДеятельности) = ТИП(Справочник.НаправленияДеятельности)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|		ИНАЧЕ Т.НаправлениеДеятельности
	|	КОНЕЦ						КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.ВидДеятельностиНДС) = ТИП(Перечисление.ТипыНалогообложенияНДС)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|		ИНАЧЕ Т.ВидДеятельностиНДС
	|	КОНЕЦ						КАК ВидДеятельностиНДС,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.ОсновноеИзделиеНоменклатура) = ТИП(Справочник.Номенклатура)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|		ИНАЧЕ Т.ОсновноеИзделиеНоменклатура
	|	КОНЕЦ						КАК ОсновноеИзделиеНоменклатура,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.ОсновноеИзделиеХарактеристика) = ТИП(Справочник.ХарактеристикиНоменклатуры)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)
	|		ИНАЧЕ Т.ОсновноеИзделиеХарактеристика
	|	КОНЕЦ						КАК ОсновноеИзделиеХарактеристика,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.Номенклатура) = ТИП(Справочник.Номенклатура)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|		ИНАЧЕ Т.Номенклатура
	|	КОНЕЦ						КАК Номенклатура,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.Характеристика) = ТИП(Справочник.ХарактеристикиНоменклатуры)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)
	|		ИНАЧЕ Т.Характеристика
	|	КОНЕЦ						КАК Характеристика,
	|	ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.ГруппаПродукции) = ТИП(Справочник.ГруппыАналитическогоУчетаНоменклатуры)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|		ИНАЧЕ Т.ГруппаПродукции
	|	КОНЕЦ						КАК ГруппаПродукции,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.Спецификация) = ТИП(Справочник.РесурсныеСпецификации)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка)
	|		ИНАЧЕ Т.Спецификация
	|	КОНЕЦ						КАК Спецификация,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.Назначение) = ТИП(Справочник.Назначения)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|		ИНАЧЕ Т.Назначение
	|	КОНЕЦ						КАК Назначение
	|ПОМЕСТИТЬ ВТКорректныеПоляПартийПроизводства
	|ИЗ
	|	ВТПоляПартийПроизводства КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.Документ) В (ТИП(Документ.ОтчетПереработчика),
	//++ НЕ УТКА
	|										ТИП(Документ.ЗаказНаПроизводство2_2),
	//-- НЕ УТКА
	|										ТИП(Документ.ПроизводствоБезЗаказа))
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Т.Документ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.ГруппировкаЗатрат) В (ТИП(Перечисление.ГруппировкиЗатратВЗаказеПереработчику),
	|													ТИП(Перечисление.ГруппировкиЗатратВПроизводствеБезЗаказа))
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Т.ГруппировкаЗатрат
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.НомерГруппыЗатрат) = ТИП(Число)
	|			ТОГДА 0
	|		ИНАЧЕ Т.НомерГруппыЗатрат
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.Организация) = ТИП(Справочник.Организации)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|		ИНАЧЕ Т.Организация
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.ТипПроцесса) = ТИП(Перечисление.ТипыПроизводственныхПроцессов)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыПроизводственныхПроцессов.ПустаяСсылка)
	|		ИНАЧЕ Т.ТипПроцесса
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.НаправлениеДеятельности) = ТИП(Справочник.НаправленияДеятельности)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|		ИНАЧЕ Т.НаправлениеДеятельности
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.ВидДеятельностиНДС) = ТИП(Перечисление.ТипыНалогообложенияНДС)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|		ИНАЧЕ Т.ВидДеятельностиНДС
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.ОсновноеИзделиеНоменклатура) = ТИП(Справочник.Номенклатура)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|		ИНАЧЕ Т.ОсновноеИзделиеНоменклатура
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.ОсновноеИзделиеХарактеристика) = ТИП(Справочник.ХарактеристикиНоменклатуры)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)
	|		ИНАЧЕ Т.ОсновноеИзделиеХарактеристика
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.Номенклатура) = ТИП(Справочник.Номенклатура)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|		ИНАЧЕ Т.Номенклатура
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.Характеристика) = ТИП(Справочник.ХарактеристикиНоменклатуры)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)
	|		ИНАЧЕ Т.Характеристика
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.ГруппаПродукции) = ТИП(Справочник.ГруппыАналитическогоУчетаНоменклатуры)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|		ИНАЧЕ Т.ГруппаПродукции
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.Спецификация) = ТИП(Справочник.РесурсныеСпецификации)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка)
	|		ИНАЧЕ Т.Спецификация
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ ТИПЗНАЧЕНИЯ(Т.Назначение) = ТИП(Справочник.Назначения)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|		ИНАЧЕ Т.Назначение
	|	КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Документ,
	|	НомерГруппыЗатрат
	|";
КонецФункции

Функция ТекстЗапросаТаблицаПартийПроизводстваПредварительная()
	
	Возврат
	"ВЫБРАТЬ
	|	Т.Документ						КАК Документ,
	|	Т.ГруппировкаЗатрат				КАК ГруппировкаЗатрат,
	|	Т.НомерГруппыЗатрат				КАК НомерГруппыЗатрат,
	|	Т.Организация					КАК Организация,
	|	Т.ТипПроцесса					КАК ТипПроцесса,
	|	Т.НаправлениеДеятельности		КАК НаправлениеДеятельности,
	|	Т.ВидДеятельностиНДС			КАК ВидДеятельностиНДС,
	|	Т.ОсновноеИзделиеНоменклатура	КАК ОсновноеИзделиеНоменклатура,
	|	Т.ОсновноеИзделиеХарактеристика	КАК ОсновноеИзделиеХарактеристика,
	|	Т.Номенклатура					КАК Номенклатура,
	|	Т.Характеристика				КАК Характеристика,
	|	Т.ГруппаПродукции				КАК ГруппаПродукции,
	|	Т.Спецификация					КАК Спецификация,
	|	Т.Назначение					КАК Назначение,
	|	ЕСТЬNULL(СпрПартииПроизводства.Ссылка,
	|		ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)) КАК ПартияПроизводства
	|ПОМЕСТИТЬ ВтТаблицаПартийПроизводстваПредварительная
	|ИЗ
	|	ВТКорректныеПоляПартийПроизводства КАК Т
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК СпрПартииПроизводства
	|		ПО СпрПартииПроизводства.Документ = Т.Документ
	|		И СпрПартииПроизводства.Код = Т.НомерГруппыЗатрат
	|		И НЕ СпрПартииПроизводства.ПометкаУдаления
	|";
	
КонецФункции

Функция ТекстЗапросаТаблицаПартийПроизводстваКОбработке(ОбновлятьСуществующие = Ложь)
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	Т.Документ						КАК Документ,
	|	Т.ГруппировкаЗатрат				КАК ГруппировкаЗатрат,
	|	Т.НомерГруппыЗатрат				КАК Код,
	|	Т.Организация					КАК Организация,
	|	Т.ТипПроцесса					КАК ТипПроцесса,
	|	Т.НаправлениеДеятельности		КАК НаправлениеДеятельности,
	|	Т.ВидДеятельностиНДС			КАК ВидДеятельностиНДС,
	|	Т.ОсновноеИзделиеНоменклатура	КАК ОсновноеИзделиеНоменклатура,
	|	Т.ОсновноеИзделиеХарактеристика	КАК ОсновноеИзделиеХарактеристика,
	|	Т.Номенклатура					КАК Номенклатура,
	|	Т.Характеристика				КАК Характеристика,
	|	Т.ГруппаПродукции				КАК ГруппаПродукции,
	|	Т.Спецификация					КАК Спецификация,
	|	Т.Назначение					КАК Назначение,
	|	Т.ПартияПроизводства			КАК ПартияПроизводства
	|ИЗ
	|	ВтТаблицаПартийПроизводстваПредварительная КАК Т
	|ГДЕ
	|	&УсловиеОбновлятьСуществующие
	|";
	
	Если ОбновлятьСуществующие Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&УсловиеОбновлятьСуществующие", "ИСТИНА");
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&УсловиеОбновлятьСуществующие", "Т.ПартияПроизводства = ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)");
	КонецЕсли;
	
	Возврат ТекстЗапроса;
	
КонецФункции

#Область ОбновлениеИнформационнойБазы

#Область ОбработчикГенерацияПартийПроизводства_2_4_6

#КонецОбласти

#КонецОбласти

#КонецОбласти

#КонецЕсли