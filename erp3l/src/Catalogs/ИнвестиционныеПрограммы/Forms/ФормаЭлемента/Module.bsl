
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если ЗначениеЗаполнено(Параметры.ЗначениеКопирования) И НЕ ЗначениеЗаполнено(Объект.Ссылка) Тогда
		
		Объект_ = РеквизитФормыВЗначение("Объект");
		
		НачатьТранзакцию();
		
		Попытка
			
			Если НЕ ЗначениеЗаполнено(Объект.Ответственный) Тогда
				Объект.Ответственный = Пользователи.ТекущийПользователь();
			КонецЕсли;
	
			Объект_.Записать();
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
				"ВЫБРАТЬ
				|	РазделыИнвестиционныхПрограмм.Ссылка,
				|	НастройкиПроцессовВыбора.НастройкаПроцессаВыбора
				|ИЗ
				|	Справочник.РазделыИнвестиционныхПрограмм КАК РазделыИнвестиционныхПрограмм
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НастройкиПроцессовВыбора КАК НастройкиПроцессовВыбора
				|		ПО РазделыИнвестиционныхПрограмм.Ссылка = НастройкиПроцессовВыбора.Владелец
				|ГДЕ
				|	РазделыИнвестиционныхПрограмм.Владелец = &Ссылка";
			
			Запрос.УстановитьПараметр("Ссылка", Параметры.ЗначениеКопирования);
			
			РезультатЗапроса = Запрос.Выполнить();
			
			// создаем подобные разделы инвест. программы
			ВыборкаРазделыИнвестПрограмм = РезультатЗапроса.Выбрать();
			Пока ВыборкаРазделыИнвестПрограмм.Следующий() Цикл
				РазделОбъект = ВыборкаРазделыИнвестПрограмм.Ссылка.Скопировать();
				РазделОбъект.Владелец = Объект_.Ссылка;
				РазделОбъект.Записать();
				
				// создаем настройки выбора
				// копируем настройку
				ОбъектНастройка = ВыборкаРазделыИнвестПрограмм.НастройкаПроцессаВыбора.Скопировать();
				ОбъектНастройка.Записать();
				
				// и назначем ее разделу
				НаборЗаписей = РегистрыСведений.НастройкиПроцессовВыбора.СоздатьНаборЗаписей();
				НаборЗаписей.Отбор.Владелец.Установить(РазделОбъект.Ссылка);
				НоваяЗапись = НаборЗаписей.Добавить();
				НоваяЗапись.Владелец = РазделОбъект.Ссылка;
				НоваяЗапись.НастройкаПроцессаВыбора = ОбъектНастройка.Ссылка;
				НаборЗаписей.Записать();
				
			КонецЦикла;

			
			ЗначениеВРеквизитФормы(Объект_, "Объект");
			
		Исключение
			
			ТекстОшибки = ОписаниеОшибки();
			
			ОтменитьТранзакцию();
			Отказ = Истина;
			
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = "Ошибка копирования инвест. программы: " + ТекстОшибки;
			Сообщение.Сообщить();
			
			
			Возврат;
			
		КонецПопытки;
		
		ЗафиксироватьТранзакцию();
		
	КонецЕсли;
	
	Проекты.Отбор.Элементы.Очистить(); 
	ОтборыСписковКлиентСерверУХ.ИзменитьЭлементОтбораСписка(Разделы, "Владелец", Объект.Ссылка, Истина);
	ОтборыСписковКлиентСерверУХ.ИзменитьЭлементОтбораСписка(Проекты, "ВладелецРазделаИП", Объект.Ссылка, Истина);
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	ОтборыСписковКлиентСерверУХ.ИзменитьЭлементОтбораСписка(Разделы, "Владелец", Объект.Ссылка, Истина);
КонецПроцедуры


